<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>An Akka DDD from scratch</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">An Akka DDD from scratch</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2017-11-13</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/ddd-shard/">ddd, shard</a></p></div><div class="article-content"><p>æœ€è¿‘çš„å¤šäººæ¸¸æˆå¼€å‘ä¸Šï¼Œå¯¹<a target="_blank" rel="noopener" href="http://akka.io/">Akka</a> çš„ä½¿ç”¨éå¸¸æ„Ÿå…´è¶£ã€‚åœ¨æˆ‘çš„å·¥ä½œä¸Šï¼Œæˆ‘å’Œ <a target="_blank" rel="noopener" href="http://www.dsfishlabs.com/en">@DsFishlabs</a> ä½¿ç”¨äº† Spring Boot ä»¥åŠ Spring Cloud ä½œä¸ºæˆ‘ä»¬çš„å†…éƒ¨æœåŠ¡ã€‚</p>
<p>åœ¨æœ¬æ–‡ï¼Œæˆ‘æƒ³å°è¯•åŸºäº <code>Akka</code> æ¥æ„å»ºç›¸ä¼¼çš„ç³»ç»Ÿï¼ŒåŠŸèƒ½æ–¹é¢è·ŸåŸæ¥å·®ä¸å¤šï¼Œä½†è¿™é‡Œæˆ‘æƒ³å°è¯•ä¸€ä¸ªä¸åŒçš„æ–¹å¼ã€‚å…¶ä¸­åŒ…å«æœ‰ Scalaï¼Œ<a target="_blank" rel="noopener" href="http://doc.akka.io/docs/akka/snapshot/scala/cluster-sharding.html">Akka Cluster Sharding</a>ï¼Œ<a target="_blank" rel="noopener" href="http://doc.akka.io/docs/akka/snapshot/scala/persistence.html">Akka Persistence aka.Event Sourcing</a> ä»¥åŠ <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Domain-driven_design">DDD</a>ã€‚</p>
<p>æ‰€æœ‰ä»£ç ä¼šåœ¨Githubä¸Šï¼Œå¯èƒ½éœ€è¦çœ‹çœ‹ <a target="_blank" rel="noopener" href="https://github.com/evolution-gaming/akka-tools">extractShardId</a> æ–¹é¢çš„èµ„æ–™ã€‚</p>
<span id="more"></span>
<h2 id="é€šç”¨è¯­è¨€-ç¬¬ä¸€ä¸ªæ¨¡å‹"><a class="header-anchor" href="#é€šç”¨è¯­è¨€-ç¬¬ä¸€ä¸ªæ¨¡å‹">Â¶</a>é€šç”¨è¯­è¨€ &amp; ç¬¬ä¸€ä¸ªæ¨¡å‹</h2>
<p>è¿™é‡Œï¼Œæˆ‘å°†åŒæ—¶æ‰®æ¼”å¼€å‘è€…(Developer)å’Œé¢†åŸŸä¸“å®¶(Domain Expert)çš„è§’è‰²ï¼Œä»¥å‡å°‘é—®é¢˜çš„å¤æ‚æ€§ã€‚æˆ‘å°†å›´ç»•æˆ‘è‡ªèº«åœ¨å…¬å¸å’Œæ¸¸æˆçš„å±‚é¢å‡ºå‘ã€‚æ¯ä¸ªé¡¹ç›®åº”è¯¥å¼€å§‹ä¸€ç§é€šç”¨è¯­è¨€(an ubiquitous language)ï¼Œä»¥åŠè¦è®¾è®¡å®ç°è§£å†³æ–¹æ¡ˆçš„éœ€æ±‚ï¼Œè®©æˆ‘ä»¬å®šä¹‰ä¸€äº›æœ¯è¯­ã€‚</p>
<blockquote>
<p>é¢†åŸŸä¸“å®¶è¯´ï¼š<br>
&quot; Each <code>Player</code> has some amount of <code>XP</code> as well as <code>Credits</code> &quot;</p>
</blockquote>
<p>å®ƒå¼•å…¥äº†3ä¸ªæœ¯è¯­ï¼š</p>
<ul>
<li>Player 	æ¸¸æˆç©å®¶ï¼Œå®ƒæœ‰å”¯ä¸€æ ‡è¯†</li>
<li>XP		æ¯ä¸ªæ¸¸æˆç©å®¶é€šè¿‡ç»éªŒå€¼(the amount of <code>XP</code>)æˆé•¿</li>
<li>Credits	è¯¥æ¸¸æˆä¸­ç”¨äºäº¤æ˜“çš„é€šç”¨è´§å¸</li>
</ul>
<p><img src="/img/pattern/ddd/dddfc/first-model.svg" alt="first-model"></p>
<p>çœŸå®çš„éœ€æ±‚ï¼Œå¼•å¯¼æˆ‘ä»¬å»ºç«‹æ¨¡å‹ã€‚è¿™é‡Œ<code>Player</code> ä½œä¸ºä¸€ä¸ª <code>Aggregate Root</code> å¹¶é™„ä¸Šä¸€ä¸ªç±»å‹Id(<code>PlayerId</code>)ã€‚</p>
<p>å®ƒåŒ…å«ä¸Šè¿°çš„æ‰€æœ‰éœ€æ±‚(å½“ç„¶åªæœ‰ä¸€ä¸ªâ€¦)ã€‚æˆ‘ä»¬çš„æ¨¡å‹ä¹ŸåŒ…æ‹¬äº†é€šç”¨è¯­è¨€ä¸­çš„æ‰€æœ‰æœ¯è¯­(terms)ã€‚</p>
<div class="clearfix"></div>
å¯¹åº”Scalaç±»å®ç°å¦‚ä¸‹ï¼š
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> id: <span class="type">PlayerId</span> = <span class="type">PlayerId</span>(<span class="type">UUID</span>.randomUUID.toString)</span><br><span class="line">  <span class="keyword">var</span> xp: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> credits: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PlayerId</span>(<span class="params">value: <span class="type">String</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>å®Œç¾ï¼æ‰€æœ‰éœ€æ±‚å®ç°äº†â€¦</p>
<p>ä½†åªæœ‰ä¸€ä¸ªç±»èµ·ä¸åˆ°ä»€ä¹ˆä½œç”¨ï¼Œä¸èƒ½å‘ç©å®¶å‘é€ä¿¡æ¯ï¼Œä¹Ÿæ²¡æœ‰åˆå§‹åŒ–çš„éšæœº<code>UUID</code>æ§åˆ¶ï¼Œå› æ­¤è®©æˆ‘ä»¬è¡¥ä¸Šã€‚</p>
<blockquote>
<p>é¢†åŸŸä¸“å®¶è¯´ï¼š<br>
â€œA new <code>Player</code> will be created when a Person registers on the Backend.<br>
It will the be initialized with a given amount of <code>XP</code> and <code>Creadits</code> (in this case 0) When a <code>Player</code> requests his information from the backend then it should return the <code>Id</code> and the amount of <code>XP</code> as well as the amount of <code>Credits</code>â€</p>
</blockquote>
<p>æ˜¯çš„ï¼Œç©å®¶å¯ä»¥è‡ªå·±åˆ›å»ºè§’è‰²ï¼Œå¹¶åˆå§‹åŒ–ä¸€å®šçš„ç»éªŒå€¼å’Œå¸å€¼(å¼€å§‹æ—¶éƒ½æ˜¯0)ã€‚å¹¶ä¸”èƒ½è·å–åˆ°åˆ›å»ºè§’è‰²çš„æœ‰å…³ä¿¡æ¯ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥æ»¡è¶³è¿™ä¸€éœ€æ±‚ï¼š</p>
<h2 id="ç¬¬ä¸€ä¸ªActor"><a class="header-anchor" href="#ç¬¬ä¸€ä¸ªActor">Â¶</a>ç¬¬ä¸€ä¸ªActor</h2>
<p>é¦–å…ˆæˆ‘ä»¬è¦å°†<code>Player</code>ç±»è½¬æ¢ä¸ºä¸€ä¸ªäº‹ä»¶æº¯æº(event sourced)Actorï¼Œä¸‹é¢ä¸ºä»£ç ï¼š</p>
<figure class="highlight scala"><figcaption><span>PlayerActor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayerActor</span> <span class="keyword">extends</span> <span class="title">PersistentActor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> id: <span class="type">PlayerId</span> = <span class="type">PlayerId</span>(self.path.name) <i class="conum" data-value="1"></i></span><br><span class="line">  <span class="keyword">var</span> xp: <span class="type">Int</span> = _</span><br><span class="line">  <span class="keyword">var</span> credits: <span class="type">Int</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="comment">// self.path.name is the entity identifier (utf-8 URL-encoded)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">persistenceId</span></span>: <span class="type">String</span> = <span class="string">&quot;Player-&quot;</span> + self.path.name</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> log = <span class="type">Logging</span>(context.system, <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveCommand</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">case</span> init: <span class="type">InitializePlayer</span> =&gt; <i class="conum" data-value="2"></i></span><br><span class="line">      persist(<span class="type">PlayerInitialized</span>(init.playerId, init.xp, init.credits)) &#123; ev =&gt; <i class="conum" data-value="3"></i></span><br><span class="line">        initialize(ev)</span><br><span class="line">        sender() ! ev <i class="conum" data-value="4"></i></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">GetPlayerInformation</span> =&gt; sender() ! <span class="type">PlayerInformation</span>(id, xp, credits) <i class="conum" data-value="5"></i></span><br><span class="line">    <span class="keyword">case</span> _ =&gt; log.info(<span class="string">&quot;received unknown message&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveRecover</span> </span>= &#123; <i class="conum" data-value="6"></i></span><br><span class="line">    <span class="keyword">case</span> init: <span class="type">PlayerInitialized</span> =&gt; initialize(init)</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; log.info(<span class="string">&quot;received unknown message&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(init: <span class="type">PlayerInitialized</span>) = &#123; <i class="conum" data-value="7"></i></span><br><span class="line">    <span class="keyword">this</span>.xp = init.xp</span><br><span class="line">    <span class="keyword">this</span>.credits = init.credits</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> ä¹‹åä½ å°†çœ‹åˆ°æˆ‘ä»¬å¯ä»¥ä»actor è·¯å¾„è·å¾— <code>Player</code>çš„Idï¼Œå› æ­¤ä¸€ä¸ª<code>Player</code>æ€»æ˜¯æœ‰ä¸€ä¸ªIdã€‚<br>
<i class="conum" data-value="2"></i> è¦å®ç°éœ€æ±‚ï¼Œ<code>Player</code>åº”è¯¥åˆå§‹åŒ–äº‹ä»¶å“åº”ã€‚<br>
<i class="conum" data-value="3"></i> é¦–å…ˆæˆ‘ä»¬ä¼šæŒä¹…åŒ–äº§ç”Ÿçš„äº‹ä»¶ï¼Œä¹‹åè°ƒç”¨<code>initialized</code>æ–¹æ³•åˆå§‹åŒ–<code>Player</code>çš„çŠ¶æ€ã€‚<br>
<i class="conum" data-value="4"></i> åˆå§‹åŒ–åï¼Œæˆ‘ä»¬ç»™senderå›åº”è¯¥äº‹ä»¶<br>
<i class="conum" data-value="5"></i> è¿™é‡Œå®ç°äº†<code>Player</code>å¯ä»¥è·å–å®ƒçš„çŠ¶æ€ã€‚å› ä¸ºæ²¡æœ‰å‘½ä»¤(command)äº§ç”Ÿçš„äº‹ä»¶ï¼Œä»…è¿”å›æ•°æ®ã€‚<br>
<i class="conum" data-value="6"></i> å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•è¡¨ç¤ºè¯¥actorçš„äº‹ä»¶è¿›å…¥â€œé‡ç©â€(replayed)ã€‚å› æ­¤ç›´æ¥è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªä¸éœ€è¦æŒä¹…åŒ–ã€‚<br>
<i class="conum" data-value="7"></i> è¯¥æ–¹æ³•æ ¹æ®äº‹ä»¶æ¥è®¾ç½®<code>XP</code>å’Œ<code>Credits</code>.</p>
<p>ç”±äºè¦ä½¿ç”¨<code>Event Sourcing</code>ä½œä¸ºæŒä¹…åŒ–æœºåˆ¶ï¼Œè¿™é‡Œæ‰©å±•<code>PersistentActor</code>ã€‚</p>
<p>ä¼´ç”Ÿå¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†äº‹ä»¶ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PlayerActor</span> </span>&#123;</span><br><span class="line">  <span class="comment">// define compatible commands</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">InitializePlayer</span>(<span class="params">playerId: <span class="type">PlayerId</span>, xp: <span class="type">Int</span>, credits: <span class="type">Int</span></span>)</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">GetPlayerInformation</span>(<span class="params">playerId: <span class="type">PlayerId</span></span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// define compatible events</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PlayerInitialized</span>(<span class="params">playerId: <span class="type">PlayerId</span>, xp: <span class="type">Int</span>, credits: <span class="type">Int</span></span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// custom responses</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PlayerInformation</span>(<span class="params">playerId: <span class="type">PlayerId</span>, xp: <span class="type">Int</span>, credits: <span class="type">Int</span></span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">extractEntityId</span></span>(): <span class="type">ShardRegion</span>.<span class="type">ExtractEntityId</span> = &#123; <i class="conum" data-value="1"></i></span><br><span class="line">    <span class="keyword">case</span> msg<span class="meta">@InitializePlayer</span>(id, _, _) =&gt; (id.value.toString, msg)</span><br><span class="line">    <span class="keyword">case</span> msg<span class="meta">@GetPlayerInformation</span>(id) =&gt; (id.value.toString, msg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">extractShardId</span></span>(numberOfShards: <span class="type">Int</span>): <span class="type">ShardRegion</span>.<span class="type">ExtractShardId</span> = &#123; <i class="conum" data-value="2"></i></span><br><span class="line">    <span class="keyword">case</span> <span class="type">InitializePlayer</span>(id, _, _) =&gt; <span class="type">Math</span>.abs(id.hashCode() % numberOfShards).toString</span><br><span class="line">    <span class="keyword">case</span> <span class="type">GetPlayerInformation</span>(id) =&gt;  <span class="type">Math</span>.abs(id.hashCode() % numberOfShards).toString</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> è¦ä½¿ç”¨<a target="_blank" rel="noopener" href="http://doc.akka.io/docs/akka/snapshot/scala/cluster-sharding.html">Akka Cluster Sharding</a> æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª<code>extractEntityId</code>æ–¹æ³•ï¼Œè¿™æ ·akkaçŸ¥é“å“ªä¸ªactoråº”è¯¥æ¥å—å½“å‰çš„æ¶ˆæ¯ã€‚è¿™é‡Œè¿”å›<code>Player</code>çš„Idï¼ŒåŒæ—¶ä¹Ÿæ˜¯actorçš„è·¯å¾„åç§°ã€‚<br>
<i class="conum" data-value="2"></i> å¦å¤–ä¹Ÿéœ€è¦å®šä¹‰ä¸€ä¸ª<code>extractShardId</code>æ–¹æ³•ï¼Œè¿™æ ·akkaçŸ¥é“å“ªä¸ªåˆ†ç‰‡è´Ÿè´£è¯¥Actor(è¿™é‡Œå®šä¹‰100ä¸ªåˆ†ç‰‡)ï¼Œè¿™æ ·å°†actoråˆ†é…åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p>
<h2 id="ä¸»å‡½æ•°"><a class="header-anchor" href="#ä¸»å‡½æ•°">Â¶</a>ä¸»å‡½æ•°</h2>
<p>æˆ‘ä»¬è¿˜éœ€è¦æ³¨å†Œä¸€ä¸ªendpointå°†å®ƒä»¬è¿æ¥èµ·æ¥ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">App</span> <span class="keyword">with</span> <span class="title">AkkaInjectable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>()</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> executor = system.dispatcher</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">5</span> seconds)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> logger: <span class="type">LoggingAdapter</span> = <span class="type">Logging</span>(system, getClass)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> appModule = <span class="keyword">new</span> <span class="type">PlayerModule</span> <i class="conum" data-value="1"></i></span><br><span class="line">  <span class="keyword">val</span> player = inject[<span class="type">ActorRef</span>](&#x27;player) <i class="conum" data-value="2"></i></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> routes = &#123;</span><br><span class="line">    logRequestResult(<span class="string">&quot;server&quot;</span>) &#123;</span><br><span class="line">      (post &amp; path(<span class="string">&quot;register&quot;</span>)) &#123;</span><br><span class="line">        complete &#123;</span><br><span class="line">          <span class="comment">// create a new user and send it a message</span></span><br><span class="line">          <span class="keyword">val</span> playerId = <span class="type">PlayerId</span>(<span class="type">UUID</span>.randomUUID().toString) <i class="conum" data-value="3"></i></span><br><span class="line">          (player ? <span class="type">InitializePlayer</span>(playerId, <span class="number">0</span>, <span class="number">0</span>)).mapTo[<span class="type">PlayerInitialized</span>].map &#123; ev: <span class="type">PlayerInitialized</span> =&gt; ev.playerId.value &#125; <i class="conum" data-value="4"></i></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">Http</span>().bindAndHandle(routes, config.getString(<span class="string">&quot;http.interface&quot;</span>), config.getInt(<span class="string">&quot;http.port&quot;</span>)) <i class="conum" data-value="5"></i></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> è½½å…¥<code>PlayerModule</code>ã€‚<br>
<i class="conum" data-value="2"></i> æ³¨å…¥åˆ†ç‰‡actorçš„å¼•ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å‘é€ä¿¡æ¯ã€‚<br>
<i class="conum" data-value="3"></i> åˆ›å»ºä¸€ä¸ªå”¯ä¸€æ ‡è¯†çš„Idã€‚<br>
<i class="conum" data-value="4"></i> å‘é€è¯·æ±‚ã€‚<br>
<i class="conum" data-value="5"></i> åœ°å€å’Œç«¯å£ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨äº†<a target="_blank" rel="noopener" href="http://scaldi.org/">Scaldi</a>ä½œä¸ºä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å£°æ˜é›†ç¾¤åˆ†ç‰‡ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayerModule</span>(<span class="params">implicit system: <span class="type">ActorSystem</span></span>) <span class="keyword">extends</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> numberOfShards = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> playerRegion: <span class="type">ActorRef</span> = <span class="type">ClusterSharding</span>(system).start(</span><br><span class="line">    typeName = <span class="string">&quot;Player&quot;</span>,</span><br><span class="line">    entityProps = <span class="type">Props</span>[<span class="type">PlayerActor</span>],</span><br><span class="line">    settings = <span class="type">ClusterShardingSettings</span>(system),</span><br><span class="line">    extractEntityId = <span class="type">PlayerActor</span>.extractEntityId(), <i class="conum" data-value="1"></i></span><br><span class="line">    extractShardId = <span class="type">PlayerActor</span>.extractShardId(numberOfShards) <i class="conum" data-value="2"></i></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  bind[<span class="type">ActorRef</span>] as &#x27;player to playerRegion <i class="conum" data-value="3"></i></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> <code>extractEntityId</code>æ–¹æ³•çš„å¼•ç”¨<br>
<i class="conum" data-value="2"></i> <code>extractShardId</code>æ–¹æ³•çš„å¼•ç”¨<br>
<i class="conum" data-value="3"></i> <code>player</code>ç»‘å®šä¸ºåˆ†ç‰‡actorçš„å¼•ç”¨ï¼Œç”¨ä½œä¾èµ–æ³¨å…¥å®ç°</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Chumper/akka-game-backend-from-scratch/tree/master/part1">è¿™é‡Œ</a>å¯ä»¥å‚è€ƒå®Œæ•´ä»£ç ã€‚</p>
<h2 id="æµ‹è¯•"><a class="header-anchor" href="#æµ‹è¯•">Â¶</a>æµ‹è¯•</h2>
<p>å¯åŠ¨æœåŠ¡æˆ–æ‰§è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbt run</span><br></pre></td></tr></table></figure>
<p>æˆ‘è¿™é‡Œä½¿ç”¨äº†<a target="_blank" rel="noopener" href="https://github.com/jkbrzt/httpie">Httpie</a>ï¼Œæµ‹è¯•æ›´åŠ æ–¹ä¾¿ã€‚</p>
<p>ä½ å¯ä»¥<code>POST</code>åˆ°<code>/register</code>ç«¯ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">http POST :9000/register</span></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 36</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Date: Sun, 10 Jan 2016 18:44:59 GMT</span><br><span class="line">Server: akka-http/2.4.1</span><br><span class="line"></span><br><span class="line">62b058cf-6d73-4d5c-9855-2aed6e36ad3d</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢ä½œä¸€ä¸ªçŸ­æœŸçš„åŸºå‡†(benchmark)æµ‹è¯•(10ç§’ï¼Œ10å¹¶å‘è¯·æ±‚)ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ab -t10 -c10 -mPOST http://localhost:9000/register</span></span><br><span class="line"></span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1663405 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10377 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        akka-http/2.4.1</span><br><span class="line">Server Hostname:        localhost</span><br><span class="line">Server Port:            9000</span><br><span class="line"></span><br><span class="line">Document Path:          /register</span><br><span class="line">Document Length:        36 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      10</span><br><span class="line">Time taken for tests:   10.000 seconds</span><br><span class="line">Complete requests:      10377</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      2044269 bytes</span><br><span class="line">HTML transferred:       373572 bytes</span><br><span class="line">Requests per second:    1037.70 [#/sec] (mean)</span><br><span class="line">Time per request:       9.637 [ms] (mean)</span><br><span class="line">Time per request:       0.964 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          199.64 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.1      0       3</span><br><span class="line">Processing:     2    9  15.0      8     474</span><br><span class="line">Waiting:        2    9  15.0      8     474</span><br><span class="line">Total:          3   10  15.0      9     474</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">     9</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">     9</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    10</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    10</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    11</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    12</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    14</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">    17</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">   474 (longest request)</span></span><br></pre></td></tr></table></figure>
<p>10ç§’å†…å¾—åˆ°10000æ–°ç”¨æˆ·ï¼Œä»¤äººå°è±¡æ·±åˆ»(æˆ‘ä»¬çš„spring æœåŠ¡ç”šè‡³æ¥è¿‘çš„æ°´å¹³éƒ½æœªåˆ°â€¦)</p>
</div></article><nav class="article-nav"><div class="article-nav-prev">ğŸ”™<a href="/2017/11/22/musics/audio-player-nest/">éŸ³ä¹æ’­æ”¾å™¨</a></div><div class="article-nav-next">ğŸ”œ<a href="/2017/11/07/pattern/ddd/functional-ddd/">Domain Design Relish</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2017/11/13/pattern/ddd/dddfs/';
var disqus_title = 'An Akka DDD from scratch';
var disqus_url = 'https://galudisu.info/2017/11/13/pattern/ddd/dddfs/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>