<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>An Akka DDD from scratch</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">An Akka DDD from scratch</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2017-11-13</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/ddd-shard/">ddd, shard</a></p></div><div class="article-content"><p>最近的多人游戏开发上，对<a target="_blank" rel="noopener" href="http://akka.io/">Akka</a> 的使用非常感兴趣。在我的工作上，我和 <a target="_blank" rel="noopener" href="http://www.dsfishlabs.com/en">@DsFishlabs</a> 使用了 Spring Boot 以及 Spring Cloud 作为我们的内部服务。</p>
<p>在本文，我想尝试基于 <code>Akka</code> 来构建相似的系统，功能方面跟原来差不多，但这里我想尝试一个不同的方式。其中包含有 Scala，<a target="_blank" rel="noopener" href="http://doc.akka.io/docs/akka/snapshot/scala/cluster-sharding.html">Akka Cluster Sharding</a>，<a target="_blank" rel="noopener" href="http://doc.akka.io/docs/akka/snapshot/scala/persistence.html">Akka Persistence aka.Event Sourcing</a> 以及 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Domain-driven_design">DDD</a>。</p>
<p>所有代码会在Github上，可能需要看看 <a target="_blank" rel="noopener" href="https://github.com/evolution-gaming/akka-tools">extractShardId</a> 方面的资料。</p>
<span id="more"></span>
<h2 id="通用语言-第一个模型"><a class="header-anchor" href="#通用语言-第一个模型">¶</a>通用语言 &amp; 第一个模型</h2>
<p>这里，我将同时扮演开发者(Developer)和领域专家(Domain Expert)的角色，以减少问题的复杂性。我将围绕我自身在公司和游戏的层面出发。每个项目应该开始一种通用语言(an ubiquitous language)，以及要设计实现解决方案的需求，让我们定义一些术语。</p>
<blockquote>
<p>领域专家说：<br>
&quot; Each <code>Player</code> has some amount of <code>XP</code> as well as <code>Credits</code> &quot;</p>
</blockquote>
<p>它引入了3个术语：</p>
<ul>
<li>Player 	游戏玩家，它有唯一标识</li>
<li>XP		每个游戏玩家通过经验值(the amount of <code>XP</code>)成长</li>
<li>Credits	该游戏中用于交易的通用货币</li>
</ul>
<p><img src="/img/pattern/ddd/dddfc/first-model.svg" alt="first-model"></p>
<p>真实的需求，引导我们建立模型。这里<code>Player</code> 作为一个 <code>Aggregate Root</code> 并附上一个类型Id(<code>PlayerId</code>)。</p>
<p>它包含上述的所有需求(当然只有一个…)。我们的模型也包括了通用语言中的所有术语(terms)。</p>
<div class="clearfix"></div>
对应Scala类实现如下：
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> id: <span class="type">PlayerId</span> = <span class="type">PlayerId</span>(<span class="type">UUID</span>.randomUUID.toString)</span><br><span class="line">  <span class="keyword">var</span> xp: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> credits: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PlayerId</span>(<span class="params">value: <span class="type">String</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>完美！所有需求实现了…</p>
<p>但只有一个类起不到什么作用，不能向玩家发送信息，也没有初始化的随机<code>UUID</code>控制，因此让我们补上。</p>
<blockquote>
<p>领域专家说：<br>
“A new <code>Player</code> will be created when a Person registers on the Backend.<br>
It will the be initialized with a given amount of <code>XP</code> and <code>Creadits</code> (in this case 0) When a <code>Player</code> requests his information from the backend then it should return the <code>Id</code> and the amount of <code>XP</code> as well as the amount of <code>Credits</code>”</p>
</blockquote>
<p>是的，玩家可以自己创建角色，并初始化一定的经验值和币值(开始时都是0)。并且能获取到创建角色的有关信息。</p>
<p>下面我们来满足这一需求：</p>
<h2 id="第一个Actor"><a class="header-anchor" href="#第一个Actor">¶</a>第一个Actor</h2>
<p>首先我们要将<code>Player</code>类转换为一个事件溯源(event sourced)Actor，下面为代码：</p>
<figure class="highlight scala"><figcaption><span>PlayerActor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayerActor</span> <span class="keyword">extends</span> <span class="title">PersistentActor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> id: <span class="type">PlayerId</span> = <span class="type">PlayerId</span>(self.path.name) <i class="conum" data-value="1"></i></span><br><span class="line">  <span class="keyword">var</span> xp: <span class="type">Int</span> = _</span><br><span class="line">  <span class="keyword">var</span> credits: <span class="type">Int</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="comment">// self.path.name is the entity identifier (utf-8 URL-encoded)</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">persistenceId</span></span>: <span class="type">String</span> = <span class="string">&quot;Player-&quot;</span> + self.path.name</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> log = <span class="type">Logging</span>(context.system, <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveCommand</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">case</span> init: <span class="type">InitializePlayer</span> =&gt; <i class="conum" data-value="2"></i></span><br><span class="line">      persist(<span class="type">PlayerInitialized</span>(init.playerId, init.xp, init.credits)) &#123; ev =&gt; <i class="conum" data-value="3"></i></span><br><span class="line">        initialize(ev)</span><br><span class="line">        sender() ! ev <i class="conum" data-value="4"></i></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">GetPlayerInformation</span> =&gt; sender() ! <span class="type">PlayerInformation</span>(id, xp, credits) <i class="conum" data-value="5"></i></span><br><span class="line">    <span class="keyword">case</span> _ =&gt; log.info(<span class="string">&quot;received unknown message&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">receiveRecover</span> </span>= &#123; <i class="conum" data-value="6"></i></span><br><span class="line">    <span class="keyword">case</span> init: <span class="type">PlayerInitialized</span> =&gt; initialize(init)</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; log.info(<span class="string">&quot;received unknown message&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(init: <span class="type">PlayerInitialized</span>) = &#123; <i class="conum" data-value="7"></i></span><br><span class="line">    <span class="keyword">this</span>.xp = init.xp</span><br><span class="line">    <span class="keyword">this</span>.credits = init.credits</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> 之后你将看到我们可以从actor 路径获得 <code>Player</code>的Id，因此一个<code>Player</code>总是有一个Id。<br>
<i class="conum" data-value="2"></i> 要实现需求，<code>Player</code>应该初始化事件响应。<br>
<i class="conum" data-value="3"></i> 首先我们会持久化产生的事件，之后调用<code>initialized</code>方法初始化<code>Player</code>的状态。<br>
<i class="conum" data-value="4"></i> 初始化后，我们给sender回应该事件<br>
<i class="conum" data-value="5"></i> 这里实现了<code>Player</code>可以获取它的状态。因为没有命令(command)产生的事件，仅返回数据。<br>
<i class="conum" data-value="6"></i> 当调用这个方法表示该actor的事件进入“重玩”(replayed)。因此直接调用初始化方法，这个不需要持久化。<br>
<i class="conum" data-value="7"></i> 该方法根据事件来设置<code>XP</code>和<code>Credits</code>.</p>
<p>由于要使用<code>Event Sourcing</code>作为持久化机制，这里扩展<code>PersistentActor</code>。</p>
<p>伴生对象如下所示，这里我们定义了事件：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PlayerActor</span> </span>&#123;</span><br><span class="line">  <span class="comment">// define compatible commands</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">InitializePlayer</span>(<span class="params">playerId: <span class="type">PlayerId</span>, xp: <span class="type">Int</span>, credits: <span class="type">Int</span></span>)</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">GetPlayerInformation</span>(<span class="params">playerId: <span class="type">PlayerId</span></span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// define compatible events</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PlayerInitialized</span>(<span class="params">playerId: <span class="type">PlayerId</span>, xp: <span class="type">Int</span>, credits: <span class="type">Int</span></span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// custom responses</span></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PlayerInformation</span>(<span class="params">playerId: <span class="type">PlayerId</span>, xp: <span class="type">Int</span>, credits: <span class="type">Int</span></span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">extractEntityId</span></span>(): <span class="type">ShardRegion</span>.<span class="type">ExtractEntityId</span> = &#123; <i class="conum" data-value="1"></i></span><br><span class="line">    <span class="keyword">case</span> msg<span class="meta">@InitializePlayer</span>(id, _, _) =&gt; (id.value.toString, msg)</span><br><span class="line">    <span class="keyword">case</span> msg<span class="meta">@GetPlayerInformation</span>(id) =&gt; (id.value.toString, msg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">extractShardId</span></span>(numberOfShards: <span class="type">Int</span>): <span class="type">ShardRegion</span>.<span class="type">ExtractShardId</span> = &#123; <i class="conum" data-value="2"></i></span><br><span class="line">    <span class="keyword">case</span> <span class="type">InitializePlayer</span>(id, _, _) =&gt; <span class="type">Math</span>.abs(id.hashCode() % numberOfShards).toString</span><br><span class="line">    <span class="keyword">case</span> <span class="type">GetPlayerInformation</span>(id) =&gt;  <span class="type">Math</span>.abs(id.hashCode() % numberOfShards).toString</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> 要使用<a target="_blank" rel="noopener" href="http://doc.akka.io/docs/akka/snapshot/scala/cluster-sharding.html">Akka Cluster Sharding</a> 我们需要定义一个<code>extractEntityId</code>方法，这样akka知道哪个actor应该接受当前的消息。这里返回<code>Player</code>的Id，同时也是actor的路径名称。<br>
<i class="conum" data-value="2"></i> 另外也需要定义一个<code>extractShardId</code>方法，这样akka知道哪个分片负责该Actor(这里定义100个分片)，这样将actor分配到每个节点上。</p>
<h2 id="主函数"><a class="header-anchor" href="#主函数">¶</a>主函数</h2>
<p>我们还需要注册一个endpoint将它们连接起来：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">App</span> <span class="keyword">with</span> <span class="title">AkkaInjectable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>()</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> executor = system.dispatcher</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">5</span> seconds)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> logger: <span class="type">LoggingAdapter</span> = <span class="type">Logging</span>(system, getClass)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> appModule = <span class="keyword">new</span> <span class="type">PlayerModule</span> <i class="conum" data-value="1"></i></span><br><span class="line">  <span class="keyword">val</span> player = inject[<span class="type">ActorRef</span>](&#x27;player) <i class="conum" data-value="2"></i></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> routes = &#123;</span><br><span class="line">    logRequestResult(<span class="string">&quot;server&quot;</span>) &#123;</span><br><span class="line">      (post &amp; path(<span class="string">&quot;register&quot;</span>)) &#123;</span><br><span class="line">        complete &#123;</span><br><span class="line">          <span class="comment">// create a new user and send it a message</span></span><br><span class="line">          <span class="keyword">val</span> playerId = <span class="type">PlayerId</span>(<span class="type">UUID</span>.randomUUID().toString) <i class="conum" data-value="3"></i></span><br><span class="line">          (player ? <span class="type">InitializePlayer</span>(playerId, <span class="number">0</span>, <span class="number">0</span>)).mapTo[<span class="type">PlayerInitialized</span>].map &#123; ev: <span class="type">PlayerInitialized</span> =&gt; ev.playerId.value &#125; <i class="conum" data-value="4"></i></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">Http</span>().bindAndHandle(routes, config.getString(<span class="string">&quot;http.interface&quot;</span>), config.getInt(<span class="string">&quot;http.port&quot;</span>)) <i class="conum" data-value="5"></i></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> 载入<code>PlayerModule</code>。<br>
<i class="conum" data-value="2"></i> 注入分片actor的引用，这样我们可以发送信息。<br>
<i class="conum" data-value="3"></i> 创建一个唯一标识的Id。<br>
<i class="conum" data-value="4"></i> 发送请求。<br>
<i class="conum" data-value="5"></i> 地址和端口。</p>
<p>这里，我使用了<a target="_blank" rel="noopener" href="http://scaldi.org/">Scaldi</a>作为依赖注入方式，因此我们需要声明集群分片：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayerModule</span>(<span class="params">implicit system: <span class="type">ActorSystem</span></span>) <span class="keyword">extends</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> numberOfShards = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> playerRegion: <span class="type">ActorRef</span> = <span class="type">ClusterSharding</span>(system).start(</span><br><span class="line">    typeName = <span class="string">&quot;Player&quot;</span>,</span><br><span class="line">    entityProps = <span class="type">Props</span>[<span class="type">PlayerActor</span>],</span><br><span class="line">    settings = <span class="type">ClusterShardingSettings</span>(system),</span><br><span class="line">    extractEntityId = <span class="type">PlayerActor</span>.extractEntityId(), <i class="conum" data-value="1"></i></span><br><span class="line">    extractShardId = <span class="type">PlayerActor</span>.extractShardId(numberOfShards) <i class="conum" data-value="2"></i></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  bind[<span class="type">ActorRef</span>] as &#x27;player to playerRegion <i class="conum" data-value="3"></i></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><i class="conum" data-value="1"></i> <code>extractEntityId</code>方法的引用<br>
<i class="conum" data-value="2"></i> <code>extractShardId</code>方法的引用<br>
<i class="conum" data-value="3"></i> <code>player</code>绑定为分片actor的引用，用作依赖注入实现</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Chumper/akka-game-backend-from-scratch/tree/master/part1">这里</a>可以参考完整代码。</p>
<h2 id="测试"><a class="header-anchor" href="#测试">¶</a>测试</h2>
<p>启动服务或执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbt run</span><br></pre></td></tr></table></figure>
<p>我这里使用了<a target="_blank" rel="noopener" href="https://github.com/jkbrzt/httpie">Httpie</a>，测试更加方便。</p>
<p>你可以<code>POST</code>到<code>/register</code>端点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">http POST :9000/register</span></span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 36</span><br><span class="line">Content-Type: text/plain; charset=UTF-8</span><br><span class="line">Date: Sun, 10 Jan 2016 18:44:59 GMT</span><br><span class="line">Server: akka-http/2.4.1</span><br><span class="line"></span><br><span class="line">62b058cf-6d73-4d5c-9855-2aed6e36ad3d</span><br></pre></td></tr></table></figure>
<p>下面作一个短期的基准(benchmark)测试(10秒，10并发请求)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ab -t10 -c10 -mPOST http://localhost:9000/register</span></span><br><span class="line"></span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 1663405 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking localhost (be patient)</span><br><span class="line">Completed 5000 requests</span><br><span class="line">Completed 10000 requests</span><br><span class="line">Finished 10377 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        akka-http/2.4.1</span><br><span class="line">Server Hostname:        localhost</span><br><span class="line">Server Port:            9000</span><br><span class="line"></span><br><span class="line">Document Path:          /register</span><br><span class="line">Document Length:        36 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      10</span><br><span class="line">Time taken for tests:   10.000 seconds</span><br><span class="line">Complete requests:      10377</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      2044269 bytes</span><br><span class="line">HTML transferred:       373572 bytes</span><br><span class="line">Requests per second:    1037.70 [#/sec] (mean)</span><br><span class="line">Time per request:       9.637 [ms] (mean)</span><br><span class="line">Time per request:       0.964 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          199.64 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    0   0.1      0       3</span><br><span class="line">Processing:     2    9  15.0      8     474</span><br><span class="line">Waiting:        2    9  15.0      8     474</span><br><span class="line">Total:          3   10  15.0      9     474</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line"><span class="meta prompt_">  50% </span><span class="language-bash">     9</span></span><br><span class="line"><span class="meta prompt_">  66% </span><span class="language-bash">     9</span></span><br><span class="line"><span class="meta prompt_">  75% </span><span class="language-bash">    10</span></span><br><span class="line"><span class="meta prompt_">  80% </span><span class="language-bash">    10</span></span><br><span class="line"><span class="meta prompt_">  90% </span><span class="language-bash">    11</span></span><br><span class="line"><span class="meta prompt_">  95% </span><span class="language-bash">    12</span></span><br><span class="line"><span class="meta prompt_">  98% </span><span class="language-bash">    14</span></span><br><span class="line"><span class="meta prompt_">  99% </span><span class="language-bash">    17</span></span><br><span class="line"><span class="meta prompt_"> 100% </span><span class="language-bash">   474 (longest request)</span></span><br></pre></td></tr></table></figure>
<p>10秒内得到10000新用户，令人印象深刻(我们的spring 服务甚至接近的水平都未到…)</p>
</div></article><nav class="article-nav"><div class="article-nav-prev"><a href="/2017/11/22/musics/audio-player-nest/">音乐播放器</a></div><div class="article-nav-next"><a href="/2017/11/07/pattern/ddd/functional-ddd/">Domain Design Relish</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2017/11/13/pattern/ddd/dddfs/';
var disqus_title = 'An Akka DDD from scratch';
var disqus_url = 'https://galudisu.info/2017/11/13/pattern/ddd/dddfs/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>