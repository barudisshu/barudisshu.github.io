<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>Akka Streamingå­¦ä¹ </title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">Akka Streamingå­¦ä¹ </h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2017-05-26</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/akka-streaming/">akka-streaming</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/akka/">akka</a></p></div><div class="article-content"><p>æ—¶è‡³ä»Šæ—¥ï¼Œæˆ‘ä»¬ä»å› ç‰¹å°”ä¸Šæ¶ˆé£æœåŠ¡åŒ…å«è®¸å¤šæµåª’ä½“æ•°æ®(streaming data)ï¼ŒåŒ…æ‹¬ä¸‹è½½ã€ä¸Šä¼ ã€ç‚¹å¯¹ç‚¹çš„æ•°æ®ä¼ é€ã€‚æŠŠæ•°æ®æ•´ä½“çœ‹åšæ˜¯ä¸€ä¸ªå…ƒç´ é›†åˆçš„æµ(a stream of elements)ï¼Œå¯¹æˆ‘ä»¬è®¡ç®—æœºå‘é€å’Œæ¥æ”¶è¿™äº›æ•°æ®èµ·äº†å¾ˆå¤§å¸®åŠ©ï¼Œå› ä¸ºæ•°æ®å˜å¾—è¶Šæ¥è¶Šåºå¤§ï¼Œä»¥â€œæµâ€çš„æ–¹å¼å¤„ç†æ•°æ®æ˜¾å¾—å¾ˆæœ‰å¿…è¦ã€‚</p>
<p>Actorsçœ‹èµ·æ¥ä¹Ÿå¯ä»¥å¤„ç†â€œæµâ€ï¼šå®ƒä»¬é¡ºåºåœ°æ¥æ”¶ä¸€ç³»åˆ—æ¶ˆæ¯ï¼Œå¹¶å¯¹æ¶ˆæ¯è¿›è¡Œä¼ è¾“ã€‚ä½†æˆ‘ä»¬å‘ç°ï¼Œåœ¨actorä¹‹é—´è¦å®ç°ä¸€ä¸ªstable streamingï¼Œä¼šæ˜¾å¾—å†—ä½™ä¹å‘³(tedious)å’Œæ˜“å‡ºé”™(error-prone)ï¼Œå› ä¸ºåœ¨å¤„ç†å‘é€(sending)å’Œæ¥æ”¶(receiving)æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‹…å¿ƒbufferæº¢å‡ºæˆ–é‚®ç®±æº¢å‡ºé—®é¢˜ã€‚å¦å¤–ä¸€ä¸ªé™·é˜±(pitfall)æ˜¯ï¼ŒActorçš„æ¶ˆæ¯ä¼šä¸¢å¤±ï¼Œå¯¹ä¸¢å¤±çš„æ¶ˆæ¯è¦è¿›è¡Œè½¬å‘ï¼Œä»¥å…streamä¸€ç›´åœç•™åœ¨receivingçš„é‚£ä¸€æ–¹ã€‚å½“å¤„ç†å®Œstreamsï¼ŒActorä¸èƒ½æ‹…ä¿ä¸ä¼šæœ‰è¿æ¥(wiring)é”™è¯¯çš„å‡ºç°ã€‚</p>
<span id="more"></span>
<p>åŸºäºè¿™äº›åŸå› ï¼ŒAkka Stream APIä¾¿è¢«æå‡ºã€‚ç›®çš„æ˜¯æä¾›ä¸€ä¸ªç›´è§‚çš„ã€å®‰å…¨çš„æ–¹å¼æ¥**å®šåˆ¶(formulate)**æµå¤„ç†ï¼Œä½¿æˆ‘ä»¬åœ¨èµ„æºé™åˆ¶ä½¿ç”¨çš„æƒ…å†µ(å³æ§åˆ¶å†…å­˜æº¢å‡ºçš„æƒ…å†µ)ä¸‹é«˜æ•ˆå¤„ç†ã€‚é‚£ä¹ˆå¦‚ä½•å®ç°ï¼Ÿakka streamå®ç°äº†ä¸€ä¸ªæœ‰ â€œback-pressureâ€ çš„ç‰¹æ€§ï¼Œå®ƒæ¥æºäº <a target="_blank" rel="noopener" href="http://reactive-streams.org/">Reactive Streams</a> ï¼Œakkaæ˜¯è¯¥è§„èŒƒçš„åˆå§‹æˆå‘˜ã€‚</p>
<p>Reactive Streamsè§„èŒƒå®ç°åªæœ‰4ä¸ªæ¥å£ï¼š</p>
<p>Publisher</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Publisher</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; s)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Subscriber</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscriber</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Subscription s)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Subscription</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscription</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Processor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T, R&gt; <span class="keyword">extends</span> <span class="title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥åè®®çš„ä¸»è¦ç›®æ ‡æ˜¯å®ç° <code>back-pressure</code>ã€<code>async</code>ã€<code>non-blocking boundaries and interoperability</code>ã€‚</p>
<ul>
<li><code>back-pressure</code>ï¼šåä½œç”¨åŠ›ï¼Œå…·ä½“å®ç°ç»†èŠ‚ä¸ºï¼Œ<code>Publisher</code>å®ç°äº†ä¸€ä¸ª<code>subscribe</code>æ–¹æ³•ï¼Œæ„æ€æ˜¯ï¼ŒPublisherå‘å¸ƒè€…æ‹¥æœ‰å¯¹Subscriberè®¢é˜…çš„åŠŸèƒ½ï¼Œæ‰€ä»¥Publisheræœ¬èº«ä¹Ÿæ˜¯ä¸ªSubscriberï¼Œåªæ˜¯å®ƒä»…èƒ½å¯¹å”¯ä¸€ä¸€ä¸ªå¯¹è±¡è¿›è¡Œè®¢é˜…â€”â€”Subscriberã€‚åä½œç”¨åŠ›ä½“ç°åœ¨ï¼Œ<code>Publisher</code>å¯ä»¥ç”±è¯¥æ–¹æ³•ï¼Œå¾—çŸ¥<code>Subscriber</code>çš„è®¢é˜…èƒ½åŠ›ï¼Œç”±æ­¤æ§åˆ¶â€œè®¢é˜…â€çš„â€œé€Ÿåº¦â€ï¼Œä¸ä¼šè¶…å‡ºâ€œå‘å¸ƒâ€çš„é€Ÿåº¦å¾ˆå¤šï¼Œä»¥æ­¤æ§åˆ¶é¿å…å†…å­˜æº¢å‡ºç­‰é—®é¢˜ã€‚</li>
<li><code>async</code>ï¼šå¼‚æ­¥ã€‚å¯ä»¥çœ‹åˆ°è¿™4ä¸ªæ¥å£çš„æ–¹æ³•éƒ½æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥è¿™äº›æ–¹æ³•å®ç°ä»¥éé˜»å¡æ–¹å¼æ§åˆ¶ï¼Œå®ç°å¯¹æµçš„å¼‚æ­¥æ“ä½œå¤„ç†ã€‚</li>
<li><code>non-blocking</code>ï¼šéé˜»å¡ã€‚<code>Subscriber</code>é™¤äº†<code>onSubscribe</code>å¤–ï¼ŒåŒ…å«æœ‰<code>onNext</code>æ–¹æ³•ï¼Œå½“ä¸€ä¸ªElementå¤„ç†å®Œæˆ(å¼‚æ­¥æ–¹å¼)ï¼Œè°ƒç”¨<code>onNext</code>æ–¹æ³•ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªElementï¼Œä¸ä¼šé˜»å¡æ•´ä¸ªæ“ä½œ(å‡ºç°å¼‚å¸¸æˆ–é”™è¯¯ï¼Œå…·ä½“çœ‹ä»£ç å®ç°ç»†èŠ‚ï¼Œakka streamå¯¹é”™è¯¯å¤„ç†ä¸ºsupervision strategyæ–¹å¼ï¼Œåˆ é™¤å‡ºé”™çš„elementï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªonNextï¼Œå‚è€ƒkafkaè®¾è®¡)ã€‚</li>
</ul>
<h2 id="å¿«é€Ÿå¼€å§‹"><a class="header-anchor" href="#å¿«é€Ÿå¼€å§‹">Â¶</a>å¿«é€Ÿå¼€å§‹</h2>
<ul>
<li>Source: something with exactly one output stream</li>
<li>Sink: something with exactly one input stream</li>
<li>Flow: something with exactly one input and one output stream</li>
<li>BidiFlow: something with exactly two input streams and two output streams that conceptually behave like two Flows of opposite direction</li>
<li>Graph: a packaged stream processing topology that exposes a certain set of input and output ports, characterized by an object of type Shape.</li>
</ul>
<p>ä¸€ä¸ªstreamé€šå¸¸ä»¥ä¸€ä¸ªsourceå¼€å§‹ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ç›¸åº”çš„åŒ…</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akka.stream._</span><br><span class="line"><span class="keyword">import</span> akka.stream.scaladsl._</span><br></pre></td></tr></table></figure>
<p>å¦å¤–è¿˜éœ€å¼•å…¥å¸¸ç”¨çš„æ‰§è¡Œå…³è”åŒ…</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akka.&#123; <span class="type">NotUsed</span>, <span class="type">Done</span> &#125;</span><br><span class="line"><span class="keyword">import</span> akka.actor.<span class="type">ActorSystem</span></span><br><span class="line"><span class="keyword">import</span> akka.util.<span class="type">ByteString</span></span><br><span class="line"><span class="keyword">import</span> scala.concurrent._</span><br><span class="line"><span class="keyword">import</span> scala.concurrent.duration._</span><br><span class="line"><span class="keyword">import</span> java.nio.file.<span class="type">Paths</span></span><br></pre></td></tr></table></figure>
<p>ä»¥åŠMainæ–¹æ³•</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Code here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªæœ€ç®€å•çš„<code>Source</code>ï¼ŒåŒ…å«1 to 100æ•´æ•°</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> source: <span class="type">Source</span>[<span class="type">Int</span>, <span class="type">NotUsed</span>] = <span class="type">Source</span>(<span class="number">1</span> to <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>Source</code>å‚æ•°åŒ–ä¸¤ä¸ªç±»å‹ï¼šç¬¬ä¸€ä¸ªæ˜¯<code>Int</code>ä¸ºè¯¥source å‘å°„å…ƒç´ çš„ç±»å‹ï¼Œç¬¬äºŒä¸ªä¸ºè¿è¡Œè¯¥sourceå¯èƒ½äº§ç”Ÿçš„ <code>è¾…åŠ©å€¼(auxiliary value)</code>(å¦‚ç½‘ç»œsourceä¼šå¾—åˆ°ç«¯å£å·æˆ–åœ°å€)ï¼Œç”±<code>Sources</code>å’Œ<code>Sinks</code>è¿è¡Œåäº§ç”Ÿçš„auxiliary valueï¼Œæœ¯è¯­ä¸Šè¢«ç§°ä½œ<code>materialized value</code>ã€‚ä¸äº§ç”Ÿè¾…åŠ©ä¿¡æ¯æ—¶ï¼Œç”¨<code>akka.NotUsed</code>è¡¨ç¤ºâ€”â€”è¿™é‡Œä¾‹å­çš„æ•´å‹è‚¯å®šä¸ä¼šäº§ç”Ÿè¾…åŠ©ä¿¡æ¯ã€‚</p>
<p>åˆ›å»ºäº†sourceï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å‘å°„è¿™100ä¸ªè‡ªç„¶æ•°ï¼Œä½†<code>Source</code>æ²¡æœ‰æ¿€æ´»ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ‰§è¡Œï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source.runForeach(i =&gt; println(i))(materializer)</span><br></pre></td></tr></table></figure>
<p>è¿™è¡Œæ‰§è¡Œåœ¨ä¸€ä¸ªconsumer å‡½æ•°å®Œæˆâ€”â€”ä»¥åŒ…å«â€œrunâ€çš„æ–¹æ³•åæ‰§è¡Œï¼›åŒ…å«å…¶å®ƒç±»ä¼¼çš„æ–¹æ³•ã€‚</p>
<p>åœ¨Appæ‰§è¡Œè¯¥ä»£ç æ—¶ï¼Œç¨‹åºå¹¶æ²¡æœ‰ç»ˆæ­¢é€€å‡ºï¼Œå› ä¸º<code>ActorSystem</code>æ²¡æœ‰ç»ˆæ­¢ã€‚<code>runForeach</code>è¿”å›ä¸€ä¸ª<code>Future[Done]</code>è¡¨ç¤ºstreamå®Œæˆ</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> done: <span class="type">Future</span>[<span class="type">Done</span>] = source.runForeach(i =&gt; println(i))(materializer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> ec = system.dispatcher</span><br><span class="line">done.onComplete(_ =&gt; system.terminate())</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æƒ³çŸ¥é“<code>materializer</code>è¡¨ç¤ºä»€ä¹ˆã€‚é¦–å…ˆæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªActor system</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">&quot;QuickStart&quot;</span>)</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br></pre></td></tr></table></figure>
<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡<code>ActorContext</code>æ¥åˆ›å»ºã€‚<code>Materializer</code>æ˜¯streamæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥å‚ï¼Œå®ƒä½¿å¾—streamså¯ä»¥æ‰§è¡Œâ€”â€”ä½ ç°åœ¨ä¸éœ€è¦äº†è§£å®ƒçš„æ›´å¤šç»†èŠ‚ï¼Œä»…éœ€è¦çŸ¥é“ä½ å¯ä»¥è°ƒç”¨<code>Source</code>çš„<code>run*</code>æ–¹æ³•ã€‚ç‰©åŒ–(materializer)å®é™…ä¸Šå°±æ˜¯å°†<code>Source</code>ã€<code>Sink</code>ã€<code>Flow</code>æ„å»ºèµ·æ¥çš„è“å›¾(blueprint)æä¾›å¯æ‰§è¡Œå®ç°ã€‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> factorials = source.scan(<span class="type">BigInt</span>(<span class="number">1</span>))((acc, next) =&gt; acc * next)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> result: <span class="type">Future</span>[<span class="type">IOResult</span>] =</span><br><span class="line">  factorials</span><br><span class="line">    .map(num =&gt; <span class="type">ByteString</span>(<span class="string">s&quot;<span class="subst">$num</span>\n&quot;</span>))</span><br><span class="line">    .runWith(<span class="type">FileIO</span>.toPath(<span class="type">Paths</span>.get(<span class="string">&quot;factorials.txt&quot;</span>)))</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¦æ—¶åˆ»è®°ä½ï¼Œ<code>Source</code>å†…éƒ¨å®é™…ä¸Šä¸ä¼šè¿›è¡Œä»»ä½•è®¡ç®—å¤„ç†ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªæè¿°(description)ï¼Œå½“ run* æ–¹æ³•æ˜¯è®¡ç®—å®ƒå†…éƒ¨æè¿°çš„å†…å®¹ã€‚</p>
<p>åœ¨Akka Streamsçš„æœ¯è¯­ä¸­<code>Source</code>è¡¨ç¤ºæ•´ä¸ªstreamçš„è¾“å…¥ï¼Œ<code>Sink</code>è¡¨ç¤ºæ•´ä¸ªstreamçš„è¾“å‡ºã€‚åœ¨Akka Streamç»“æ„ä¸­ï¼Œ<code>Source</code>ä»…æœ‰ä¸€ä¸ªoutput channelä¸åŒ…å«input channelï¼Œ<code>Sink</code>åˆ™åˆšå¥½ç›¸åï¼ŒåŒ…å«ä¸€ä¸ªinput channelï¼Œä¸åŒ…å«output channelã€‚</p>
<p>ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªå‚è€ƒä¾‹å­ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akka.<span class="type">NotUsed</span></span><br><span class="line"><span class="keyword">import</span> akka.actor.<span class="type">ActorSystem</span></span><br><span class="line"><span class="keyword">import</span> akka.stream.<span class="type">ActorMaterializer</span></span><br><span class="line"><span class="keyword">import</span> akka.stream.scaladsl._</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">handle: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtag</span>(<span class="params">name: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Tweet</span>(<span class="params">author: <span class="type">Author</span>, timestamp: <span class="type">Long</span>, body: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hashtags</span></span>: <span class="type">Set</span>[<span class="type">Hashtag</span>] =</span><br><span class="line">    body.split(<span class="string">&quot; &quot;</span>).collect &#123; <span class="keyword">case</span> t <span class="keyword">if</span> t.startsWith(<span class="string">&quot;#&quot;</span>) =&gt; <span class="type">Hashtag</span>(t) &#125;.toSet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> akkaTag = <span class="type">Hashtag</span>(<span class="string">&quot;#akka&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> tweets: <span class="type">Source</span>[<span class="type">Tweet</span>, <span class="type">NotUsed</span>] = <span class="type">Source</span>(</span><br><span class="line">  <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;rolandkuhn&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka rocks!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;patriknw&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;bantonsson&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;drewhk&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;ktosopl&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka on the rocks!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;mmartynas&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;wow #akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;akkateam&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka rocks!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;bananaman&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#bananas rock!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;appleman&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#apples rock!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;drama&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;we compared #apples to #oranges!&quot;</span>) ::</span><br><span class="line">    <span class="type">Nil</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">&quot;reactive-tweets&quot;</span>)</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br><span class="line"></span><br><span class="line">  tweets</span><br><span class="line">    .filterNot(_.hashtags.contains(akkaTag))</span><br><span class="line">    .mapConcat(_.hashtags)</span><br><span class="line">    .map(_.name.toUpperCase)</span><br><span class="line">    .runWith(<span class="type">Sink</span>.foreach(println))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $FiddleDependency org.akka-js %%% akkajsactorstream % 1.2.5.1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç‰‡æ®µé‡ç”¨"><a class="header-anchor" href="#ç‰‡æ®µé‡ç”¨">Â¶</a>ç‰‡æ®µé‡ç”¨</h2>
<p>Akka Streamsä¸­æ‰€æœ‰æ¨¡å—éƒ½å¯ä»¥å®ç°resuableï¼Œä¾‹å¦‚</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lineSink</span></span>(filename: <span class="type">String</span>): <span class="type">Sink</span>[<span class="type">String</span>, <span class="type">Future</span>[<span class="type">IOResult</span>]] =</span><br><span class="line">  <span class="type">Flow</span>[<span class="type">String</span>]</span><br><span class="line">    .map(s =&gt; <span class="type">ByteString</span>(s + <span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    .toMat(<span class="type">FileIO</span>.toPath(<span class="type">Paths</span>.get(filename)))(<span class="type">Keep</span>.right)</span><br></pre></td></tr></table></figure>
<p>é“¾æ¥<code>Source</code>å’Œ<code>Flow</code>åå¾—åˆ°çš„auxiliary informationå°±æ˜¯â€œmaterialized valueâ€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†æ–°åˆ›å»ºçš„<code>Sink</code>è´´åˆ°æˆ‘ä»¬çš„<code>factorials</code> sourceä¸Š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">factorials.map(_.toString).runWith(lineSink(<span class="string">&quot;factorial2.txt&quot;</span>))</span><br></pre></td></tr></table></figure>
<h2 id="åŸºäºæ—¶é—´å¤„ç†"><a class="header-anchor" href="#åŸºäºæ—¶é—´å¤„ç†">Â¶</a>åŸºäºæ—¶é—´å¤„ç†</h2>
<p>ç°åœ¨æˆ‘ä»¬é€šè¿‡zipå®ç°å°†ä¸¤ä¸ªsourceè½¬æ¢ä¸ºä¸€ä¸ªstream</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">factorials</span><br><span class="line">  .zipWith(<span class="type">Source</span>(<span class="number">0</span> to <span class="number">100</span>))((num, idx) =&gt; <span class="string">s&quot;<span class="subst">$idx</span>! = <span class="subst">$num</span>&quot;</span>)</span><br><span class="line">  .throttle(<span class="number">1</span>, <span class="number">1.</span>second, <span class="number">1</span>, <span class="type">ThrottleMode</span>.shaping)</span><br><span class="line">  .runForeach(println)</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¾èµ–äºæ—¶é—´æ‰§è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨<code>throttle</code>æ¥åè°ƒstreamçš„é€Ÿç‡(æ¯1ç§’é’Ÿï¼Œä¼ è¾“ä¸€ä¸ªå…ƒç´ )ï¼Œä»¥æ­¤ä¿è¯ï¼Œå³ä½¿æ˜¯ç™¾ä¸‡çº§ä»¥ä¸Šçš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šå‡ºç°JVMå†…å­˜æº¢å‡ºçš„æƒ…å†µã€‚è¿™é‡Œçš„<code>throttle</code>åœ¨Akka Streamsè¢«ç§°ä½œ combinatorsâ€”â€”åè°ƒå™¨ï¼ŒAkka Streamsä¸­æ‰€æœ‰ combinators éƒ½éµå¾ªback-pressureè®¾è®¡å®ç°ã€‚</p>
<h2 id="Reactive-Tweets"><a class="header-anchor" href="#Reactive-Tweets">Â¶</a>Reactive Tweets</h2>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå¯¹éç»“æ„åŒ–æ•°æ®çš„å¤„ç†</p>
<p>é¦–å…ˆå®šä¹‰æˆ‘ä»¬çš„case class</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">handle: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtag</span>(<span class="params">name: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Tweet</span>(<span class="params">author: <span class="type">Author</span>, timestamp: <span class="type">Long</span>, body: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hashtags</span></span>: <span class="type">Set</span>[<span class="type">Hashtag</span>] =</span><br><span class="line">    body.split(<span class="string">&quot; &quot;</span>).collect &#123; <span class="keyword">case</span> t <span class="keyword">if</span> t.startsWith(<span class="string">&quot;#&quot;</span>) =&gt; <span class="type">Hashtag</span>(t) &#125;.toSet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> akkaTag = <span class="type">Hashtag</span>(<span class="string">&quot;#akka&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>å¼•å…¥éšå¼è¿è¡Œå˜é‡</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">&quot;reactive-tweets&quot;</span>)</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º<code>Source</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tweets: <span class="type">Source</span>[<span class="type">Tweet</span>, <span class="type">NotUsed</span>]</span><br></pre></td></tr></table></figure>
<p>é‡ç”¨<code>Source</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> authors: <span class="type">Source</span>[<span class="type">Author</span>, <span class="type">NotUsed</span>] =</span><br><span class="line">  tweets</span><br><span class="line">    .filter(_.hashtags.contains(akkaTag))</span><br><span class="line">    .map(_.author)</span><br></pre></td></tr></table></figure>
<p>ç‰©åŒ–(materializer)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authors.runWith(<span class="type">Sink</span>.foreach(println))</span><br></pre></td></tr></table></figure>
<h2 id="Flowå¤„ç†"><a class="header-anchor" href="#Flowå¤„ç†">Â¶</a>Flowå¤„ç†</h2>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> count: <span class="type">Flow</span>[<span class="type">Tweet</span>, <span class="type">Int</span>, <span class="type">NotUsed</span>] = <span class="type">Flow</span>[<span class="type">Tweet</span>].map(_ =&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sumSink: <span class="type">Sink</span>[<span class="type">Int</span>, <span class="type">Future</span>[<span class="type">Int</span>]] = <span class="type">Sink</span>.fold[<span class="type">Int</span>, <span class="type">Int</span>](<span class="number">0</span>)(_ + _)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> counterGraph: <span class="type">RunnableGraph</span>[<span class="type">Future</span>[<span class="type">Int</span>]] =</span><br><span class="line">  tweets</span><br><span class="line">    .via(count)</span><br><span class="line">    .toMat(sumSink)(<span class="type">Keep</span>.right)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sum: <span class="type">Future</span>[<span class="type">Int</span>] = counterGraph.run()</span><br><span class="line"></span><br><span class="line">sum.foreach(c =&gt; println(<span class="string">s&quot;Total tweets processed: <span class="subst">$c</span>&quot;</span>))</span><br></pre></td></tr></table></figure>
</div></article><nav class="article-nav"><div class="article-nav-prev">ğŸ”™<a href="/2017/07/26/linux/gentoo/gentoo-install-guide/">Gentoo å¿«é€Ÿå®‰è£…</a></div><div class="article-nav-next">ğŸ”œ<a href="/2017/05/24/akka/streaming/akka-reactive-streams/">Akka Reactive Streams</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2017/05/26/akka/streaming/akka-streams-learning/';
var disqus_title = 'Akka Streamingå­¦ä¹ ';
var disqus_url = 'https://galudisu.info/2017/05/26/akka/streaming/akka-streams-learning/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>