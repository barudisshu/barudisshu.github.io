<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>Akka Streaming学习</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/maths/">Maths</a></li><li class="menu-item"><a class="menu-link" href="/projects/">Projects</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/maths/">Maths</a></li><li class="menu-item"><a class="menu-link" href="/projects/">Projects</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">Akka Streaming学习</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2017-05-26</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/akka-streaming/">akka-streaming</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/akka/">akka</a></p></div><div class="article-content"><p>时至今日，我们从因特尔上消遣服务包含许多流媒体数据(streaming data)，包括下载、上传、点对点的数据传送。把数据整体看做是一个元素集合的流(a stream of elements)，对我们计算机发送和接收这些数据起了很大帮助，因为数据变得越来越庞大，以“流”的方式处理数据显得很有必要。</p>
<p>Actors看起来也可以处理“流”：它们顺序地接收一系列消息，并对消息进行传输。但我们发现，在actor之间要实现一个stable streaming，会显得冗余乏味(tedious)和易出错(error-prone)，因为在处理发送(sending)和接收(receiving)时，我们还需要担心buffer溢出或邮箱溢出问题。另外一个陷阱(pitfall)是，Actor的消息会丢失，对丢失的消息要进行转发，以免stream一直停留在receiving的那一方。当处理完streams，Actor不能担保不会有连接(wiring)错误的出现。</p>
<span id="more"></span>
<p>基于这些原因，Akka Stream API便被提出。目的是提供一个直观的、安全的方式来**定制(formulate)**流处理，使我们在资源限制使用的情况(即控制内存溢出的情况)下高效处理。那么如何实现？akka stream实现了一个有 “back-pressure” 的特性，它来源于 <a target="_blank" rel="noopener" href="http://reactive-streams.org/">Reactive Streams</a> ，akka是该规范的初始成员。</p>
<p>Reactive Streams规范实现只有4个接口：</p>
<p>Publisher</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Publisher</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; s)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Subscriber</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscriber</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Subscription s)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Subscription</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscription</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Processor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T, R&gt; <span class="keyword">extends</span> <span class="title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该协议的主要目标是实现 <code>back-pressure</code>、<code>async</code>、<code>non-blocking boundaries and interoperability</code>。</p>
<ul>
<li><code>back-pressure</code>：反作用力，具体实现细节为，<code>Publisher</code>实现了一个<code>subscribe</code>方法，意思是，Publisher发布者拥有对Subscriber订阅的功能，所以Publisher本身也是个Subscriber，只是它仅能对唯一一个对象进行订阅——Subscriber。反作用力体现在，<code>Publisher</code>可以由该方法，得知<code>Subscriber</code>的订阅能力，由此控制“订阅”的“速度”，不会超出“发布”的速度很多，以此控制避免内存溢出等问题。</li>
<li><code>async</code>：异步。可以看到这4个接口的方法都没有返回值，所以这些方法实现以非阻塞方式控制，实现对流的异步操作处理。</li>
<li><code>non-blocking</code>：非阻塞。<code>Subscriber</code>除了<code>onSubscribe</code>外，包含有<code>onNext</code>方法，当一个Element处理完成(异步方式)，调用<code>onNext</code>方法，处理下一个Element，不会阻塞整个操作(出现异常或错误，具体看代码实现细节，akka stream对错误处理为supervision strategy方式，删除出错的element，继续处理下一个onNext，参考kafka设计)。</li>
</ul>
<h2 id="快速开始"><a class="header-anchor" href="#快速开始">¶</a>快速开始</h2>
<ul>
<li>Source: something with exactly one output stream</li>
<li>Sink: something with exactly one input stream</li>
<li>Flow: something with exactly one input and one output stream</li>
<li>BidiFlow: something with exactly two input streams and two output streams that conceptually behave like two Flows of opposite direction</li>
<li>Graph: a packaged stream processing topology that exposes a certain set of input and output ports, characterized by an object of type Shape.</li>
</ul>
<p>一个stream通常以一个source开始，我们需要引入相应的包</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akka.stream._</span><br><span class="line"><span class="keyword">import</span> akka.stream.scaladsl._</span><br></pre></td></tr></table></figure>
<p>另外还需引入常用的执行关联包</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akka.&#123; <span class="type">NotUsed</span>, <span class="type">Done</span> &#125;</span><br><span class="line"><span class="keyword">import</span> akka.actor.<span class="type">ActorSystem</span></span><br><span class="line"><span class="keyword">import</span> akka.util.<span class="type">ByteString</span></span><br><span class="line"><span class="keyword">import</span> scala.concurrent._</span><br><span class="line"><span class="keyword">import</span> scala.concurrent.duration._</span><br><span class="line"><span class="keyword">import</span> java.nio.file.<span class="type">Paths</span></span><br></pre></td></tr></table></figure>
<p>以及Main方法</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Code here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个最简单的<code>Source</code>，包含1 to 100整数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> source: <span class="type">Source</span>[<span class="type">Int</span>, <span class="type">NotUsed</span>] = <span class="type">Source</span>(<span class="number">1</span> to <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>其中<code>Source</code>参数化两个类型：第一个是<code>Int</code>为该source 发射元素的类型，第二个为运行该source可能产生的 <code>辅助值(auxiliary value)</code>(如网络source会得到端口号或地址)，由<code>Sources</code>和<code>Sinks</code>运行后产生的auxiliary value，术语上被称作<code>materialized value</code>。不产生辅助信息时，用<code>akka.NotUsed</code>表示——这里例子的整型肯定不会产生辅助信息。</p>
<p>创建了source，我们便可以发射这100个自然数，但<code>Source</code>没有激活。因此我们需要执行：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source.runForeach(i =&gt; println(i))(materializer)</span><br></pre></td></tr></table></figure>
<p>这行执行在一个consumer 函数完成——以包含“run”的方法名执行；包含其它类似的方法。</p>
<p>在App执行该代码时，程序并没有终止退出，因为<code>ActorSystem</code>没有终止。<code>runForeach</code>返回一个<code>Future[Done]</code>表示stream完成</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> done: <span class="type">Future</span>[<span class="type">Done</span>] = source.runForeach(i =&gt; println(i))(materializer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> ec = system.dispatcher</span><br><span class="line">done.onComplete(_ =&gt; system.terminate())</span><br></pre></td></tr></table></figure>
<p>我们想知道<code>materializer</code>表示什么。首先我们要创建一个Actor system</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">&quot;QuickStart&quot;</span>)</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br></pre></td></tr></table></figure>
<p>你也可以通过<code>ActorContext</code>来创建。<code>Materializer</code>是stream执行引擎的一个工厂，它使得streams可以执行——你现在不需要了解它的更多细节，仅需要知道你可以调用<code>Source</code>的<code>run*</code>方法。物化(materializer)实际上就是将<code>Source</code>、<code>Sink</code>、<code>Flow</code>构建起来的蓝图(blueprint)提供可执行实现。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> factorials = source.scan(<span class="type">BigInt</span>(<span class="number">1</span>))((acc, next) =&gt; acc * next)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> result: <span class="type">Future</span>[<span class="type">IOResult</span>] =</span><br><span class="line">  factorials</span><br><span class="line">    .map(num =&gt; <span class="type">ByteString</span>(<span class="string">s&quot;<span class="subst">$num</span>\n&quot;</span>))</span><br><span class="line">    .runWith(<span class="type">FileIO</span>.toPath(<span class="type">Paths</span>.get(<span class="string">&quot;factorials.txt&quot;</span>)))</span><br></pre></td></tr></table></figure>
<p>我们要时刻记住，<code>Source</code>内部实际上不会进行任何计算处理，它仅仅是一个描述(description)，当 run* 方法是计算它内部描述的内容。</p>
<p>在Akka Streams的术语中<code>Source</code>表示整个stream的输入，<code>Sink</code>表示整个stream的输出。在Akka Stream结构中，<code>Source</code>仅有一个output channel不包含input channel，<code>Sink</code>则刚好相反，包含一个input channel，不包含output channel。</p>
<p>下面是另外一个参考例子：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> akka.<span class="type">NotUsed</span></span><br><span class="line"><span class="keyword">import</span> akka.actor.<span class="type">ActorSystem</span></span><br><span class="line"><span class="keyword">import</span> akka.stream.<span class="type">ActorMaterializer</span></span><br><span class="line"><span class="keyword">import</span> akka.stream.scaladsl._</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">handle: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtag</span>(<span class="params">name: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Tweet</span>(<span class="params">author: <span class="type">Author</span>, timestamp: <span class="type">Long</span>, body: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hashtags</span></span>: <span class="type">Set</span>[<span class="type">Hashtag</span>] =</span><br><span class="line">    body.split(<span class="string">&quot; &quot;</span>).collect &#123; <span class="keyword">case</span> t <span class="keyword">if</span> t.startsWith(<span class="string">&quot;#&quot;</span>) =&gt; <span class="type">Hashtag</span>(t) &#125;.toSet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> akkaTag = <span class="type">Hashtag</span>(<span class="string">&quot;#akka&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> tweets: <span class="type">Source</span>[<span class="type">Tweet</span>, <span class="type">NotUsed</span>] = <span class="type">Source</span>(</span><br><span class="line">  <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;rolandkuhn&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka rocks!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;patriknw&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;bantonsson&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;drewhk&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;ktosopl&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka on the rocks!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;mmartynas&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;wow #akka !&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;akkateam&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#akka rocks!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;bananaman&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#bananas rock!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;appleman&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;#apples rock!&quot;</span>) ::</span><br><span class="line">    <span class="type">Tweet</span>(<span class="type">Author</span>(<span class="string">&quot;drama&quot;</span>), <span class="type">System</span>.currentTimeMillis, <span class="string">&quot;we compared #apples to #oranges!&quot;</span>) ::</span><br><span class="line">    <span class="type">Nil</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">&quot;reactive-tweets&quot;</span>)</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br><span class="line"></span><br><span class="line">  tweets</span><br><span class="line">    .filterNot(_.hashtags.contains(akkaTag))</span><br><span class="line">    .mapConcat(_.hashtags)</span><br><span class="line">    .map(_.name.toUpperCase)</span><br><span class="line">    .runWith(<span class="type">Sink</span>.foreach(println))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $FiddleDependency org.akka-js %%% akkajsactorstream % 1.2.5.1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="片段重用"><a class="header-anchor" href="#片段重用">¶</a>片段重用</h2>
<p>Akka Streams中所有模块都可以实现resuable，例如</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lineSink</span></span>(filename: <span class="type">String</span>): <span class="type">Sink</span>[<span class="type">String</span>, <span class="type">Future</span>[<span class="type">IOResult</span>]] =</span><br><span class="line">  <span class="type">Flow</span>[<span class="type">String</span>]</span><br><span class="line">    .map(s =&gt; <span class="type">ByteString</span>(s + <span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    .toMat(<span class="type">FileIO</span>.toPath(<span class="type">Paths</span>.get(filename)))(<span class="type">Keep</span>.right)</span><br></pre></td></tr></table></figure>
<p>链接<code>Source</code>和<code>Flow</code>后得到的auxiliary information就是“materialized value”，我们可以直接将新创建的<code>Sink</code>贴到我们的<code>factorials</code> source上</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">factorials.map(_.toString).runWith(lineSink(<span class="string">&quot;factorial2.txt&quot;</span>))</span><br></pre></td></tr></table></figure>
<h2 id="基于时间处理"><a class="header-anchor" href="#基于时间处理">¶</a>基于时间处理</h2>
<p>现在我们通过zip实现将两个source转换为一个stream</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">factorials</span><br><span class="line">  .zipWith(<span class="type">Source</span>(<span class="number">0</span> to <span class="number">100</span>))((num, idx) =&gt; <span class="string">s&quot;<span class="subst">$idx</span>! = <span class="subst">$num</span>&quot;</span>)</span><br><span class="line">  .throttle(<span class="number">1</span>, <span class="number">1.</span>second, <span class="number">1</span>, <span class="type">ThrottleMode</span>.shaping)</span><br><span class="line">  .runForeach(println)</span><br></pre></td></tr></table></figure>
<p>这段代码依赖于时间执行，我们使用<code>throttle</code>来协调stream的速率(每1秒钟，传输一个元素)，以此保证，即使是百万级以上的数据，也不会出现JVM内存溢出的情况。这里的<code>throttle</code>在Akka Streams被称作 combinators——协调器，Akka Streams中所有 combinators 都遵循back-pressure设计实现。</p>
<h2 id="Reactive-Tweets"><a class="header-anchor" href="#Reactive-Tweets">¶</a>Reactive Tweets</h2>
<p>下面是一个例子，对非结构化数据的处理</p>
<p>首先定义我们的case class</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">handle: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtag</span>(<span class="params">name: <span class="type">String</span></span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Tweet</span>(<span class="params">author: <span class="type">Author</span>, timestamp: <span class="type">Long</span>, body: <span class="type">String</span></span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">hashtags</span></span>: <span class="type">Set</span>[<span class="type">Hashtag</span>] =</span><br><span class="line">    body.split(<span class="string">&quot; &quot;</span>).collect &#123; <span class="keyword">case</span> t <span class="keyword">if</span> t.startsWith(<span class="string">&quot;#&quot;</span>) =&gt; <span class="type">Hashtag</span>(t) &#125;.toSet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> akkaTag = <span class="type">Hashtag</span>(<span class="string">&quot;#akka&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>引入隐式运行变量</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">&quot;reactive-tweets&quot;</span>)</span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> materializer = <span class="type">ActorMaterializer</span>()</span><br></pre></td></tr></table></figure>
<p>创建<code>Source</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tweets: <span class="type">Source</span>[<span class="type">Tweet</span>, <span class="type">NotUsed</span>]</span><br></pre></td></tr></table></figure>
<p>重用<code>Source</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> authors: <span class="type">Source</span>[<span class="type">Author</span>, <span class="type">NotUsed</span>] =</span><br><span class="line">  tweets</span><br><span class="line">    .filter(_.hashtags.contains(akkaTag))</span><br><span class="line">    .map(_.author)</span><br></pre></td></tr></table></figure>
<p>物化(materializer)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authors.runWith(<span class="type">Sink</span>.foreach(println))</span><br></pre></td></tr></table></figure>
<h2 id="Flow处理"><a class="header-anchor" href="#Flow处理">¶</a>Flow处理</h2>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> count: <span class="type">Flow</span>[<span class="type">Tweet</span>, <span class="type">Int</span>, <span class="type">NotUsed</span>] = <span class="type">Flow</span>[<span class="type">Tweet</span>].map(_ =&gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sumSink: <span class="type">Sink</span>[<span class="type">Int</span>, <span class="type">Future</span>[<span class="type">Int</span>]] = <span class="type">Sink</span>.fold[<span class="type">Int</span>, <span class="type">Int</span>](<span class="number">0</span>)(_ + _)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> counterGraph: <span class="type">RunnableGraph</span>[<span class="type">Future</span>[<span class="type">Int</span>]] =</span><br><span class="line">  tweets</span><br><span class="line">    .via(count)</span><br><span class="line">    .toMat(sumSink)(<span class="type">Keep</span>.right)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sum: <span class="type">Future</span>[<span class="type">Int</span>] = counterGraph.run()</span><br><span class="line"></span><br><span class="line">sum.foreach(c =&gt; println(<span class="string">s&quot;Total tweets processed: <span class="subst">$c</span>&quot;</span>))</span><br></pre></td></tr></table></figure>
</div></article><nav class="article-nav"><div class="article-nav-prev"><a href="/2017/07/26/linux/gentoo/gentoo-install-guide/">Gentoo 快速安装</a></div><div class="article-nav-next"><a href="/2017/05/24/akka/streaming/akka-reactive-streams/">Akka Reactive Streams</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2017/05/26/akka/streaming/akka-streams-learning/';
var disqus_title = 'Akka Streaming学习';
var disqus_url = 'https://galudisu.info/2017/05/26/akka/streaming/akka-streams-learning/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>