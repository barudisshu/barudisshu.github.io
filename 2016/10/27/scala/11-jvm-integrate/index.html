<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>第十一章：Scala和Java相互集成</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">第十一章：Scala和Java相互集成</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2016-10-27</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/scala/">scala</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/learning/">learning</a></p></div><div class="article-content"><h4 id="主要内容："><a class="header-anchor" href="#主要内容：">¶</a>主要内容：</h4>
<ol>
<li>Scala中使用Java</li>
<li>使用Java泛型和集合</li>
<li>集成问题</li>
<li>使用Java框架构建Web应用</li>
</ol>
<p>最激动人心的事情是，Scala可以运行在JVM上。这带来的好处是你可以使用构建在JVM语言上的所有框架和工具。基于JVM，更有一些公司甚至不使用Java作为他们的首选编程语言。对于大多数企业软件项目，我坚信不支持JVM的语言，几乎不可能实现。</p>
<p>Scala的一个主要设计目的，是令其运行在JVM上，并提供对Java的相互协作。Scala被编译为Java字节码，所以你可以使用如javap(Java class file disassembler)工具，对有Scala编译器生成的字节码进行反编译。大部分情况下，Scala的特性被转换为Java的特性，因此Scala可以轻松和Java集成。例如，Scala使用类型擦除来兼容Java。类型擦除<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> (Type erasure)也允许Scala对JVM的动态类型进行集成。一些Scala特性(如traits)，不会直接地映射为Java，在这种情况下，你需要灵活变通地使用。</p>
<p>虽然对Java的大部分集成都可轻松实现，我仍然更推荐你使用 pure Scala。我尝试查找两者之间某些等价的部分，以及Scala不能实现的，则使用Java来解决。使用Java库的不好的方面是，你必须处理可变性、异常、空值这些Scala中绝对不会出现的问题。在Scala中，需要特别小心地选择Java的库或者框架。以一个编码良好的Java库<a target="_blank" rel="noopener" href="http://joda-time.sourceforge.net">Joda-Time</a>为例。</p>
<p>Scala和Java最通常的集成，是指部分项目由Scala编写的。小节11.4将介绍Scala中使用Java框架，Hibernate、Spring等的web项目构建。</p>
<span id="more"></span>
<p>多数情况下，Scala和Java之间的集成是无缝的，但也需要注意某些例外。本章的目的是讲述，如何轻松地在Scala和Java之间进行集成，以及练习避免集成问题。Java类和框架的集成，尽管本书没有阐述，相信你已经很好地处理，但这里，你面临是两个语言的集成问题，并吸收接纳彼此的优势。</p>
<p>在一个已有的Java项目中阐述Scala，最好的方式是在其中编写Scala代码，并证明其超越Java语言的优势，并逐渐把Java部分，重写为Scala。这种过渡的工作会出现多次。</p>
<p>让我们开始本章中两个语言间的集成例子。你会学习到，解决处理那些在Java中可用，在Scala中不可用的特性问题，如Java的static静态成员、exceptions异常处理，以及Scala的特性在Java中怎样解决处理。你也将会学习Scala的注解在集成中的帮助，例如，生成JavaBean-style的get和set。本章的最后，将带领你学习构建一个使用Java框架的web应用。</p>
<h3 id="11-1〖Using-Java-classes-in-Scala〗P324"><a class="header-anchor" href="#11-1〖Using-Java-classes-in-Scala〗P324">¶</a>11~1〖Using Java classes in Scala〗P324</h3>
<p>在Java中集成Scala是很容易的。因为在Java中使用日期总是一个痛苦的过程，下面Java代码片段使用了Joda-Time库，用于计算两个日期之间的天数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.joda.time.Chronology;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.DateTime;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.Days;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">daysBetween</span><span class="params">(Date start, Date end)</span> &#123;</span><br><span class="line">        <span class="type">Days</span> <span class="variable">d</span> <span class="operator">=</span> Days.daysBetween(<span class="keyword">new</span> <span class="title class_">DateTime</span>(start.getTime()), <span class="keyword">new</span> <span class="title class_">DateTime</span>(end.getTime()));</span><br><span class="line">        <span class="keyword">return</span> d.getDays();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Chronology <span class="title function_">getChronologyUsed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DateTime.now().getChronology();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在SBT项目中，要将上述代码保存到src/main/java/chap11/java文件夹。SBT能够识别跨编译的Java代码和Scala代码。要在Scala中使用这个类，继承这个类：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentCalculator</span>(<span class="params">val payPerDay: <span class="type">Int</span> = 100</span>) <span class="keyword">extends</span> <span class="title">DateCalculator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">calculatePayment</span></span>(start: <span class="type">Date</span>, end: <span class="type">Date</span>) = &#123;</span><br><span class="line">    daysBetween(start, end) * payPerDay</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了daysBetween方法进行计算。该集成是无缝的，你不会发现有什么不同。</p>
<blockquote><h4 id="Compiling-Java-and-Scala-together"><a class="header-anchor" href="#Compiling-Java-and-Scala-together">¶</a>Compiling Java and Scala together</h4>
<p>SBT知道如何构建混有Scala和Java的项目。Scala编译器允许你同时构建Java类和Java源代码。这样，如果你有Java和Scala间的双向依赖，你可以同时构建它们，而不用担心顺序问题。</p>
<p>当然，你也可以在Maven工具中构建混有Java和Scala的项目。要这样做，你应该在Maven中添加额外的Scala插件。在本章的最后，你将会使用Maven来构建一个示例项目。</p>
</blockquote>
<p>下小节，你会学习在Scala中如何使用Java的static成员。</p>
<h3 id="1111〖Working-with-Java-static-members〗P325"><a class="header-anchor" href="#1111〖Working-with-Java-static-members〗P325">¶</a>11<sub>1</sub>1〖Working with Java static members〗P325</h3>
<p>当使用声明了static成员的Java类是，你需要理解它们在Scala中是如何解析的。</p>
<p>Scala没有任何静态关键字，Scal解析Java的静态成员方法时，把它们认为是一个伴生对象的方法。看看下面的例子是如何工作的。代码中添加一个静态方法，返回Chronology：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.joda.time.Chronology;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.DateTime;</span><br><span class="line"><span class="keyword">import</span> org.joda.time.Days;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">daysBetween</span><span class="params">(Date start, Date end)</span> &#123;</span><br><span class="line">        <span class="type">Days</span> <span class="variable">d</span> <span class="operator">=</span> Days.daysBetween(<span class="keyword">new</span> <span class="title class_">DateTime</span>(start.getTime()), <span class="keyword">new</span> <span class="title class_">DateTime</span>(end.getTime()));</span><br><span class="line">        <span class="keyword">return</span> d.getDays();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Chronology <span class="title function_">getChronologyUsed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DateTime.now().getChronology();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要访问这个静态成员，你需要引用它，并定义在一个伴生对象中，如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaymentCalculator</span>(<span class="params">val payPerDay: <span class="type">Int</span> = 100</span>) <span class="keyword">extends</span> <span class="title">DateCalculator</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">chronologyUsed</span> </span>= <span class="type">DateCalculator</span>.getChronologyUsed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，通过定义在DateCalculator访问一个伴生对象，对静态方法访问。</p>
<blockquote><h4 id="Visibility-issues-between-Scala-and-Java"><a class="header-anchor" href="#Visibility-issues-between-Scala-and-Java">¶</a>Visibility issues between Scala and Java</h4>
<p>Scala和Java间的可见性实现不同。</p>
<p>Scala在编译期强制可见性，但在运行期所有都是public的。这样做的一个原因是：在Scala中，伴生对象被允许访问伴生类的protected成员，但在字节层面，如果不另所有为public，则不能对其编码(encode)。</p>
<p>Java则在编译和运行期都强制可见性规则。这会带来一些例外。例如，如果你有一个定义在Java类的protected静态成员，在Scala中则没有任何方式对其访问。唯一变通的方法，是转换为一个public成员，以对其访问。</p>
</blockquote>
<p>接下来，将看到如何处理Java的异常检查，因为Scala没有这些东西。</p>
<h3 id="1112〖Working-with-Java-checked-exceptions〗P326"><a class="header-anchor" href="#1112〖Working-with-Java-checked-exceptions〗P326">¶</a>11<sub>1</sub>2〖Working with Java checked exceptions〗P326</h3>
<p>Scala缺少异常检测，Java基础代码每次编译时执行异常检测，这会带来不少疑惑。在Scala中你调用下面Java方法，你不需要在try/catch块中封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeToFile</span><span class="params">(String content)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;tmoFile&quot;</span>, <span class="string">&quot;.tmp&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">FileWriter</span>(f).write(content);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Scala，你可以不需要try/catch块调用这个方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">def write(content: String) = &#123;</span></span><br><span class="line">  | val w = new Writer</span><br><span class="line">  | w.writeToFile(content)</span><br><span class="line">  | &#125;</span><br><span class="line">write: (content: String)Unit</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">write(<span class="string">&quot;This is a test&quot;</span>)</span></span><br></pre></td></tr></table></figure>
<p>作为一个编程人员，你的职责是决定是否需要捕获异常。Scala编译器不会强迫要求你这样做。这里，当你需要捕获异常时，不要从Scala中抛出异常。这是一个不好的习惯。最好的方式是创建一个<code>Either</code> 或  <code>Option</code>类型的实例。下面代码片段调用了<code>writeToFile</code>方法，并返回<code>Either[Exception,Boolean]</code>的一个实例：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span></span>(content: <span class="type">String</span>): <span class="type">Either</span>[<span class="type">Exception</span>, <span class="type">Boolean</span>] = &#123;</span><br><span class="line">  <span class="keyword">val</span> w = <span class="keyword">new</span> <span class="type">Writer</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    w.writeToFile(content)</span><br><span class="line">    <span class="type">Right</span>(<span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> e: java.io.<span class="type">IOException</span> =&gt; <span class="type">Left</span>(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的好处是，你可以组合这些结果。要永远记住，异常不应该进行组合。但有些时候，你需要抛出一个异常，因为某些框架或客户端代码期望异常的抛出，这种情况，你可以使用Scala的注解来生成抛出异常的字节码(小节11.2.1有更多这方面内容)。现在，让我们转到Java的泛型上面来。应理解Java泛型如何工作的，因为它们在Java集合中用到。</p>
<h3 id="1113〖Working-with-Java-generics-using-existential-types〗P327"><a class="header-anchor" href="#1113〖Working-with-Java-generics-using-existential-types〗P327">¶</a>11<sub>1</sub>3〖Working with Java generics using existential types〗P327</h3>
<p>Java泛型直接转换为Scala的类型参数。例如 <code>Comparator&lt;T&gt;</code> 转换为 <code>Comparamot[T]</code>，<code>ArrayList&lt;T&gt;</code> 转换为 <code>ArrayList[T]</code>。但类以通配符方式定义在Java中，会变得有趣。下面是两个Java集合带通配符类型的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vector&lt;?&gt; names = <span class="keyword">new</span> <span class="title class_">Vector</span>&lt;?&gt;()</span><br><span class="line"><span class="type">List</span> <span class="variable">numbers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>()</span><br></pre></td></tr></table></figure>
<p>这两种情况，类型参数都是未知的。像这些在Scala中称作原生类型(raw types)，以及已有的类型让你处理这些原生类型。<code>Vector&lt;?&gt;</code> 在Scala中可以表示为 <code>Vector[T] forSome &#123;type T&#125;</code>。从左到右读取，这个类型表达式代表的是一个类型为 <code>T</code> 的向量。这个 <code>T</code> 类型未知，它可以表示为任何东西。但 <code>T</code> 固定为向量的某些类型。</p>
<p>让我们看看如何在Scala中使用Java的原生类型。下面创建了一个带通配类型的Java向量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaRawType</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Vector&lt;?&gt; languages() &#123;</span><br><span class="line">    <span class="type">Vector</span> <span class="variable">languages</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();</span><br><span class="line">	languages.add(<span class="string">&quot;Scala&quot;</span>);</span><br><span class="line">	languages.add(<span class="string">&quot;Java&quot;</span>);</span><br><span class="line">	languages.add(<span class="string">&quot;Haskell&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> languages;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JavaRawType.languages</code>返回一个向量，但用通配符 <code>?</code> 表示。要在Scala中使用这个language 方法，你需要使用已有的类型。类型声明为 <code>Vector[T] forSome &#123; type T&#125;</code>，如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Vector</span> =&gt; <span class="type">JVector</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printLanguages</span></span>[<span class="type">C</span> &lt;: <span class="type">JVector</span>[<span class="type">T</span>] <span class="keyword">forSome</span> &#123; <span class="class"><span class="keyword">type</span> <span class="title">T</span>&#125;](<span class="params">langs: <span class="type">C</span></span>)</span>:<span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">for</span>(i &lt;- <span class="number">0</span> until langs.size) println(langs.get(i))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类型C的上边界为存在类型集合，并打印所有Java向量元素。</p>
<p>有一种占位符的语法<code>JVector[_]</code>。它和 <code>JVector[T] forSome &#123;type T&#125;</code>是同一个意思。因此，上述代码等价地表示为：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printLanguages</span></span>[<span class="type">C</span> &lt;: <span class="type">JVector</span>[_]](langs: <span class="type">C</span>):<span class="type">Unit</span> = &#123;</span><br><span class="line">	<span class="keyword">for</span>(i &lt;- <span class="number">0</span> until langs.size) println(langs.get(i))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><h4 id="Working-with-Java-collections"><a class="header-anchor" href="#Working-with-Java-collections">¶</a>Working with Java collections</h4>
<p>一旦你习惯了Scala强大的集合库，在Scala中使用Java集合库会变得痛苦。理想情况下，在Scala代码中使用Scala集合，并等价转换为Java代码，反之亦然。这样，你既可以使用强大的Scala集合库，在需要的使用便可轻松集成到Java基础代码中。Scala库为此提供了两个工具类用于转换：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala.collection.<span class="type">JavaConversions</span></span><br><span class="line">scala.collection.<span class="type">JavaConverters</span></span><br></pre></td></tr></table></figure>
<p>这两个类都提供了同样的特性，但实现方式不同。JavaConversions提供了一系列的隐式转换，来对Java集合和Scala集合的近似转换。JavaConverters使用了一个 “Pimp my Library” 模式对Java集合添加了asScala方法、对Scala则添加了asJava方法。我推荐使用JavaConverters，因为它是显式的转换。下面例子使用了JavaConverters将java.util.List转换为Scala，然后再转换为Java：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">import java.util.&#123;ArrayList =&gt; JList &#125;</span></span><br><span class="line">import java.util.&#123;ArrayList =&gt; JList&#125;</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">val jList = new JList[Int]()</span></span><br><span class="line">jList: java.util.ArrayList[Int] = []</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">jList.add(1)</span></span><br><span class="line">res1: Boolean = true</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">jList.add(2)</span></span><br><span class="line">res2: Boolean = true</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">import scala.collection.JavaConverters._</span></span><br><span class="line">import scala.collection.JavaConverters._</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">jList.asScala foreach println</span></span><br></pre></td></tr></table></figure>
<p>作用在jList的asScala方法，将java.util.ArrayList转换为scala.collection.mutable.Buffer，这样你可以调用foreach方法。下面为将scala的List转换为java.util.List：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">List(1, 2).asJava</span></span><br><span class="line">res4: java.util.List[Int] = [1, 2]</span><br></pre></td></tr></table></figure></blockquote>
<h3 id="11-2〖Using-Scala-classes-in-Java〗P329"><a class="header-anchor" href="#11-2〖Using-Scala-classes-in-Java〗P329">¶</a>11~2〖Using Scala classes in Java〗P329</h3>
<p>Scala语言最有趣的特性之一是特质(traits)，基础代码中被大量用到。如果你定义一个特质仅带有抽象方法，它可以编译得到Java接口，并直接在Java中使用，而不会带来任何问题。但如果这个特质带有具体的方法，则会有些微妙。让我们以一个例子来看看，这种情况下是如何编译成Java字节码的。</p>
<p>下面是一个Scala特质，它以混入的方式将对象持久化到数据库中：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Persistable</span>[<span class="type">T</span>] </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getEntity</span></span>: <span class="type">T</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">save</span></span>(): <span class="type">T</span> = &#123;</span><br><span class="line">    persistToDb(getEntity)</span><br><span class="line">    getEntity</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">persistToDb</span></span>(t: <span class="type">T</span>) = &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里带有一个抽象方法getEntity和两个具体方法，save和persistToDb。当这段代码被编译时，Scala编译器会生成两个类文件，<code>Persistable.class</code>和<code>Persistable$class</code>。要检验每个类文件的内容，你可以使用SBT控制台 <code>:javap</code> 选项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">:javap chap11.scala.Persistable</span></span><br><span class="line">Compiled from &quot;ScalaJavaMash.scala&quot;</span><br><span class="line">public interface chap11.scala.Persistable extends scala.ScalaObject&#123;</span><br><span class="line">	public abstract java.lang.Object getEntity();</span><br><span class="line">	public abstract java.lang.Object save();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">:javap chap11.scala.Persistable<span class="variable">$class</span></span></span><br><span class="line">Compiled from &quot;ScalaJavaMash.scala&quot;</span><br><span class="line">public abstract class chap11.scala.Persistable$class extends</span><br><span class="line">  java.lang.Object&#123;</span><br><span class="line">	public static java.lang.Object save(chap11.scala.Persistable);</span><br><span class="line">	public static void $init$(chap11.scala.Persistable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件 Persistable.class 表示Java接口，包含所有定义在Persistable特质的公共方法，以及继承了scala.ScalaObject。Scala中所有用户定义的类都继承了scala.ScalaObject。另一方面，Persistable$class文件定义了一个抽象类，该抽象类定义特质中所有的具体方法。可以把这个抽象类认为是一个门面，作用在trait定义的所有具体方法。</p>
<p>在Java中，你将继承这个接口，并使用抽象类作为一个门面来访问特质中的具体方法。下面示例中Account实现了Persistable接口，并使用Persistable$class的静态方法，来访问Persistable特质的具体方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> <span class="keyword">implements</span> <span class="title class_">Persistable</span>&lt;Account&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">getEntity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Account <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (Account) Persistable$class.save(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Persistable接口的实现是直接的。 getEntity返回Account对象的一个实例，save方法代表Persistable$class类中的静态方法save，来访问trait的实现定义。注意当使用层叠的特质时，创建一个具体的Scala类，然后在Java中直接使用或继承会更好些。</p>
<p>当集成Scala和Java框架，第一个障碍是Scala类没有JavaBean-style的 get 和 set 方法。Scala注解提供了这样的灵活性，来指定让Scala编译器生成字节码。</p>
<h3 id="1121〖Using-Scala-annotations〗P331"><a class="header-anchor" href="#1121〖Using-Scala-annotations〗P331">¶</a>11<sub>2</sub>1〖Using Scala annotations〗P331</h3>
<p>Scala不遵循标准的Java getter和  setter 模式。在Scala中，getters 和 setters看起来不一样。例如，要创建一个Scala-style的getter和setter的Scala类，你需要做的是将成员声明为var，如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalaBean</span>(<span class="params">var name: <span class="type">String</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>当被编译，该类生成下面字节码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">:javap chap11.scala.ScalaBean</span></span><br><span class="line">Compiled from &quot;ScalaJavaMash.scala&quot;</span><br><span class="line">public class chap11.scala.ScalaBean extends java.lang.Object</span><br><span class="line">  implements scala.ScalaObject&#123;</span><br><span class="line">	public java.lang.String name();</span><br><span class="line">	public void name_$eq(java.lang.String);</span><br><span class="line">	public chap11.scala.ScalaBean(java.lang.String);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比较下面代码，便会说得通：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">val s = new chap11.scala.ScalaBean(<span class="string">&quot;Nima&quot;</span>)</span></span><br><span class="line">s: chap11.scala.ScalaBean = chap11.scala.ScalaBean@6cd4be25</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">s.name</span></span><br><span class="line">res0: String = Nima</span><br><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">s.name = <span class="string">&quot;Paul&quot;</span></span></span><br><span class="line">s.name: String = Paul</span><br></pre></td></tr></table></figure>
<p>如果你添加 scala.beans.BeanProperty注解到一个属性中，Scala编译器会生成相应的get 和 set方法。例如这里的name，便会生成getName 和 setName 方法：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalaBean</span>(<span class="params">@scala.beans.<span class="type">BeanProperty</span> var name: <span class="type">String</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>使用javap检视，则有：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">:javap chap11.scala.ScalaBean</span></span><br><span class="line">Compiled from &quot;ScalaJavaMash.scala&quot;</span><br><span class="line">public class chap11.scala.ScalaBean extends java.lang.Object implements</span><br><span class="line">  scala.ScalaObject&#123;</span><br><span class="line">	public java.lang.String name();</span><br><span class="line">	public void name_$eq(java.lang.String);</span><br><span class="line">	public void setName(java.lang.String);</span><br><span class="line">	public java.lang.String getName();</span><br><span class="line">	public chap11.scala.ScalaBean(java.lang.String);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用BeanProperty注解，Scala编译器会同时生成Scala和Java风格的get和set方法。使用BeanProperty的确会增加生成class文件的大小，但对于和Java协作性方面是个很小的代价。现在，如果你想要生成JavaBean-compliant BeanInfo，你可以使用scala.beans.BeanInfo。</p>
<p>小节11.1展示了Scala不对异常检测作处理，因为Scala没有throws关键字来声明方法抛出异常。问题来了。例如，你想要使用Scala来声明一个java.rmi.Remote接口，你困惑的是Remote中每个声明的方法都需要抛出RemoteException。再一次，使用注解，你可以指明Scala编译器生成方法的throws。下面代码定义一个个RMI接口：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">RemoteLogger</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">rmi</span>.<span class="title">Remote</span> </span>&#123;</span><br><span class="line">  <span class="meta">@throws</span>(classOf[java.rmi.<span class="type">RemoteException</span>])</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">log</span></span>(m: <span class="type">String</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>特质RemoteLogger继承了标准java.rmi.Remote，标记该接口为一个RMI远程接口；要生成throws捕获，只需要使用Scala标准库中定义的scala.throws注解。查阅生成的字节码，你将看到 throws 从句：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">scala&gt; </span><span class="language-bash">:javap chap11.scala.RemoteLogger</span></span><br><span class="line">Compiled from &quot;ScalaJavaMash.scala&quot;</span><br><span class="line">public interface chap11.scala.RemoteLogger extends java.rmi.Remote&#123;</span><br><span class="line">  public abstract void log(java.lang.String) throws</span><br><span class="line">	java.rmi.RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你也可以使用Scala的目标元注解的方式，来控制注解的位置，例如下面代码 @Id注解会仅添加到Bean getter的 getX上面：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.persistence.<span class="type">Id</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; @(<span class="type">Id</span> <span class="meta">@beanGetter</span>) <span class="meta">@BeanProperty</span> <span class="keyword">val</span> x = <span class="number">0</span> &#125;</span><br></pre></td></tr></table></figure>
<p>否则，默认地，字段上的注解最终在字段上面。这个很重要，因为当你处理某些Java框架时，有些特别要求注解的定义。下个小节将看到目标注解的一些用法，以及如何在Scala中使用流行框架，如Spring、Hibernate。</p>
<h3 id="11-3〖Building-web-applications-in-Scala-using-Java-frameworks〗P332"><a class="header-anchor" href="#11-3〖Building-web-applications-in-Scala-using-Java-frameworks〗P332">¶</a>11~3〖Building web applications in Scala using Java frameworks〗P332</h3>
<p>本章介绍使用Scala和Java框架构建一个web应用。这个例子将展示在Java-heavy环境中使用Scala，当吸收或迁移到Scala，你不必丢弃你在Java框架上的投入和基础。显然，使用框架来构建Scala，某些示例代码会有出入。无碍，在没有接触任何Scala框架之前，学习Java框架同样重要。在本小节，你将构建一个web应用，使用到Spring和Hibernate框架。你将离开你最喜欢的构建工具，SBT，以及使用Maven来构建你的Java，因为它是Scala中最常用的。</p>
<p><strong>注意</strong> 本小节要求你已经掌握了Spring、Hibernate以及Maven构建工具来构建Java Web应用。如果没有，这会很难跟上。保守起见，如果你对Java框架不感兴趣，也可以跳过该小节。</p>
<p>在此之前，让我们理清你将构建一个怎样的应用。你将构建一个i额小的web应用，叫做topArtists，用于展示来自Last.fm的艺术家。Last.fm是一个流行的音乐网站，可以通过收音机频道进入访问。Last.fm同时也提供了一个API，通过该API可以获得各种各样的音乐排行榜。你将使用它的chart.getTopArtists的REST API来获取所有当前的艺术家，并保存到本地数据库中。你也将从本地数据库中展示所有的艺术家数据给用户。</p>
<p><strong>注意</strong> 你首先要做的是获得一个来自Last.fm的API key。你可以从Last.fm的 <a href="www.last.fm/api/authentication">网站</a>获得。</p>
<p>如果你做过Java开发，你可能最经常使用的是Maven。Maven知道如何编译Java源文件，但要编译Scala文件，你需要添加Maven的Scala插件<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>。要使用Maven创建一个空白web应用，执行下面命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DgroupId=scala.in.action -DartifactId=top.artists -DarchetypeArtifactId=maven-archetype-webapp</span><br></pre></td></tr></table></figure>
<p>该项目的结构，实质上和SBT项目是一样的(SBT 遵循Maven的约定)。创建了pom.xml文件后，便可以配置所有的依赖。</p>
<p>对于topArtists应用，你将使用Spring来构建web层，并作为依赖注入框架。Hibernate则作为ORM层，应用保存所有artists到数据库中。作为练手，你将使用数据库HSQLDB。但要作REST请求，你将使用纯的Scala库 dispatch<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>。 Dispatch是一个Scala库，构建在Async Http Client库上，使得它易于作web services<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>。</p>
<h3 id="1131〖Building-the-model-view-and-controller〗P334"><a class="header-anchor" href="#1131〖Building-the-model-view-and-controller〗P334">¶</a>11<sub>3</sub>1〖Building the model, view, and controller〗P334</h3>
<p>该topArtists应用展示了来自Last.fm的REST API。要看从Last.fm接收的信息，在任何浏览器窗口调用下面的URL：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ws.audioscrobbler.com/2.0/?method=chart.gettopartists&amp;api_key=&lt;your api key&gt;</span><br></pre></td></tr></table></figure>
<p>但前提先确保你在 <a target="_blank" rel="noopener" href="http://Last.fm">Last.fm</a> 拥有API Key。如果该请求成功，你可以看到艺术家的相关信息，如名字、播放次数、听众、链接等其它属性。为了使问题简单化，我们仅取来自第一页的结果，并存储艺术家的名字、播放次数、以及听众。这个领域模型看起来如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chap11.top.artists.model</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Artist</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name: <span class="type">String</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">var</span> playCount: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> listeners: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为使用了Hibernate作为你的ORM工具，你需要使你的领域对象与Hibernate相适。首先使用@BeanProperty来生成JavaBean-style的get/set方法。再使用javax.persistence的注解标注属性。下面为完整的领域对象代码。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chap11.top.artists.model</span><br><span class="line"><span class="keyword">import</span> reflect.<span class="type">BeanProperty</span></span><br><span class="line"><span class="keyword">import</span> javax.persistence._</span><br><span class="line"><span class="keyword">import</span> scala.annotation.target.field</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Artist</span> </span>&#123;</span><br><span class="line">  @(<span class="type">Id</span> <span class="meta">@field</span>) @(<span class="type">GeneratedValue</span> <span class="meta">@field</span>) <span class="meta">@BeanProperty</span></span><br><span class="line">  <span class="keyword">var</span> id: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">  <span class="meta">@BeanProperty</span></span><br><span class="line">  <span class="keyword">var</span> name: <span class="type">String</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="meta">@BeanProperty</span></span><br><span class="line">  <span class="keyword">var</span> playCount: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">  <span class="meta">@BeanProperty</span></span><br><span class="line">  <span class="keyword">var</span> listeners: <span class="type">Long</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Artist</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(name: <span class="type">String</span>, playCount: <span class="type">Long</span>, listeners: <span class="type">Long</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> a = <span class="keyword">new</span> <span class="type">Artist</span></span><br><span class="line">    a.name = name</span><br><span class="line">    a.playCount = playCount</span><br><span class="line">    a.listeners = listeners</span><br><span class="line">    a</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>Hibernate实现了Java Persistence API (JPA)，以及使用JPA注解Entity标明Hibernate将持久化该对象到数据库中。你可以使用Id注解来标识ID字段，以及使用scala.annotation.target来生成带有Id和GeneratedValue注解的字段。</p>
<p>为了将接收的艺术家信息保存到数据库中，需要用到Hibernate的session factory。创建一个ArtistDb封装。它将隐藏Hibernate规范的详细剩余内容。该类可以作为一个数据访问对象。因为你使用了Spring，你可以轻松地必要的Hibernate依赖到新类中。下面列出ArtistDb类的完整实现。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">List</span> =&gt; <span class="type">JList</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.scala.chapter6.top_artists.model.<span class="type">Artist</span></span><br><span class="line"><span class="keyword">import</span> org.hibernate.<span class="type">SessionFactory</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.<span class="type">Autowired</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.<span class="type">Repository</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.<span class="type">Transactional</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">ArtistDb</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">findAll</span></span>: <span class="type">JList</span>[<span class="type">Artist</span>]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">save</span></span>(artist: <span class="type">Artist</span>): <span class="type">Long</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArtistRepository</span> <span class="keyword">extends</span> <span class="title">ArtistDb</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">var</span> sessionFactory: <span class="type">SessionFactory</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">save</span></span>(artist: <span class="type">Artist</span>): <span class="type">Long</span> = currentSession.save(artist).asInstanceOf[<span class="type">Long</span>]</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span>(readOnly = <span class="literal">true</span>)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">findAll</span></span>: <span class="type">JList</span>[<span class="type">Artist</span>] = currentSession.createCriteria(classOf[<span class="type">Artist</span>]).</span><br><span class="line">                               list().asInstanceOf[<span class="type">JList</span>[<span class="type">Artist</span>]]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">currentSession</span> </span>= sessionFactory.getCurrentSession</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类ArtistRepository类用Spring的原型注解Repository标识，这样Spring框架可以自动地浏览并装载。当Spring装载该类时，也设置了sessionFactory依赖。下个小节，将看到这些组件是如何配置的。现在，先假设sessionFactory在ArtistRepository是可以用的。save方法比较直接：使用当前Hibernate session，它将Artist的一个实例存储到数据库中。 <code>asInstanceOf[Long]</code>类型转换得到Long。在这里，你应该知道save操作返回对象Id。findAll方法，将查询数据库，并返回所有的artists。这里类型转换为list，Hibernate默认list方法返回一个List对象。至此，你已经可以将接收的领域对象保存到数据库中。下面来构建控制器。</p>
<p>前面讨论过，你将使用Spring来构建你的web应用层。这里，将使用Spring的原型注解@Controller来标识类为控制器。控制器的工作是获得来自Last.fm的艺术家信息，以及展示存储在本地数据库的艺术家信息。你已经有一个ArtistDb来获得来自数据库的艺术家信息，所以你可以注入一个ArtistDb的实例到控制器中：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArtistsController</span> </span>&#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">val</span> db: <span class="type">ArtistDb</span> = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在controller添加一个URL的方法映射，并返回艺术家列表到视图：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="type">Array</span>(<span class="string">&quot;/artists&quot;</span>), method = <span class="type">Array</span>(<span class="type">GET</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loadArtists</span></span>() =</span><br><span class="line">	<span class="keyword">new</span> <span class="type">ModelAndView</span>(<span class="string">&quot;artists&quot;</span>, <span class="string">&quot;topArtists&quot;</span>, db.findAll)</span><br></pre></td></tr></table></figure>
<p>@RequestMapping注解映射地址 “/artists” URI到方法loadArtists中。该方法使用db.findAll来查找来自数据库的所有艺术家。ModelAndView的第一个参数为视图渲染名称。topArtists参数为db.findAll的响应内容。使用视图里面的topArtists名称，你可以访问所有调用findAll得到的艺术家。但在获取艺术家信息之前，先要得到来自Last.fm的信息列表。即允许用户刷新艺术家信息，并保存到本地数据库中。要实现刷新，调用Last.fm的REST API。<a target="_blank" rel="noopener" href="http://xn--DispatchLast-ov8s620ozw1ai99bka1346h.fm">使用Dispatch库来调用Last.fm</a>。Dispatch提供了一个优秀的DSL或者Apache HttpClient库的转换器。下面代码片段创建一个Http请求对象：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> rootUrl = <span class="string">&quot;http://ws.audioscrobbler.com/2.0/&quot;</span></span><br><span class="line"><span class="keyword">val</span> apiMethod = <span class="string">&quot;chart.gettopartists&quot;</span></span><br><span class="line"><span class="keyword">val</span> apiKey = sys.props(<span class="string">&quot;api.key&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> req = url(rootUrl + <span class="string">&quot;?method=&quot;</span> + apiMethod + <span class="string">&quot;&amp;api_key=&quot;</span> + apiKey)</span><br></pre></td></tr></table></figure>
<p>API key来自system属性。当运行该应用，你必须指定API key为一个系统属性。url方法接收一个字符URL作为输入，并返回一个Http请求实例。但创建一个Http请求不会再作更多内容，因此要告诉Dispatch如何处理接收来自请求的响应内容。你可以通过一个具体的操作实现。这里我们使用内建的 as.xml.Elem来处理这些XHTML响应：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Http</span>(req <span class="type">OK</span> as.xml.<span class="type">Elem</span>).map &#123;resp =&gt; ...&#125;</span><br></pre></td></tr></table></figure>
<p>Http返回scala.xml.Elem的Promise(因为每个HTTP请求都是异步处理的)，我们使用map来访问Promise对象的内容。因为我们没有使用Spring的异步支持，我们需要等待Promise来完成结果渲染。来自Last.fm的响应包含一个XML，它是个web service接口：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">lfm</span> <span class="attr">status</span>=<span class="string">&quot;ok&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artists</span> <span class="attr">page</span>=<span class="string">&quot;1&quot;</span> <span class="attr">perPage</span>=<span class="string">&quot;50&quot;</span> <span class="attr">totalPages</span>=<span class="string">&quot;20&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">total</span>=<span class="string">&quot;1000&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artist</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">artist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artist</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">artist</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">artists</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">lfm</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>你可以使用Scala的本地XML解析该结果。Dispatch早已将response转换为一个NodeSeq实例，现在你可以解压这些艺术家信息，创建一个Hibernate Artist对象，并保存到数据库中。下面方法为解压操作：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">retrieveAndLoadArtists</span></span>() &#123;</span><br><span class="line">  <span class="keyword">val</span> rootUrl = <span class="string">&quot;http://ws.audioscrobbler.com/2.0/&quot;</span> </span><br><span class="line">  <span class="keyword">val</span> apiMethod = <span class="string">&quot;chart.gettopartists&quot;</span></span><br><span class="line">  <span class="keyword">val</span> apiKey = sys.props(<span class="string">&quot;api.key&quot;</span>)</span><br><span class="line">  <span class="keyword">val</span> req = url(rootUrl + <span class="string">&quot;?method=&quot;</span> + apiMethod + <span class="string">&quot;&amp;api_key=&quot;</span> + apiKey)</span><br><span class="line">  <span class="type">Http</span>(req <span class="type">OK</span> as.xml.<span class="type">Elem</span>).map &#123;resp =&gt;</span><br><span class="line">      <span class="keyword">val</span> artists = resp \\ <span class="string">&quot;artist&quot;</span></span><br><span class="line">      artists.foreach &#123;node =&gt;</span><br><span class="line">        <span class="keyword">val</span> artist = makeArtist(node)</span><br><span class="line">        println(artist.name)</span><br><span class="line">        db.save(artist)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;()  <span class="comment">//applying the promise</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">makeArtist</span></span>(n: <span class="type">Node</span>) = &#123;</span><br><span class="line">  <span class="keyword">val</span> name = (n \ <span class="string">&quot;name&quot;</span>).text</span><br><span class="line">  <span class="keyword">val</span> playCount = (n \ <span class="string">&quot;playcount&quot;</span>).text.toLong</span><br><span class="line">  <span class="keyword">val</span> listeners = (n \ <span class="string">&quot;listeners&quot;</span>).text.toLong</span><br><span class="line">  <span class="type">Artist</span>(name = name, playCount = playCount, listeners = listeners)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>controller的刷新动作需要用到retrieveAndLoad方法来装载并保存艺术家到数据库中，并展示到view。下面为该controller的完整实现：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chap11.top.artists.controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.<span class="type">Controller</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.<span class="type">Autowired</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.<span class="type">RequestMapping</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.<span class="type">RequestMethod</span>._</span><br><span class="line"><span class="keyword">import</span> chap11.top.artists.db.<span class="type">ArtistDb</span></span><br><span class="line"><span class="keyword">import</span> chap11.top.artists.model.<span class="type">Artist</span></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.<span class="type">ModelAndView</span></span><br><span class="line"><span class="keyword">import</span> dispatch._</span><br><span class="line"><span class="keyword">import</span> scala.xml.<span class="type">Node</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArtistsController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">val</span> db: <span class="type">ArtistDb</span> = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value = <span class="type">Array</span>(<span class="string">&quot;/artists&quot;</span>), method = <span class="type">Array</span>(<span class="type">GET</span>))</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">loadArtists</span></span>() =</span><br><span class="line">    <span class="keyword">new</span> <span class="type">ModelAndView</span>(<span class="string">&quot;artists&quot;</span>, <span class="string">&quot;topArtists&quot;</span>, db.findAll)  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value = <span class="type">Array</span>(<span class="string">&quot;/refresh&quot;</span>), method = <span class="type">Array</span>(<span class="type">GET</span>))  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">refresh</span></span>() = &#123;</span><br><span class="line">    retrieveAndLoadArtists()</span><br><span class="line">    <span class="keyword">new</span> <span class="type">ModelAndView</span>(<span class="string">&quot;artists&quot;</span>, <span class="string">&quot;topArtists&quot;</span>, db.findAll) </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">retrieveAndLoadArtists</span></span>() &#123;</span><br><span class="line">    <span class="keyword">val</span> rootUrl = <span class="string">&quot;http://ws.audioscrobbler.com/2.0/&quot;</span> </span><br><span class="line">    <span class="keyword">val</span> apiMethod = <span class="string">&quot;chart.gettopartists&quot;</span></span><br><span class="line">    <span class="keyword">val</span> apiKey = sys.props(<span class="string">&quot;api.key&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> req = url(rootUrl + <span class="string">&quot;?method=&quot;</span> + apiMethod + <span class="string">&quot;&amp;api_key=&quot;</span> + apiKey)</span><br><span class="line">    <span class="type">Http</span>(req <span class="type">OK</span> as.xml.<span class="type">Elem</span>).map &#123;resp =&gt;</span><br><span class="line">        <span class="keyword">val</span> artists = resp \\ <span class="string">&quot;artist&quot;</span></span><br><span class="line">        artists.foreach &#123;node =&gt;</span><br><span class="line">          <span class="keyword">val</span> artist = makeArtist(node)</span><br><span class="line">          println(artist.name)</span><br><span class="line">          db.save(artist)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;()  <span class="comment">//applying the promise</span></span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">makeArtist</span></span>(n: <span class="type">Node</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> name = (n \ <span class="string">&quot;name&quot;</span>).text</span><br><span class="line">    <span class="keyword">val</span> playCount = (n \ <span class="string">&quot;playcount&quot;</span>).text.toLong</span><br><span class="line">    <span class="keyword">val</span> listeners = (n \ <span class="string">&quot;listeners&quot;</span>).text.toLong</span><br><span class="line">    <span class="type">Artist</span>(name = name, playCount = playCount, listeners = listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在已经有了model和controller，现在切换到view上。这个简单的视图接收来自controller的响应内容，并使用JSP渲染。该视图使用单纯的Java处理，但你完全可以使用有Java编写的模版库，如<a target="_blank" rel="noopener" href="http://scalate.fusesource.org">Scalate</a>。你的JSP视图会接收topArtists参数，并迭代渲染响应内容。下面为该视图代码清单：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> contentType=<span class="string">&quot;text/html;charset=utf-8&quot;</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">&quot;c&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/core&quot;</span>%&gt;</span><br><span class="line">&lt;%@ taglib uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/functions&quot;</span> prefix=<span class="string">&quot;fn&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;Top Artists from Last.fm&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"> &lt;p&gt;</span><br><span class="line">   &lt;a href=<span class="string">&quot;&lt;c:url value=&quot;</span>/refresh.html<span class="string">&quot;/&gt;&quot;</span>&gt;Refresh from Last.fm&lt;/a&gt;</span><br><span class="line"> &lt;/p&gt;</span><br><span class="line">&lt;h2&gt;Top artists&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">  &lt;c:<span class="keyword">if</span> test=<span class="string">&quot;$&#123;fn:length(topArtists) == 0&#125;&quot;</span>&gt;</span><br><span class="line">    &lt;h3&gt;No artists found in database. Refresh from Last.fm&lt;/h3&gt;</span><br><span class="line">  &lt;/c:<span class="keyword">if</span>&gt;</span><br><span class="line">  &lt;table&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">      &lt;th&gt;Name&lt;/th&gt;</span><br><span class="line">      &lt;th&gt;Play count&lt;/th&gt;</span><br><span class="line">      &lt;th&gt;Listeners&lt;/th&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">    &lt;c:forEach items=<span class="string">&quot;$&#123;topArtists&#125;&quot;</span> <span class="keyword">var</span>=<span class="string">&quot;artist&quot;</span>&gt;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;$&#123;artist.name&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;$&#123;artist.playCount&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;$&#123;artist.listeners&#125;&lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/c:forEach&gt;</span><br><span class="line">  &lt;/table&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>你使用topArtists来访问artists列表，并展示。下个小节你将集成Spring配置文件的所以片段。</p>
<h3 id="1132〖Configuring-and-running-the-application〗P340"><a class="header-anchor" href="#1132〖Configuring-and-running-the-application〗P340">¶</a>11<sub>3</sub>2〖Configuring and running the application〗P340</h3>
<p>你会用到Spring的配置来配置Spring MVC和 Hibernate。这样Spring会确保所有需要的依赖被合适得初始化并注入。因为你遵循Spring配置层上的约定，在配置Scala类上，完全没问题。这在Scala和Java互操作上优越是明显的。下面为spring-context-data.xml文件，它应用配置模型和控制器对象。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;chap11.top.artists.db&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.hsqldb.jdbcDriver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:hsqldb:mem:scala-spring-hibernate&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sa&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;annotatedClasses&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>chap11.top.artists.model.Artist<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hibernateProperties&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;hibernate.dialect&quot;</span>&gt;</span>org.hibernate.dialect.HSQLDialect<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;hibernate.show_sql&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;hibernate.hbm2ddl.auto&quot;</span>&gt;</span>create<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>该文件中，你配置了Hibernate方言为HSQLDB。以及使用Spring组件浏览方式来查找ArtistDb，以此初始化Hibernate的必要依赖项。接下来为spring-context-web.xml文件，它配置了控制器以及HTTP请求拦截。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;chap11.top.artists.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;viewResolver&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.UrlBasedViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;viewClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;openSessionInViewInterceptor&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.springframework.orm.hibernate3.support.OpenSessionInViewInterceptor&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sessionFactory&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sessionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;interceptors&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span><span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;openSessionInViewInterceptor&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接下来为web.xml配置文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">id</span>=<span class="string">&quot;scala-spring-hibernate&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;2.5&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/spring-context-data.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/spring-context-web.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.html<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>所有的Java web容易读取web.xml来初始化Java-based web应用。监听器listener属性允许应用监听由容器生成的事件，例如一个应用被加载或没被加载。这里，监听器的配置是ContextLoaderListener，该类通过读取context-param，知道如何配置Spring。要运行应用，你可以使用早以配置的jetty服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -Dapi.key=&lt;your-last.fm-pai-key&gt; jetty:run</span><br></pre></td></tr></table></figure>
<p>正如你所看，使用Scala和Java框架，建立并创建web应用是容易的。当使用Java框架是，某些样板配置是不可避免的，但你让然可以编写有趣的Scala代码。</p>
<h3 id="11-4〖Summary〗P343"><a class="header-anchor" href="#11-4〖Summary〗P343">¶</a>11~4〖Summary〗P343</h3>
<p>本章所阐述的是，Scala对Java的互操作是无痛的(pain-free)。很少地方你需要做防护措施，但对于大部分你都可以不用顾虑太多地集成已有的Java基础代码。额外要小心的，则是集成某些Scala特性，在Java中并不支持，反之亦然。在本章介绍了如何处理这种问题。因为Scala被设计来自渐渐成长的Java，大多数变通的地方都可以简单地学习和实现。</p>
<p>简单集成Java，意味着你可以容易地在已有代码中使用Scala。在最后的一个例子中证明了，你可以使用Scala和已有的流行的Java框架进行集成，而不用重写整个应用。</p>
<p>下个章节将进入到最激动人心的Scala框架：Akka。该框架让你使用丰富的并发模型来构建大型的、可伸缩的、分布式的应用。</p>
<div id="footnotes"><hr><div id="footnotelist"><ol><li id="fn:1">Java Tutorials: Type erasure, <a target="_blank" rel="noopener" href="http://download.oracle.com/javase/tutorial/java/generics/erasure.html">http://download.oracle.com/javase/tutorial/java/generics/erasure.html</a>.<a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2">Maven Scala plug-in download, <a target="_blank" rel="noopener" href="http://scala-tools.org/mvnsites/maven-scala-plugin/">http://scala-tools.org/mvnsites/maven-scala-plugin/</a>.<a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3">Dispatch Scala library: <a target="_blank" rel="noopener" href="http://dispatch.databinder.net/Dispatch.html">http://dispatch.databinder.net/Dispatch.html</a>.<a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4">See “AsyncHttpClient/async-http-client,” <a target="_blank" rel="noopener" href="https:/github.com/AsyncHttpClient/async-http-client">https:/github.com/AsyncHttpClient/async-http-client</a>.<a href="#fnref:4" rev="footnote"> ↩</a></li></ol></div></div></div></article><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2016/10/27/scala/11-jvm-integrate/';
var disqus_title = '第十一章：Scala和Java相互集成';
var disqus_url = 'https://galudisu.info/2016/10/27/scala/11-jvm-integrate/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>