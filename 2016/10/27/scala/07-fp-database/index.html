<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>第七章：连接到数据库</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">第七章：连接到数据库</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2016-10-27</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/scala/">scala</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/learning/">learning</a></p></div><div class="article-content"><h4 id="主要内容："><a class="header-anchor" href="#主要内容：">¶</a>主要内容：</h4>
<ol>
<li>SBT构建数据库。</li>
<li>webKanban中，通过Squeryl连接数据库。</li>
<li>完善weKanban。</li>
</ol>
<p>第六章，我们学习了如何使用SBT(Simple Build Tool)和Scalaz HTTP模组构建一个简单的Web应用。但这个应用在前面章节中未算竣工。原因是：构建一个函数式的Kanban应用，你的应用需要存储信息，即存储到持久化环境中。</p>
<p><strong>注意</strong> 本章是第六章的延续，如果你未曾读过上一章节，一些本章节的相关部分很难跟进。</p>
<p>本章将完成上一个章节未完成的部分。你将学习如何检索数据并存储到关系型数据中。我将介绍一个Scala ORM(Object Relational Mapping)工具——Squeryl。并将探索如何安全地模拟数据字典。你将构建一个应用存储，以及在Kanban面板上展示该存储数据。在此过程中，你将探索Scala中如何与数据库工作。尽管本章关注于数据库方面的内容，也会介绍到Scalaz和SBT在数据库方面的使用。在构建应用之前，让我们回顾一下我们所需要实现weKanban应用的用户故事：</p>
<p>As a customer I want to create a new user story so that I can add stories to the ready phase.<br>
As a developer I want to move cards (stories) from one phase to another to signal progress.</p>
<p>下面开始构建基于用户故事的weKanban应用。</p>
<span id="more"></span>
<h3 id="7-1〖Adding-a-new-story-to-a-weKanban-board〗P194"><a class="header-anchor" href="#7-1〖Adding-a-new-story-to-a-weKanban-board〗P194">¶</a>7~1〖Adding a new story to a weKanban board〗P194</h3>
<p>首先要做的是在面板中添加案例，如果不添加根本做不了任何事情。添加案例意味着你需要担心持久化存储。企业开发者使用关系型数据库将信息存储到表中，这里建议使用开源的Java数据库 <a target="_blank" rel="noopener" href="http://www.h2database.com/html/main.html">H2</a>。实际上，你还可以自由地选取下面的数据库：<code>Postgres</code>、<code>Oracle</code>、<code>MySQL</code>，<code>DB2</code> 。这里之所以列出这几个数据库的原因是，你所使用的ORM库Squeryl，仅支持这几种数据。</p>
<p><strong>注意</strong> 使用诸如MongoDB这种模式自由的数据库，在这里有些许争议，这里希望专注于一个事务型的关系型数据库的解决方案，以及展示Scala是如何在关系型数据库管理系统(RDBMS)中工作。你也可以自由地尝试其它类型的数据库。</p>
<h3 id="711〖Connecting-to-a-database-using-Squeryl〗P194"><a class="header-anchor" href="#711〖Connecting-to-a-database-using-Squeryl〗P194">¶</a>7<sub>1</sub>1〖Connecting to a database using Squeryl〗P194</h3>
<p>那么，为什么使用Squeryl来访问数据库？首先是它在Scala社区内非常流行，以及它提供了一个良好的、简单的DSL对接数据库。尽管直接在Scala中使用JDBC也未尝不可，使用Squeryl，你则直接学习了一整个ORM工具。Scala强大的类型系统正很好地用来创建一个类型安全的ORM工具。这里鼓励你使用其它的Scala ORM，如ScalaQuery<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>、Querulous<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>作为选择。</p>
<p>现在，Squeryl和H2作为weKanban的项目依赖，添加到构建文件中，如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">name := <span class="string">&quot;weKanban&quot;</span></span><br><span class="line">organization := <span class="string">&quot;scalainaction&quot;</span></span><br><span class="line">version := <span class="string">&quot;0.2&quot;</span></span><br><span class="line">scalaVersion := <span class="string">&quot;2.10.0&quot;</span></span><br><span class="line">scalacOptions ++= <span class="type">Seq</span>(<span class="string">&quot;-unchecked&quot;</span>, <span class="string">&quot;-deprecation&quot;</span>)</span><br><span class="line">libraryDependencies ++= <span class="type">Seq</span>(</span><br><span class="line">  <span class="string">&quot;org.scalaz&quot;</span> %% <span class="string">&quot;scalaz-core&quot;</span> % <span class="string">&quot;6.0.3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.scalaz&quot;</span> %% <span class="string">&quot;scalaz-http&quot;</span> % <span class="string">&quot;6.0.3&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.eclipse.jetty&quot;</span> % <span class="string">&quot;jetty-servlet&quot;</span> % <span class="string">&quot;7.3.0.v20110203&quot;</span> % <span class="string">&quot;container&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.eclipse.jetty&quot;</span> % <span class="string">&quot;jetty-webapp&quot;</span> % <span class="string">&quot;7.3.0.v20110203&quot;</span> % <span class="string">&quot;test,container&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.eclipse.jetty&quot;</span> % <span class="string">&quot;jetty-server&quot;</span> % <span class="string">&quot;7.3.0.v20110203&quot;</span> % <span class="string">&quot;container&quot;</span>,</span><br><span class="line">  <span class="string">&quot;com.h2database&quot;</span> % <span class="string">&quot;h2&quot;</span> % <span class="string">&quot;1.2.137&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.squeryl&quot;</span> % <span class="string">&quot;squeryl_2.10&quot;</span> % <span class="string">&quot;0.9.5-6&quot;</span></span><br><span class="line">)</span><br><span class="line">seq(com.github.siasia.<span class="type">WebPlugin</span>.webSettings :_*)</span><br></pre></td></tr></table></figure>
<p>现在，你要做的是update构建依赖。对于weKanban项目，面板案例应该有三个属性：唯一标识，标题描述，以及案例段落。下面你如何构建的案例类：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Story</span>(<span class="params">val number: <span class="type">String</span>, val title: <span class="type">String</span>, val phase:<span class="type">String</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>要使该类在Squeryl下工作，你还必须进行大量的设置。首先，你需要告诉Squeryl你需要一个table存储所有这些story。Squeryl中的实现是，创建org.squeryl.Schema的子类。该类等效地看作是数据库的schema，下面代码定义了一个schema表为&quot;STORIES&quot;的Story类：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kanban.models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.squeryl._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KanbanSchema</span> <span class="keyword">extends</span> <span class="title">Schema</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> stories = table[<span class="type">Story</span>](<span class="string">&quot;STORIES&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将该文件保存为KanbanSchema.scala，置于src/main/scala/com/kanban/models。这里要注意的是我定义了一个类型安全的管理器。stories表示数据库表&quot;STORIES&quot;，你可以对stories执行各种各样的查询，而不用担心story类型对象的返回问题。</p>
<p><strong>注意</strong> 大多数ORM工具使用了各种内建配置文件来指定数据库的schema和domain model映射信息。因为Scala是一个DSL友好的表达式语言，Scala工具通常都使用Scala语言本身作为配置。目前所看到的SBT、Squeryl就是个以Scala语言为DSL的明显的例子。下一次，你想你应该需要一个内置配置、属性文件，以及如何用Scala语言表述这些配置信息。</p>
<p>下一步，为Squeryl配置使用H2数据库。在连接数据库之前，首先有确保H2数据库服务已经运行。开启H2数据库服务很简单，你需要把h2.jar文件添加到路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ~/.ivy2/cache/com.h2database/h2/jars/h2*.jar org.h2.tools.Server</span><br></pre></td></tr></table></figure>
<p>这看起来很丑陋，因为你需要在本地存储ivy中运行你的依赖。如果可以想Jetty那样运行H2数据库就好了，不幸的是，SBT内建(built-in)不支持H2，所以你要为H2数据库创建tasks。一个好消息是，SBT构建tasks是十分容易的，所以，我们需要修改build.scala文件。SBT提供了大量的辅助方法来构建自定义tasks，但这里的tasks由方法实现。代码清单如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sbt._</span><br><span class="line"><span class="keyword">import</span> <span class="type">Keys</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">H2TaskManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> process: <span class="type">Option</span>[<span class="type">Process</span>] = <span class="type">None</span></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> <span class="type">H2</span> = config(<span class="string">&quot;h2&quot;</span>) extend <span class="type">Compile</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> startH2 = <span class="type">TaskKey</span>[<span class="type">Unit</span>](<span class="string">&quot;start&quot;</span>,<span class="string">&quot;Starts H2 database&quot;</span>)</span><br><span class="line">  <span class="keyword">val</span> startH2Task = startH2 in <span class="type">H2</span> &lt;&lt;= (fullClasspath in <span class="type">Compile</span>) map &#123;</span><br><span class="line">    cp =&gt;</span><br><span class="line">      startDatabase &#123;</span><br><span class="line">        cp.map(_.data)</span><br><span class="line">        .map(_.getAbsolutePath())</span><br><span class="line">        .filter(_.contains(<span class="string">&quot;h2database&quot;</span>))</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">startDatabase</span></span>(paths: <span class="type">Seq</span>[<span class="type">String</span>]) = &#123;</span><br><span class="line">    process <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">        <span class="keyword">val</span> cp = paths.mkString(<span class="type">System</span>.getProperty(<span class="string">&quot;path.separator&quot;</span>))</span><br><span class="line">        <span class="keyword">val</span> command = <span class="string">&quot;java -cp &quot;</span> + cp + <span class="string">&quot; org.h2.tools.Server&quot;</span></span><br><span class="line">        println(<span class="string">&quot;Starting Database with command: &quot;</span> + command)</span><br><span class="line">        process = <span class="type">Some</span>(<span class="type">Process</span>(command).run())</span><br><span class="line">        println(<span class="string">&quot;Database started ! &quot;</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Some</span>(_) =&gt;</span><br><span class="line">        println(<span class="string">&quot;H2 Database already started&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> stopH2 = <span class="type">TaskKey</span>[<span class="type">Unit</span>](<span class="string">&quot;stop&quot;</span>, <span class="string">&quot;Stops H2 database&quot;</span>)</span><br><span class="line">  <span class="keyword">val</span> stopH2Task = stopH2 in <span class="type">H2</span> :=&#123;</span><br><span class="line">    process <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">None</span> =&gt; println(<span class="string">&quot;Database already stopped&quot;</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Some</span>(_) =&gt;</span><br><span class="line">        println(<span class="string">&quot;Stopping database...&quot;</span>)</span><br><span class="line">        process.foreach&#123;_.destroy()&#125;</span><br><span class="line">        process = <span class="type">None</span></span><br><span class="line">        println(<span class="string">&quot;Database stopped...&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MainBuild</span> <span class="keyword">extends</span> <span class="title">Build</span> </span>&#123;</span><br><span class="line"><span class="keyword">import</span> <span class="type">H2TaskManager</span>._</span><br><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> scalazVersion = <span class="string">&quot;6.0.3&quot;</span></span><br><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> jettyVersion = <span class="string">&quot;7.3.0.v20110203&quot;</span></span><br><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> wekanban = <span class="type">Project</span>(</span><br><span class="line">  <span class="string">&quot;wekanban&quot;</span>,</span><br><span class="line">  file(<span class="string">&quot;.&quot;</span>)).settings(startH2Task, stopH2Task)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的build.scala文件做了两件事。一是，定义了项目的<code>name</code>，<code>locations</code>，<code>settings</code>。项目工程的settings通过继承Build获得默认值，并添加两个新任务：<code>startH2Task</code>和<code>stopH2Task</code>。这两个任务现在作为项目settings的一部分，并可以用开启和停止H2数据库。</p>
<p>二是，scalazVersion和jettyVersion被声明为<code>lazy val</code>。这个好处是，你不用在build.sbt文件中重复声明多次：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">libraryDependencies ++= <span class="type">Seq</span>(</span><br><span class="line">  <span class="string">&quot;org.scalaz&quot;</span> %% <span class="string">&quot;scalaz-core&quot;</span> % scalazVersion,</span><br><span class="line">  <span class="string">&quot;org.scalaz&quot;</span> %% <span class="string">&quot;scalaz-http&quot;</span> % scalazVersion,</span><br><span class="line">  <span class="string">&quot;org.eclipse.jetty&quot;</span> % <span class="string">&quot;jetty-servlet&quot;</span> % jettyVersion % <span class="string">&quot;container&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.eclipse.jetty&quot;</span> % <span class="string">&quot;jetty-webapp&quot;</span> % jettyVersion % <span class="string">&quot;test, container&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.eclipse.jetty&quot;</span> % <span class="string">&quot;jetty-server&quot;</span> % jettyVersion % <span class="string">&quot;container&quot;</span>,</span><br><span class="line">  <span class="string">&quot;com.h2database&quot;</span> % <span class="string">&quot;h2&quot;</span> % <span class="string">&quot;1.2.137&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org.squeryl&quot;</span> % <span class="string">&quot;squeryl_2.10&quot;</span> % <span class="string">&quot;0.9.5-6&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>是的，你可以共享build.scala的settings和vals到build.sbt文件。事实上，常规做法是，build.scala通常用于声明，build.sbt则使用其声明内容用于构建。最好，所有settings由多个文件组合成为一个settings队列中。</p>
<p>重载构建定义之后，你可以看到两个新的tasks，<strong>h2:start</strong> 和 <strong>h2:stop</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">h2:st</span></span><br><span class="line">start stop</span><br></pre></td></tr></table></figure>
<blockquote><h4 id="How-h2-start-and-h2-stop-tasks-are-implemented"><a class="header-anchor" href="#How-h2-start-and-h2-stop-tasks-are-implemented">¶</a>How h2:start and h2:stop tasks are implemented</h4>
<p>在SBT中创建一个新的任务是简单的：创建一个TaskKey，委派一个闭包实现这个task。因为你需要和其它自定义tasks和内建tasks做的更贴切，为H2任务创建一个新的范围：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> <span class="type">H2</span> = config(<span class="string">&quot;h2&quot;</span>) extend (<span class="type">Compile</span>)</span><br></pre></td></tr></table></figure>
<p>这里创建一个新的配置&quot;h2&quot;，继承自Compile。Compile配置会提供必需的classpath设置setting。新的配置&quot;h2&quot;创建了一个新的范围，即Compile，以及&quot;h2&quot;在该范围起作用。</p>
<p>任务startH2通过startDatabase方法实现。该方法要求一个指向H2数据库 .jar文件的路径序列。因为&quot;h2&quot;配置继承了Compile，你可以使用来自于Compile的settings键fullClasspath接入到classpath中。方法<code>&lt;==</code>则帮助创建一个新setting，该setting依赖于其它settings。下面代码片段中，将Compile 范围的fullCpasspath映射到新的任务中，并创建一个新的函数，该函数将在该任务开启是被执行：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> startH2Task = startH2 in <span class="type">H2</span> &lt;&lt;= (fullClasspath in <span class="type">Compile</span>) map &#123;</span><br><span class="line">cp =&gt;</span><br><span class="line">  startDatabase &#123;</span><br><span class="line">    cp.map(_.data)</span><br><span class="line">    .map(_.getAbsolutePath())</span><br><span class="line">    .filter(_.contains(<span class="string">&quot;h2database&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法startDatabase存储了进程对象的引用，这样可以在<code>stopDatabase</code>方法中使用。<code>stopDatabase</code>和<code>h2:stop</code>任务相关联。</p>
</blockquote>
<p>这会帮助你不用离开舒适的SBT控制台，就可以在使用H2进行工作。当你执行<code>h2:start</code>，它会自动在端口为8082上开启H2数据库，并在默认浏览器上开启H2登录视窗，如图Figure 7.1。</p>
<p><img src="/img/scala-in-action/chapter7/Figure_7_1.png" alt="The H2 Console"></p>
<p>(如果浏览器没有打开，需要直接在浏览器输入 <a target="_blank" rel="noopener" href="http://localhost:8082">http://localhost:8082</a> )因为H2服务已经在运行，我们专注于Squeryl连接到该服务的处理上。要连接到H2服务，使用下面的Driver和URL：</p>
<ul>
<li>[x] JDBC Driver class: org.h2.Driver</li>
<li>[x] Database URL: jdbc:h2:tcp://localhost/~/test</li>
<li>[x] User name: sa</li>
</ul>
<p>更多有关这方面的信息，请参考 <a href="www.h2database.com/html/quickstart.html">www.h2database.com/html/quickstart.html</a>。下面列出一个init方法，该方法用于连接 H2 数据库。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kanban.models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.<span class="type">DriverManager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.squeryl.<span class="type">PrimitiveTypeMode</span>._</span><br><span class="line"><span class="keyword">import</span> org.squeryl._</span><br><span class="line"><span class="keyword">import</span> org.squeryl.adapters._</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @author Barudisshu</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KanbanSchema</span> <span class="keyword">extends</span> <span class="title">Schema</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> stories = table[<span class="type">Story</span>](<span class="string">&quot;STORIES&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span></span>() = &#123;</span><br><span class="line">    <span class="type">Class</span>.forName(<span class="string">&quot;org.h2.Driver&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">SessionFactory</span>.concreteFactory.isEmpty) &#123;</span><br><span class="line">      <span class="type">SessionFactory</span>.concreteFactory = <span class="type">Some</span>(() =&gt;</span><br><span class="line">        <span class="type">Session</span>.create(<span class="type">DriverManager</span>.getConnection(<span class="string">&quot;jdbc:h2:tcp://localhost/~/test&quot;</span>, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="type">H2Adapter</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>KanbanSchema表示weKanban应用数据库schema定义。第一件事要做的是，把Story DOM用方法table定义的STORIES进行映射。</p>
<p>方法init为与正在运行的H2数据库进行连接。在该方法中，<code>import org.squeryl.SessionFactory。SessionFactory</code>类似于数据库连接工厂，它用于创建新的连接。下一步，用<code>Class.forName(&quot;org.h2.Driver&quot;)</code>载入H2 jdbc驱动。该驱动在创建一个新的连接时使用。</p>
<p>在Squeryl创建一个新的连接，意味着创建一个新的Session。这种方式和Java流行ORM框架Hibernate很相似，即把连接封装为Session。把Squeryl的session看作为一个基于数据库的连接转换器，该连接可以控制数据库的事务。其中Squeryl 的 session实例提供了额外的方法如log，这些方法用于绑定/解绑session到当前线程。注意，Session将这些数据库连接保存到一个ThreadLocal<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>变量中，这样，每个线程都可以获取到它自己的连接。这在web应用中的好处是，可以有多个用户在任何节点访问应用。</p>
<p>在Squeryl中，创建一个新的session机制是需要定义一个concreteFactory变量，它定义在SessionFactory对象中。默认地，该值为<code>None</code>。如果不为<code>None</code>，则说明它已经被初始化。Squeryl要求concreteFactory作为一个函数用于创建新的sessions。下面为该函数的使用：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">() =&gt;</span><br><span class="line">    <span class="type">Session</span>.create(<span class="type">DriverManager</span>.getConnection(<span class="string">&quot;jdbc:h2:tcp://localhost/~/test&quot;</span>, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="type">H2Adapter</span>))</span><br></pre></td></tr></table></figure>
<p>这里真正被调用的方法，是Session对象里面的create方法，由传递一个数据库连接和一个适配器adapter执行。其中，Java DriverManager接收URL、用户名和密码。Squeryl提供的适配器用于它所支持的数据库类型，这里的适配器为H2Adapter，表示数据库为H2的连接。因为concreteFactory的类型是<code>Option[()=&gt;Session]</code>，你需要用Option值Some进行转换。</p>
<p>因为你定义了stories对象来表示&quot;STORIES&quot;表，它不会在数据库中创建表。某些情况下你可能会用SQL脚本来创建数据库表结构，但这里你可以使用Squeryl来创建这些Schema。添加一个main方法入口，如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>])&#123;</span><br><span class="line">    println(<span class="string">&quot;initializing the weKanban schema&quot;</span>)</span><br><span class="line">    init</span><br><span class="line">    inTransaction &#123;drop;crete&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义在Squeryl的方法inTransaction在数据库事务中执行并关闭。这里表示drop所有的表，并重新创建。现在，唯一定义的表是&quot;STORIES&quot;，你可以在SBT控制台下运行这个main方法，它将在数据库中创建一个新的Schema。在运行main之前，请确保H2数据库服务正在运行。下面继续讲解如何将数据存储到数据库上。</p>
<h3 id="712〖Saving-a-new-story-to-the-database〗P200"><a class="header-anchor" href="#712〖Saving-a-new-story-to-the-database〗P200">¶</a>7<sub>1</sub>2〖Saving a new story to the database〗P200</h3>
<p>要通过Squeryl向数据库插入一条新的记录，你需要调用定义在org.squeryl.Table类里面的方法insert，该方法接收一个model实例，并存储到数据库中。Schema中已经定义了执行数据库表的&quot;STORIES&quot;。你现在需要创建一个传递给insert方法的实例Story，该实例代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Story</span>(<span class="params">val number: <span class="type">String</span>, val title: <span class="type">String</span>, val phase: <span class="type">String</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>在将Story实例存储到数据库之前，你需要为其添加验证。例如，Story的两个属性<code>number</code> 和 <code>title</code> 都不能为空，以及<code>number</code>是唯一标识的，下面为该验证的实现：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidationException</span>(<span class="params">message: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">RuntimeException</span>(<span class="params">message</span>)</span></span><br><span class="line"><span class="keyword">private</span>[<span class="keyword">this</span>] <span class="function"><span class="keyword">def</span> <span class="title">validate</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">if</span>(number.isEmpty || title.isEmpty) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidateException</span>(<span class="string">&quot;Both number and title are required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将方法validate添加到Story类中，并在save动作之前调用。这里创建了一个自定义异常ValidationException用于所有验证失败处理。</p>
<p><strong>注意</strong> 这里没有定义主键，而仅仅是把number声明为唯一键。在小应用中这样做没什么问题，但是，在真实环境中，你应该将它代替为主键。要给你的domain类添加一个自动递增的主键id，你可以继承<code>KeyedEntity[A]</code>特质，你也可以使用<code>KeyedEntity</code>来创建组合<code>keys</code>。关于更多信息内容，参考Squeryl官方文档。</p>
<p>为了检查number字段的唯一性，你需要检查&quot;STORIES&quot;表，确保没有其它记录有相同的number。Squeryl提供了一个很好的方法<code>where</code>，在表对象中，你可以很容易地实现。<code>where</code>方法接收一个断言函数，并过滤得出结果。下面是使用<code>where</code>方法来检查number的唯一性：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!stories.where(a =&gt; a.number === number).isEmpty) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span> (<span class="string">&quot;The story number is not unique&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了函数<code>a =&gt; a.number === number</code> (<code>===</code> Squeryl定义的等价操作符)，这表示你查询的结果匹配给定number。如果查询的结果为空，则给定的number不是唯一的。注意<code>where</code>方法返回一个<code>lazy iterable</code> 叫做 Query ，它定义在<code>org.squeryl.Query</code>。查询仅在动作开始时向数据库发送信息。添加完这些验证后，<code>validate</code>方法现在看起来像下面：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>[<span class="keyword">this</span>] <span class="function"><span class="keyword">def</span> <span class="title">validate</span></span>() = &#123;</span><br><span class="line"><span class="keyword">if</span> (number.isEmpty || title.isEmpty) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">&quot;Both number and title are required&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (stories.where(a =&gt; a.number === number).nonEmpty) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">&quot;The story number is not unique&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，在插入Story记录到数据库之前，你需要调用这个validate方法，以确保是否有效。你还需要在数据库事务上提交或者回滚。现在，我们为该Story类添加一个<code>save</code>方法。但，这个方法应该返回什么？当创建记录成功时，你可以返回成功信息，但创建失败时怎么表示好？在这里我推荐使用<code>scala.Either</code>，它可以允许你同时返回成功和失败信息。它使得save方法可以优雅地处理问题。下面是完整的Story类方法，它包含<code>validate</code>和<code>save</code>方法：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kanban.models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kanban.models.<span class="type">KanbanSchema</span>._</span><br><span class="line"><span class="keyword">import</span> org.squeryl.<span class="type">KeyedEntity</span></span><br><span class="line"><span class="keyword">import</span> org.squeryl.<span class="type">PrimitiveTypeMode</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Story</span>(<span class="params">val id: <span class="type">Long</span>, val number: <span class="type">String</span>, val title: <span class="type">String</span>, val phase: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">KeyedEntity</span>[<span class="type">Long</span>]</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>[<span class="keyword">this</span>] <span class="function"><span class="keyword">def</span> <span class="title">validate</span></span>() = &#123;</span><br><span class="line">    <span class="keyword">if</span> (number.isEmpty || title.isEmpty) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">&quot;Both number and title are required&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stories.where(a =&gt; a.number === number).nonEmpty) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">&quot;The story number is not unique&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">save</span></span>(): <span class="type">Either</span>[<span class="type">Throwable</span>, <span class="type">String</span>] = &#123;</span><br><span class="line">    tx &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        validate()</span><br><span class="line">        stories.insert(<span class="keyword">this</span>)</span><br><span class="line">        <span class="type">Right</span>(<span class="string">&quot;Story is created successfully&quot;</span>)</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> exception: <span class="type">Throwable</span> =&gt; <span class="type">Left</span>(exception)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Story</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(number: <span class="type">String</span>, title: <span class="type">String</span>) = <span class="keyword">new</span> <span class="type">Story</span>(<span class="number">0</span>, number, title, <span class="string">&quot;ready&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidationException</span>(<span class="params">message: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">RuntimeException</span>(<span class="params">message</span>)</span></span><br></pre></td></tr></table></figure>
<p>number 和 title两个字段都不能为空，如果为空，你可以抛出一个异常。第二个验证是从数据库检验number是否是唯一的。这里使用了一个内建方法<code>where</code>，该方法用用于所有表对象，它接收一个函数作为参数，函数参数是一个Boolean表达式，并根据表达式过滤搜索查询。代码中匹配 <code>a =&gt; a.number === number</code>，用于查询数据库中和number相等的记录，如果存在该记录，将抛出异常，表示不能插入不唯一的记录。</p>
<p>在save方法之前，最先调用validate方法，以此验证是否插入重复数据。这两个方法都处于闭包环境tx方法中。方法tx表示初始化SessionFactory.concrete 和 数据库事务。该方法在 KanbanSchema里面定义。因为save返回结果包含成功和失败，所以这个使用了Either作为save方法的返回类型。在Scala公共方法中，使用<code>scala.Either</code>作为返回 更通常于抛出异常。另外，你创建了Story的伴生对象Story来创建新的实例，phase的默认值为&quot;Ready&quot;。</p>
<p>方法tx在前面的代码片段中，确保了SessionFactory被正确初始化，以及开启了一个新的事务。方法tx接收一个函数作为参数，并以函数作为返回类型。函数参数可以是任何闭包或者代码块，下面是完整的KanbanSchema对象。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kanban.models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.<span class="type">DriverManager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.squeryl.<span class="type">PrimitiveTypeMode</span>._</span><br><span class="line"><span class="keyword">import</span> org.squeryl._</span><br><span class="line"><span class="keyword">import</span> org.squeryl.adapters._</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @author Barudisshu</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KanbanSchema</span> <span class="keyword">extends</span> <span class="title">Schema</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> stories = table[<span class="type">Story</span>](<span class="string">&quot;STORIES&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span></span>() = &#123;</span><br><span class="line">    <span class="type">Class</span>.forName(<span class="string">&quot;org.h2.Driver&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="type">SessionFactory</span>.concreteFactory.isEmpty) &#123;</span><br><span class="line">      <span class="type">SessionFactory</span>.concreteFactory = <span class="type">Some</span>(() =&gt;</span><br><span class="line">        <span class="type">Session</span>.create(<span class="type">DriverManager</span>.getConnection(<span class="string">&quot;jdbc:h2:tcp://localhost/~/test&quot;</span>, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="keyword">new</span> <span class="type">H2Adapter</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">tx</span></span>[<span class="type">A</span>](a: =&gt; <span class="type">A</span>): <span class="type">A</span> = &#123;</span><br><span class="line">    init()</span><br><span class="line">    inTransaction(a)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    println(<span class="string">&quot;initializing the weKanban schema&quot;</span>)</span><br><span class="line">    init()</span><br><span class="line">    inTransaction &#123;</span><br><span class="line">      drop; create</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法tx接收一个函数，并在事务中执行该函数。方法<code>inTransaction</code>定义在Squeryl，它会检查线程中是否有其它事务，如果有，加入进程中的事务，否则创建一个新的事务。方法tx最先会执行init以确保<code>SessionFactory.concrete</code>和事务被初始化；以及方法<code>inTransaction</code>用于执行事务处理。</p>
<h3 id="713〖Building-the-Create-Story-web-page〗P204"><a class="header-anchor" href="#713〖Building-the-Create-Story-web-page〗P204">¶</a>7<sub>1</sub>3〖Building the Create Story web page〗P204</h3>
<p>接下来完成Story的新增页面内容，并在weKanban应用中完成下面这些特性：</p>
<p>As a customer, I want to create a new user story so I can add stories to the ready phase.</p>
<p>在web页面中，你可以有很多方式创建动态web页面。你可以使用JSP，Scala模版引擎 <a target="_blank" rel="noopener" href="http://scalate.fusesource.org">Scalate</a> <sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>，或者使用Scala内建的XML支持来创建XHTML。这里使用Scala的内建XML来生成XHTML web页面，它的特点是简单、易测试、以及有明显的Scala XML性能。对于复杂的大型的应用，这种方式不能扩展。在Chapter12你会探索Scala web框架如何更容易地构建大型web应用。</p>
<p>为了用XML来表示每一个页面dom，你需要创建一个视图对象，用于WeKanbanApplication类来发送响应内容。图Figure 7.2为我们需要构建的页面内容。</p>
<p><img src="/img/scala-in-action/chapter7/Figure_7_2.png" alt="Figure 7.2"></p>
<p>要创建上图页面内容，你需要创建下列代码CreateStory，置于src/main/com/kanban/views：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kanban.views</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CreateStory</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(message: <span class="type">String</span> = <span class="string">&quot;&quot;</span>) =</span><br><span class="line">    &lt;html&gt;</span><br><span class="line">      &lt;head&gt;</span><br><span class="line">        &lt;title&gt;<span class="type">Create</span> <span class="keyword">new</span> <span class="type">Story</span>&lt;/title&gt;</span><br><span class="line">        &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;/css/main.css&quot;</span> <span class="class"><span class="keyword">type</span></span>=<span class="string">&quot;text/css&quot;</span> media=<span class="string">&quot;screen&quot;</span> charset=<span class="string">&quot;utf-8&quot;</span>/&gt;</span><br><span class="line">      &lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">        &lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;message&quot;</span>&gt;</span><br><span class="line">          &#123;message&#125;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;createStory&quot;</span>&gt;</span><br><span class="line">          &lt;form action=<span class="string">&quot;/card/save&quot;</span> method=<span class="string">&quot;post&quot;</span> accept-charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">            &lt;fieldset&gt;</span><br><span class="line">              &lt;legend&gt;<span class="type">Create</span> a <span class="keyword">new</span> <span class="type">Story</span>&lt;/legend&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;section&quot;</span>&gt;</span><br><span class="line">                &lt;label <span class="keyword">for</span>=<span class="string">&quot;storyNumber&quot;</span>&gt;<span class="type">Story</span> <span class="type">Number</span></span><br><span class="line">                  &lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;subtle&quot;</span>&gt;(uniquely identifies a story)&lt;/span&gt;</span><br><span class="line">                &lt;/label&gt;</span><br><span class="line">                &lt;input <span class="class"><span class="keyword">type</span></span>=<span class="string">&quot;text&quot;</span> size=<span class="string">&quot;10&quot;</span> maxlength=<span class="string">&quot;10&quot;</span> minlength=<span class="string">&quot;3&quot;</span> name=<span class="string">&quot;storyNumber&quot;</span> id=<span class="string">&quot;storyNumber&quot;</span>/&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;section&quot;</span>&gt;</span><br><span class="line">                &lt;label <span class="keyword">for</span>=<span class="string">&quot;title&quot;</span>&gt;<span class="type">Title</span></span><br><span class="line">                  &lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;subtle&quot;</span>&gt;(describe the story)&lt;/span&gt;</span><br><span class="line">                &lt;/label&gt;</span><br><span class="line">                &lt;textarea rows=<span class="string">&quot;5&quot;</span> cols=<span class="string">&quot;30&quot;</span> name=<span class="string">&quot;title&quot;</span> id=<span class="string">&quot;title&quot;</span>&gt;&lt;/textarea&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;section&quot;</span>&gt;</span><br><span class="line">                &lt;button <span class="class"><span class="keyword">type</span></span>=<span class="string">&quot;submit&quot;</span>&gt;<span class="type">Save</span>&lt;/button&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/fieldset&gt;</span><br><span class="line">          &lt;/form&gt;</span><br><span class="line">          &lt;span <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;linkLabel&quot;</span>&gt;</span><br><span class="line">            &lt;a href=<span class="string">&quot;/kanban/board&quot;</span>&gt;<span class="type">Go</span> to <span class="type">Kanban</span> board&lt;/a&gt;</span><br><span class="line">          &lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">    &lt;/html&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的apply方法为创建页面所需要的HTML代码，尽管它是HTML，在Scala代码中，不论是XML或HTML都是有效的。这里的apply方法的返回类型是scala.xml.NodeSeq，它是一系列XML节点，NodeSeq会被渲染为String，并返回真是的HTML代码。现在要为其指定一个URL。其中，静态链接内容分别在webapp/js 和 webapp/css目录下。</p>
<p>到目前为止，Scalaz中的application已经使用resource方法处理了这些静态资源：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span></span>(<span class="keyword">implicit</span> servlet: <span class="type">HttpServlet</span>, servletRequest:</span><br><span class="line"><span class="type">HttpServletRequest</span>, request: <span class="type">Request</span>[<span class="type">Stream</span>]) = &#123;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">found</span></span>(x: <span class="type">Iterator</span>[<span class="type">Byte</span>]) : <span class="type">Response</span>[<span class="type">Stream</span>] = <span class="type">OK</span> &lt;&lt; x.toStream</span><br><span class="line">resource(found, <span class="type">NotFound</span>.xhtml)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要处理这些静态资源，在application方法中调用handle方法，该方法接收application方法相同的参数，并在请求对象上匹配URL。典型地，web框架使用了分割配置文件来将URL映射为一个资源或函数。基于约定(convention-based)框架如：Rails、playframework 中，URL包含了足够的信息来映射到 合适的函数或动作中。Scalaz使用了一个不同的方式——Scala强大的类型匹配，当URL进入到HTTP方法，URL被分成List。例如，一个URL地址为 <a target="_blank" rel="noopener" href="http://localhost:8080/card/create">http://localhost:8080/card/create</a>  匹配为：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request <span class="keyword">match</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">GET</span>,<span class="string">&quot;card&quot;</span>::<span class="string">&quot;create&quot;</span>::<span class="type">Nil</span>) =&gt;   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MethodParts是一个<code>Extractor object</code>，它接收一个Scalaz请求Request，并返回HTTP方法的Option，以及URL的List对象。前面提供的代码片段中，<code>GET</code>为HTTP请求资源方法，第二个参数为拆分为List的URL。</p>
<blockquote><h4 id="How-an-Extractor-object-works"><a class="header-anchor" href="#How-an-Extractor-object-works">¶</a>How an Extractor object works</h4>
<p>第三章中介绍了case class是如何进行模式匹配的，但模式匹配并不仅限于case class。几乎任何对象都可以用做模式匹配，只要它定义了方法unapply。包含unapply方法的对象称为Extractor object。例如，Scalaz中定义的MethodParts代码为：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MethodParts</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">unapply</span></span>[<span class="type">IN</span>[_]](r : <span class="type">Request</span>[<span class="type">IN</span>]) : <span class="type">Option</span>[(<span class="type">Method</span>,</span><br><span class="line">    <span class="type">List</span>[<span class="type">String</span>])] = &#123;</span><br><span class="line">    <span class="type">Some</span>(r.method, r.parts)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的unapply方法接收一个Scalaz 请求实例，并返回一个包含method 和 parts的 <code>Some</code>。parts方法返回所有由 <code>/</code> 分割的路径。</p>
<p>当Scala遇到诸如<code>MethodParts(...)</code> 这种模式，会转换为一个<code>MethodParts.unapply</code>方法的调用，即由模式匹配引用传递对象(这里是Scalaz的request实例)。注意，apply方法对于模式匹配(pattern matching)不是必须的。典型使用最小构造器，例如，在Story实例中使用apply来创建一个新的Story实例。</p>
<p>我们规定，如果你想要从unapply方法中得到返回值，则返回类型必须为scala.Option的转换。</p>
</blockquote>
<p>有时候，你会通过请求参数来请求资源。例如，当一个Story被成功创建后，你会回到原来的页面，并附带一个创建成功消息。从URL中获取请求参数，需要用到Scalaz Request对象中的方法 <code>!</code>。下面我们创建一个私有方法<code>param</code>，该方法用于返回一个字符串值。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">param</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>]) = (request ! name).getOrElse(<span class="type">List</span>[<span class="type">Char</span>]()).mkString(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>方法 ! 返回<code>Option[List[Char]]</code>，这里把它转换为字符串。下面创建handle方法将它们组合起来：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>], servletRequest: <span class="type">HttpServletRequest</span>): <span class="type">Option</span>[<span class="type">Response</span>[<span class="type">Stream</span>]] = &#123;</span><br><span class="line">  request <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">GET</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;create&quot;</span> :: <span class="type">Nil</span>) =&gt; </span><br><span class="line">      <span class="type">Some</span>(<span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt; <span class="type">CreateStory</span>(param(<span class="string">&quot;message&quot;</span>)))</span><br><span class="line">      <span class="type">Some</span>(moveCard)</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; <span class="type">None</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，当request匹配HTTP method类型和URL，会创建一个调用CreateStory产生的Response。<code>OK(ContentType,&quot;text/html&quot;)</code>创建一个空的Response，该Response带有HTTP响应标头(header)类型content-type。方法 <code>&lt;&lt;</code> 表示向Response 添加额外内容。因为Scala鼓励创建不可变对象(immutable objects)，所以，每次调用 <code>&lt;&lt;</code> 方法时，都会创建一个新的Response对象。</p>
<p><strong>注意</strong> handle方法里面使用的 strict 称为 <em>doctype</em> 。文档类型不是一个HTML标签。它用于告诉浏览器当前页面使用的是哪个版本的标记语言。这里使用了strict HTML 标准，在例子中使用 strict 。</p>
<p>接下来，我们需要在application方法中使用handle方法。原来方法中保留resource方法，用来加载静态资源。要在application方法中添加handle方法处理，Scalaz内核提供了一个方法 <code>|</code> 用于Option类，使用它可以组合handle方法和resource方法，这样，当handle方法返回None时，则调用resource方法作为静态资源处理。下面是改变之后的application方法。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span></span>(<span class="keyword">implicit</span> servlet: <span class="type">HttpServlet</span>,</span><br><span class="line">  servletRequest: <span class="type">HttpServletRequest</span>, request: <span class="type">Request</span>[<span class="type">Stream</span>]) = &#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">found</span></span>(x: <span class="type">Iterator</span>[<span class="type">Byte</span>]) : <span class="type">Response</span>[<span class="type">Stream</span>] = <span class="type">OK</span> &lt;&lt; x.toStream</span><br><span class="line">    handle | resource(found, <span class="type">NotFound</span>.xhtml)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为所有传递给handle方法的参数都是隐式的，你可以不用显式给它传递参数。使用了 <code>| </code>方法，如果handle方法返回的是None，则方法resource会被调用。当URL找不到匹配的资源时，则会返回NotFound.xhtml。</p>
<p><strong>注意</strong> Scalaz使用Scala的隐式方法转换将 <code>|</code> 方法添加到 Option类中。如果你曾经使用过Ruby,Groovy或其它编程语言的 元程序(metaprogramming)，隐式转换是Scala实现 元程序(metaprogramming) 的方式，但有更多控制。你会在下一章节了解更多隐式转换的详细内容。</p>
<p>在运行应用之前，先看看经过修改后的完整代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scalaz._</span><br><span class="line"><span class="keyword">import</span> <span class="type">Scalaz</span>._</span><br><span class="line"><span class="keyword">import</span> scalaz.http._</span><br><span class="line"><span class="keyword">import</span> response._</span><br><span class="line"><span class="keyword">import</span> request._</span><br><span class="line"><span class="keyword">import</span> servlet._</span><br><span class="line"><span class="keyword">import</span> <span class="type">HttpServlet</span>._</span><br><span class="line"><span class="keyword">import</span> <span class="type">Slinky</span>._</span><br><span class="line"><span class="keyword">import</span> com.kanban.views._</span><br><span class="line"><span class="keyword">import</span> com.kanban.models._</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WeKanbanApplication</span> <span class="keyword">extends</span> <span class="title">StreamStreamServletApplication</span> </span>&#123;</span><br><span class="line">  <span class="keyword">import</span> <span class="type">Request</span>._</span><br><span class="line">  <span class="keyword">import</span> <span class="type">Response</span>._</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> charset = <span class="type">UTF8</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">param</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>]) =</span><br><span class="line">  (request ! name).getOrElse(<span class="type">List</span>[<span class="type">Char</span>]()).mkString(<span class="string">&quot;&quot;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>],</span><br><span class="line">    servletRequest: <span class="type">HttpServletRequest</span>): <span class="type">Option</span>[<span class="type">Response</span>[<span class="type">Stream</span>]] = &#123;</span><br><span class="line">    request <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">GET</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;create&quot;</span> :: <span class="type">Nil</span>) =&gt;</span><br><span class="line">          <span class="type">Some</span>(<span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt;</span><br><span class="line">          <span class="type">CreateStory</span>(param(<span class="string">&quot;message&quot;</span>)))</span><br><span class="line">      <span class="keyword">case</span> _ =&gt; <span class="type">None</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">val</span> application = <span class="keyword">new</span> <span class="type">ServletApplication</span>[<span class="type">Stream</span>, <span class="type">Stream</span>] &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">application</span></span>(<span class="keyword">implicit</span> servlet: <span class="type">HttpServlet</span>,</span><br><span class="line">  servletRequest: <span class="type">HttpServletRequest</span>, request: <span class="type">Request</span>[<span class="type">Stream</span>]) = &#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">found</span></span>(x: <span class="type">Iterator</span>[<span class="type">Byte</span>]) : <span class="type">Response</span>[<span class="type">Stream</span>] = <span class="type">OK</span> &lt;&lt; x.toStream</span><br><span class="line">      handle | resource(found, <span class="type">NotFound</span>.xhtml)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里添加了两个新的方法handle和param，handle方法用于将匹配请求到函数。它使用了一个Scalaz 的Extractor对象 MethodParts，该对象将Scalaz请求拆分为请求类型和URL部分。HTTP GET请求 <a target="_blank" rel="noopener" href="http://localhost:8080/card/create">http://localhost:8080/card/create</a> 会被拆分为 GET请求类型 和 URL <code>&quot;card&quot;::&quot;crate&quot;::Nil</code> 这两部分。当请求匹配后，创建一个Scalaz Response 来渲染页面 <code>Some(OK(ContentType, &quot;text/html&quot;) &lt;&lt; strict &lt;&lt; CreateStory(param(&quot;message&quot;)))</code>。其中 CreateStory为一个view对象，<code>OK(ContentType, &quot;text/html&quot;) &lt;&lt; strict</code> 创建一个空的Response，并粘滞有strict HTML文档类型。</p>
<p>方法param用于获取request请求参数，这里使用了Scalaz定义的 <code>!</code> 方法，方法param将 <code>!</code> 方法处理的结果转换为String类型。Scalaz默认使用<code>List[Char]</code>表示请求参数值的类型。</p>
<p>当请求URL不匹配定义的handle方法时，返回默认的None。再由 <code>|</code> 方法进行 “或” 处理，执行resource方法载入静态资源。</p>
<p>现在进入SBT控制台，执行 <code>jetty-run</code>命令开启服务器，在浏览器中输入 <a target="_blank" rel="noopener" href="http://localhost:8080/card/create">http://localhost:8080/card/create</a> 进行访问，并点击上面的按钮进行操作。</p>
<p>单击save按钮时，还没有任何动作，因此，要在application中添加save URL的匹配case：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>],</span><br><span class="line"> servletRequest: <span class="type">HttpServletRequest</span>): <span class="type">Option</span>[<span class="type">Response</span>[<span class="type">Stream</span>]] = &#123;</span><br><span class="line">  request <span class="keyword">match</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">GET</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;create&quot;</span> :: <span class="type">Nil</span>) =&gt;</span><br><span class="line">    <span class="type">Some</span>(<span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt;</span><br><span class="line">    <span class="type">CreateStory</span>(param(<span class="string">&quot;message&quot;</span>)))</span><br><span class="line">  <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">POST</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;save&quot;</span> :: <span class="type">Nil</span>) =&gt;</span><br><span class="line">    <span class="type">Some</span>(saveStory)</span><br><span class="line">  <span class="keyword">case</span> _ =&gt; <span class="type">None</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法saveStory会读取request里面post过来的参数，并实例化一个Story，然后调用save方法。为了读取post里面的方法，需要添加一个工具方法，但和param方法不同，因为是post请求，通常意味着有副作用，所以改用 <code>!</code> 方法来处理。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">param_!</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>]) =</span><br><span class="line">  (request | name).getOrElse(<span class="type">List</span>[<span class="type">Char</span>]()).mkString(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Story里面的save方法的返回类型是<code>scala.Either[Throwable, String]</code>，就是说如果出现错误返回左边的异常；否则返回右边的成功信息。Left和Right是Either的唯一子类型。因此可以用模式匹配进行处理。当save成功时，你便重定向到应用的创建页面，并带有成功信息；同样，当创建失败时，则在页面显示失败信息。下面是saveStory方法的实现：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">saveStory</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>],</span><br><span class="line">  servletRequest: <span class="type">HttpServletRequest</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> title = param_!(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> number = param_!(<span class="string">&quot;storyNumber&quot;</span>)</span><br><span class="line">    <span class="type">Story</span>(number, title).save <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Right</span>(message) =&gt;</span><br><span class="line">    redirects[<span class="type">Stream</span>, <span class="type">Stream</span>](<span class="string">&quot;/card/create&quot;</span>, (<span class="string">&quot;message&quot;</span>, message))</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Left</span>(error) =&gt; <span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; transitional &lt;&lt;</span><br><span class="line">    <span class="type">CreateStory</span>(error.toString)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法redirects定义在Response对象中，它表示页面的重定向。</p>
<p>在运行应用之前，请确保H2数据库服务处于开启状态，下面列出完整的application类代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WeKanbanApplication</span> <span class="keyword">extends</span> <span class="title">StreamStreamServletApplication</span> </span>&#123;</span><br><span class="line">  <span class="keyword">import</span> <span class="type">Request</span>._</span><br><span class="line">  <span class="keyword">import</span> <span class="type">Response</span>._</span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> charset = <span class="type">UTF8</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">param_!</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>]) = (request | name).getOrElse(<span class="type">List</span>[<span class="type">Char</span>]()).mkString(<span class="string">&quot;&quot;</span>)</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">param</span></span>(name: <span class="type">String</span>)(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>]) = (request ! name).getOrElse(<span class="type">List</span>[<span class="type">Char</span>]()).mkString(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>], servletRequest: <span class="type">HttpServletRequest</span>): <span class="type">Option</span>[<span class="type">Response</span>[<span class="type">Stream</span>]] = &#123;</span><br><span class="line">    request <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">GET</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;create&quot;</span> :: <span class="type">Nil</span>) =&gt; </span><br><span class="line">        <span class="type">Some</span>(<span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt; <span class="type">CreateStory</span>(param(<span class="string">&quot;message&quot;</span>)))</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">POST</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;save&quot;</span> :: <span class="type">Nil</span>) =&gt;  </span><br><span class="line">        <span class="type">Some</span>(saveStory)      </span><br><span class="line">      <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">GET</span>, <span class="string">&quot;kanban&quot;</span> :: <span class="string">&quot;board&quot;</span> :: <span class="type">Nil</span>) =&gt; </span><br><span class="line">        <span class="type">Some</span>(<span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt; <span class="type">KanbanBoard</span>())</span><br><span class="line">      <span class="keyword">case</span> <span class="type">MethodParts</span>(<span class="type">POST</span>, <span class="string">&quot;card&quot;</span> :: <span class="string">&quot;move&quot;</span> :: <span class="type">Nil</span>) =&gt; </span><br><span class="line">        <span class="type">Some</span>(moveCard)</span><br><span class="line">      <span class="keyword">case</span> _ =&gt; <span class="type">None</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">moveCard</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>], servletRequest: <span class="type">HttpServletRequest</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> number = param_!(<span class="string">&quot;storyNumber&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> toPhase = param_!(<span class="string">&quot;phase&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> story = <span class="type">Story</span>.findByNumber(number)</span><br><span class="line">    story.moveTo(toPhase) <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Right</span>(message) =&gt; <span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt; message</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Left</span>(error) =&gt; <span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt; error.getMessage</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">saveStory</span></span>(<span class="keyword">implicit</span> request: <span class="type">Request</span>[<span class="type">Stream</span>], servletRequest: <span class="type">HttpServletRequest</span>) = &#123;</span><br><span class="line">    <span class="keyword">val</span> title  = param_!(<span class="string">&quot;title&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> number = param_!(<span class="string">&quot;storyNumber&quot;</span>)</span><br><span class="line">    <span class="type">Story</span>(number, title).save() <span class="keyword">match</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Right</span>(message) =&gt; redirects[<span class="type">Stream</span>, <span class="type">Stream</span>](<span class="string">&quot;/card/create&quot;</span>, (<span class="string">&quot;message&quot;</span>, message))</span><br><span class="line">      <span class="keyword">case</span> <span class="type">Left</span>(error) =&gt; <span class="type">OK</span>(<span class="type">ContentType</span>, <span class="string">&quot;text/html&quot;</span>) &lt;&lt; strict &lt;&lt; <span class="type">CreateStory</span>(error.toString)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> application = <span class="keyword">new</span> <span class="type">ServletApplication</span>[<span class="type">Stream</span>, <span class="type">Stream</span>] &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">application</span></span>(<span class="keyword">implicit</span> servlet: <span class="type">HttpServlet</span>, servletRequest: <span class="type">HttpServletRequest</span>, request:</span><br><span class="line">    <span class="type">Request</span>[<span class="type">Stream</span>]): <span class="type">Response</span>[<span class="type">Stream</span>] = &#123;</span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">found</span></span>(x: <span class="type">Iterator</span>[<span class="type">Byte</span>]): <span class="type">Response</span>[<span class="type">Stream</span>] = <span class="type">OK</span> &lt;&lt; x.toStream</span><br><span class="line">      handle | <span class="type">HttpServlet</span>.resource(found, <span class="type">NotFound</span>.xhtml)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>现在已经实现了Story的新增功能，删除、修改功能与之类似。这样，我们就可以开始构建完整的weKanban项目了。</p>
<h3 id="7-2〖Building-the-Kanban-board-page〗P212"><a class="header-anchor" href="#7-2〖Building-the-Kanban-board-page〗P212">¶</a>7~2〖Building the Kanban board page〗P212</h3>
<p>(略… 剩余部分内容为上述内容的重复操作，此处省略)</p>
<h3 id="7-3〖Summary〗p223"><a class="header-anchor" href="#7-3〖Summary〗p223">¶</a>7~3〖Summary〗p223</h3>
<p>在第6、7章我们开始构建我们的第一个中小型Scala应用。我们也由此从REPL环境切换到了SBT环境。你学习了如何使用SBT，如何配置SBT，以及如何通过SBT导入依赖、管理依赖来构建我们的项目。紧接着，我们学习了使用Scalaz HTTP 模组来构建我们的web应用，以及学习了函数式编程的概念是如何运用到web应用中。Scalaz使用了Scala的高阶函数(higher-order functions)和模式匹配暴露了优秀的APIs。构建企业级应用程序意味着你需要和关系型数据库打交道。我们学习了Squeryl，Scala的ORM工具，并学习了如何在Scala应用中构建关系型数据模型。</p>
<p>本章已经提供了足够的基础使用各种Scala工具来构建我们的应用。我鼓励使用不同的Scala ORM工具、视图模版引擎、web框架来构建或扩展这些应用。我希望这两章学习的这些概念和工具之后，可以使你更舒适地在各种Scala工具市场中驾驭。</p>
<p>在本章，我们稍稍瞥见了隐式转换和隐式参数。下一章我们将深入到Scala的类型系统，以及如何使用类型来构建抽象的层面。</p>
<div id="footnotes"><hr><div id="footnotelist"><ol><li id="fn:1">A fork of SLICK to keep old links to the ScalaQuery repository alive, <a target="_blank" rel="noopener" href="http://github.com/szeiger/scala-query">http://github.com/szeiger/scala-query</a>.<a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2">Querulous, an agreeable way to talk to your database, <a target="_blank" rel="noopener" href="http://github.com/nkallen/querulous">http://github.com/nkallen/querulous</a>.<a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3">“Class ThreadLocal<T>,” Java Platform Standard Ed. 6, <a target="_blank" rel="noopener" href="http://mng.bz/cqt0">http://mng.bz/cqt0</a>.<a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4">“Scalate: Scala Template Engine,” Scalate 1.5.3, <a target="_blank" rel="noopener" href="http://scalate.fusesource.org">http://scalate.fusesource.org</a>.<a href="#fnref:4" rev="footnote"> ↩</a></li><li id="fn:5">“Group and Aggregate Queries,” <a target="_blank" rel="noopener" href="http://squeryl.org/group-and-aggregate.html">http://squeryl.org/group-and-aggregate.html</a>.<a href="#fnref:5" rev="footnote"> ↩</a></li></ol></div></div></div></article><nav class="article-nav"><div class="article-nav-prev"><a href="/2016/10/27/scala/08-scala-components/">第八章：构建可伸缩的、可扩展的组件</a></div><div class="article-nav-next"><a href="/2016/10/27/scala/06-functional-webapp/">第六章：构建函数式风格的Web应用</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2016/10/27/scala/07-fp-database/';
var disqus_title = '第七章：连接到数据库';
var disqus_url = 'https://galudisu.info/2016/10/27/scala/07-fp-database/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>