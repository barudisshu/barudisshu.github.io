<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>æ³›å‹</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">æ³›å‹</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2022-01-07</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/kotlin/">kotlin</a></p></div><div class="article-content"><h2 id="ä¸»è¦å†…å®¹"><a class="header-anchor" href="#ä¸»è¦å†…å®¹">Â¶</a>ä¸»è¦å†…å®¹</h2>
<ol>
<li>æ³›å‹å‡½æ•°å’Œç±»çš„å£°æ˜</li>
<li>ç±»å‹æ“¦é™¤(erasure)å’Œå…·ç°(reified)</li>
<li>Declaration-site and use-site variance</li>
</ol>
<p>kotlinçš„æ³›å‹ç±»å‹å¹¶ä¸å±äºç±»å‹ç³»ç»Ÿä¸Šçš„å®ç°ï¼Œè€Œæ˜¯å°½é‡å¾€Javaæ–¹å‘å…¼å®¹ã€‚æ‰€ä»¥å®ç°å½¢å¼ä¸Šå¾ˆå¤šæ¦‚å¿µæ˜¯ç­‰ä»·çš„ã€‚</p>
<span id="more"></span>
<h2 id="Generic-type-parameters"><a class="header-anchor" href="#Generic-type-parameters">Â¶</a>Generic type parameters</h2>
<p>æ³›å‹æŒ‡å…è®¸ä½ å®šä¹‰çš„ç±»å‹æœ‰ <em>æ³›å‹å‚æ•°(type parameters)</em> ã€‚å½“ä¸€ä¸ªè¯¥ç±»å‹çš„å®ä¾‹è¢«åˆ›å»ºäº†ï¼Œç±»å‹å‚æ•°è¢«æ›¿ä»£ä¸ºæŒ‡å®šçš„ç±»å‹ç§°ä¹‹ä¸º <em>type arguments</em> ã€‚</p>
<p>Kotlinçš„ç±»å‹å‚æ•°åœ¨ç¼–è¯‘å™¨ä¸­å¯è‡ªåŠ¨æ¨æ–­ç±»å‹ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> authors = listOf(<span class="string">&quot;Dmitry&quot;</span>, <span class="string">&quot;Svetlana&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä¼ é€’ç»™å‡½æ•°<code>listOf</code>çš„å€¼çš„ç±»å‹éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œç¼–è¯‘å™¨æ¨æ–­åˆ›å»ºäº†ä¸€ä¸ª<code>List&lt;String&gt;</code>å€¼å¯¹è±¡ã€‚ä½†å¦‚æœåˆ›å»ºä¸€ä¸ªç©ºçš„listï¼Œå› ä¸ºæ— æ³•è¿›è¡Œæ¨æ–­ï¼Œæ‰€ä»¥æ­¤æ—¶å¿…é¡»æ˜¾å¼æŒ‡å®šç±»å‹ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> readers: MutableList&lt;String&gt; = mutableListOf()</span><br><span class="line"><span class="keyword">val</span> readers = mutableListOf&lt;String&gt;()</span><br></pre></td></tr></table></figure>
<p>è¿™ç§å£°æ˜æ˜¯ç­‰ä»·çš„ã€‚</p>
<blockquote>
<p><strong>NOTE</strong> å’ŒJavaä¸åŒï¼ŒKotlinè¦æ±‚ç±»å‹å‚æ•°è¦ä¹ˆæ˜¾å¼æŒ‡å®šï¼Œè¦ä¹ˆç”±ç¼–è¯‘å™¨æ¨å¯¼ã€‚ä½†æ³›å‹æ˜¯ä»JDK1.5æ‰å‡ºç°ï¼Œä¸ºäº†å…¼å®¹æ—§çš„ç‰ˆæœ¬ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨æ³›å‹ç±»å‹æ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šç±»å‹å‚æ•°ï¼Œå«åšâ€”â€”åŸç”Ÿç±»å‹(raw type)ã€‚ä¾‹å¦‚ï¼ŒJavaä¸­ä½¿ç”¨Listæ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šç±»å‹å‚æ•°ã€‚ä½†Kotlinä¸åŒäºJavaï¼Œæœ€å¼€å§‹çš„ç‰ˆæœ¬å°±æä¾›æ³›å‹æ”¯æŒï¼Œå®ƒæ˜¯ä¸æ”¯æŒraw typeçš„ï¼Œæ³›å‹å‚æ•°å¿…é¡»æ˜¾å¼æŒ‡å®šã€‚</p>
</blockquote>
<h3 id="Generic-functions-and-properties"><a class="header-anchor" href="#Generic-functions-and-properties">Â¶</a>Generic functions and properties</h3>
<p>å½“ä½ ç¼–å†™çš„å‡½æ•°åŒ…å«Listé›†åˆæ—¶ï¼Œéœ€è¦å¤„ç†æ³›å‹å‚æ•°ä»¥ä½¿å¾—Listå¯¹æ‰€æœ‰ç±»å‹éƒ½ç”Ÿæ•ˆï¼Œè¿™ç§å¸¦æœ‰æ³›å‹å‚æ•°çš„å‡½æ•°ç§°ä¸º <em>æ³›å‹å‡½æ•°(generic function)</em>ã€‚</p>
<p>ä»¥æ ‡å‡†åº“ä¸­çš„æ³›å‹å‡½æ•°<code>slice</code>ä¸ºä¾‹ï¼Œ</p>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_01.png" alt="Figure 9.1"></p>
<p>è¯¥å‡½æ•°çš„ç±»å‹å‚æ•°<code>T</code>è¢«ç”¨ä½œæ¥æ”¶ç±»å‹å’Œè¿”å›ç±»å‹ï¼›éƒ½ä¸º<code>List&lt;T&gt;</code>ã€‚åœ¨è°ƒç”¨è¿™ç±»å‡½æ•°æ—¶ï¼Œéœ€è¦æ˜¾å¼æŒ‡å®šç±»å‹å‚æ•°ã€‚ä½†ç»å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ä¸æŒ‡å®šï¼Œç”±ç¼–è¯‘å™¨æ¨å¯¼å³å¯ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> letters = (<span class="string">&#x27;a&#x27;</span>..<span class="string">&#x27;z&#x27;</span>).toList()</span><br><span class="line">&gt;&gt;&gt; println(letters.slice&lt;<span class="built_in">Char</span>&gt;(<span class="number">0.</span><span class="number">.2</span>))  <span class="comment">// Specifies the type argument explicitly</span></span><br><span class="line">[a, b, c]</span><br><span class="line">&gt;&gt;&gt; println(letters.slice(<span class="number">10.</span><span class="number">.13</span>))  <span class="comment">// The compiler infers that T is Char here.</span></span><br><span class="line">[k, l, m, n]</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ç»“æœç±»å‹éƒ½æ˜¯<code>List&lt;Chart&gt;</code>ã€‚ç¼–è¯‘å™¨æ¨å¯¼<code>T</code>æ›¿ä»£ä¸º<code>Char</code>ä½œä¸ºè¿”å›ç±»å‹<code>List&lt;T&gt;</code>çš„è¡¨è¿°ã€‚</p>
<p>ä¸Šä¸€ç« çš„é«˜é˜¶å‡½æ•°<code>filter</code>å¯ä»¥è¿›è¡Œç¼–è¯‘å™¨æ¨å¯¼ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> authors = listOf(<span class="string">&quot;Dmitry&quot;</span>, <span class="string">&quot;Svetlana&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> readers = mutableListOf&lt;String&gt;(<span class="comment">/* ... */</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> List<span class="type">&lt;T&gt;</span>.<span class="title">filter</span><span class="params">(predicate: (<span class="type">T</span>) -&gt; <span class="type">Boolean</span>)</span></span>: List&lt;T&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; readers.filter&#123; it !<span class="keyword">in</span> authors &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>it</code>ç¼–è¯‘å™¨æ¨å¯¼ä¸º<code>String</code>ï¼Œå› ä¸ºå®é™…çš„æ¥æ”¶ç±»å‹æ˜¯<code>readers</code> ï¼Œå®ƒçš„å®é™…å‚æ•°ç±»å‹æ˜¯<code>List&lt;String&gt;</code>ã€‚</p>
<p>ç±»å‹å‚æ•°å¯ä»¥å£°æ˜åœ¨classesã€interfacesã€top-level functions æˆ– external functionsè¿™äº›åœ°æ–¹ã€‚ä¹Ÿå¯ä»¥å¯¹æ‰©å±•å±æ€§ä¹Ÿä½¿ç”¨ç›¸åŒçš„è¯­æ³•ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯è¿”å›æœ€åä¸€ä¸ªå…ƒç´ çš„extension propertyã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> &lt;T&gt; List&lt;T&gt;.penultimate: T  <span class="comment">// This generic extension property can be called on a list of any kind.</span></span><br><span class="line">  <span class="keyword">get</span>() = <span class="keyword">this</span>[size - <span class="number">2</span>]</span><br><span class="line">  </span><br><span class="line">&gt;&gt;&gt; println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).penultimate)  <span class="comment">// The type parameter T is inferred to be Int in this invocation.</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>You canâ€™t declare a generic non-extension property</strong></p>
<p>å¸¸è§„çš„å±æ€§(non-extension)ä¸èƒ½æœ‰ç±»å‹å‚æ•°ã€‚å› ä¸ºä¸€ä¸ªç±»ä¸èƒ½åŒæ—¶å­˜å‚¨ä¸åŒçš„ç±»å‹å€¼ï¼Œå› æ­¤å£°æ˜ä¸€ä¸ªæ³›å‹éæ‰©å±•å±æ€§æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ä½ å¯ä»¥å°è¯•è¿™æ ·åšï¼Œä½†ç¼–è¯‘å™¨æŠ¥å‘Šé”™è¯¯ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> &lt;T&gt; x: T = TODO()</span><br><span class="line">ERROR: type parameter of a property must be used <span class="keyword">in</span> its receiver type</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Declaring-generic-classes"><a class="header-anchor" href="#Declaring-generic-classes">Â¶</a>Declaring generic classes</h3>
<p>å’ŒJavaä¸€æ ·ï¼ŒKotlinå¯ä»¥ä½¿ç”¨å°–æ‹¬å·æ¥å£°æ˜æ³›å‹ç±»æˆ–æ¥å£ï¼Œä¸€æ—¦å£°æ˜æ³›å‹ç±»åï¼Œå°±å¯ä»¥åœ¨è¯¥ç±»çš„bodyå†…ä½¿ç”¨è¯¥æ³›å‹å‚æ•°ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">List</span>&lt;<span class="type">T</span>&gt; &#123;  <span class="comment">// The List interface defines a type parameter T.</span></span><br><span class="line">  <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(index: <span class="type">Int</span>)</span></span>: T  <span class="comment">// T can be used as a regular type in an interface or a class.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³›å‹ç±»çš„ç»§æ‰¿ä¹Ÿå’ŒJavaä¸€è‡´ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StringList</span>: <span class="type">List</span>&lt;<span class="type">String</span>&gt; &#123;  <span class="comment">// This class implements List, providing a speific type argument: String</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(index: <span class="type">Int</span>)</span></span>: String = ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;<span class="type">T</span>&gt;: <span class="type">List</span>&lt;<span class="type">T</span>&gt; &#123;  <span class="comment">// Now the generic type parameter T of ArrayList is a type argument of list</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(index: <span class="type">Int</span>)</span></span>: T = ... &#125;  </span><br></pre></td></tr></table></figure>
<p><code>StringList</code>ç»§æ‰¿æ³›å‹äº†ï¼Œå£°æ˜äº†å…·ä½“çš„ç±»å‹å‚æ•°ï¼Œä¸å†æ˜¯æ³›å‹ç±»ï¼Œè€Œæ˜¯å…·ä½“ç±»ï¼›<code>ArrayList</code>æ‰§è¡Œäº†æ³›å‹å‚æ•°å¹¶ä¼ é€’ç»™çˆ¶ç±»æ³›å‹å‚æ•°ï¼Œè‡ªèº«ä½œä¸ºæ³›å‹ç±»å®ç°ã€‚</p>
<p>ä¸€ä¸ªç±»ä¹Ÿå¯ä»¥å¼•ç”¨è‡ªèº«ä½œä¸ºæ³›å‹å‚æ•°ï¼Œä¾‹å¦‚<code>Comparable</code>æ¥å£ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Comparable</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">compareTo</span><span class="params">(other: <span class="type">T</span>)</span></span>: <span class="built_in">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">String</span>: <span class="type">Comparable</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">override</span> compareTo(other: String): <span class="built_in">Int</span> = <span class="comment">/*...*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Type-parameter-constraints"><a class="header-anchor" href="#Type-parameter-constraints">Â¶</a>Type parameter constraints</h3>
<p>Kotlinçš„ç±»å‹çº¦æŸç”¨æ³•å’ŒJavaæ— å¼‚ã€‚åªä¸è¿‡æ˜¯å†™æ³•ä¸Šçš„åŒºåˆ«ã€‚</p>
<p>è¦å£°æ˜ä¸€ä¸ªçº¦æŸï¼Œéœ€è¦åœ¨ç±»å‹å‚æ•°åå¸¦ä¸Šå†’å·(ğŸ˜ƒï¼Œå†è·Ÿç€æŒ‡å®šçš„è¾¹ç•Œç±»å‹ï¼Œ</p>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_02.png" alt="Figure 9.2"></p>
<p>ç­‰ä»·äºJava çš„å†™æ³•<code>&lt;T extends Number&gt;</code>ã€‚ä¸‹é¢çš„å‡½æ•°è°ƒç”¨æ˜¯è¿è¡Œçš„ï¼Œå› ä¸ºKotlinä¸­çš„<code>Int</code>å®é™…ä¸Šç»§æ‰¿è‡ª<code>Number</code>ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; println(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>).sum())</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>ä¸€æ—¦æŒ‡å®šäº†ç±»å‹å‚æ•°<code>T</code>çš„è¾¹ç•Œï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒçš„ä¸Šç•Œç±»å‹å®šä¹‰çš„æ–¹æ³•æˆ–å±æ€§ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T: Number&gt;</span> <span class="title">oneHalf</span><span class="params">(value: <span class="type">T</span>)</span></span>: <span class="built_in">Double</span> &#123;  <span class="comment">// Specifies Number as the type parameter upper bound</span></span><br><span class="line">  <span class="keyword">return</span> value.toDouble() / <span class="number">2.0</span>  <span class="comment">// Invoke a method defined in the Number class</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; println(oneHalf(<span class="number">3</span>))</span><br><span class="line"><span class="number">1.5</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢ç¼–å†™ä¸€ä¸ªæ³›å‹å‡½æ•°æŸ¥æ‰¾ä¸¤å€¼ä¸­çš„æœ€å¤§å€¼ã€‚ä½ éœ€è¦å®šä¹‰<code>Comparable</code>çš„ä¸Šç•Œæ‰èƒ½è¿›è¡Œæ¯”è¾ƒã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T: Comparable&lt;T&gt;</span>&gt; <span class="title">max</span><span class="params">(first: <span class="type">T</span>, second: <span class="type">T</span>)</span></span>: T &#123;  <span class="comment">// The arguments of this function must be comprable elements.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">if</span> (first &gt; second) first <span class="keyword">else</span> second</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; println(max(<span class="string">&quot;kotlin&quot;</span>, <span class="string">&quot;java&quot;</span>))  <span class="comment">// The strings are compared alphabetically.</span></span><br><span class="line">kotlin</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¼ å…¥çš„å‚æ•°ç±»å‹æ²¡æœ‰ç»§æ‰¿<code>Comprable</code>ï¼Œç¼–è¯‘å°†ä¸é€šè¿‡ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; println(max(<span class="string">&quot;kotlin&quot;</span>, <span class="number">42</span>))</span><br><span class="line">ERROR: Type parameter bound <span class="keyword">for</span> T <span class="keyword">is</span> not satisfied:</span><br><span class="line">  inferred type Any <span class="keyword">is</span> not a subtype of Comparable&lt;Any&gt;</span><br></pre></td></tr></table></figure>
<p><code>T</code>çš„ä¸Šç•Œæ˜¯ä¸€ä¸ªæ³›å‹ç±»å‹<code>Comparable&lt;T&gt;</code>ã€‚å‰é¢çœ‹åˆ°ï¼Œ<code>String</code>ç±»ç»§æ‰¿äº†<code>Comparable&lt;String&gt;</code>ï¼Œå› æ­¤å¯ä»¥ä¼ å…¥å­—ç¬¦ä¸²ç±»å‹ä½œä¸ºå‚æ•°ã€‚</p>
<p>è®°ä½ï¼Œä¾æ®Kotlinçš„operator conventionsçš„è§„çº¦ï¼Œ<code>first &gt; second</code>å®é™…ä¸Šè¢«ç¼–è¯‘ä¸º<code>first.compareTo(second) &gt; 0</code>ã€‚</p>
<p>å¾ˆå°‘çš„æƒ…å†µä¸‹éœ€è¦å¯¹åŒä¸€ä¸ªç±»å‹å‚æ•°æŒ‡å®šå¤šä¸ªä¸Šç•Œçš„ï¼Œä½ éœ€è¦ç¨å¾®ä½¿ç”¨ä¸åŒçš„è¯­æ³•ã€‚ä¾‹å¦‚ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">ensureTrailingPeriod</span><span class="params">(seq: <span class="type">T</span>)</span></span></span><br><span class="line">		<span class="keyword">where</span> T: CharSequence, T: Appendable &#123;</span><br><span class="line">  <span class="keyword">if</span>(!seq.endsWith(<span class="string">&#x27;.&#x27;</span>)) &#123;  <span class="comment">// Calls an extension function defined for the CharSequence interface</span></span><br><span class="line">    seq.append(<span class="string">&#x27;.&#x27;</span>)  <span class="comment">// Calls the method from the Appendable interface</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> helloWorld = StringBuilder(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; ensureTrailingPeriod(helloWorld)</span><br><span class="line">&gt;&gt;&gt; println(helloWorld)</span><br><span class="line">Hello World.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½¿ç”¨çš„æ³›å‹ç±»å‹å¿…é¡»åŒæ—¶ç»§æ‰¿<code>CharSequence</code>å’Œ<code>Appendable</code>æ¥å£ã€‚æ„å‘³ç€å¯ä»¥å¯¹å…¶è¿›è¡Œè®¿é—®(<code>endsWith</code>)å’Œä¿®æ”¹(<code>append</code>)æ“ä½œã€‚</p>
<h3 id="Making-type-parameters-non-null"><a class="header-anchor" href="#Making-type-parameters-non-null">Â¶</a>Making type parameters non-null</h3>
<p>å¦‚æœä½ å£°æ˜ä¸€ä¸ªæ³›å‹ç±»æˆ–å‡½æ•°ï¼Œä»»ä½•ç±»å‹å‚æ•°ï¼ŒåŒ…æ‹¬å¯ç©ºï¼Œå¯ä»¥è¢«æ›¿æ¢ä¸ºå®ƒè‡ªèº«çš„ç±»å‹å‚æ•°ã€‚å®é™…ä¸Šï¼Œä¸€ä¸ªç±»å‹å‚æ•°å¦‚æœä¸æŒ‡å®šä¸Šç•Œçš„è¯ï¼Œå®ƒçš„ä¸Šç•Œåˆ™ä¸º<code>Any?</code>ã€‚è€ƒè™‘å¦‚ä¸‹ä¾‹å­ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Processor</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">process</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    value?.hashCode()  <span class="comment">// &quot;value&quot; is nullable, so you have to use a safe call.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°<code>process</code>çš„å‚æ•°<code>value</code>æ˜¯å¯ç©ºçš„ï¼Œå°½ç®¡<code>T</code>æ²¡æœ‰æ ‡è®°ä¸Šé—®å·ã€‚è¿™ç§æƒ…å†µä¸‹<code>Processor</code>ç±»å¯ä»¥ä¼ å…¥å¯ç”¨ç±»å‹æ¥æ›¿æ¢<code>T</code>ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> nullableStringProcessor = Processor&lt;String?&gt;()  <span class="comment">// String?, which is a nullable type, is substituted for T.</span></span><br><span class="line">nullableStringProcessor.process(<span class="literal">null</span>)  <span class="comment">// This code compiles fine, having &quot;null&quot; as the &quot;value&quot; argument.</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ æƒ³è¦ç¡®ä¿ä¸€ä¸ªéç©ºç±»å‹æ€»æ˜¯è¢«æ›¿æ¢ä½¿ç”¨ã€‚ä½ å¯ä»¥å®ç°è¿™ç§ç‰¹å®šçš„è¾¹ç•Œã€‚å¦åˆ™å°±ä¸æŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤çš„<code>Any?</code>å®ç°ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Processor</span>&lt;<span class="type">T: Any</span>&gt; &#123;  <span class="comment">// Specifying a non-&quot;null&quot; upper bound</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">process</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    value.hashCode()  <span class="comment">// &quot;value&quot; of type T is now non-&quot;null&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>&lt;T: Any&gt;</code>çº¦æŸç¡®ä¿äº†<code>T</code>ç±»å‹æ€»æ˜¯ä¸ä¸ºç©ºçš„å‚æ•°ç±»å‹ã€‚ä¼ å…¥å¯ç©ºå‚æ•°å°†å‘ç”Ÿç¼–è¯‘é”™è¯¯ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> nullableStringProcessor = Processor&lt;String?&gt;()</span><br><span class="line">Error: Type argument <span class="keyword">is</span> not within its bounds: should be subtype of <span class="string">&#x27;Any&#x27;</span></span><br></pre></td></tr></table></figure>
<p>ç›®å‰ä¸ºæ­¢ï¼ŒKotlinçš„åŸºæœ¬æ³›å‹è¯­æ³•å’ŒJavaç±»ä¼¼ã€‚ä¸‹é¢è®¨è®ºè¿è¡Œæ—¶æ³›å‹çš„è¡Œä¸ºã€‚</p>
<h2 id="Generics-at-runtime-erased-and-reified-type-parameters"><a class="header-anchor" href="#Generics-at-runtime-erased-and-reified-type-parameters">Â¶</a>Generics at runtime: erased and reified type parameters</h2>
<p>ä½ å¯èƒ½å·²ç»çŸ¥é“ï¼ŒJVMä¸Šçš„æ³›å‹é€šè¿‡ <em>ç±»å‹æ“¦é™¤(type erasure)</em> å®ç°ï¼Œæ„å‘³ç€ä¸€ä¸ªæ³›å‹ç±»çš„ä¸€ä¸ªå®ä¾‹çš„ç±»å‹å‚æ•°åœ¨è¿è¡Œæ—¶æ˜¯ä¸ä¿ç•™çš„ã€‚æˆ‘ä»¬å°†è®¨è®ºKotlinçš„ç±»å‹ç¡®ä¿çš„å®é™…æ„ä¹‰ï¼Œä»¥åŠå¦‚ä½•åº”å¯¹<code>inline</code>å‡½æ•°çš„é™åˆ¶ã€‚ä½ å¯ä»¥å£°æ˜ä¸€ä¸ª<code>inline</code>å‡½æ•°ï¼Œè¿™æ ·å®ƒçš„ç±»å‹å‚æ•°ä¸ä¼šè¢«æ“¦é™¤<strong>erased</strong>(æˆ–ï¼Œåœ¨Kotlinæœ¯è¯­ä¸­ï¼Œå«å…·ç°åŒ–<strong>reified</strong>)ã€‚</p>
<h3 id="Generics-at-runtime-type-checks-and-casts"><a class="header-anchor" href="#Generics-at-runtime-type-checks-and-casts">Â¶</a>Generics at runtime: type checks and casts</h3>
<p>å’ŒJavaä¸€æ ·ï¼ŒKotlinçš„æ³›å‹ä¹Ÿæ˜¯è¿è¡Œæ—¶æ“¦é™¤çš„ã€‚æ„å‘³ç€ä¸€ä¸ªæ³›å‹ç±»çš„å®ä¾‹ä¸ä¼šæºå¸¦åˆ›å»ºæ—¶çš„ç±»å‹å‚æ•°ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ª<code>List&lt;String&gt;</code>ï¼Œé‡Œé¢æ”¾äº†ä¸€å †å­—ç¬¦ä¸²ï¼Œåœ¨è¿è¡Œæ—¶ä½ å°†åªèƒ½çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ª<code>List</code>ã€‚æ²¡æœ‰ä»»ä½•å¯èƒ½åŒºåˆ†åˆ°å®ƒçš„å®é™…åŒ…å«çš„å…ƒç´ ç±»å‹(å½“ç„¶ï¼Œä½ å¯ä»¥è·å–åˆ°å®ƒçš„å…ƒç´ ï¼Œæ ¡éªŒå®ƒçš„ç±»å‹ï¼Œä½†ä¸ä¼šç»™ä½ ä»»ä½•ä¿éšœï¼Œå› ä¸ºå…¶å®ƒå…ƒç´ å¯èƒ½æœ‰ä¸åŒç±»å‹)ã€‚</p>
<p>è€ƒè™‘å¦‚ä¸‹ä»£ç å¹¶è¿è¡Œï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list1: List&lt;String&gt; = listOf(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> list2: List&lt;<span class="built_in">Int</span>&gt; = listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_03.png" alt="Figure 9.3"></p>
<p>å°½ç®¡ç¼–è¯‘å™¨çœ‹å‡ºæ¥è¿™ä¸¤ä¸ªlistæœ‰ä¸åŒçš„ç±»å‹ï¼Œä½†åœ¨æ‰§è¡ŒæœŸé—´å®ƒä»¬å®é™…ä¸Šæ˜¯ä¸€æ ·çš„ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä½ å¯ä»¥ç¡®å®š<code>List&lt;String&gt;</code>ä»…åŒ…å«å­—ç¬¦ä¸²ï¼›<code>List&lt;Int&gt;</code>ä»…åŒ…å«æ•´å‹ï¼Œå› ä¸ºç¼–è¯‘å™¨çŸ¥é“ç±»å‹å‚æ•°å¹¶ä¸”ç¡®ä¿å…ƒç´ æ˜¯è¢«æ­£ç¡®å­˜å‚¨çš„ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­è®¨è®ºç±»å‹æ“¦é™¤çš„çº¦æŸä¿¡æ¯ã€‚å› ä¸ºç±»å‹å‚æ•°ä¸ä¼šè¢«å­˜å‚¨ï¼Œä½ ä¸èƒ½æ ¡éªŒå®ƒä»¬â€”â€”ä¾‹å¦‚ï¼Œä½ ä¸èƒ½æ ¡éªŒä¸€ä¸ªlistæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²listè€Œä¸æ˜¯å…¶å®ƒå‘¢ã€‚é€šå¸¸è§„å®šï¼Œä½ æ— æ³•ä½¿ç”¨<code>is</code>å…³é”®å­—æ¥æ ¡éªŒç±»å‹å‚æ•°ã€‚ä¸‹é¢ä»£ç ä¸è¢«ç¼–è¯‘ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">if</span> (value <span class="keyword">is</span> List&lt;String&gt;) &#123; ... &#125;</span><br><span class="line">ERROR: Cannot check <span class="keyword">for</span> instance of erased type</span><br></pre></td></tr></table></figure>
<p>å°½ç®¡åœ¨è¿è¡Œæ—¶ä½ å¯ä»¥æ‰¾å‡ºè¯¥å€¼æ˜¯ä¸€ä¸ª<code>List</code>ï¼Œå´æ²¡æœ‰å‘ŠçŸ¥å®ƒåˆ°åº•æ˜¯å­—ç¬¦ä¸²listè¿˜æ˜¯å…¶å®ƒç±»å‹çš„listï¼šç±»å‹ä¿¡æ¯è¢«æ“¦é™¤<strong>erased</strong>äº†ã€‚æ³›å‹ç±»å‹ä¿¡æ¯è¢«æ“¦é™¤æ˜¯æœ‰å¥½å¤„çš„ï¼šæ€»ä½“çš„å†…å­˜ä¿¡æ¯å°†è¢«å‡å°‘ï¼Œå› ä¸ºéœ€è¦å°½å¯èƒ½å°‘çš„å­˜å‚¨ç±»å‹ä¿¡æ¯åˆ°å†…å­˜ä¸­ã€‚</p>
<p>Kotlinä¸å…è®¸ä½ ä½¿ç”¨æ²¡æœ‰æŒ‡å®šæ³›å‹å‚æ•°çš„æ³›å‹ç±»å‹ã€‚è¿™æ ·ä½ å¯èƒ½æƒ³çŸ¥é“å¦‚ä½•æ ¡éªŒlistçš„å€¼ï¼Œä½ å¯èƒ½ä¼šç”¨åˆ°ç‰¹å®šçš„ <em>star projection</em> è¯­æ³•ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (value <span class="keyword">is</span> List&lt;*&gt;) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾è‘—åœ°ï¼Œå¼•å…¥ <em><code>*</code></em> è¡¨è¿°å®ƒä¼šæ˜¯ä»»ä½•ç±»å‹ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºå®ƒè¡¨ç¤ºçš„æ˜¯æœªçŸ¥ç±»å‹(ç±»ä¼¼äºJavaçš„ <code>List&lt;?&gt;</code>)ã€‚è¿™æ ·ä¸€æ¥ï¼Œä½ å°±å¯ä»¥æ ¡éªŒ<code>value</code>æ˜¯å¦æ˜¯ä¸€ä¸ª<code>List</code>ï¼Œä½†ä»ç„¶æ— æ³•å¾—çŸ¥å®ƒçš„å…ƒç´ ç±»å‹ã€‚</p>
<p>ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„<code>as</code>å’Œ<code>as?</code>è¿›è¡Œè½¬æ¢ã€‚ä½†å½“è¯¥ç±»åŒ…å«æœ‰æ­£ç¡®çš„åŸºç¡€ç±»å‹å’Œé”™è¯¯çš„å‚æ•°ç±»å‹ï¼Œç±»å‹è½¬æ¢ä¸ä¼šå¤±è´¥ï¼Œå› ä¸ºè¿›è¡Œè½¬æ¢æ—¶å¹¶ä¸çŸ¥é“å…·ä½“çš„ç±»å‹å‚æ•°ã€‚æ­£å› ä¸ºè¿™æ ·ï¼Œç¼–è¯‘å™¨ä¼šå‘å‡º&quot;unchecked cast&quot;è¿™æ ·çš„è­¦å‘Šã€‚ä½†ä»…ä»…æ˜¯è­¦å‘Šï¼Œåé¢ä½ è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨å®ƒã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">printSum</span><span class="params">(c: <span class="type">Collection</span>&lt;*&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> intList = c <span class="keyword">as</span>? List&lt;<span class="built_in">Int</span>&gt;  <span class="comment">// Warning here. Unchecked cast: List&lt;*&gt; to List&lt;Int&gt;</span></span><br><span class="line">		?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;List is expected&quot;</span>)</span><br><span class="line">  println(intList.sum())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; printSum(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))  <span class="comment">// Everything works as expected.</span></span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>ä¸€åˆ‡é¡ºåˆ©ï¼šç¼–è¯‘å™¨ä»…äº§ç”Ÿä¸€ä¸ªå‘Šè­¦ï¼Œæ„å‘³ç€ä»£ç æ˜¯åˆç†çš„(legitimate)ã€‚å¦‚æœä½ åœ¨ä¸€ä¸ªæ•´å‹çš„listæˆ–setä¸Šè°ƒç”¨<code>printSum</code>ï¼Œç¬¬ä¸€ç§æƒ…å†µå·¥ä½œï¼Œåé¢ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœä¼ é€’é”™è¯¯çš„å€¼ç±»å‹ï¼Œåˆ™æŠ›å‡º<code>ClassCastException</code>è¿è¡ŒæœŸå¼‚å¸¸ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; printSum(setOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))  <span class="comment">// Set isn&#x27;t a list, so an exception is thrown.</span></span><br><span class="line">IllegalArgumentException: List <span class="keyword">is</span> expected</span><br><span class="line">&gt;&gt;&gt; printSum(listOf(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>))  <span class="comment">// The cast succeeds, and another exception is thrown later.</span></span><br><span class="line">ClassCastException: String cannot be cast to Number</span><br></pre></td></tr></table></figure>
<p>Kotlinçš„æ™ºèƒ½è½¬æ¢å¯ä»¥åœ¨ç¼–è¯‘æœŸæ ¡éªŒå®ƒçš„ç±»å‹ä¿¡æ¯ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">printSum</span><span class="params">(c: <span class="type">Collection</span>&lt;<span class="type">Int</span>&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (c <span class="keyword">is</span> List&lt;<span class="built_in">Int</span>&gt;)  <span class="comment">// This check is legitimate.</span></span><br><span class="line">    println(c.sum())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; printSum(listOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥æ ¡éªŒ<code>c</code>æ˜¯å¦æ˜¯<code>List&lt;Int&gt;</code>ï¼Œå› ä¸ºç¼–è¯‘æœŸå·²ç»ç¡®å®šäº†è¯¥é›†åˆç±»å‹ã€‚</p>
<p>é€šå¸¸ï¼ŒKotlinç¼–è¯‘æœŸä¼šå¤„ç†å¥½å“ªäº›ç±»å‹æ˜¯å±é™©çš„(ç¦æ­¢<code>is</code>æ ¡éªŒå’ŒæŠ›å‡º<code>as</code>è½¬æ¢çš„å‘Šè­¦)ã€‚ä½ ä»…éœ€è¦çŸ¥é“å‘Šè­¦çš„å«ä¹‰å¹¶ç†è§£æ“ä½œæ˜¯å¦æ˜¯å®‰å…¨çš„ã€‚</p>
<p>å‰é¢æåŠåˆ°Kotlinæœ‰åŠæ³•å¯ä»¥æŒ‡å®šç±»å‹å‚æ•°ï¼Œä½†ä»…å…è®¸åœ¨<code>inline</code>å†…è”å‡½æ•°ä½¿ç”¨ã€‚ä¸‹é¢çœ‹çœ‹æ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚</p>
<h3 id="Declaring-functions-with-reified-type-parameters"><a class="header-anchor" href="#Declaring-functions-with-reified-type-parameters">Â¶</a>Declaring functions with reified type parameters</h3>
<p>å‰é¢æåˆ°ï¼ŒKotlinçš„æ³›å‹å’ŒJavaä¸€æ ·ï¼Œéƒ½æ˜¯è¿è¡ŒæœŸæ“¦é™¤çš„ï¼Œæ„å‘³ç€å¦‚æœä¸€ä¸ªæ³›å‹ç±»çš„å®ä¾‹ï¼Œåœ¨å®ä¾‹è¢«åˆ›å»ºæ—¶æ— æ³•å¾—çŸ¥å®ƒçš„ç±»å‹å‚æ•°ã€‚æ³›å‹å‡½æ•°ä¹Ÿä¸€æ ·ã€‚å½“ä½ è°ƒç”¨ä¸€ä¸ªæ³›å‹å‡½æ•°æ—¶ï¼Œæ— æ³•åœ¨è°ƒç”¨æ—¶å†³å®šbodyçš„ç±»å‹å‚æ•°ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">isA</span><span class="params">(value: <span class="type">Any</span>)</span></span> = value <span class="keyword">is</span> T</span><br><span class="line">ERROR: Cannot check <span class="keyword">for</span> instance of erased type: T</span><br></pre></td></tr></table></figure>
<p>é€šå¸¸è¿™æ˜¯æ­£ç¡®çš„ï¼Œä½†æœ‰ä¸€ç§æƒ…å†µå¯ä»¥é¿å…è¿™ç§é™åˆ¶ï¼šå†…è”å‡½æ•°ã€‚å†…è”å‡½æ•°çš„ç±»å‹å‚æ•°å¯ä»¥å…·ç°åŒ–ï¼Œæ„å‘³ç€ä½ å¯ä»¥å¼•ç”¨åˆ°è¿è¡ŒæœŸçš„çœŸå®çš„ç±»å‹å‚æ•°ã€‚</p>
<p>Kotlinçš„å†…è”å‡½æ•°ï¼Œåœ¨ç¼–è¯‘æœŸæ˜¯è¢«æ›¿æ¢ä¸ºçœŸå®ä»£ç å®ç°çš„ã€‚æ ‡è®°ä¸€ä¸ª<code>inline</code>å‡½æ•°å¯ä»¥æä¾›æ€§èƒ½ï¼Œå¦‚æœè¯¥å‡½æ•°ä½¿ç”¨lambdaè¡¨è¾¾å¼ä½œä¸ºå…¥å‚çš„è¯ï¼šlambdaä»£ç è¢«å†…è”ï¼ŒåŒ¿åç±»è¢«åˆ›å»ºã€‚è¿™é‡Œæ˜¾å¼<code>inline</code>å‡½æ•°å¦ä¸€ä¸ªæœ‰ç”¨çš„åœºæ™¯ï¼šç±»å‹å‚æ•°å¯ä»¥è¢«å…·ç°(reified)ã€‚</p>
<p>æ›´æ”¹å‰é¢çš„å‡½æ•°<code>isA</code>ï¼Œæ ‡è®°ä¸Š<code>inline</code>åï¼Œç±»å‹å‚æ•°ä½œä¸º<code>reified</code>ï¼Œç°åœ¨ä½ å¯ä»¥æ ¡éªŒ<code>value</code>çš„å®ä¾‹ç±»å‹<code>T</code>ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">isA</span><span class="params">(value: <span class="type">Any</span>)</span></span> = value <span class="keyword">is</span> T  <span class="comment">// Now this code compiles.</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; println(isA&lt;String&gt;(<span class="string">&quot;abc&quot;</span>))</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&gt;&gt;&gt; println(isA&lt;String&gt;(<span class="number">123</span>))</span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>çœ‹çœ‹ä¸€äº›å…¶å®ƒå¾ˆå°‘ç”¨åˆ°çš„å…·ç°åŒ–çš„ä¾‹å­ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> items = listOf(<span class="string">&quot;one&quot;</span>, <span class="number">2</span>, <span class="string">&quot;three&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; println(items.filterIsInstance&lt;String&gt;())</span><br><span class="line">[one, threee]</span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒæŒ‡å®šäº†<code>&lt;String&gt;</code>ä½œä¸ºç±»å‹å‚æ•°ã€‚å› æ­¤å®ƒè¿”å›<code>List&lt;String&gt;</code>ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ<em>the type argument is known at runtime</em> ï¼Œ<code>filterIsInstance</code>è¢«ç”¨æ¥æ ¡éªŒlistå®ä¾‹çš„å…·ä½“ç±»å‹ã€‚</p>
<p>ä¸‹é¢æ˜¯å®ƒçš„æ ‡å‡†åº“å®ç°ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span>  // &quot;<span class="keyword">reified</span>&quot; declares that this type parameter will not be erased at runtime.</span></span><br><span class="line">	Iterable&lt;*&gt;.filterIsInstance(): List&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">val</span> destination = mutableListOf&lt;T&gt;()</span><br><span class="line">  <span class="keyword">for</span> (element <span class="keyword">in</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (element <span class="keyword">is</span> T) &#123;  <span class="comment">// You can check whether the element is an instance of the class sepcified as a type argument.</span></span><br><span class="line">	  destination.add(element)</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> destination</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Why reification works for inline functions only</strong></p>
<p>ç¼–è¾‘å™¨å°†å­—èŠ‚ç æ’å…¥åˆ°å¯¹åº”çš„å†…è”å‡½æ•°çš„è°ƒç”¨éƒ¨åˆ†ã€‚æ¯æ¬¡è°ƒç”¨å¸¦æœ‰reified ç±»å‹å‚æ•°çš„å‡½æ•°ï¼Œç¼–è¯‘å™¨éƒ½çŸ¥é“å®ƒçš„çœŸå®ç±»å‹ã€‚å› æ­¤ç¼–è¯‘å™¨å¯ä»¥ç”Ÿæˆç›¸åº”ç‰¹å®šç±»å‹å‚æ•°å¯¹åº”ç±»çš„å­—èŠ‚ç ã€‚å®é™…ä¸Šï¼Œ<code>filterIsInstance&lt;String&gt;</code>è°ƒç”¨çš„ç­‰ä»·å­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (element <span class="keyword">in</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (element <span class="keyword">is</span> String) &#123;  <span class="comment">// References a specific class.</span></span><br><span class="line">    destination.add(element)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºç”Ÿæˆçš„å­—èŠ‚ç å¼•ç”¨ä¸€ä¸ªç‰¹å®šçš„ç±»ï¼Œè€Œä¸æ˜¯ç±»å‹å‚æ•°ï¼Œå®ƒä¸ä¼šåœ¨è¿è¡Œæ—¶æ”¶åˆ°ç±»å‹æ“¦é™¤çš„å½±å“ã€‚</p>
<p>æ³¨æ„å¸¦æœ‰<code>reified</code>ç±»å‹å‚æ•°çš„<code>inline</code>å‡½æ•°ä¸èƒ½è¢«Javaæ‰€è°ƒç”¨ã€‚å¸¸è§„çš„å†…è”å‡½æ•°å¯ä»¥è¢«Javaä½œä¸ºæ™®é€šå‡½æ•°è®¿é—®â€”â€”ä½†ä¸æ˜¯å†…è”çš„ã€‚å¸¦æœ‰reifiedç±»å‹å‚æ•°çš„å†…è”å‡½æ•°è¦æ±‚é¢å¤–çš„å­—èŠ‚ç æ›¿æ¢æ“ä½œï¼Œå› ä¸ºå®ƒå¿…é¡»æ˜¯å†…è”çš„ã€‚æ‰€ä»¥æ— æ³•ä»æ™®é€šçš„æ–¹å¼è°ƒç”¨å®ƒï¼ŒJavaä»£ç ä¹Ÿä¸€æ ·ã€‚</p>
</blockquote>
<p>å†…è”å‡½æ•°å¯ä»¥æœ‰å¤šä¸ªå…·ç°åŒ–å‚æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ã€‚å› ä¸ºå†…è”å‡½æ•°å¸¦æ¥æ€§èƒ½æä¾›çš„å”¯ä¸€å‰ææ˜¯å‡½æ•°çš„å…¥å‚æ˜¯ä¸€ä¸ªlambdaè¡¨è¾¾å¼ï¼Œä½†è¿™é‡Œçš„<code>filterIsInstance</code>æ²¡æœ‰ä»»ä½•å…¥å‚ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>inline</code>å‡½æ•°å¹¶ä¸æ˜¯ä½œä¸ºæ€§èƒ½æå‡çš„åŸå› ï¼›ç›¸åï¼Œç”¨äºç±»å‹å‚æ•°å…·ç°åŒ–ã€‚</p>
<p>ä¸ºäº†ç¡®ä¿è‰¯å¥½çš„æ€§èƒ½ï¼Œä½ ä»ç„¶éœ€è¦å…³æ³¨<code>inline</code>å‡½æ•°ç¼–è¯‘åçš„å†…å­˜å ç”¨å¤§å°ã€‚å¦‚æœå‡½æ•°å˜å¾—å¤ªå¤§ï¼Œæœ€å¥½é‡æ„æå–å‡ºä¸ä¾èµ–reifiedç±»å‹å‚æ•°çš„éå†…è”éƒ¨åˆ†å‡½æ•°ã€‚</p>
<h3 id="Replacing-class-references-with-reified-type-parameters"><a class="header-anchor" href="#Replacing-class-references-with-reified-type-parameters">Â¶</a>Replacing class references with reified type parameters</h3>
<p>å…·ç°åŒ–ç±»å‹å‚æ•°çš„ä¸€ä¸ªå¸¸è§„ç”¨æ³•æ˜¯ä¸º<code>java.lang.Class</code>æ„å»ºAPIé€‚é…å™¨ã€‚ä¾‹å¦‚æ¥è‡ªJDKçš„APIæ˜¯<code>ServiceLoader</code>ï¼Œæ¥æ”¶ä¸€ä¸ª<code>java.lang.Class</code>ä½œä¸ºæ¥å£æˆ–æŠ½è±¡ç±»ä½œä¸ºå‚æ•°å¹¶è¿”å›è¯¥ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚æˆ‘ä»¬çœ‹çœ‹å…·ç°åŒ–ç±»å‹å‚æ•°å¦‚ä½•è°ƒç”¨å®ç°ã€‚</p>
<p>è¦ä½¿ç”¨Java APIç±»<code>ServiceLoader</code>ï¼Œå¯ä»¥å¦‚ä¸‹è°ƒç”¨ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> serviceImpl = ServiceLoader.load(Service::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>
<p><code>::class.java</code>è¯­æ³•æ˜¾å¼äº†å¦‚ä½•è·å¾—ä¸€ä¸ª<code>java.lang.Class</code>å¯¹åº”çš„Kotlinç±»ã€‚å®é™…ä¸Šç­‰ä»·äºJavaçš„<code>Service.class</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…·ç°åŒ–å†…è”å‡½æ•°é‡å†™è¿™ä¸ªä¾‹å­ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> serviceImpl = loadService&lt;Service&gt;()</span><br></pre></td></tr></table></figure>
<p>æ›´ç®€çŸ­ã€‚ç°åœ¨è¯¥ç±»ä¸ä½œä¸ºå…¥å‚è€Œæ˜¯ä½œä¸ºç±»å‹å‚æ•°ä½¿ç”¨ã€‚ä¸‹é¢é‡å®šä¹‰<code>loadService</code>å†…è”å‡½æ•°ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">loadService</span><span class="params">()</span></span> &#123;  <span class="comment">// The type parameter is marked as &quot;refied&quot;.</span></span><br><span class="line">  <span class="keyword">return</span> ServiceLoader.load(T::<span class="keyword">class</span>.java)  <span class="comment">// Accesses the class of the type parameter as T::class</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨åŒæ ·çš„<code>::class.java</code>è¯­æ³•åœ¨å…·ç°åŒ–ç±»å‹å‚æ•°ä¸Šã€‚å› ä¸ºå®ƒæ˜¯è¿è¡ŒæœŸæ›¿æ¢çš„ã€‚</p>
<blockquote>
<p><strong>Simplifying the startActivity function on Android</strong></p>
<p>å¦‚æœä½ æ˜¯Androidå¼€å‘è€…ï¼Œä½ å¯èƒ½å‘ç°å¦å¤–ä¸€ä¸ªæ›´ç›¸ä¼¼çš„ä¾‹å­ï¼šshowing activities. å–ä»£<code>java.lang.Class</code>è¿›è¡Œä¼ é€’ï¼Œä½ å¯ä»¥ä½¿ç”¨å…·ç°åŒ–ç±»å‹å‚æ•°ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T : Activity&gt;</span></span></span><br><span class="line">        Context.startActivity() &#123;  <span class="comment">// The type parameter is marked as &quot;reified&quot;.</span></span><br><span class="line">  <span class="keyword">val</span> intent = Intent(<span class="keyword">this</span>, T::<span class="keyword">class</span>.java)  <span class="comment">// Accesses the class of the type parameter as T::class</span></span><br><span class="line">  startActivity(intent)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startActivity&lt;DetailActivity&gt;()  <span class="comment">// Invokes the method to show an activity</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Restrictions-on-reified-type-parameters"><a class="header-anchor" href="#Restrictions-on-reified-type-parameters">Â¶</a>Restrictions on reified type parameters</h3>
<p>å°½ç®¡å…·ç°åŒ–ç±»å‹å‚æ•°éå¸¸æœ‰ç”¨ï¼Œä½†å®ƒæœ‰æŸäº›é™åˆ¶ã€‚æŸäº›ç»§æ‰¿äº†è¿™äº›æ¦‚å¿µï¼Œå…¶å®ƒçš„ç‰¹æ€§åˆ™å–å†³äºå½“å‰çš„å®ç°åˆè·å–åœ¨å°†æ¥çš„Kotlinç‰ˆæœ¬ä¸åŠ çº¦æŸã€‚</p>
<p>æ›´å…·ä½“æ¥è¯´ï¼Œä¸‹é¢æ˜¯å¦‚ä½•ä½¿ç”¨ä¸€ä¸ªå…·ç°åŒ–ç±»å‹å‚æ•°ï¼š</p>
<ul>
<li>In type checks and casts(<code>is</code>ã€<code>!is</code>ã€<code>as</code>ã€<code>as?</code>)</li>
<li>To use the Kotlin reflection APIs(<code>::class</code>)</li>
<li>To get the corresponding <code>java.lang.Class</code>(<code>::class.java</code>)</li>
<li>As a type argument to call other functions</li>
</ul>
<p>ä½  <em>ä¸å¯ä»¥</em> å¦‚ä¸‹åšï¼š</p>
<ul>
<li>Create new instances of the class specified as a type parameter</li>
<li>Call methods on the companion object of the type parameter class</li>
<li>Use a non-reified type parameter as a type argument when calling a function with reified type parameter</li>
<li>Mark type parameters of classes, properties, or non-inline functions as <code>reified</code></li>
</ul>
<p>æœ€åä¸€ä¸ªçº¦æŸå¯¼è‡´ä¸€ä¸ªæœ‰è¶£çš„ç»“æœï¼šå› ä¸ºå…·ç°åŒ–ç±»å‹å‚æ•°ä»…èƒ½è¢«ç”¨äºå†…è”å‡½æ•°ï¼Œä½¿ç”¨ä¸€ä¸ªå…·ç°åŒ–ç±»å‹å‚æ•°æ„å‘³ç€å‡½æ•°è¿ç€æ‰€æœ‰ä¼ å…¥çš„lambdaéƒ½æ˜¯è¢«å†…è”çš„ã€‚å¦‚æœç”±äºä½¿ç”¨æ–¹å¼å¯¼è‡´lambdaä¸è¢«å†…è”ï¼Œæˆ–è€…ç”±äºæ€§èƒ½çš„åŸå› ä¸å¸Œæœ›å…¶è¢«å†…è”ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>noinline</code>ä¿®æ”¹å™¨æ¯”è¾ƒä¸è®©å…¶å†…è”ã€‚</p>
<h2 id="Variance-generics-and-subtyping"><a class="header-anchor" href="#Variance-generics-and-subtyping">Â¶</a>Variance: generics and subtyping</h2>
<p><em>åå˜(variance)</em> çš„æ¦‚å¿µæè¿°åŒä¸€ä¸ªåŸºç¡€ç±»å‹åœ¨ä¸åŒç±»å‹å‚æ•°å¦‚ä½•å…³è”ï¼šä¾‹å¦‚ï¼Œ<code>List&lt;String&gt;</code>å’Œ<code>List&lt;Any&gt;</code>ã€‚é¦–å…ˆæˆ‘ä»¬å°†æè¿°ä¸ºä»€ä¹ˆè¿™ç§å…³è”å…³ç³»çš„é‡è¦æ€§ï¼Œä»¥åŠåœ¨Kotlinä¸­å¦‚ä½•è¡¨è¿°ã€‚ç†è§£åå˜æ˜¯ç¼–å†™æ³›å‹ç±»æˆ–å‡½æ•°çš„æœ¬è´¨ï¼šå®ƒå¸®åŠ©ä½ åˆ›å»ºAPIä¸å¼ºåˆ¶ç”¨æˆ·ä»¥ä¸æ–¹ä¾¿çš„æ–¹å¼æ‰“ç ´ä»–ä»¬çš„ç±»å‹å®‰å…¨æœŸæœ›ã€‚</p>
<h3 id="Why-variance-exists-passing-an-argument-to-a-function"><a class="header-anchor" href="#Why-variance-exists-passing-an-argument-to-a-function">Â¶</a>Why variance exists: passing an argument to a function</h3>
<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ª<code>List&lt;Any&gt;</code>ä½œä¸ºå‚æ•°ã€‚ä¼ é€’<code>List&lt;String&gt;</code>ç±»å‹å˜é‡ç»™è¯¥å‡½æ•°æ˜¯å®‰å…¨çš„å—ï¼Ÿå½“ç„¶æ˜¯å®‰å…¨çš„ï¼Œå› ä¸º<code>String</code>ç±»ç»§æ‰¿è‡ª<code>Any</code>ã€‚ä½†å½“<code>Any</code>å’Œ<code>String</code>å˜ä¸º<code>List</code>æ¥å£çš„ç±»å‹å‚æ•°æ—¶ï¼Œè¯­ä¹‰ä¸å†æ¸…æ™°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªå‡½æ•°æ‰“å°å†…å®¹åˆ°æ§åˆ¶å°ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">printContents</span><span class="params">(list: <span class="type">List</span>&lt;<span class="type">Any</span>&gt;)</span></span> &#123;</span><br><span class="line">   println(list.joinToString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; printContents(listOf(<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;bac&quot;</span>))</span><br><span class="line">abc, bac</span><br></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¥å­—ç¬¦ä¸²å¯ä»¥å·¥ä½œã€‚è¯¥å‡½æ•°æŠŠæ¯ä¸ªå…ƒç´ çœ‹åšæ˜¯<code>Any</code>ï¼Œç„¶åæ¯ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯<code>Any</code>ï¼Œå®ƒæ˜¯å®‰å…¨çš„ã€‚</p>
<p>ç°åœ¨çœ‹çœ‹å¦ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†ä¿®æ”¹list(æ‰€ä»¥ç”¨åˆ°<code>MutableList</code>ä½œä¸ºå‚æ•°)ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">addAnswer</span><span class="params">(list: <span class="type">MutableList</span>&lt;<span class="type">Any</span>&gt;)</span></span> &#123;</span><br><span class="line">  list.add(<span class="number">42</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¼ é€’å­—ç¬¦ä¸²listä¼šæ€æ ·ï¼Ÿ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> strings = mutableListOf(<span class="string">&quot;abc&quot;</span>, <span class="string">&quot;bac&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; addAnswer(strings)  <span class="comment">// If this line compiled...</span></span><br><span class="line">&gt;&gt;&gt; println(strings.maxBy &#123; it.length &#125;)  <span class="comment">// ...you&#x27;d get an exception at runtime.</span></span><br><span class="line">ClassCastException: Integer cannot be cast to String</span><br></pre></td></tr></table></figure>
<p>ä½ å£°æ˜ä¸€ä¸ª<code>string</code>çš„ç±»å‹<code>MutableList&lt;String&gt;</code>å˜é‡ã€‚ç„¶åä¼ é€’ç»™è¯¥å‡½æ•°ã€‚å¦‚æœç¼–è¯‘å™¨æ¥æ”¶å®ƒï¼Œä½ ä¾¿å¯ä»¥åœ¨è¯¥listæ·»åŠ ä¸€ä¸ªæ•´æ•°ï¼Œå½“å°è¯•è®¿é—®è¿™ä¸ªlistçš„å†…å®¹è¿™å°†å¯¼è‡´è¿è¡Œæ—¶å¼‚å¸¸ã€‚æ­£å› å¦‚æ­¤ï¼Œè¯¥è°ƒç”¨æ— æ³•ç¼–è¯‘ã€‚è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ä¼ é€’ä¸€ä¸ª<code>MutableList&lt;String&gt;</code>ä½œä¸ºå‚æ•°ä½†å´å—åˆ°ä¸€ä¸ª<code>MutableList&lt;Any&gt;</code>æ˜¯ä¸å®‰å…¨çš„ï¼›Kotlinç¼–è¯‘å™¨ç¦æ­¢è¿™æ ·åšã€‚</p>
<p>ç”±äºç±»å‹çš„ä¸ä¸€è‡´æ€§ï¼Œæ·»åŠ æˆ–æ›¿æ¢listä¸­çš„å…ƒç´ æ˜¯ä¸å®‰å…¨çš„ã€‚å…¶å®ƒè¡Œä¸ºåˆ™æ˜¯å®‰å…¨çš„ã€‚åœ¨Kotlinä¸­ï¼Œå¦‚æœæ¥å£æ­£ç¡®å¯ä»¥å¾ˆå¥½æ§åˆ¶ã€‚</p>
<h3 id="Classes-types-and-subtypes"><a class="header-anchor" href="#Classes-types-and-subtypes">Â¶</a>Classes, types, and subtypes</h3>
<p>æŸäº›æƒ…å†µä¸‹<code>type</code>å’Œ<code>class</code>æ˜¯ç­‰ä»·çš„ï¼ŒæŸäº›æƒ…å†µä¸‹ä¸æ˜¯ã€‚</p>
<p>åœ¨éæ³›å‹ç±»ä¸­ï¼Œç±»åå¯ä»¥ç›´æ¥ç”¨ä½œç±»å‹ã€‚ä¾‹å¦‚ï¼Œ<code>var x: String</code>ç›´æ¥å£°æ˜çš„å˜é‡çš„ç±»å‹å°±æ˜¯<code>String</code>ç±»ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥å£°æ˜ä¸ºå¯ç©ºç±»å‹ï¼Œ<code>var x: String?</code>ã€‚</p>
<p>åœ¨æ³›å‹ç±»ä¸­ï¼Œè¦è·å¾—æœ‰æ•ˆçš„ç±»å‹ï¼Œéœ€è¦åœ¨è¿è¡Œæ—¶æ›¿æ¢çœŸå®çš„ç±»å‹ï¼Œè­¬å¦‚<code>List</code>ä¸æ˜¯ä¸€ä¸ªç±»å‹(å®ƒæ˜¯ä¸€ä¸ªç±»)ï¼Œä½†ä¸‹åˆ—çš„æƒ…å†µæ˜¯æœ‰æ•ˆçš„ç±»å‹ï¼š<code>List&lt;Int&gt;</code>ã€<code>List&lt;String?&gt;</code>ã€<code>List&lt;List&lt;String&gt;&gt;</code>ï¼Œç­‰ç­‰ã€‚æ¯ä¸ªæ³›å‹ç±»äº§ç”Ÿä¸€ä¸ªå¯èƒ½çš„æ— é™ç±»å‹ã€‚</p>
<p>ä¸ºäº†è®©æˆ‘ä»¬è®¨è®ºç±»å‹ç›´æ¥çš„å…³ç³»ï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰å±äº <em>subtype</em> ã€‚å®ƒçš„å¯¹ç«‹æ˜¯ <em>supertype</em> ã€‚å­ç±»å‹å’Œçˆ¶ç±»å‹çš„å…³ç³»æœ‰å¦‚ä¸‹ï¼š</p>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_04.png" alt="Figure 9.4"></p>
<p>ä¸ºä»€ä¹ˆä¸€ä¸ªç±»å‹åˆ°åº•æ˜¯å­ç±»å‹æˆ–å…¶å®ƒç±»å‹å¦‚æ­¤é‡è¦ï¼Ÿç¼–è¯‘å™¨æ¯æ¬¡éƒ½å¯¹ä¼ é€’ç»™å‡½æ•°çš„å˜é‡è¿›è¡Œæ£€æŸ¥ã€‚è€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">(i: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> n: Number = i  <span class="comment">// Compiles, because Int is a subtype of Number</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">f</span><span class="params">(s: <span class="type">String</span>)</span></span> &#123; <span class="comment">/*..*/</span> &#125;</span><br><span class="line">  f(i)  <span class="comment">// Doesn&#x27;t compile, because Int isn&#x27;t a subtype of String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ä¸€ä¸ªå€¼å­˜å‚¨åœ¨å˜é‡ä»…å½“è¯¥å€¼çš„ç±»å‹æ˜¯è¯¥å˜é‡çš„å­ç±»å‹ï¼›ä¾‹å¦‚ï¼Œè¿™é‡Œçš„<code>i</code>çš„ç±»å‹æ˜¯<code>Int</code>ï¼Œ<code>Int</code>æ˜¯<code>Number</code>çš„å­ç±»å‹ï¼Œå®ƒå¯ä»¥å­˜å‚¨åœ¨<code>n</code>å˜é‡ä¸­ï¼›ä½†å®ƒä¸æ˜¯<code>String</code>çš„å­ç±»å‹ï¼Œç¼–è¯‘å°†ä¸é€šè¿‡ã€‚</p>
<p>æŸäº›æƒ…å†µä¸‹ï¼Œå­ç±»ç­‰åŒäºå­ç±»å‹çš„ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œ<code>Int</code>æ˜¯<code>Number</code>çš„å­ç±»ï¼Œå› æ­¤<code>Int</code>ç±»å‹æ˜¯<code>Number</code>ç±»å‹çš„å­ç±»å‹ã€‚</p>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_05.png" alt="Figure 9.5"></p>
<p>éç©ºç±»å‹æ˜¯å¯ç©ºç±»å‹çš„å­ç±»å‹ï¼Œåä¹‹åˆ™ä¸æ˜¯ï¼Œå› ä¸ºæ²¡æœ‰åŒ…å«å…³ç³»ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> s: String = <span class="string">&quot;abc&quot;</span></span><br><span class="line"><span class="keyword">val</span> t: String? = s  <span class="comment">// This assignment is legal because String is a subtype of String?.</span></span><br></pre></td></tr></table></figure>
<p>è¯¸å¦‚<code>MutableList</code>è¿™æ ·çš„æ³›å‹ç±»ï¼Œå®ƒçš„ç±»å‹å‚æ•°æ˜¯ä¸å¯å˜çš„ï¼Œå¯¹äºä¸¤ä¸ªä¸åŒçš„ç±»å‹Aå’ŒBï¼Œ<code>MutableList&lt;A&gt;</code>ä¸æ˜¯<code>MutableList&lt;B&gt;</code>çš„å­ç±»å‹æˆ–çˆ¶ç±»å‹ã€‚åœ¨Javaä¸­ï¼Œæ‰€æœ‰ç±»å‹éƒ½æ˜¯ä¸å¯å˜çš„(invariant)ã€‚</p>
<h3 id="Covariance-preserved-subtyping-relation"><a class="header-anchor" href="#Covariance-preserved-subtyping-relation">Â¶</a>Covariance: preserved subtyping relation</h3>
<p>æ³›å‹ç±»çš„åå˜ç±»éµå¾ªä¸‹é¢è§„åˆ™ï¼š<code>Producer&lt;A&gt;</code>æ˜¯<code>Producer&lt;B&gt;</code>çš„å­ç±»å‹å½“<code>A</code> æ˜¯<code>B</code>çš„å­ç±»å‹ã€‚å®ƒæ˜¯ <em>å­ç±»å‹ä¿ç•™çš„(subtyping is preserved)</em> ã€‚ä¾‹å¦‚ï¼Œ<code>Producer&lt;Cat&gt;</code>æ˜¯<code>Producer&lt;Animal&gt;</code>çš„å­ç±»å‹ï¼Œå› ä¸º<code>Cat</code>æ˜¯<code>Animal</code>çš„å­ç±»å‹ã€‚</p>
<p>åœ¨Kotlin ä¸­å£°æ˜ä¸€ä¸ªç±»æˆä¸ºåå˜ç±»ï¼Œä½¿ç”¨<code>out</code>å…³é”®å­—åœ¨ç±»å‹å‚æ•°å‰ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Producer</span>&lt;<span class="type">out T</span>&gt; &#123; <span class="comment">// This class is declared as covariant on T.</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ä¸€ä¸ªç±»çš„ç±»å‹å‚æ•°åå˜ï¼Œå¯ä»¥ä»¤å‚æ•°ä¸ºè¯¥ç±»çš„å‡½æ•°ï¼Œå…¥å‚å¯ä»¥ä¸åŒ¹é…å‡½æ•°å®šä¹‰ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">feed</span><span class="params">()</span></span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Herd</span>&lt;<span class="type">out T: Animal</span>&gt; &#123;  <span class="comment">// The type parameter is now covariant.</span></span><br><span class="line">  <span class="keyword">val</span> size: <span class="built_in">Int</span> <span class="keyword">get</span>() = ...</span><br><span class="line">  <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(i: <span class="type">Int</span>)</span></span>: T &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">feedAll</span><span class="params">(animals: <span class="type">Herd</span>&lt;<span class="type">Animal</span>&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until animals.size) &#123;</span><br><span class="line">    animals[i].feed()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">takeCareOfCats</span><span class="params">(cats: <span class="type">Herd</span>&lt;<span class="type">Cat</span>&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span>(i <span class="keyword">in</span> <span class="number">0</span> until cats.size) &#123;</span><br><span class="line">    cats[i].cleanLitter()</span><br><span class="line">  &#125;</span><br><span class="line">  feedAll(cats)  <span class="comment">// You don&#x27;t need a cast.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ ä¸èƒ½ä»¤ä»»ä½•ç±»éƒ½æ˜¯åå˜çš„ï¼šä¼šå¯¼è‡´ä¸å®‰å…¨ã€‚</p>
<p>å‡è®¾ä¸€ä¸ªç±»å£°æ˜äº†ç±»å‹å‚æ•°<code>T</code>å¹¶ä¸”åŒ…å«ä¸€ä¸ªå‡½æ•°ä½¿ç”¨äº†<code>T</code>ã€‚æˆ‘ä»¬è¯´<code>T</code>ä½œä¸ºå‡½æ•°çš„è¿”å›ç±»å‹æ—¶ï¼Œæ˜¯åœ¨<code>out</code>ä½ç½®ã€‚å¦‚æœ<code>T</code>ä½œä¸ºå‡½æ•°çš„ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯åœ¨<code>in</code>ä½ç½®ã€‚</p>
<p><img src="/img/kotlin-in-action/chapter06/Figure_09_06.png" alt="Figure 9.6"></p>
<p><code>out</code>ä½ç½®è¦æ±‚æ‰€æœ‰ç”¨åˆ°çš„ç±»å‹å‚æ•°æ‰€å¯¹åº”çš„<code>T</code>ä»…èƒ½åœ¨å£°æ˜äº†<code>out</code>çš„ç±»å‹å…³è”ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œ<code>Hered</code>ç±»ä½¿ç”¨äº†<code>T</code>å°±åœ¨<code>out</code>çš„ä½ç½®ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Herd</span>&lt;<span class="type">out T: Animal</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">val</span> size: <span class="built_in">Int</span> <span class="keyword">get</span>() = ...</span><br><span class="line">  <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(i: <span class="type">Int</span>)</span></span>: T &#123; ... &#125;  <span class="comment">// Uses T as the return type</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>out</code>å…³é”®å­—åœ¨<code>T</code>ç±»å‹å‚æ•°æ„å‘³ç€ï¼š</p>
<ul>
<li>å­ç±»å‹æ˜¯è¢«ä¿ç•™çš„(<code>Producer&lt;Cat&gt;</code>æ˜¯<code>Producer&lt;Animal&gt;</code>çš„å­ç±»å‹)</li>
<li><code>T</code>ä»…èƒ½è¢«ç”¨äº<code>out</code>ä½ç½®ã€‚</li>
</ul>
<p>ç°åœ¨åœ¨çœ‹ä¸‹<code>List&lt;T&gt;</code>æ¥å£ã€‚Kotlinçš„<code>List</code>æ˜¯åªè¯»çš„ï¼Œå®ƒåªæœ‰ä¸€ä¸ª<code>get</code>æ–¹æ³•è¿”å›<code>T</code>ç±»å‹çš„å…ƒç´ ï¼Œå®ƒæ˜¯åå˜çš„ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">List</span>&lt;<span class="type">out T</span>&gt;: <span class="type">Collection</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(index: <span class="type">Int</span>)</span></span>: T  <span class="comment">// Read-only interface that defines only methods that return T (so T is in the &quot;out&quot; position</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ç±»å‹å‚æ•°ä¸ä»…æ˜¯ä½œä¸ºå‚æ•°çš„ç±»å‹æˆ–è¿”å›ç±»å‹ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå…¶å®ƒç±»å‹çš„ç±»å‹å‚æ•°ã€‚ä¾‹å¦‚ï¼Œ<code>List</code>æ¥å£åŒ…å«æ–¹æ³•<code>subList</code>è¿”å›<code>List&lt;T&gt;</code>ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">List</span>&lt;<span class="type">out T</span>&gt;: <span class="type">Collection</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">subList</span><span class="params">(fromIndex: <span class="type">Int</span>, toIndex: <span class="type">Int</span>)</span></span>: List&lt;T&gt;  <span class="comment">// Here T is in the &quot;out&quot; position as well.</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>T</code>ç”¨åœ¨<code>subList</code>å‡½æ•°çš„<code>out</code>ä½ç½®ã€‚</p>
<p>ä½†ä½ ä¸èƒ½å£°æ˜<code>MutableList&lt;T&gt;</code>ä½œä¸ºåå˜ç±»ï¼Œå› ä¸ºå®ƒåŒ…å«æ–¹æ³•æ¥æ”¶<code>T</code>ä½œä¸ºå‚æ•°å¹¶è¿”å›è¯¥å€¼(<code>T</code>åŒæ—¶å‡ºç°åœ¨<code>in</code>å’Œ<code>out</code>ä½ç½®)ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">MutableList</span>&lt;<span class="type">T</span>&gt;  // <span class="title">MutableList</span> <span class="title">can</span>&#x27;<span class="title">t</span> <span class="title">be</span> <span class="title">declared</span> <span class="title">a</span> <span class="title">covariant</span> <span class="title">on</span> <span class="title">T</span> ...</span><br><span class="line">		: List&lt;T&gt;, MutableCollection&lt;T&gt; &#123; </span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">add</span><span class="params">(element: <span class="type">T</span>)</span></span>: <span class="built_in">Boolean</span>  <span class="comment">// ...because T is used in the &quot;in&quot; postion.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨ä¸¥æ ¼æ‰§è¡Œè¯¥çº¦æŸã€‚å¦‚æœè¯¥ç±»è¢«å£°æ˜ä¸ºä¸€ä¸ªåå˜ä¼šæŠ¥é”™è¯¯ï¼š<code>Type parameter T is declared as 'out' but occurs in 'in' postion.</code>ã€‚</p>
<p>æ³¨æ„æ„é€ å‚æ•°æ—¢æ²¡æœ‰<code>in</code>ä¹Ÿæ²¡æœ‰<code>out</code>ã€‚å³ä½¿ä¸€ä¸ªç±»å‹å‚æ•°è¢«å£°æ˜ä¸º<code>out</code>ï¼Œä½ ä»ç„¶å¯ä»¥ä½¿ç”¨æ„é€ å‚æ•°çš„å£°æ˜ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Herd</span>&lt;<span class="type">out T: Animal</span>&gt;(vararge animals: T) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>æ„é€ å‡½æ•°ä¸æ˜¯æ–¹æ³•ï¼Œå®ƒåœ¨å®ä¾‹è¢«åˆ›å»ºåè°ƒç”¨ï¼Œå› æ­¤ä¸ä¼šæœ‰æ½œåœ¨çš„éšæ‚£ã€‚</p>
<p>ä½ å¯ä»¥åœ¨æ„é€ å‚æ•°ä½¿ç”¨<code>val</code>æˆ–<code>var</code>å…³é”®å­—ï¼Œä¹Ÿå¯ä»¥å£°æ˜ä¸€ä¸ªgetterå’Œsetter(mutable)ã€‚å› æ­¤ï¼Œç±»å‹å‚æ•°ç”¨åœ¨<code>out</code>ä½ç½®ä½œä¸ºåªè¯»å±æ€§ï¼ŒåŒæ—¶åœ¨<code>out</code>å’Œ<code>in</code>ä½ç½®åˆ™ä½œä¸ºä¸€ä¸ªå¯å˜(mutable)å±æ€§ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Herd</span>&lt;<span class="type">T: Animal</span>&gt;(<span class="keyword">var</span> leadAnimal: T, vararge animals: T) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å¯ä»¥ä»¤<code>Herd</code>å¯¹<code>T</code>åå˜ï¼Œå› ä¸º<code>leadAnimal</code>å±æ€§æ˜¯privateçš„ã€‚</p>
<h3 id="Contravariance-reversed-subtyping-relation"><a class="header-anchor" href="#Contravariance-reversed-subtyping-relation">Â¶</a>Contravariance: reversed subtyping relation</h3>
<p><em>é€†å˜(contravariance)</em> å¯ä»¥è®¤ä¸ºæ˜¯åå˜(covariance)çš„é•œåƒï¼šå¯¹äºé€†å˜ç±»ï¼Œå­ç±»å‹å…³è”çš„æ˜¯å®ƒçš„ç±»å‹å‚æ•°çš„å­ç±»å‹çš„åé¢ã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªä¾‹å­å¼€å§‹ï¼š<code>Comparator</code>æ¥å£ã€‚è¯¥æ¥å£å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œ<code>compare</code>ï¼Œæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Comparator</span>&lt;<span class="type">in T</span>&gt; &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">compare</span><span class="params">(e1: <span class="type">T</span>, e2: <span class="type">T</span>)</span></span>: <span class="built_in">Int</span> &#123; .. &#125;  <span class="comment">// Uses T in &quot;in&quot; positions</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¯¥æ¥å£çš„å”¯ä¸€æ–¹æ³•ä»…æ¶ˆè´¹<code>T</code>ç±»å‹ã€‚æ„å‘³ç€<code>T</code>ä»…è¢«ç”¨äº<code>in</code>ä½ç½®ï¼Œå› æ­¤å®ƒçš„å£°æ˜å‰é¢æ˜¯<code>in</code>å…³é”®å­—ã€‚</p>
<p>å®šä¹‰äº†comparatorçš„ç±»å‹å€¼ï¼Œå¯ä»¥å¯¹è¯¥ç±»å‹çš„ä»»æ„å­ç±»å‹è¿›è¡Œæ¯”è¾ƒã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> anyComparator = Comparator&lt;Any&gt; &#123;</span><br><span class="line">...    e1, e2 -&gt; e1.hashCode() - e2.hashCode()</span><br><span class="line">... &#125;</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> strings: List&lt;String&gt; = ...</span><br><span class="line">&gt;&gt;&gt; strings.sortedWith(anyComparator)  <span class="comment">// You can use the comparator for any objects to compare specific objects, such as strings.</span></span><br></pre></td></tr></table></figure>
<p>æ„å‘³ç€<code>Comparator&lt;Any&gt;</code>æ˜¯<code>Comparator&lt;String&gt;</code>çš„å­ç±»å‹ï¼Œç„¶è€Œ<code>Any</code>æ˜¯<code>String</code>çš„è¶…ç±»å‹ã€‚ä¸¤ç§ç±»å‹çš„å­ç±»åŒ–å…³ç³»åˆšå¥½æ˜¯ç›¸åçš„ã€‚</p>
<p>ç°åœ¨å¯¹é€†å˜å‡†å¤‡çš„æ›´å……åˆ†çš„å®šä¹‰ã€‚ä¸€ä¸ªç±»å¦‚æœæ˜¯é€†å˜çš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸€ä¸ªæ³›å‹ç±»(ä»¥<code>Consumer&lt;T&gt;</code>ä¸ºä¾‹)ï¼Œå®ƒçš„æ³›å‹å‚æ•°éµå¾ªå¦‚ä¸‹ï¼šå¦‚æœ<code>B</code>æ˜¯<code>A</code>çš„è¶…ç±»å‹ï¼Œé‚£ä¹ˆ<code>Consumer&lt;A&gt;</code>æ˜¯<code>Consumer&lt;B&gt;</code>çš„å­ç±»å‹ã€‚ç±»å‹å‚æ•°<code>A</code>å’Œ<code>B</code>äº¤æ¢ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°å­ç±»åŒ–æ˜¯åè¿‡æ¥çš„ã€‚ä¾‹å¦‚ï¼Œ<code>Consumer&lt;Animal&gt;</code>æ˜¯<code>Consumer&lt;Cat&gt;</code>çš„å­ç±»å‹ã€‚</p>
<p>ä¸‹å›¾æ˜¾ç¤ºäº†åå˜å’Œé€†å˜çš„ç±»å‹å‚æ•°å­ç±»åŒ–çš„ä¸åŒæ¯”è¾ƒã€‚å¯ä»¥çœ‹åˆ°ï¼Œ<code>Producer</code>å’Œ<code>Consumer</code>çš„å­ç±»åŒ–å…³ç³»æ˜¯ç›¸åçš„ã€‚</p>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_07.png" alt="Figure 9.7"></p>
<p><code>in</code>å…³é”®å­—è¡¨ç¤ºç›¸åº”ç±»å‹çš„å€¼è¢« <em>passed in</em> åˆ°è¯¥ç±»çš„æ–¹æ³•æ¶ˆè´¹ã€‚ç±»ä¼¼äºåå˜ï¼Œå¯¹ç±»å‹å‚æ•°çš„çº¦æŸäº§ç”Ÿç‰¹å®šçš„å­ç±»åŒ–å…³ç³»ã€‚ç±»å‹<code>T</code>å¸¦æœ‰<code>in</code>å…³é”®å­—æ„å‘³ç€å­ç±»åŒ–è¢«åè½¬ï¼Œ<code>T</code>ä»…èƒ½è¢«ç”¨äº<code>in</code>ä½ç½®ã€‚ä¸‹æ ‡æ€»ç»“äº†å¯èƒ½çš„varianceçš„æƒ…å†µã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">Covariant</th>
<th style="text-align:left">Contravariant</th>
<th style="text-align:left">Invariant</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>Producer&lt;out T&gt;</code></td>
<td style="text-align:left"><code>Consumer&lt;in T&gt;</code></td>
<td style="text-align:left"><code>MutableList&lt;T&gt;</code></td>
</tr>
<tr>
<td style="text-align:left">Subtyping for the class is preserved: <code>Producer&lt;cat&gt;</code> is a subtype of <code>Producer&lt;Animal&gt;</code></td>
<td style="text-align:left">Subtyping is   reversed: <code>Consumer&lt;Animal&gt;</code> is a subtype of <code>Consumer&lt;Cat&gt;</code></td>
<td style="text-align:left">No subtyping</td>
</tr>
<tr>
<td style="text-align:left"><code>T</code> only in <code>out</code> positions</td>
<td style="text-align:left"><code>T</code> only in <code>in</code> positions</td>
<td style="text-align:left"><code>T</code> in any position</td>
</tr>
</tbody>
</table>
<p>ä¸€ä¸ªç±»æˆ–æ¥å£åŒæ—¶å¯ä»¥å¯¹ä¸€ä¸ªç±»å‹å‚æ•°åå˜(covariant)ï¼Œå¯¹å¦ä¸€ä¸ªç±»å‹é€†å˜(contravariant)ã€‚æœ€ç»å…¸çš„ä¾‹å­è«è¿‡äº<code>Function</code>æ¥å£ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç±»å‹å‚æ•°çš„<code>Function</code>å®šä¹‰ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Function1</span>&lt;<span class="type">in P, out R</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(p: <span class="type">P</span>)</span></span>: R</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä½¿ç”¨åˆ°äº†<code>operator</code>è§„çº¦ï¼Œè¯´æ˜å®ƒæœ‰æ›´ç®€å•çš„å†™æ³•<code>(P) -&gt; R</code>ã€‚è¿™é‡Œçœ‹åˆ°<code>P</code>æ ‡è®°ä¸º<code>in</code>å®ƒæ˜¯ä½œä¸ºå…¥å‚ï¼Œè€Œ<code>R</code>åˆ™ä½œä¸ºè¿”å›ç±»å‹ï¼Œç”¨<code>out</code>æ ‡è®°ä»…èƒ½ç”¨åœ¨<code>out</code>çš„ä½ç½®ã€‚æ„å‘³ç€å¯¹äºç¬¬ä¸€ä¸ªç±»å‹å‚æ•°<code>P</code>æ˜¯é€†å˜çš„ã€åè½¬çš„ï¼›è€Œå¯¹äºç¬¬äºŒä¸ªç±»å‹å‚æ•°<code>R</code>æ˜¯ä¿ç•™çš„ã€åå˜çš„ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">enumerateCats</span><span class="params">(f: (<span class="type">Cat</span>) -&gt; <span class="type">Number</span>)</span></span> &#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">fun</span> Animal.<span class="title">getIndex</span><span class="params">()</span></span>: <span class="built_in">Int</span> = ...</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; enumerateCats(Animal::getIndex)  <span class="comment">// This code is legal in Kotlin. Animal is a supertype of Cat, and Int is a subtype Of Number.</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾ä¸ºå…¶subtyping relationshipã€‚</p>
<p><img src="/img/kotlin-in-action/chapter09/Figure_09_08.png" alt="Figure 9.8"></p>
<h3 id="Use-site-variance-specifying-variance-for-type-occurrences"><a class="header-anchor" href="#Use-site-variance-specifying-variance-for-type-occurrences">Â¶</a>Use-site variance: specifying variance for type occurrences</h3>
<p>åœ¨ç±»çš„å£°æ˜ä¸ŠæŒ‡å®šå…¶å¯å˜æ€§çš„èƒ½åŠ›ä¼šå˜å¾—å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºä¿®æ”¹ä¼šä½œç”¨åˆ°è¯¥ç±»çš„ä½¿ç”¨çš„ä»»ä½•åœ°æ–¹ã€‚è¿™å«åš <em>declaration-site variance</em> ã€‚å¦‚æœä½ ç†Ÿæ‚‰Javaçš„é€šé…ç¬¦ç±»å‹(<code>? extends</code> å’Œ <code>? super</code>)ï¼Œä½ ä¼šæ„è¯†åˆ°Javaå¤„ç†å¯å˜æ€§çš„å·®å¼‚ã€‚åœ¨Javaä¸­ï¼Œæ¯æ¬¡ä½ éƒ½å¯ä»¥ä½¿ç”¨å­ç±»å‹æˆ–è¶…ç±»å‹æ¥æ›¿ä»£ã€‚è¿™å«åš <em>use-site variance</em> ã€‚</p>
<blockquote>
<p><strong>Declaration-site variance in Kotlin vs. Java wildcards</strong></p>
<p>Declaration-site variance çš„æ–¹å¼ä¼šä½¿å¾—ä»£ç æ›´åŠ ç®€æ˜æ‰¼è¦ï¼Œå› ä¸ºå¯å˜ç±»ä»…ä¿®æ”¹ä¸€æ¬¡ï¼Œå…¶å®ƒæ‰€æœ‰ç”¨åˆ°çš„åœ°æ–¹éƒ½ä¸ç”¨è€ƒè™‘ã€‚åœ¨Javaï¼ŒAPIçš„åˆ›å»ºè¡Œä¸ºä¾æ®ç”¨æˆ·çš„æœŸæœ›ï¼Œæ ‡å‡†åº“æ€»æ˜¯ä½¿ç”¨é€šé…ç¬¦ï¼š<code>Function&lt;? super T, ? extends R&gt;</code>ã€‚Java8æ ‡å‡†åº“åˆ°å¤„éƒ½ç”¨åˆ°<code>Function</code>æ¥å£ï¼Œä¾‹å¦‚<code>Stream.map</code>æ–¹æ³•çš„å£°æ˜å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Stream</span>&lt;T&gt; &#123;</span><br><span class="line">  &lt;R&gt; Stream&lt;R&gt; <span class="title function_">map</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends R&gt; mapper)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å£°æ˜åœ°æ–¹å¯¹å¯å˜ç±»å‹çš„ä¸€æ¬¡ä¿®æ”¹å³ç”Ÿæ•ˆå¯ä½¿çš„ä»£ç æ›´åŠ ç®€æ˜å’Œä¼˜é›…ã€‚</p>
</blockquote>
<p>Kotlin æ”¯æŒuse-site varianceï¼Œå…è®¸æŒ‡å®šå½“å‰çš„ç±»å‹å‚æ•°ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">copyData</span><span class="params">(source: <span class="type">MutableList</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">				destination: <span class="type">MutableList</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (item <span class="keyword">in</span> source) &#123;</span><br><span class="line">    destination.add(item)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°å°†å…ƒç´ ä»ä¸€ä¸ªé›†åˆcopyåˆ°å¦ä¸€ä¸ªé›†åˆã€‚å°½ç®¡ä¸¤ä¸ªé›†åˆéƒ½æ˜¯ä¸å¯å˜ç±»å‹ï¼Œä½†æºé›†åˆä»…ä»…ç”¨ä½œè¯»ï¼Œç›®æ ‡é›†åˆä»…ç”¨ä½œå†™ã€‚è¿™ç§æƒ…å†µï¼Œé›†åˆçš„å…ƒç´ ç±»å‹å¹¶ä¸éœ€è¦åŒ¹é…ã€‚ä½ å¯ä»¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²é›†åˆæ‹·è´åˆ°ä¸€ä¸ª<code>Any</code>ç±»å‹çš„é›†åˆå†…ã€‚</p>
<p>ä¸ºäº†ä¾¿äºæ¯”è¾ƒï¼Œæˆ‘ä»¬åœ¨è¯¥å‡½æ•°å¼•å…¥æ³›å‹å‚æ•°ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T: R, R&gt;</span> <span class="title">copyData</span><span class="params">(source: <span class="type">MutableList</span>&lt;<span class="type">T</span>&gt;,  <span class="comment">// Source&#x27;s element type should be a subtype of the destination&#x27;s element type</span></span></span></span><br><span class="line"><span class="params"><span class="function">						destination: <span class="type">MutableList</span>&lt;<span class="type">R</span>&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (item <span class="keyword">in</span> source) &#123;</span><br><span class="line">    destination.add(item)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> ints = mutableListOf(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> anyItems = mutableListOf&lt;Any&gt;()</span><br><span class="line">&gt;&gt;&gt; copyData(ints, anyItems)  <span class="comment">// You can call this function, because Int is a subtype of Any.</span></span><br><span class="line">&gt;&gt;&gt; println(anyItems)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦æ±‚<code>destination</code>çš„å…ƒç´ çš„ç±»å‹ï¼Œéœ€è¦æ˜¯<code>source</code>çš„å…ƒç´ ç±»å‹çš„çˆ¶ç±»å‹ï¼Œå¦åˆ™æ— æ³•è°ƒç”¨<code>add()</code>ã€‚</p>
<p>ä¸è¿‡Kotlinæä¾›äº†æ›´åŠ ä¼˜é›…çš„æ–¹å¼æ¥è¡¨è¿°è¿™ç§é—®é¢˜ã€‚å½“å®ç°çš„å‡½æ•°å†…ä»…ä»…è¿›è¡Œ<code>out</code>ã€æˆ–ä»…ä»…è¿›è¡Œ<code>in</code>ä½ç½®å¤„ç†æ—¶ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å¯å˜ä¿®æ”¹å™¨(variance modifier)å®šä¹‰ç±»å‹å‚æ•°ã€‚å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">copyData</span><span class="params">(source: <span class="type">MutableList</span>&lt;<span class="type">out</span> <span class="type">T</span>&gt;,  <span class="comment">// You can add the &quot;out&quot; keyword to the type usage: no methods with T in the &quot;in&quot; postion are used.</span></span></span></span><br><span class="line"><span class="params"><span class="function">				destination: <span class="type">MutableList</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (item <span class="keyword">in</span> source) &#123;</span><br><span class="line">    destination.add(item)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥åœ¨ä¸€ä¸ªç±»å‹å£°æ˜çš„ä»»æ„ç±»å‹å‚æ•°çš„ä½¿ç”¨ä¸ŠæŒ‡å®šä¸€ä¸ªå¯å˜æ€§ä¿®æ”¹å™¨ï¼šå‚æ•°ç±»å‹ã€æœ¬åœ°å˜é‡ç±»å‹ã€å‡½æ•°è¿”å›ç±»å‹ç­‰ç­‰ã€‚è¿™é‡Œå‡ºç°çš„ç§°ä¸º <em>ç±»å‹æŠ•å½±(type projection)</em> ï¼šæˆ‘ä»¬è¯´<code>source</code>ä¸æ˜¯ä¸€ä¸ªå¸¸è§„çš„<code>MutableList</code>ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ª <em>æŠ•å½±(projected)</em> ã€‚ä½ ä»…èƒ½è°ƒç”¨é‚£äº›è¿”å›æ³›å‹ç±»å‹å‚æ•°çš„æ–¹æ³•ï¼Œåˆæˆ–è€…ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œä»…èƒ½åœ¨<code>out</code>ä½ç½®ä½¿ç”¨å®ƒã€‚ç¼–è¯‘å™¨ç¦æ­¢è°ƒç”¨é‚£äº›ç±»å‹ç”¨ä½œå‚æ•°çš„æ–¹æ³•(ç¦æ­¢è°ƒç”¨ <code>in</code> ä½ç½®çš„æ–¹æ³•)ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> list: MutableList&lt;<span class="keyword">out</span> Number&gt; = ...</span><br><span class="line">&gt;&gt;&gt; list.add(<span class="number">42</span>)</span><br><span class="line">Error: Out-projected type <span class="string">&#x27;MutableList&lt;out Number&gt;&#x27;</span> prohibits the use of <span class="string">&#x27;fun add(element: E): Boolean&#x27;</span></span><br></pre></td></tr></table></figure>
<p><em>Donâ€™t be surprised that you canâ€™t call some of the methods if youâ€™re using a projected type</em> ã€‚å¦‚æœä½ éœ€è¦è°ƒç”¨å®ƒä»¬ï¼Œä½ éœ€è¦ä½¿ç”¨å¸¸è§„ç±»å‹å–ä»£æŠ•å½±ç±»å‹ã€‚è¿™è¦æ±‚ä½ å£°æ˜ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ï¼Œä¾èµ–å…¶æŠ•å½±ç±»å‹ã€‚è­¬å¦‚ä¸Šè¿°ä»£ç çš„<code>&lt;T: R, R&gt;</code>ã€‚</p>
<p>å¦‚æœç±»å‹å£°æ˜å·²ç»ä¸º<code>out</code>ï¼Œåœ¨ä½¿ç”¨çš„ä½¿ç”¨å†å£°æ˜ä¸ºåå˜æ˜¯æ²¡æ„ä¹‰çš„ã€‚è­¬å¦‚<code>List&lt;out T&gt;</code>ï¼Œå®é™…ç­‰åŒäº<code>List&lt;T&gt;</code>ï¼Œå› ä¸º<code>List</code>çš„å£°æ˜ç±»æœ¬æ¥å°±æ˜¯<code>class List&lt;out T&gt;</code>ã€‚ç¼–è¯‘å™¨ä¼šå‘Šè­¦è¿™æ ·çš„æŠ•å½±æ˜¯å¤šä½™çš„ã€‚</p>
<p>ç±»ä¼¼çš„æƒ…å†µä¹Ÿå‡ºç°åœ¨é€†å˜ç±»å‹ä¸Šã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>in</code>å¯å˜ä¿®æ”¹å™¨è¡¨æ˜è¯¥å€¼æ˜¯ä½œä¸ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹çš„ç±»å‹å°†è¢«åè½¬(reversed)æ›¿æ¢ä¸ºçˆ¶ç±»å‹ã€‚å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">copyData</span><span class="params">(source: <span class="type">MutableList</span>&lt;<span class="type">T</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">				destination: <span class="type">MutableList</span>&lt;<span class="type">in</span> <span class="type">T</span>&gt;)</span></span> &#123;  <span class="comment">// Allows the destination element type to be a supertype of the source element type</span></span><br><span class="line">  <span class="keyword">for</span> (item <span class="keyword">in</span> source) &#123;</span><br><span class="line">    destination.add(item)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„</strong>ï¼šuse-site varianceçš„å£°æ˜åœ¨Kotlinæ˜¯è·ŸJavaçš„é€šé…ç±»å‹å¯¹åº”çš„ã€‚<code>MutableList&lt;out T&gt;</code>åœ¨Kotlinç­‰åŒäºJavaçš„<code>MutableList&lt;? extends T&gt;</code>ã€‚<code>in</code>æŠ•å½±<code>MutableList&lt;in T&gt;</code>ç­‰åŒäº<code>MutableList&lt;? super T&gt;</code>ã€‚</p>
<h3 id="Star-projection-using-instead-of-a-type-argument"><a class="header-anchor" href="#Star-projection-using-instead-of-a-type-argument">Â¶</a>Star projection: using * instead of a type argument</h3>
<p>è®¨è®ºç±»å‹æ£€æŸ¥å’Œè½¬æ¢çš„æ—¶å€™ï¼Œæ›¾æåŠè¿‡ <em>star-projection</em> è¿™ä¸€è¯­æ³•ç”¨æ¥å‘ŠçŸ¥ <em>no information about a generic argument</em> ã€‚å°±æ˜¯æ— æ³•çŸ¥é“ç±»å‹å‚æ•°çš„ä¿¡æ¯ã€‚ä¾‹å¦‚<code>List&lt;*&gt;</code>ï¼Œå°±æ˜¯åŒ…å«æœªçŸ¥å…ƒç´ ç±»å‹çš„é›†åˆã€‚</p>
<p>é¦–å…ˆæ³¨æ„ï¼Œ<code>MutableList&lt;*&gt;</code>ä¸æ˜¯<code>MutableList&lt;Any?&gt;</code>(è¿™å¾ˆé‡è¦å› ä¸ºè¿™é‡Œçš„<code>MutableList&lt;T&gt;</code>æ˜¯ä¸å¯å˜çš„<code>T</code>)ã€‚ä¸€ä¸ª<code>MutableList&lt;Any?&gt;</code>å‘Šè¯‰äº†ä½ å®ƒåŒ…å«çš„å…ƒç´ æ˜¯ä»»æ„ç±»å‹ã€‚ç„¶è€Œï¼Œ<code>MutableList&lt;*&gt;</code>åŒ…å«çš„å…ƒç´ æ˜¯ä¸€ä¸ª<strong>ç‰¹å®š</strong>çš„å…ƒç´ ï¼Œä½†æˆ‘ä¸æ¸…æ¥šå®ƒæ˜¯ä»€ä¹ˆã€‚è¿™ç§ç‰¹å®šçš„å…ƒç´ ç±»å‹å¯èƒ½æ˜¯<code>String</code>ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶å®ƒï¼Œè¿™æ ·å†™çš„ä»£ç ä»…åŒ…å«è¯¥ç‰¹å®šç±»å‹çš„å…ƒç´ ã€‚å› ä¸ºä½ ä¸çŸ¥é“ç±»å‹æ˜¯ä»€ä¹ˆï¼Œä½ ä¸èƒ½æŠŠä»»æ„ä¸œè¥¿éƒ½æ”¾è¿›å»ï¼Œè¿™ä¼šä¾µçŠ¯åŸæ¥ç±»å‹çš„ä»£ç è°ƒç”¨ã€‚ä½†å¯ä»¥ä»listè·å–å…ƒç´ ï¼Œå› ä¸ºä½ çŸ¥é“æ‰€æœ‰å­˜å‚¨äºè¯¥listçš„å…ƒç´ ï¼Œå®ƒéƒ½æ˜¯<code>Any?</code>çš„å­ç±»å‹ï¼Œ</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> list: MutableList&lt;Any?&gt; = mutableListOf(<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>, <span class="string">&quot;qwe&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> chars = mutableListOf(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> unknownElements: MutableList&lt;*&gt; =  <span class="comment">// MutableList&lt;*&gt; isn&#x27;t the same as MutableList&lt;Any?&gt;.</span></span><br><span class="line">			<span class="keyword">if</span> (Random().nextBoolean()) list <span class="keyword">else</span> chars</span><br><span class="line">&gt;&gt;&gt; unknownElements.add(<span class="number">42</span>)  <span class="comment">// The compiler forbids you to call this method.</span></span><br><span class="line">Error: Out-projected type <span class="string">&#x27;MutableList&lt;*&gt;&#x27;</span> prohibits the use of <span class="string">&#x27;fun add(element: E): Boolean&#x27;</span></span><br><span class="line">&gt;&gt;&gt; println(unknownElements.first())  <span class="comment">// It&#x27;s safe to get elements: first() returns an element of the Any? type.</span></span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆç¼–è¯‘å™¨å§<code>MutableList&lt;*&gt;</code>å¼•è¿°ä¸ºä¸€ä¸ª<code>out</code>-projectç±»å‹ï¼Ÿåœ¨ä¸Šä¸‹æ–‡ï¼Œ<code>MutableList&lt;*&gt;</code>æ˜¯è¢«æŠ•å½±åˆ°<code>MutableList&lt;out Any?&gt;</code>ï¼šä½ æ— æ³•çŸ¥é“å…ƒç´ çš„ç±»å‹ï¼Œä½†å¯¹äºè·å–<code>Any?</code>ç±»å‹çš„å…ƒç´ æ˜¯å®‰å…¨çš„ï¼Œè€Œå¯¹äºå‘é‡Œé¢æ·»åŠ å…ƒç´ åˆ™æ˜¾å¾—ä¸å®‰å…¨ã€‚è¯´åˆ°Javaçš„é€šé…ç±»å‹ï¼Œ<code>MyType&lt;*&gt;</code>åœ¨Kotlinæ˜¯å’ŒJavaçš„<code>MyType&lt;?&gt;</code>ç›¸å¯¹åº”çš„ã€‚</p>
<p><strong>æ³¨æ„</strong> å¯¹äºé€†å˜ç±»å‹å‚æ•°è¯¸å¦‚<code>Consumer&lt;in T&gt;</code>ï¼Œå®ƒçš„star-projectionç­‰ä»·äº<code>&lt;in Nothing&gt;</code>ã€‚å®é™…ä¸Šï¼Œä½ æ— æ³•è°ƒç”¨åŸºäºè¯¥æŠ•å½±çš„ä»»ä½•æ–¹æ³•ã€‚å¦‚æœç±»å‹æ˜¯é€†å˜çš„ï¼Œå®ƒä»…ä½œä¸ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä½ ä¸çŸ¥é“å®ƒå®é™…ä¸Šå¯ä»¥æ¶ˆè´¹ä»€ä¹ˆã€‚å› æ­¤ï¼Œä½ ä¸èƒ½è®©å®ƒæ¶ˆè´¹ã€‚</p>
<p>å½“ç±»å‹å‚æ•°å¹¶ä¸é‡è¦æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <em>star-projection</em> çš„è¯­æ³•ï¼šåœ¨ç­¾åéƒ¨åˆ†ä½ ä¸ä¼šç”¨åˆ°ç±»å‹å‚æ•°çš„ä»»ä½•æ–¹æ³•ï¼Œæˆ–è€…ä½ ä»…ä»…åªè¯»æ•°æ®ä¸å…³å¿ƒå®ƒçš„å…·ä½“ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å®ç°<code>printFirst</code>å‡½æ•°å¹¶æ¥æ”¶<code>List&lt;*&gt;</code>ä½œä¸ºå‚æ•°ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">printFirst</span><span class="params">(list: <span class="type">List</span>&lt;*&gt;)</span></span> &#123;  <span class="comment">// Every list is a possible argument.</span></span><br><span class="line">  <span class="keyword">if</span> (list.isNotEmpty()) &#123;  <span class="comment">// isNotEmpty() doesn&#x27;t use the generic type parameter.</span></span><br><span class="line">    println(list.first())  <span class="comment">// first() now returns Any?, but in this case that&#x27;s enough.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; printFirst(listOf(<span class="string">&quot;Svetlana&quot;</span>, <span class="string">&quot;Dmitry&quot;</span>))</span><br><span class="line">Svetlana</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯ä½œä¸ºuse-site varianceï¼Œéœ€è¦å¼•å…¥æ³›å‹ç±»å‹å‚æ•°ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">printFirst</span><span class="params">(list: <span class="type">List</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;  <span class="comment">// Again, every list is a possible argument.</span></span><br><span class="line">  <span class="keyword">if</span> (list.isNotEmpty()) &#123;</span><br><span class="line">    println(list.first())  <span class="comment">// first() now returns a value of T.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¸¦æœ‰æ˜ŸæŠ•å½±çš„è¯­æ³•æ›´åŠ ç®€æ˜ï¼Œä½†å®ƒä»…å·¥ä½œåœ¨ä½ ä¸éœ€è¦å…³å¿ƒå®é™…æ³›å‹ç±»å‹å‚æ•°çš„æƒ…å†µï¼šä»…èƒ½ä½¿ç”¨äº§ç”Ÿè¯¥å€¼çš„æ–¹æ³•ï¼Œä¸å…³å¿ƒè¿™äº›å€¼çš„ç±»å‹ã€‚</p>
<p>ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªæ˜ŸæŠ•å½±çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦éªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å£°æ˜<code>FieldValidator</code>ã€‚å®ƒåŒ…å«çš„ç±»å‹ä»…åœ¨<code>in</code>ä½ç½®ï¼Œå› æ­¤å®ƒå¯ä»¥å£°æ˜ä¸ºé€†å˜ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">FieldValidator</span>&lt;<span class="type">in T</span>&gt; &#123;  <span class="comment">// Interface declared as contravariant on T</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">validate</span><span class="params">(input: <span class="type">T</span>)</span></span>: <span class="built_in">Boolean</span>  <span class="comment">// T is used only in the &quot;in&quot; position(this method consumes a value of T).</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> DefaultStringValidator: FieldValidator&lt;String&gt; &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">validate</span><span class="params">(input: <span class="type">String</span>)</span></span> = input.isNotEmpty()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> DefaultIntValidator: FieldValidator&lt;<span class="built_in">Int</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">validate</span><span class="params">(input: <span class="type">Int</span>)</span></span> = input &gt;= <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æƒ³è±¡ä½ å¸Œæœ›åœ¨ç›¸åŒçš„å®¹å™¨å­˜å‚¨æ‰€æœ‰çš„validatorï¼Œå¹¶æ ¹æ®è¾“å…¥ç±»å‹è·å–æ­£ç¡®çš„validatorã€‚æœ€å…ˆä½ å¯èƒ½ä¼šç”¨ä¸€ä¸ªmapæ¥å­˜å‚¨ã€‚å¹¶ä¸ºä»»æ„ç±»å‹å­˜å‚¨validatorï¼Œä½ å¯èƒ½éœ€è¦å£°æ˜ä¸€ä¸ª<code>KClass</code>ç±»å‹çš„mapï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> validators = mutableMapOf&lt;KClass&lt;*&gt;, FieldValidator&lt;*&gt;&gt;()</span><br><span class="line">&gt;&gt;&gt; validators[String::<span class="keyword">class</span>] = DefaultStringValidator</span><br><span class="line">&gt;&gt;&gt; validators[<span class="built_in">Int</span>::<span class="keyword">class</span>] = DefaultIntValidator</span><br></pre></td></tr></table></figure>
<p>ä¸€æ—¦è¿™æ ·åšäº†ï¼Œå½“ä½¿ç”¨è¿™äº›validatoræ—¶ä¼šè§‰å¾—æœ‰å›°éš¾ã€‚ä½ ä¸èƒ½ç”¨<code>FieldValidator&lt;*&gt;</code>æ¥æ ¡éªŒå­—ç¬¦ä¸²ã€‚è¿™ä¸æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¸çŸ¥é“å®ƒæ˜¯å“ªç§validatorï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; validators[String::<span class="keyword">class</span>]!!.validate(<span class="string">&quot;&quot;</span>)  <span class="comment">// The value stored in the map has the type FieldValidator&lt;*&gt;.</span></span><br><span class="line">Error: Out-projected type <span class="string">&#x27;FieldValidator&lt;*&gt;&#x27;</span> prohibits the use of <span class="string">&#x27;fun validate(input: T): Boolean&#x27;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ç±»é”™è¯¯åœ¨ä»¥å‰ä»‹ç»<code>MutableList&lt;*&gt;</code>æè¿°è¿‡äº†ã€‚è¿™ç±»é”™è¯¯æ„å‘³ç€è¾“å…¥ç‰¹å®šç±»å‹åˆ°ä¸€ä¸ªæœªçŸ¥ç±»å‹çš„å…¥å£ï¼Œä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€‚ä¸€ç§æ–¹å¼æ˜¯ï¼Œæ˜¾å¼è½¬æ¢ä¸ºæŒ‡å®šçš„ç±»å‹ï¼Œä½†å®ƒæ—¢ä¸æ˜¯ç±»å‹å®‰å…¨çš„ã€ä¹Ÿä¸æ¨èè¿™æ ·åšï¼Œä¸è¿‡ä¸‹é¢å¯ä»¥åˆ—å‡ºä»£ç ä½œä¸ºå‚è€ƒä¸€ä¸‹ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> stringValidator = validators[String::<span class="keyword">class</span>] <span class="keyword">as</span> FieldValidator&lt;String&gt;  <span class="comment">// Warning: unchecked cast</span></span><br><span class="line">&gt;&gt;&gt; println(stringValidator.validate(<span class="string">&quot;&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨å‘å‡ºå‘Šè­¦å…³äºunchecked çš„è½¬æ¢ã€‚æ³¨æ„ï¼Œè¿™æ®µä»£ç ä»…ä¼šåœ¨æ ¡éªŒæ—¶å¤±è´¥ï¼Œä¸æ˜¯åœ¨è½¬æ¢çš„åœ°æ–¹ï¼Œå› ä¸ºè¿è¡Œæ—¶æ‰€æœ‰æ³›å‹ä¿¡æ¯éƒ½è¢«æ“¦é™¤ã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="keyword">val</span> stringValidator = validators[<span class="built_in">Int</span>::<span class="keyword">class</span>] <span class="keyword">as</span> FieldValidator&lt;String&gt;  <span class="comment">// You get an incorrect validator(may be by mistake), but this code compiles.</span></span><br><span class="line">&gt;&gt;&gt; stringValidator.validate(<span class="string">&quot;&quot;</span>)  <span class="comment">// The real error is hidden until you use the validator.</span></span><br><span class="line">java.lang.ClassCastException:</span><br><span class="line">  java.lang.String cannot be cast to java.lang.Number at DefaultIntValidator.validate</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç åœ¨ç¼–è¯‘æœŸä»…æœ‰ä¸€ä¸ªå‘Šè­¦ï¼Œè¿è¡ŒæœŸç”±äºæ³›å‹æ“¦é™¤ï¼Œå‡ºç°é”™è¯¯ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆä¸æ˜¯ç±»å‹å®‰å…¨çš„(type-safe)ã€å¹¶ä¸”å®¹æ˜“å‡ºé”™(error-prone)ã€‚å› æ­¤ï¼Œéœ€è¦æ¢è®¨ä¸€ä¸‹å…¶å®ƒå¯èƒ½çš„æ–¹æ¡ˆã€‚</p>
<p>ä¸‹é¢ä»£ç ä½¿ç”¨åŒä¸€ä¸ª<code>validators</code>mapï¼Œä½†å°è£…äº†æ‰€æœ‰çš„è®¿é—®åˆ°ä¸¤ä¸ªæ³›å‹æ–¹æ³•ï¼Œä»…åŒ…å«æ­£ç¡®çš„validatorçš„æ³¨å†Œå’Œè¿”å›ã€‚è¯¥ä»£ç å¯¹æœªæ ¡éªŒçš„è½¬æ¢ä¼šå‘å‡ºä¸€ä¸ªå‘Šè­¦ï¼Œä½†è¿™é‡Œçš„<code>Validators</code>æ§åˆ¶æ‰€æœ‰çš„è®¿é—®ï¼Œå¹¶ç¡®ä¿ä¸å¯èƒ½é”™è¯¯ä¿®æ”¹mapã€‚</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Validators &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> validators = <span class="comment">// Uses the same map as before, but now you can&#x27;t access it outside</span></span><br><span class="line">			mutableMapOf&lt;KClass&lt;*&gt;, FieldValidator&lt;*&gt;&gt;()</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T: Any&gt;</span> <span class="title">registerValidator</span><span class="params">(kClass: <span class="type">KClass</span>&lt;<span class="type">T</span>&gt;, fieldValidator: <span class="type">FieldValidator</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    validators[kClass] = fieldValidator  <span class="comment">// Puts into the map only the correct key-value pairs, when a validator corresponds to a class</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Suppress(<span class="string">&quot;UNCECKED_CAST&quot;</span>)</span>  <span class="comment">// Suppresses the warning about the unchecked cast to FieldValidator&lt;T&gt;</span></span><br><span class="line">  <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T: Any&gt;</span> <span class="title">get</span><span class="params">(kClass: <span class="type">KClass</span>&lt;<span class="type">T</span>&gt;)</span></span>: FieldValidator&lt;T&gt; = </span><br><span class="line">	validators[kClass] <span class="keyword">as</span>? FieldValidator&lt;T&gt; ?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;No validator for <span class="subst">$&#123;kClass.simpleName&#125;</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Validators.registerValidator(String::<span class="keyword">class</span>, DefaultStringValidator)</span><br><span class="line">&gt;&gt;&gt; Validators.registerValidator(<span class="built_in">Int</span>::<span class="keyword">class</span>, DefaultIntValidator)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; println(Validators[String::<span class="keyword">class</span>].validate(<span class="string">&quot;Kotlin&quot;</span>))</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">&gt;&gt;&gt; println(Validators[INt::<span class="keyword">class</span>].validate(<span class="number">42</span>))</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªtype-safe APIã€‚æ‰€æœ‰çš„unsafeé€»è¾‘è¢«éšè—åœ¨ç±»çš„bodyéƒ¨åˆ†ï¼›é€šè¿‡æœ¬åœ°åŒ–å®ç°ï¼Œç¡®ä¿äº†å®ƒä¸ä¼šè¢«é”™è¯¯ä½¿ç”¨ã€‚ç¼–è¯‘å™¨ç¦æ­¢ä½ ä½¿ç”¨ä¸æ­£ç¡®çš„validatorï¼Œå› ä¸º<code>Validators</code>å¯¹è±¡æ€»æ˜¯ç»™å®šäº†æ­£ç¡®çš„validatorçš„å®ç°ï¼š</p>
<figure class="highlight kt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; println(Validators[String::<span class="keyword">class</span>].validate(<span class="number">42</span>))  <span class="comment">// Now the &quot;get&quot; method returns an instance of FieldValidator&lt;String&gt;.</span></span><br><span class="line">Error: The integer literal does not conform to the expected type String</span><br></pre></td></tr></table></figure>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå¹¶ä¸ç®—æ˜¯Kotlinçš„ç‰¹æ€§å†…å®¹ã€‚å®ç°è¿™ç§æ¨¡å¼å¯ä»¥éå¸¸å®¹æ˜“åœ°å¯¹è‡ªå®šä¹‰æ³›å‹ç±»å‹è¿›è¡Œæ‰©å±•ã€‚å°†unsafeçš„ä»£ç è¿›è¡Œæœ¬åœ°åŒ–åˆ†ç¦»é¿å…è¯¯ç”¨ã€‚</p>
<p>Javaçš„æ³›å‹å’Œåå˜æ€§é€šå¸¸è¢«è®¤ä¸ºæ˜¯è¯¥è¯­è¨€æœ€æ£˜æ‰‹çš„éƒ¨åˆ†ã€‚åœ¨Kotlinä¸­ï¼Œåœ¨Kotlinä¸­æˆ‘ä»¬å°½æœ€å¤§åŠªåŠ›ä½¿å…¶æ˜“äºç†è§£å’Œæ˜“äºä½¿ç”¨ï¼ŒåŒæ—¶æœ‰ä¿ç•™å¯¹Javaçš„äº’æ“ä½œæ€§ã€‚</p>
<h2 id="Summary"><a class="header-anchor" href="#Summary">Â¶</a>Summary</h2>
<ul>
<li>Kotlinçš„æ³›å‹å’ŒJavaçš„æ³›å‹éå¸¸ç›¸ä¼¼ï¼šä½ å¯ä»¥ä»¥åŒæ ·çš„æ–¹å¼å£°æ˜æ³›å‹å‡½æ•°æˆ–ç±»ã€‚</li>
<li>åœ¨Javaï¼Œæ³›å‹ç±»å‹çš„ç±»å‹å‚æ•°(type parameter)ä»…å­˜åœ¨äºç¼–è¯‘æœŸã€‚</li>
<li>åœ¨ä½¿ç”¨ç±»å‹æ—¶ï¼Œä¸èƒ½åŒæ—¶å°†ç±»å‹å‚æ•°å’Œ<code>is</code>æ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸º <strong>ç±»å‹å‚æ•°æ˜¯è¿è¡ŒæœŸæ“¦é™¤çš„</strong>ã€‚</li>
<li>ç±»å‹å‚æ•°å’Œå†…è”å‡½æ•°ä¸€èµ·ä½¿ç”¨æ—¶å¯ä»¥æ ‡è®°ä¸Š<code>reified</code>ï¼Œå®ƒå…è®¸ä½ åœ¨è¿è¡Œæ—¶æ“ä½œ<code>is</code>çš„æ ¡éªŒä»¥åŠè·å¾—<code>java.lang.Class</code>å®ä¾‹ã€‚</li>
<li>Variance is a way to specify whether one of two generic types with the same base class and different type arguments is a subtype or a supertype of the other one if one of the type arguments is the subtype of the other one.</li>
<li>ä½ å¯ä»¥é€šè¿‡å£°æ˜åœ¨ç±»å‹å‚æ•°ä¸Šçš„ç±»ä½œä¸ºåå˜(covariant)ï¼Œå½“ä¸”ä»…å½“è¯¥ç±»å‹å‚æ•°è¢«ç”¨åœ¨<code>out</code>ä½ç½®ã€‚</li>
<li>é€†å˜(contravariant)åˆ™æ˜¯ç›¸åï¼šå£°æ˜çš„ç±»çš„ç±»å‹å‚æ•°ä»…ç”¨åœ¨<code>in</code>ä½ç½®ã€‚</li>
<li>åªè¯»æ¥å£<code>List</code>åœ¨kotlinè¢«å£°æ˜ä¸ºåå˜ï¼Œæ„å‘³ç€<code>List&lt;String&gt;</code>æ˜¯<code>List&lt;Any&gt;</code>çš„å­ç±»å‹ã€‚</li>
<li><code>Function</code>ç±»çš„æ¥å£å£°æ˜å°±æ˜¯ç¬¬ä¸€ä¸ªç±»å‹å‚æ•°å£°æ˜ä¸ºé€†å˜(contravariant)ï¼Œä»¥åŠç¬¬äºŒä¸ªç±»å‹å‚æ•°å£°æ˜ä¸ºåå˜(covariant)ï¼Œå¯ä»¥ä½¿å¾—<code>(Animal) -&gt; Int</code>æ˜¯<code>(Cat) -&gt; Number</code>çš„ç±»å‹å­ç±»ã€‚</li>
<li>Kotlinå¯ä»¥è®©ä½ åŒæ—¶å¯¹æ³›å‹ç±»(declaration-site variance)å’Œç‰¹å®šæ³›å‹ç±»å‹(use-site variance)æŒ‡å®šå¯å˜æ€§(variance)ã€‚</li>
<li>æ˜ŸæŠ•å½±(star-projection)è¯­æ³•è¢«ç”¨äºç±»å‹å‚æ•°æœªçŸ¥æˆ–ä¸é‡è¦/ä¸æ•æ„Ÿçš„æƒ…å†µã€‚</li>
</ul>
</div></article><nav class="article-nav"><div class="article-nav-prev"><a href="/2022/01/28/kotlin/09_annotations_and_reflection/">æ³¨è§£å’Œåå°„</a></div><div class="article-nav-next"><a href="/2021/12/27/kotlin/07_higher-order_functions~lambdas_as_parameters_and_return_values/">é«˜é˜¶å‡½æ•°ï¼šlambdaä½œä¸ºå‚æ•°å’Œè¿”å›</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2022/01/07/kotlin/08_generics/';
var disqus_title = 'æ³›å‹';
var disqus_url = 'https://galudisu.info/2022/01/07/kotlin/08_generics/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>