<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>ZookeeperåŸç†ä¸APIåº”ç”¨</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">ZookeeperåŸç†ä¸APIåº”ç”¨</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2018-10-21</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/zookeeper/">zookeeper</a></p></div><div class="article-content"><h2 id="ZooKeeperæ¦‚è¿°"><a class="header-anchor" href="#ZooKeeperæ¦‚è¿°">Â¶</a>ZooKeeperæ¦‚è¿°</h2>
<p>1.1 æ¦‚è¿°</p>
<p>Zookeeperæ˜¯Googleçš„Chubbyä¸€ä¸ªå¼€æºå®ç°ã€‚å®ƒæ˜¯ä¸€ä¸ªé’ˆå¯¹å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯é åè°ƒç³»ç»Ÿã€‚æä¾›çš„åŠŸèƒ½åŒ…æ‹¬ï¼šé…ç½®ç»´æŠ¤ã€åå­—æœåŠ¡ã€åˆ†å¸ƒå¼åŒæ­¥ã€ç»„æœåŠ¡ç­‰ã€‚Zookeeperçš„ç›®æ ‡å°±æ˜¯å°è£…å¤æ‚æ˜“å‡ºé”™çš„å…³é”®æœåŠ¡ï¼Œè®²ç®€å•æ˜“ç”¨çš„æ¥å£å’Œæ€§èƒ½é«˜æ•ˆã€åŠŸèƒ½ç¨³å®šçš„ç³»ç»Ÿæä¾›ç»™ç”¨æˆ·ã€‚</p>
<span id="more"></span>
<p>Zookeeperä»è®¾è®¡æ¨¡å¼è§’åº¦æ¥ç†è§£ï¼šæ˜¯ä¸€ä¸ªæœºé‡è§‚å¯Ÿè€…æ¨¡å¼è®¾è®¡çš„åˆ†å¸ƒå¼æœåŠ¡ç®¡ç†æ¡†æ¶ï¼Œå®ƒè´Ÿè´£å­˜å‚¨å’Œç®¡ç†å¤§å®¶å…³å¿ƒçš„æ•°æ®ï¼Œç„¶åæ¥å—è§‚å¯Ÿè€…çš„æ³¨å†Œï¼Œä¸€æ—¦è¿™äº›æ•°æ®çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ŒZookeeperå°±å°†è´Ÿè´£é€šçŸ¥å·²ç»åœ¨Zookeeperä¸Šæ³¨å†Œçš„é‚£äº›è§‚å¯Ÿè€…åšå‡ºç›¸åº”çš„ååº”ï¼Œä»è€Œå®ç°é›†ç¾¤ä¸­ç±»ä¼¼Master/Slaveç®¡ç†æ¨¡å¼ã€‚</p>
<p>1.2 ç‰¹ç‚¹</p>
<p><img src="/img/spark/zookeeper-architecture.png" alt="zookeeper-architecture"></p>
<ul>
<li>Zookeeperï¼šä¸€ä¸ªé¢†å¯¼è€…(leader)ï¼Œå¤šä¸ªè·Ÿéšè€…(follower)ç»„æˆçš„é›†ç¾¤ã€‚</li>
<li>Leaderè´Ÿè´£è¿›è¡ŒæŠ•ç¥¨çš„å‘èµ·å’Œå†³è®®ï¼Œæ›´æ–°ç³»ç»ŸçŠ¶æ€ã€‚</li>
<li>æ‰€æœ‰æœåŠ¡(servers)å­˜å‚¨æ•°æ®çš„ä¸€ä»½æ‹·è´(æ—¢å¯ä»¥å­˜å‚¨åœ¨å†…å­˜ï¼Œä¹Ÿå¯ä»¥æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ)</li>
<li>Followerç”¨äºæ¥æ”¶å®¢æˆ·è¯·æ±‚å¹¶å‘å®¢æˆ·ç«¯è¿”å›ç»“æœï¼Œåœ¨é€‰ä¸¾Leaderè¿‡ç¨‹ä¸­å‚ä¸æŠ•ç¥¨ã€‚</li>
<li>é›†ç¾¤ä¸­åªè¦æœ‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹å­˜æ´»ï¼ŒZookeeperé›†ç¾¤å°±èƒ½æ­£å¸¸æœåŠ¡ã€‚</li>
<li>å…¨å±€æ•°æ®ä¸€è‡´ï¼šæ¯ä¸ªserverä¿å­˜ä¸€ä»½ç›¸åŒçš„æ•°æ®å‰¯æœ¬ï¼Œclientæ— è®ºè¿æ¥åˆ°å“ªä¸ªserverï¼Œæ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ã€‚</li>
<li>æ›´æ–°è¯·æ±‚é¡ºåºè¿›è¡Œï¼Œæ¥è‡ªåŒä¸€ä¸ªclientçš„æ›´æ–°è¯·æ±‚æŒ‰å…¶å‘é€é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</li>
<li>æ•°æ®æ›´æ–°åŸå­æ€§ï¼Œä¸€æ¬¡æ•°æ®æ›´æ–°è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ã€‚</li>
<li>å®æ—¶æ€§ï¼Œåœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…ï¼Œclientèƒ½è¯»åˆ°æœ€æ–°æ•°æ®ã€‚</li>
<li>ä¸å­˜åœ¨åˆ†åŒºè¯»å†™ã€‚</li>
</ul>
<p>1.3 æ•°æ®ç»“æ„</p>
<p><img src="/img/spark/zookeeper-data-model.png" alt="zookeeper-data-model"></p>
<p>Zookeeperæ•°æ®æ¨¡å¼çš„ç»“æ„ä¸Unixæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ•´ä½“ä¸Šå¯ä»¥çœ‹åšæ˜¯ä¸€é¢—æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç§°ä½œä¸€ä¸ªZNodeã€‚æ¯ä¸ªZNodeé»˜è®¤èƒ½å¤Ÿå­˜å‚¨1MBçš„æ•°æ®ï¼Œæ¯ä¸ªZNodeéƒ½å¯ä»¥é€šè¿‡å…¶è·¯å¾„å”¯ä¸€æ ‡è¯†ã€‚</p>
<p>1.4 åº”ç”¨åœºæ™¯</p>
<p>æä¾›çš„æœåŠ¡åŒ…æ‹¬ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€ç»Ÿä¸€é…ç½®ç®¡ç†ã€ç»Ÿä¸€é›†ç¾¤ç®¡ç†ã€æœåŠ¡å™¨èŠ‚ç‚¹åŠ¨æ€ä¸Šä¸‹çº¿ã€è½¯è´Ÿè½½å‡è¡¡ç­‰ã€‚</p>
<ul>
<li>ç»Ÿä¸€å‘½åæœåŠ¡ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç»å¸¸éœ€è¦å¯¹åº”ç”¨/æœåŠ¡è¿›è¡Œç»Ÿä¸€å‘½åï¼Œä¾¿äºè¯†åˆ«ä¸åŒæœåŠ¡ã€‚</li>
<li>ç»Ÿä¸€é…ç½®ç®¡ç†ï¼šå°†é…ç½®ä¿¡æ¯å†™å…¥ZooKeeperä¸Šçš„ä¸€ä¸ªZNodeï¼Œå„ä¸ªèŠ‚ç‚¹ç›‘å¬è¿™ä¸ªZNodeï¼Œä¸€æ—¦ZNodeä¸­çš„æ•°æ®è¢«ä¿®æ”¹ï¼ŒZooKeeperé€šçŸ¥å„ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>ç»Ÿä¸€é›†ç¾¤ç®¡ç†ï¼šå°†èŠ‚ç‚¹ä¿¡æ¯å†™å…¥ZooKeeperä¸Šçš„ä¸€ä¸ªZNodeï¼Œç›‘å¬è¿™ä¸ªZNodeè·å–å®ƒçš„å®æ—¶çŠ¶æ€å˜åŒ–ã€‚</li>
<li>æœåŠ¡å™¨èŠ‚ç‚¹åŠ¨æ€ä¸Šä¸‹çº¿ï¼šç›‘å¬æ³¨å†ŒæœåŠ¡åˆ—è¡¨ï¼ŒæœåŠ¡å™¨ä¸‹çº¿å‘é€äº‹ä»¶é€šçŸ¥ã€‚</li>
<li>è½¯è´Ÿè½½å‡è¡¡ã€‚</li>
</ul>
<p><img src="/img/spark/zookeeper-in-hadoop.png" alt="zookeeper-in-hadoop"></p>
<h2 id="Zookeeperå†…éƒ¨åŸç†"><a class="header-anchor" href="#Zookeeperå†…éƒ¨åŸç†">Â¶</a>Zookeeperå†…éƒ¨åŸç†</h2>
<ol>
<li>é€‰ä¸¾æœºåˆ¶</li>
</ol>
<ul>
<li>åŠæ•°æœºåˆ¶ï¼šé›†ç¾¤ä¸­åŠæ•°ä»¥ä¸Šæœºå™¨å­˜æ´»ï¼Œé›†ç¾¤å¯ç”¨ã€‚æ‰€ä»¥ZooKeeperé€‚åˆè£…åœ¨å¥‡æ•°å°æœºå™¨ä¸Šã€‚</li>
<li>ZooKeeperè™½ç„¶åœ¨é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æŒ‡å®šmasterå’Œslaveã€‚ä½†æ˜¯ï¼ŒZooKeeperåœ¨å¯åŠ¨æ—¶ï¼Œleaderè¢«é€‰ä¸¾å‡ºï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªï¼Œå…¶å®ƒä½œä¸ºfollowerï¼ŒLeaderæ˜¯é€šè¿‡å†…éƒ¨çš„é€‰ä¸¾æœºåˆ¶ä¸´æ—¶äº§ç”Ÿçš„ã€‚</li>
</ul>
<ol start="2">
<li>èŠ‚ç‚¹ç±»å‹</li>
</ol>
<p>ZNodeæœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>çŸ­æš‚(ephemeral)ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ–­å¼€è¿æ¥åï¼Œåˆ›å»ºçš„èŠ‚ç‚¹è‡ªå·±åˆ é™¤</li>
<li>æŒä¹…(persistent)ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ–­å¼€è¿æ¥åï¼Œåˆ›å»ºçš„èŠ‚ç‚¹ä¸åˆ é™¤</li>
</ul>
<p>ZNodeæœ‰å››ç§å½¢å¼çš„ç›®å½•èŠ‚ç‚¹(é»˜è®¤æ˜¯persistent)</p>
<ul>
<li>æŒä¹…åŒ–ç›®å½•èŠ‚ç‚¹(persistent)ï¼šå®¢æˆ·ç«¯ä¸ZooKeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨</li>
<li>æŒä¹…åŒ–é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹(persistent_sequential)ï¼šå®¢æˆ·ç«¯ä¸ZooKeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹ä¾æ—§å­˜åœ¨ï¼Œåªæ˜¯ZooKeeperç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œé¡ºåºç¼–å·</li>
<li>ä¸´æ—¶ç›®å½•èŠ‚ç‚¹(ephemeral)ï¼šå®¢æˆ·ç«¯ä¸ZooKeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹è¢«åˆ é™¤</li>
<li>ä¸´æ—¶é¡ºåºç¼–å·ç›®å½•èŠ‚ç‚¹(ephemeral_sequential)ï¼šå®¢æˆ·ç«¯ä¸ZooKeeperæ–­å¼€è¿æ¥åï¼Œè¯¥èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œåªæ˜¯ZooKeeperç»™è¯¥èŠ‚ç‚¹åç§°è¿›è¡Œé¡ºåºç¼–å·</li>
</ul>
<p>åˆ›å»ºZNodeæ—¶è®¾ç½®é¡ºåºæ ‡è¯†ï¼ŒZNodeåç§°åä¼šé™„åŠ ä¸€ä¸ªå€¼ï¼Œé¡ºåºå·æ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤ã€‚</p>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé¡ºåºå·å¯ä»¥è¢«ç”¨äºä¸ºæ‰€æœ‰çš„äº‹ä»¶è¿›è¡Œå…¨å±€æ’åºï¼Œè¿™æ ·å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡é¡ºåºå·æ¨æ–­äº‹ä»¶çš„é¡ºåºã€‚</p>
<ol start="3">
<li>statç»“æ„ä½“</li>
</ol>
<ol>
<li>czxid- å¼•èµ·è¿™ä¸ªznodeåˆ›å»ºçš„zxidï¼Œåˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡çš„zxid</li>
</ol>
<p>æ¯æ¬¡ä¿®æ”¹ZooKeeperçŠ¶æ€éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªzxidå½¢å¼çš„æ—¶é—´æˆ³ï¼Œä¹Ÿå°±æ˜¯ZooKeeperäº‹åŠ¡IDã€‚</p>
<p>äº‹åŠ¡IDæ˜¯ZooKeeperä¸­æ‰€æœ‰ä¿®æ”¹æ€»çš„æ¬¡åºã€‚æ¯ä¸ªä¿®æ”¹éƒ½æœ‰å”¯ä¸€çš„zxidï¼Œå¦‚æœzxid1å°äºzxid2ï¼Œé‚£ä¹ˆzxid1åœ¨zxid2ä¹‹å‰å‘ç”Ÿã€‚</p>
<ol start="2">
<li>
<p>ctime - znodeè¢«åˆ›å»ºçš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)</p>
</li>
<li>
<p>mzxid - znodeæœ€åæ›´æ–°çš„zxid</p>
</li>
<li>
<p>mtime - znodeæœ€åä¿®æ”¹çš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)</p>
</li>
<li>
<p>pZxid-znodeæœ€åæ›´æ–°çš„å­èŠ‚ç‚¹zxid</p>
</li>
<li>
<p>cversion - znodeå­èŠ‚ç‚¹å˜åŒ–å·ï¼Œznodeå­èŠ‚ç‚¹ä¿®æ”¹æ¬¡æ•°</p>
</li>
<li>
<p>dataversion - znodeæ•°æ®å˜åŒ–å·</p>
</li>
<li>
<p>aclVersion - znodeè®¿é—®æ§åˆ¶åˆ—è¡¨çš„å˜åŒ–å·</p>
</li>
<li>
<p>ephemeralOwner- å¦‚æœæ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯znodeæ‹¥æœ‰è€…çš„session idã€‚å¦‚æœä¸æ˜¯ä¸´æ—¶èŠ‚ç‚¹åˆ™æ˜¯0ã€‚</p>
</li>
<li>
<p>dataLength- znodeçš„æ•°æ®é•¿åº¦</p>
</li>
<li>
<p>numChildren - znodeå­èŠ‚ç‚¹æ•°é‡</p>
</li>
</ol>
<ol start="4">
<li>ç›‘å¬å™¨åŸç†</li>
</ol>
<p><img src="/img/spark/zookeeper-listener.png" alt="zookeeper-listener"></p>
<ol start="5">
<li>å†™æ•°æ®æµç¨‹</li>
</ol>
<p><img src="/img/spark/zookeeper-write-process.png" alt="zookeeper-write"></p>
<p><img src="/img/spark/zookeeper-write-process-b.png" alt="zookeeper-write"></p>
<ol start="6">
<li>è¯»æ•°æ®æµç¨‹</li>
</ol>
<p>è¯»æµç¨‹æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºæ˜¯æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ï¼ŒZooKeeperçš„è¯»æµç¨‹æ˜¯ç›´æ¥è¯»å–å³å¯ã€‚</p>
<h2 id="APIåº”ç”¨"><a class="header-anchor" href="#APIåº”ç”¨">Â¶</a>APIåº”ç”¨</h2>
<p>åˆ›å»ºZooKeeperå®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;node21:2181,node22:2181,node23:2181&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">ZooKeeper</span> <span class="variable">zkClient</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      zkClient = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">      <span class="comment">// æ”¶åˆ°äº‹ä»¶é€šçŸ¥åçš„å›è°ƒå‡½æ•°ï¼ˆç”¨æˆ·çš„ä¸šåŠ¡é€»è¾‘ï¼‰</span></span><br><span class="line">      System.out.println(event.getType() + <span class="string">&quot;--&quot;</span> + event.getPath());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå­èŠ‚ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// åˆ›å»ºå­èŠ‚ç‚¹</span><br><span class="line">@Test</span><br><span class="line">public void create() throws Exception &#123;</span><br><span class="line">// æ•°æ®çš„å¢åˆ æ”¹æŸ¥</span><br><span class="line">// å‚æ•°1ï¼šè¦åˆ›å»ºçš„èŠ‚ç‚¹çš„è·¯å¾„ï¼› å‚æ•°2ï¼šèŠ‚ç‚¹æ•°æ® ï¼› å‚æ•°3ï¼šèŠ‚ç‚¹æƒé™ ï¼›å‚æ•°4ï¼šèŠ‚ç‚¹çš„ç±»å‹</span><br><span class="line">String nodeCreated = zkClient.create(&quot;/eclipse&quot;, &quot;hello zk&quot;.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­ZNodeæ˜¯å¦å­˜åœ¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// åˆ¤æ–­znodeæ˜¯å¦å­˜åœ¨</span><br><span class="line">@Test</span><br><span class="line">public void exist() throws Exception &#123;</span><br><span class="line">       Stat stat = zkClient.exists(&quot;/eclipse&quot;, false);</span><br><span class="line">       System.out.println(stat == null ? &quot;not exist&quot; : &quot;exist&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Zookeeperå®æˆ˜"><a class="header-anchor" href="#Zookeeperå®æˆ˜">Â¶</a>Zookeeperå®æˆ˜</h2>
<ol>
<li>ç›‘å¬æœåŠ¡å™¨èŠ‚ç‚¹ä¸Šä¸‹çº¿</li>
</ol>
<p>éœ€æ±‚ï¼šæŸåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šå°ï¼Œå¯ä»¥åŠ¨æ€ä¸Šä¸‹çº¿ï¼Œä»»æ„ä¸€å°å®¢æˆ·ç«¯éƒ½èƒ½å®æ—¶æ„ŸçŸ¥åˆ°ä¸»èŠ‚ç‚¹æœåŠ¡å™¨çš„ä¸Šä¸‹çº¿ã€‚<br>
å…·ä½“å®ç°ï¼š</p>
<p>åœ¨é›†ç¾¤ä¸Šåˆ›å»º/serversèŠ‚ç‚¹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 10] create /servers &quot;servers&quot;</span><br><span class="line">Created /servers</span><br></pre></td></tr></table></figure>
<p>æœåŠ¡ç«¯ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyg.zkcase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.CreateMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooDefs.Ids;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeServer</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;node21:2181,node22:2181,node23:2181&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">ZooKeeper</span> <span class="variable">zk</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">parentNode</span> <span class="operator">=</span> <span class="string">&quot;/servers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåˆ°zkçš„å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line"></span><br><span class="line">        zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line">       &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†ŒæœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registServer</span><span class="params">(String hostname)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">create</span> <span class="operator">=</span> zk.create(parentNode + <span class="string">&quot;/server&quot;</span>, hostname.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">        System.out.println(hostname +<span class="string">&quot; is online &quot;</span>+ create);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸šåŠ¡åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">(String hostname)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">       System.out.println(hostname+<span class="string">&quot; is working ...&quot;</span>);</span><br><span class="line">       Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">// è·å–zkè¿æ¥</span></span><br><span class="line"><span class="type">DistributeServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributeServer</span>();</span><br><span class="line">server.getConnect();</span><br><span class="line"><span class="comment">// åˆ©ç”¨zkè¿æ¥æ³¨å†ŒæœåŠ¡å™¨ä¿¡æ¯</span></span><br><span class="line">server.registServer(args[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// å¯åŠ¨ä¸šåŠ¡åŠŸèƒ½</span></span><br><span class="line">server.business(args[<span class="number">0</span>]);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyg.zkcase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeClient</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">connectString</span> <span class="operator">=</span> <span class="string">&quot;hadoop102:2181,hadoop103:2181,hadoop104:2181&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">ZooKeeper</span> <span class="variable">zk</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">parentNode</span> <span class="operator">=</span> <span class="string">&quot;/servers&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåˆ°zkçš„å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(connectString, sessionTimeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span> &#123;</span><br><span class="line">      <span class="comment">// å†æ¬¡å¯åŠ¨ç›‘å¬</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          getServerList();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getServerList</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æœåŠ¡å™¨å­èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶ä¸”å¯¹çˆ¶èŠ‚ç‚¹è¿›è¡Œç›‘å¬</span></span><br><span class="line">    List&lt;String&gt; children = zk.getChildren(parentNode, <span class="literal">true</span>);</span><br><span class="line">    ArrayList&lt;String&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">    <span class="type">byte</span>[] data = zk.getData(parentNode + <span class="string">&quot;/&quot;</span> + child, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    servers.add(<span class="keyword">new</span> <span class="title class_">String</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŠŠserversèµ‹å€¼ç»™æˆå‘˜serverListï¼Œå·²æä¾›ç»™å„ä¸šåŠ¡çº¿ç¨‹ä½¿ç”¨</span></span><br><span class="line">     serversList = servers;</span><br><span class="line">     System.out.println(serversList);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸šåŠ¡åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;client is working ...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–zkè¿æ¥</span></span><br><span class="line"><span class="type">DistributeClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributeClient</span>();</span><br><span class="line">client.getConnect();</span><br><span class="line"><span class="comment">// è·å–serversçš„å­èŠ‚ç‚¹ä¿¡æ¯ï¼Œä»ä¸­è·å–æœåŠ¡å™¨ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line">client.getServerList();</span><br><span class="line"><span class="comment">// ä¸šåŠ¡è¿›ç¨‹å¯åŠ¨</span></span><br><span class="line">client.business();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article><nav class="article-nav"><div class="article-nav-prev">ğŸ”™<a href="/2018/10/22/spark/spark-hadoop-1/">Hadoopé›†ç¾¤é…ç½®</a></div><div class="article-nav-next">ğŸ”œ<a href="/2018/10/21/spark/spark-zookeeper-1/">CentOS 7.5 æ­å»ºZookeeperé›†ç¾¤ä¸å‘½ä»¤è¡Œæ“ä½œ</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2018/10/21/spark/spark-zookeeper-2/';
var disqus_title = 'ZookeeperåŸç†ä¸APIåº”ç”¨';
var disqus_url = 'https://galudisu.info/2018/10/21/spark/spark-zookeeper-2/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>