<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>Elasticsearché›†ç¾¤å®‰è£…é…ç½®</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">Elasticsearché›†ç¾¤å®‰è£…é…ç½®</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2018-05-22</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/elasticsearch/">elasticsearch</a></p></div><div class="article-content"><p>å®˜æ–¹æ­å»ºæ­¥éª¤å†™å¾—æ¯”è¾ƒç®€å•ï¼Œå› æ­¤éµå¾ªå®˜æ–¹çš„æŒ‡å¼•<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html">å®‰è£…</a>ã€‚</p>
<span id="more"></span>
<h2 id="è®¾ç½®ESå ç”¨å†…å­˜"><a class="header-anchor" href="#è®¾ç½®ESå ç”¨å†…å­˜">Â¶</a>è®¾ç½®ESå ç”¨å†…å­˜</h2>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒESåªå…è®¸æœ¬åœ°è®¿é—®apiæ¥å£ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨å¦å¤–ä¸€å°æœºå™¨ä¸Šè®¿é—®ESçš„æ¥å£çš„è¯ï¼Œéœ€è¦é…ç½®ä¸»æœºåœ°å€ï¼š<br>
/data/elasticsearch-6.2.4&gt; vim config/elasticsearch.yml</p>
<p>#network.host: 192.168.0.1<br>
network.host: 10.140.7.12</p>
<p>ä¿å­˜é€€å‡ºï¼Œé‡æ–°å¯åŠ¨esï¼Œä¸€èˆ¬éƒ½ä¼šæŠ¥é”™ï¼Œæ— æ³•å¯åŠ¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[2017-03-16T10:51:23,168][INFO ][o.e.t.TransportService ] [DwX_4EG] publish_address &#123;10.140.7.12:9300&#125;, bound_addresses &#123;10.140.7.12:9300&#125;</span><br><span class="line">[2017-03-16T10:51:23,176][INFO ][o.e.b.BootstrapChecks ] [DwX_4EG] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks</span><br><span class="line">ERROR: bootstrap checks failed</span><br><span class="line">max virtual memory areas vm.max_map_count [65536] is too low, increase to at least [262144]</span><br></pre></td></tr></table></figure>
<p>å¯¹äºè¿™ä¸ªé”™è¯¯ï¼Œéœ€è¦è¿™æ ·å¤„ç†ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œæˆ–è€…æŠŠè¿™ä¸ªé…ç½®<code>/etc/sysctl.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡å¯åŠ¨ï¼ŒæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk</span><br></pre></td></tr></table></figure>
<p>åŸå› ï¼š<br>
è¿™æ˜¯åœ¨å› ä¸ºæ“ä½œç³»ç»Ÿä¸æ”¯æŒSecCompï¼Œè€ŒES6.2.4é»˜è®¤<code>bootstrap.system_call_filter</code>ä¸ºtrueè¿›è¡Œæ£€æµ‹ï¼Œæ‰€ä»¥å¯¼è‡´æ£€æµ‹å¤±è´¥ï¼Œå¤±è´¥åç›´æ¥å¯¼è‡´ESä¸èƒ½å¯åŠ¨ã€‚</p>
<p>è§£å†³ï¼š</p>
<p>åœ¨<code>elasticsearch.yml</code>ä¸­é…ç½®<code>bootstrap.system_call_filter</code>ä¸ºfalseï¼Œæ³¨æ„è¦åœ¨Memoryä¸‹é¢:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br></pre></td></tr></table></figure>
<p>é‡å¯ok<br>
ä¸€ä¸‹æ˜¯ç½‘å‹é‡åˆ°çš„é—®é¢˜ï¼Œä¹Ÿä¸€å¹¶è®°å½•ä¸€ä¸‹ï¼š<br>
[2016-12-20T22:37:28,543][INFO ][o.e.b.BootstrapCheck ] [elk-node1] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks<br>
[2016-12-20T22:37:28,552][ERROR][o.e.b.Bootstrap ] [elk-node1] node validation exception<br>
bootstrap checks failed<br>
max number of threads [1024] for user [elasticsearch] is too low, increase to at least [2048]<br>
[2016-12-20T22:37:28,560][INFO ][o.e.n.Node ] [elk-node1] stopping â€¦<br>
[2016-12-20T22:37:28,628][INFO ][o.e.n.Node ] [elk-node1] stopped<br>
[2016-12-20T22:37:28,629][INFO ][o.e.n.Node ] [elk-node1] closing â€¦<br>
[2016-12-20T22:37:28,677][INFO ][o.e.n.Node ] [elk-node1] closed</p>
<p>æŠ¥äº†ä¸€å¤§ä¸²é”™è¯¯ï¼Œå…¶å®åªæ˜¯ä¸€ä¸ªè­¦å‘Šã€‚</p>
<p>è§£å†³ï¼šä½¿ç”¨æ–°çš„linuxç‰ˆæœ¬ï¼Œå°±ä¸ä¼šå‡ºç°æ­¤ç±»é—®é¢˜äº†ã€‚</p>
<p>é—®é¢˜äºŒï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR: bootstrap checks failed</span><br><span class="line">max file descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]</span><br><span class="line">max number of threads [1024] for user [lishang] likely too low, increase to at least [2048]</span><br></pre></td></tr></table></figure>
<p>è§£å†³ï¼šåˆ‡æ¢åˆ°rootç”¨æˆ·ï¼Œç¼–è¾‘<code>/etc/security/limits.conf</code> æ·»åŠ ç±»ä¼¼å¦‚ä¸‹å†…å®¹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜ä¸‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max number of threads [1024] for user [lish] likely too low, increase to at least [2048]</span><br></pre></td></tr></table></figure>
<p>è§£å†³ï¼šåˆ‡æ¢åˆ°rootç”¨æˆ·ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶<code>/etc/security/limits.d/90-nproc.conf</code>ï¼Œå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶ï¼Œåˆ™å¢åŠ </p>
<p>ä¿®æ”¹å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* soft nproc 1024</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¿®æ”¹ä¸º</span></span><br><span class="line">* soft nproc 2048</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜å››ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]</span><br></pre></td></tr></table></figure>
<p>è§£å†³ï¼šåˆ‡æ¢åˆ°rootç”¨æˆ·ä¿®æ”¹é…ç½®<code>/etc/sysctl.conf</code></p>
<p>æ·»åŠ ä¸‹é¢é…ç½®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure>
<p>å¹¶æ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜äº”ï¼š</p>
<p>ä»¥.debå®‰è£…åŒ…æ–¹å¼å®‰è£…æ—¶ï¼Œä¼šæç¤ºæ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ã€‚æ·»åŠ è½¯è¿æ¥ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/elasticsearch /usr/share/elasticsearch/config</span><br></pre></td></tr></table></figure>
<p>é‡å¯æœåŠ¡ã€‚</p>
<h2 id="è„‘è£‚-split-brain"><a class="header-anchor" href="#è„‘è£‚-split-brain">Â¶</a>è„‘è£‚(split brain)</h2>
<p>å•æœºæµ‹è¯•å¼€å‘çš„æ—¶å€™, å…¶å®ä¸€ä¸ªèŠ‚ç‚¹å°±å¤Ÿäº†. ä¸Šçº¿, ä½¿ç”¨ä¸¤ä¸ªèŠ‚ç‚¹, ç›®çš„æ˜¯åˆ©ç”¨esæœ¬èº«çš„ç‰¹æ€§åšåˆ°é«˜å¯ç”¨.</p>
<p>ä½†æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯è¿œè¿œä¸å¤Ÿçš„. å¯åŠ¨å, é›†ç¾¤ä¼šé€‰ä¸¾ä¸€ä¸ªmaster, ä¸€åˆ‡ok. ä½†æ˜¯å¦‚æœå­˜åœ¨ç½‘ç»œé—®é¢˜æˆ–è€…æŸä¸ªèŠ‚ç‚¹æ— å“åº”(è´Ÿè½½è¿‡é«˜), å°±ä¼šè®¤ä¸ºå¯¹æ–¹deadäº†, ç„¶åä¸¤ä¸ªèŠ‚ç‚¹è‡ªåŠ¨é€‰ä¸¾ä¸ºmaster, åœ¨åç»­å»ºç´¢å¼•çš„æ—¶å€™é€ æˆæ•°æ®ä¸ä¸€è‡´.</p>
<p>ä¸¤ä¸ªèŠ‚ç‚¹é˜²è„‘è£‚çš„é…ç½®, minimum_master_nodeså†³å®šäº†é€‰ä¸»éœ€è¦çš„æœ€å°‘èŠ‚ç‚¹æ•°, N/2+1, ä¸¤ä¸ªèŠ‚ç‚¹å³2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.minimum_master_nodes: 2 </span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯, æ­¤æ—¶ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†, åˆ™æ•´ä¸ªé›†ç¾¤æŒ‚äº†(æ— æ³•é€‰ä¸¾ä¸»èŠ‚ç‚¹äº†)</p>
<p>æ‰€ä»¥, è¦å†åŠ ä¸€ä¸ªèŠ‚ç‚¹, è¿™ä¸ªèŠ‚ç‚¹åªè¦ä¿è¯ç¨³å®šå³å¯, å¯¹cpuå’Œç£ç›˜è¦æ±‚ä¸é«˜. è¿™ä¸ªesèŠ‚ç‚¹çš„é…ç½®åŒå…¶ä»–èŠ‚ç‚¹çš„åŒºåˆ«node.data: false, ä¸å­˜å‚¨ç´¢å¼•æ•°æ®.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">split</span> brain prevent</span></span><br><span class="line">node.data: false</span><br></pre></td></tr></table></figure>
</div></article><nav class="article-nav"><div class="article-nav-prev">ğŸ”™<a href="/2018/06/06/akka/ddata/Akka-Distributed-Data-Deep-Dive/">Akka Distributed Data Deep Dive</a></div><div class="article-nav-next">ğŸ”œ<a href="/2018/05/06/docker/Modifying-an-Existing-Docker-Image/">Modifying an Existing Docker Image</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2018/05/22/elasticsearch/Elasticsearch-Cluster-Setup/';
var disqus_title = 'Elasticsearché›†ç¾¤å®‰è£…é…ç½®';
var disqus_url = 'https://galudisu.info/2018/05/22/elasticsearch/Elasticsearch-Cluster-Setup/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>