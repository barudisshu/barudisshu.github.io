<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>åœ¨CentOS7å¿«é€Ÿæ„å»ºCephé›†ç¾¤</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">åœ¨CentOS7å¿«é€Ÿæ„å»ºCephé›†ç¾¤</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-02-08</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/ceph/">ceph</a></p></div><div class="article-content"><p>Cephæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¯æ‰©å±•ã€é«˜å¯ç”¨ã€æ€§èƒ½ä¼˜å¼‚çš„å­˜å‚¨ç³»ç»Ÿå¹³å°ï¼Œæ”¯æŒå—è®¾å¤‡ã€æ–‡ä»¶ç³»ç»Ÿå’ŒRESTä¸‰ç§å­˜å‚¨æ¥å£ã€‚å®ƒæ˜¯ä¸€ä¸ªé«˜åº¦å¯é…ç½®çš„ç³»ç»Ÿï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œç•Œé¢ç”¨äºç›‘è§†å’Œæ§åˆ¶å…¶å­˜å‚¨é›†ç¾¤ã€‚Cephè¿˜åŒ…å«è®¤è¯å’ŒæˆæƒåŠŸèƒ½ï¼Œå¯å…¼å®¹å¤šç§å­˜å‚¨ç½‘å…³æ¥å£ï¼Œå¦‚OpenStack Swiftå’ŒAmazon S3ã€‚</p>
<span id="more"></span>
<h2 id="Ceph-cluster"><a class="header-anchor" href="#Ceph-cluster">Â¶</a>Ceph cluster</h2>
<p>æœºå™¨å‡†å¤‡ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ceph Â  Â 10.10.51.200</span><br><span class="line">mon1 Â   10.10.51.201</span><br><span class="line">mon2 Â   10.10.51.202</span><br><span class="line">mon3 Â   10.10.51.203</span><br><span class="line">osd1 Â  Â 10.10.51.211 Â  (10.10.110.211)</span><br><span class="line">osd2 Â  Â 10.10.51.212 Â  (10.10.110.212)</span><br><span class="line">osd3 Â  Â 10.10.51.213 Â  (10.10.110.213)</span><br><span class="line">osd4 Â  Â 10.10.51.214 Â  (10.10.110.214)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºceph-deployå·¥å…·æ˜¯é€šè¿‡ä¸»æœºåä¸å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œæ‰€ä»¥è¦é€šè¿‡hostnamectlä¿®æ”¹ä¸»æœºåï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl --static set-hostname ceph</span><br><span class="line">hostnamectl --static set-hostname mon1</span><br><span class="line">hostnamectl --static set-hostname mon2</span><br><span class="line">hostnamectl --static set-hostname mon3</span><br><span class="line">hostnamectl --static set-hostname osd1</span><br><span class="line">hostnamectl --static set-hostname osd2</span><br><span class="line">hostnamectl --static set-hostname osd3</span><br><span class="line">hostnamectl --static set-hostname osd4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œ</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">useradd -d /home/cephuser -m cephuser</span><br><span class="line">passwd cephuser</span><br><span class="line">echo &quot;cephuser ALL = (root) NOPASSWD:ALL&quot; | sudo tee /etc/sudoers.d/cephuser</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephuser</span><br><span class="line">yum install -y ntp ntpdate ntp-doc</span><br><span class="line">ntpdate 0.us.pool.ntp.org</span><br><span class="line">hwclock --systohc</span><br><span class="line">systemctl enable ntpd.service</span><br><span class="line">systemctl start ntpd.service</span><br><span class="line">yum install -y open-vm-tools ## If you run the nodes as virtual machines, otherwise remove this line</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line">sed -i s&#x27;/Defaults requiretty/#Defaults requiretty&#x27;/g /etc/sudoers</span><br><span class="line">yum -y update</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªèŠ‚ç‚¹å»ºç«‹cephuserç”¨æˆ·çš„sshè¿æ¥ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id cephuser@osd1</span><br></pre></td></tr></table></figure>
<p>åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.ssh/config</span><br><span class="line">Host osd1</span><br><span class="line">Hostname osd1</span><br><span class="line">User cephuser</span><br><span class="line">Host osd2</span><br><span class="line">Hostname osd2</span><br><span class="line">User cephuser</span><br><span class="line">Host osd3</span><br><span class="line">Hostname osd3</span><br><span class="line">User cephuser</span><br><span class="line">Host osd4</span><br><span class="line">Hostname osd4</span><br><span class="line">User cephuser</span><br><span class="line">Host mon1</span><br><span class="line">Hostname mon1</span><br><span class="line">User cephuser</span><br><span class="line">Host mon2</span><br><span class="line">Hostname mon2</span><br><span class="line">User cephuser</span><br><span class="line">Host mon3</span><br><span class="line">Hostname mon3</span><br><span class="line">User cephuser</span><br></pre></td></tr></table></figure>
<p>æ›´æ”¹æƒé™ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 440 ~/.ssh/config</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªOSDèŠ‚ç‚¹å‡†å¤‡ç£ç›˜ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parted -s /dev/sdc mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sdc -f</span><br><span class="line">parted -s /dev/sdd mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sdd -f</span><br><span class="line">parted /dev/sde mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sde -f</span><br><span class="line">parted -s /dev/sdb mklabel gpt mkpart primary 0% 33% mkpart primary 34% 66% mkpart primary 67% 100%</span><br></pre></td></tr></table></figure>
<p><img src="/img/ceph/osd-disk.png" alt=""></p>
<p>ä½¿ç”¨cephuserè´¦å·ç™»å½•ç®¡ç†èŠ‚ç‚¹(å³ceph node)ï¼Œåˆ›å»ºä¸€ä¸ªä¸“ç”¨ç›®å½•ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ceph-deploy</span><br><span class="line">cd ceph-deploy/</span><br></pre></td></tr></table></figure>
<p>åœ¨ç›‘æ§èŠ‚ç‚¹å®‰è£…å’Œåˆ›å»ºæ–°é›†ç¾¤ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -Uhv http://download.ceph.com/rpm-jewel/el7/noarch/ceph-release-1-1.el7.noarch.rpm</span><br><span class="line">sudo yum update -y &amp;&amp; sudo yum install ceph-deploy -y</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–é…ç½®ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vi ceph.conf</span><br><span class="line">public network = 10.10.51.0/24</span><br><span class="line">cluster network = 10.10.110.0/24</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Choose reasonable numbers <span class="keyword">for</span> number of replicas and placement <span class="built_in">groups</span>.</span></span><br><span class="line">osd pool default size = 2 # Write an object 2 times</span><br><span class="line">osd pool default min size = 1 # Allow writing 1 copy in a degraded state</span><br><span class="line">osd pool default pg num = 256</span><br><span class="line">osd pool default pgp num = 256</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Choose a reasonable crush leaf <span class="built_in">type</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">0 <span class="keyword">for</span> a 1-node cluster.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1 <span class="keyword">for</span> a multi node cluster <span class="keyword">in</span> a single rack</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2 <span class="keyword">for</span> a multi node, multi chassis cluster with multiple hosts <span class="keyword">in</span> a chassis</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3 <span class="keyword">for</span> a multi node cluster with hosts across racks, etc.</span></span><br><span class="line">osd crush chooseleaf type = 1</span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œåœ¨ä¸ºä¸ªèŠ‚ç‚¹å®‰è£…cephï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install ceph mon1 mon2 mon3 osd1 osd2 osd3 osd4</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy gatherkeys mon1</span><br></pre></td></tr></table></figure>
<p>åœ¨æ¯ä¸ªOSDèŠ‚ç‚¹åˆ›å»ºOSDç£ç›˜ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy disk zap osd1:sdc osd1:sdd osd1:sde</span><br><span class="line">ceph-deploy osd create osd1:sdc:/dev/sdb1 osd1:sdd:/dev/sdb2 osd1:sde:/dev/sdb3</span><br></pre></td></tr></table></figure>
<p>é›†ç¾¤åˆ›å»ºå®Œåï¼Œå‘ç°OSDæ²¡æœ‰å¼€å¯ï¼Œè¿™æ—¶æ–°ç‰ˆceph-deployä¸€ä¸ªissueï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤è§£å†³ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sgdisk -t 1:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/sdb</span><br><span class="line">sgdisk -t 2:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/sdb</span><br><span class="line">sgdisk -t 3:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/sdb</span><br></pre></td></tr></table></figure>
<p>é‡å¯æ¯ä¸ªèŠ‚ç‚¹ï¼Œç»™æ¯ä¸ªmonitoråŠ å…¥systemdï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ceph-mon.target</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œç»™æ‰€æœ‰èŠ‚ç‚¹éƒ¨ç½²å¯†é’¥ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin ceph mon1 mon2 mon3 osd1 osd2 osd3 osd4</span><br><span class="line">sudo chmod +r /etc/ceph/ceph.client.admin.keyring</span><br></pre></td></tr></table></figure>
<p>ä¸€åˆ‡å¦‚æœæ­£å¸¸ï¼Œä½¿ç”¨<code>ceph -v</code>å’Œ<code>ceph -s</code>ä¼šçœ‹åˆ°ï¼Œ</p>
<p><img src="/img/ceph/ceph-cluster.png" alt=""></p>
</div></article><nav class="article-nav"><div class="article-nav-prev">ğŸ”™<a href="/2019/02/26/algorithm/probabilistic/birthday-paradox-problem/">éšæœºç®—æ³•å…³äºç”Ÿæ—¥æ‚–è®ºçš„æ±‚å€¼</a></div><div class="article-nav-next">ğŸ”œ<a href="/2019/02/08/kubernetes/kubernetes-04-theory-and-concpetion-md/">kubernetes è®¾è®¡ç†å¿µåŠä¸»è¦æ¦‚å¿µä¹‹Volume(å››)</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/02/08/ceph/quickly-build-a-new-ceph-cluster-with-ceph-deploy-on-centos-7/';
var disqus_title = 'åœ¨CentOS7å¿«é€Ÿæ„å»ºCephé›†ç¾¤';
var disqus_url = 'https://galudisu.info/2019/02/08/ceph/quickly-build-a-new-ceph-cluster-with-ceph-deploy-on-centos-7/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>