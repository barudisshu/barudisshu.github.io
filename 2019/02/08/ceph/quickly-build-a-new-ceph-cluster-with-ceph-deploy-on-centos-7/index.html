<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>在CentOS7快速构建Ceph集群</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">在CentOS7快速构建Ceph集群</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-02-08</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/ceph/">ceph</a></p></div><div class="article-content"><p>Ceph是一个分布式、可扩展、高可用、性能优异的存储系统平台，支持块设备、文件系统和REST三种存储接口。它是一个高度可配置的系统，并提供了一个命令行界面用于监视和控制其存储集群。Ceph还包含认证和授权功能，可兼容多种存储网关接口，如OpenStack Swift和Amazon S3。</p>
<span id="more"></span>
<h2 id="Ceph-cluster"><a class="header-anchor" href="#Ceph-cluster">¶</a>Ceph cluster</h2>
<p>机器准备，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ceph    10.10.51.200</span><br><span class="line">mon1    10.10.51.201</span><br><span class="line">mon2    10.10.51.202</span><br><span class="line">mon3    10.10.51.203</span><br><span class="line">osd1    10.10.51.211   (10.10.110.211)</span><br><span class="line">osd2    10.10.51.212   (10.10.110.212)</span><br><span class="line">osd3    10.10.51.213   (10.10.110.213)</span><br><span class="line">osd4    10.10.51.214   (10.10.110.214)</span><br></pre></td></tr></table></figure>
<p>因为ceph-deploy工具是通过主机名与其他节点通信，所以要通过hostnamectl修改主机名，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl --static set-hostname ceph</span><br><span class="line">hostnamectl --static set-hostname mon1</span><br><span class="line">hostnamectl --static set-hostname mon2</span><br><span class="line">hostnamectl --static set-hostname mon3</span><br><span class="line">hostnamectl --static set-hostname osd1</span><br><span class="line">hostnamectl --static set-hostname osd2</span><br><span class="line">hostnamectl --static set-hostname osd3</span><br><span class="line">hostnamectl --static set-hostname osd4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">每个节点执行以下命令，</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">useradd -d /home/cephuser -m cephuser</span><br><span class="line">passwd cephuser</span><br><span class="line">echo &quot;cephuser ALL = (root) NOPASSWD:ALL&quot; | sudo tee /etc/sudoers.d/cephuser</span><br><span class="line">chmod 0440 /etc/sudoers.d/cephuser</span><br><span class="line">yum install -y ntp ntpdate ntp-doc</span><br><span class="line">ntpdate 0.us.pool.ntp.org</span><br><span class="line">hwclock --systohc</span><br><span class="line">systemctl enable ntpd.service</span><br><span class="line">systemctl start ntpd.service</span><br><span class="line">yum install -y open-vm-tools ## If you run the nodes as virtual machines, otherwise remove this line</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class="line">sed -i s&#x27;/Defaults requiretty/#Defaults requiretty&#x27;/g /etc/sudoers</span><br><span class="line">yum -y update</span><br></pre></td></tr></table></figure>
<p>每个节点建立cephuser用户的ssh连接，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id cephuser@osd1</span><br></pre></td></tr></table></figure>
<p>在每个节点执行下面命令，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.ssh/config</span><br><span class="line">Host osd1</span><br><span class="line">Hostname osd1</span><br><span class="line">User cephuser</span><br><span class="line">Host osd2</span><br><span class="line">Hostname osd2</span><br><span class="line">User cephuser</span><br><span class="line">Host osd3</span><br><span class="line">Hostname osd3</span><br><span class="line">User cephuser</span><br><span class="line">Host osd4</span><br><span class="line">Hostname osd4</span><br><span class="line">User cephuser</span><br><span class="line">Host mon1</span><br><span class="line">Hostname mon1</span><br><span class="line">User cephuser</span><br><span class="line">Host mon2</span><br><span class="line">Hostname mon2</span><br><span class="line">User cephuser</span><br><span class="line">Host mon3</span><br><span class="line">Hostname mon3</span><br><span class="line">User cephuser</span><br></pre></td></tr></table></figure>
<p>更改权限，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 440 ~/.ssh/config</span><br></pre></td></tr></table></figure>
<p>每个OSD节点准备磁盘，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parted -s /dev/sdc mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sdc -f</span><br><span class="line">parted -s /dev/sdd mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sdd -f</span><br><span class="line">parted /dev/sde mklabel gpt mkpart primary xfs 0% 100%</span><br><span class="line">mkfs.xfs /dev/sde -f</span><br><span class="line">parted -s /dev/sdb mklabel gpt mkpart primary 0% 33% mkpart primary 34% 66% mkpart primary 67% 100%</span><br></pre></td></tr></table></figure>
<p><img src="/img/ceph/osd-disk.png" alt=""></p>
<p>使用cephuser账号登录管理节点(即ceph node)，创建一个专用目录，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ceph-deploy</span><br><span class="line">cd ceph-deploy/</span><br></pre></td></tr></table></figure>
<p>在监控节点安装和创建新集群，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -Uhv http://download.ceph.com/rpm-jewel/el7/noarch/ceph-release-1-1.el7.noarch.rpm</span><br><span class="line">sudo yum update -y &amp;&amp; sudo yum install ceph-deploy -y</span><br></pre></td></tr></table></figure>
<p>初始化配置，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vi ceph.conf</span><br><span class="line">public network = 10.10.51.0/24</span><br><span class="line">cluster network = 10.10.110.0/24</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Choose reasonable numbers <span class="keyword">for</span> number of replicas and placement <span class="built_in">groups</span>.</span></span><br><span class="line">osd pool default size = 2 # Write an object 2 times</span><br><span class="line">osd pool default min size = 1 # Allow writing 1 copy in a degraded state</span><br><span class="line">osd pool default pg num = 256</span><br><span class="line">osd pool default pgp num = 256</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Choose a reasonable crush leaf <span class="built_in">type</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">0 <span class="keyword">for</span> a 1-node cluster.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1 <span class="keyword">for</span> a multi node cluster <span class="keyword">in</span> a single rack</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2 <span class="keyword">for</span> a multi node, multi chassis cluster with multiple hosts <span class="keyword">in</span> a chassis</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3 <span class="keyword">for</span> a multi node cluster with hosts across racks, etc.</span></span><br><span class="line">osd crush chooseleaf type = 1</span><br></pre></td></tr></table></figure>
<p>然后，在为个节点安装ceph，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install ceph mon1 mon2 mon3 osd1 osd2 osd3 osd4</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy gatherkeys mon1</span><br></pre></td></tr></table></figure>
<p>在每个OSD节点创建OSD磁盘，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy disk zap osd1:sdc osd1:sdd osd1:sde</span><br><span class="line">ceph-deploy osd create osd1:sdc:/dev/sdb1 osd1:sdd:/dev/sdb2 osd1:sde:/dev/sdb3</span><br></pre></td></tr></table></figure>
<p>集群创建完后，发现OSD没有开启，这时新版ceph-deploy一个issue，执行下面命令解决，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sgdisk -t 1:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/sdb</span><br><span class="line">sgdisk -t 2:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/sdb</span><br><span class="line">sgdisk -t 3:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/sdb</span><br></pre></td></tr></table></figure>
<p>重启每个节点，给每个monitor加入systemd，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ceph-mon.target</span><br></pre></td></tr></table></figure>
<p>最后，给所有节点部署密钥，</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin ceph mon1 mon2 mon3 osd1 osd2 osd3 osd4</span><br><span class="line">sudo chmod +r /etc/ceph/ceph.client.admin.keyring</span><br></pre></td></tr></table></figure>
<p>一切如果正常，使用<code>ceph -v</code>和<code>ceph -s</code>会看到，</p>
<p><img src="/img/ceph/ceph-cluster.png" alt=""></p>
</div></article><nav class="article-nav"><div class="article-nav-prev">🔙<a href="/2019/02/26/algorithm/probabilistic/birthday-paradox-problem/">随机算法关于生日悖论的求值</a></div><div class="article-nav-next">🔜<a href="/2019/02/08/kubernetes/kubernetes-04-theory-and-concpetion-md/">kubernetes 设计理念及主要概念之Volume(四)</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/02/08/ceph/quickly-build-a-new-ceph-cluster-with-ceph-deploy-on-centos-7/';
var disqus_title = '在CentOS7快速构建Ceph集群';
var disqus_url = 'https://galudisu.info/2019/02/08/ceph/quickly-build-a-new-ceph-cluster-with-ceph-deploy-on-centos-7/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>