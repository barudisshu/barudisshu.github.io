<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>kubernetes è®¾è®¡ç†å¿µåŠä¸»è¦æ¦‚å¿µä¹‹Service(ä¸‰)</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">ç®€å•æ˜“æ‡‚ã®ç°ä»£é­”æ³•</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">kubernetes è®¾è®¡ç†å¿µåŠä¸»è¦æ¦‚å¿µä¹‹Service(ä¸‰)</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-02-06</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tag"> </i><a class="tag-link" href="/tags/kubernetes/">kubernetes</a></p></div><div class="article-content"><h2 id="æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"><a class="header-anchor" href="#æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡">Â¶</a>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h2>
<p>Kubernetesæä¾›æœ‰æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œæä¾›äº†Serviceèµ„æºï¼Œå¹¶é€šè¿‡kube-proxyé…åˆcloud provideræ¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚</p>
<p>ç›®å‰ï¼ŒKubernetesä¸­çš„è´Ÿè½½å‡è¡¡å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æœºåˆ¶ï¼Œæ¯ç§æœºåˆ¶éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>Serviceï¼šç›´æ¥ç”¨Serviceæä¾›clusterå†…éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œå¹¶å€ŸåŠ©cloud provideræä¾›çš„LBæä¾›å¤–éƒ¨è®¿é—®</li>
<li>Ingress Controllerï¼šè¿˜æ˜¯ç”¨Serviceæä¾›clusterå†…éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œä½†æ˜¯é€šè¿‡è‡ªå®šä¹‰LBæä¾›å¤–éƒ¨è®¿é—®</li>
<li>Service Load Balancerï¼šæŠŠload balancerç›´æ¥è·‘åœ¨å®¹å™¨ä¸­ï¼Œå®ç°Bare Metalçš„Service Load Balancer</li>
<li>Custom Load Balancerï¼šè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ï¼Œå¹¶æ›¿ä»£kube-proxyï¼Œä¸€èˆ¬åœ¨ç‰©ç†éƒ¨ç½²Kubernetesæ—¶ä½¿ç”¨ï¼Œæ–¹ä¾¿æ¥å…¥å…¬å¸å·²æœ‰çš„å¤–éƒ¨æœåŠ¡</li>
</ul>
<span id="more"></span>
<h2 id="Service"><a class="header-anchor" href="#Service">Â¶</a>Service</h2>
<p><img src="/img/kubernetes/service.svg" alt="service"></p>
<p>Kubernetesè®¾è®¡äº†Serviceçš„æŠ½è±¡ï¼šé€»è¾‘ä¸Šçš„ä¸€ç»„Podï¼Œä¸€ç§å¯ä»¥è®¿é—®å®ƒä»¬çš„ç­–ç•¥ã€‚è¿™ä¸€ç»„Podèƒ½å¤Ÿè¢«Serviceè®¿é—®ï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ã€‚é€šå¸¸æ˜¯é€šè¿‡Label Selectorå®ç°çš„ã€‚å€ŸåŠ©Serviceï¼Œåº”ç”¨å¯ä»¥æ–¹ä¾¿çš„å®ç°æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼Œå®ç°åº”ç”¨çš„é›¶å®•æœºå‡çº§ã€‚</p>
<p>Serviceé€šè¿‡æ ‡ç­¾é€‰å–æœåŠ¡åç«¯ï¼Œä¸€èˆ¬é…åˆReplication Controlleræˆ–è€…Deploymentæ¥ä¿è¯åç«¯å®¹å™¨çš„æ­£å¸¸è¿è¡Œã€‚è¿™äº›åŒ¹é…æ ‡ç­¾çš„Pod IPå’Œç«¯å£åˆ—è¡¨ç»„æˆendpointsï¼Œç”±kube-proxyè´Ÿè´£å°†æœåŠ¡IPè´Ÿè½½å‡è¡¡åˆ°è¿™äº›endpointsä¸Šã€‚</p>
<p>Serviceç”±å››ç§ç±»å‹ï¼š</p>
<ul>
<li>ClusterIPï¼šé»˜è®¤ç±»å‹ï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»…clusterå†…éƒ¨å¯ä»¥è®¿é—®çš„è™šæ‹ŸIP</li>
<li>NodePortï¼šåœ¨ClusterIPåŸºç¡€ä¸Šä¸ºServiceåœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šä¸€ä¸ªç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡<code>&lt;NodeIP&gt;:NodePort</code>æ¥è®¿é—®è¯¥æœåŠ¡</li>
<li>LoadBalancerï¼šåœ¨NodePortçš„åŸºç¡€ä¸Šï¼Œå€ŸåŠ©cloud provideråˆ›å»ºä¸€ä¸ªå¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°<code>&lt;NodeIP&gt;:NodePort</code></li>
<li>ExternalNameï¼šå°†æœåŠ¡é€šè¿‡DNS CNAMEè®°å½•æ–¹å¼è½¬å‘åˆ°æŒ‡å®šçš„åŸŸå(é€šè¿‡<code>spec.externalName</code>è®¾å®š)ã€‚éœ€è¦kube-dnsç‰ˆæœ¬åœ¨1.7ä»¥ä¸Šã€‚</li>
</ul>
<p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥å°†å·²æœ‰çš„æœåŠ¡ä»¥Serviceçš„å½¢å¼åŠ å…¥åˆ°Kubernetesé›†ç¾¤ä¸­æ¥ï¼Œåªéœ€è¦åœ¨åˆ›å»ºServiceçš„æ—¶å€™ä¸æŒ‡å®šLabel selectorï¼Œè€Œæ˜¯åœ¨Serviceåˆ›å»ºå¥½åæ‰‹åŠ¨ä¸ºå…¶æ·»åŠ endpointã€‚</p>
<ol>
<li>Serviceå®šä¹‰</li>
</ol>
<p>é€šè¿‡yamlæˆ–jsonå®šä¹‰ï¼Œæ¯”å¦‚ä¸‹é¢å®šä¹‰ä¸€ä¸ªåä¸ºnginxçš„æœåŠ¡ï¼Œå°†æœåŠ¡çš„80ç«¯å£è½¬å‘åˆ°default namespaceä¸­å¸¦æœ‰æ ‡ç­¾<code>run=nginx</code>çš„Podçš„80ç«¯å£ï¼Œ</p>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œé¦–å…ˆè¦éƒ¨ç½²Podï¼Œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">nginx-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>å…¶æ¬¡å†å®šä¹‰Serviceï¼Œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure>
<p>Serviceè‡ªåŠ¨åˆ†é…äº†Cluster IP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> kubectl get service nginx-app       </span><br><span class="line">NAME        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx-app   ClusterIP   10.108.166.254   &lt;none&gt;        80/TCP    22s</span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨åˆ›å»ºçš„endpoint</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get endpoints nginx-app</span><br><span class="line">NAME        ENDPOINTS                       AGE</span><br><span class="line">nginx-app   10.244.1.38:80,10.244.3.28:80   82s</span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨å…³è”endpoint</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe service nginx-app  </span><br><span class="line">Name:              nginx-app</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            run=nginx-app</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          run=nginx-app</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.108.166.254</span><br><span class="line">Port:              &lt;unset&gt;  80/TCP</span><br><span class="line">TargetPort:        80/TCP</span><br><span class="line">Endpoints:         10.244.1.38:80,10.244.3.28:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>ä¸æŒ‡å®šSelectorsæœåŠ¡</li>
</ol>
<p>åœ¨åˆ›å»ºServiceçš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šSelectorsï¼Œç”¨æ¥å°†Serviceè½¬å‘åˆ°Kubernetesé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡(è€Œä¸æ˜¯Pod)ã€‚ç›®å‰æœ‰ä¸¤ç§æ–¹æ³•</p>
<p>ä¸€æ˜¯ï¼Œ è‡ªå®šä¹‰endpointï¼Œå³åˆ›å»ºåŒåçš„serviceå’Œendpointï¼Œåœ¨endpointä¸­è®¾ç½®å¤–éƒ¨æœåŠ¡çš„IPå’Œç«¯å£</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">	  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">	  <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">	 <span class="attr">ports:</span></span><br><span class="line">	   <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9376</span></span><br></pre></td></tr></table></figure>
<p>äºŒæ˜¯ï¼Œé€šè¿‡DNSè½¬å‘ï¼Œåœ¨Serviceå®šä¹‰ä¸­æŒ‡å®šexternalNameã€‚æ­¤æ—¶DNSæœåŠ¡ä¼šç»™<code>&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</code>åˆ›å»ºä¸€ä¸ªCNAMEè®°å½•ï¼Œå…¶å€¼ä¸º<code>my.database.example.com</code>ã€‚å¹¶ä¸”ï¼Œè¯¥æœåŠ¡ä¸ä¼šè‡ªåŠ¨åˆ†é…Cluster IPï¼Œéœ€è¦é€šè¿‡Serviceçš„DNSæ¥è®¿é—®(è¿™ç§æœåŠ¡ä¹Ÿç§°ä¸ºHeadless Service)ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">my.database.example.com</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>HeadlessæœåŠ¡</li>
</ol>
<p>HeadlessæœåŠ¡å³ä¸éœ€è¦Cluster IPçš„æœåŠ¡ï¼Œå³åœ¨åˆ›å»ºServiceçš„æ—¶å€™ï¼ŒæŒ‡å®š<code>spec.clusterIP=None</code>ï¼ŒåŒ…æ‹¬ä¸¤ç§ç±»å‹ï¼Œ</p>
<ul>
<li>ä¸æŒ‡å®šSelectorsï¼Œä½†è®¾ç½®externalNameï¼Œé€šè¿‡CNAMEè®°å½•å¤„ç†</li>
<li>æŒ‡å®šSelectorsï¼Œé€šè¿‡DNS Aè®°å½•è®¾ç½®åç«¯endpointåˆ—è¡¨</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-80-80-3b6tl</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢æ„å»ºçš„nginxæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°Cluster IPæ˜¯None</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get service --all-namespaces=true</span><br><span class="line">NAMESPACE     NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes             ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         36h</span><br><span class="line">default       nginx-app              ClusterIP   None            &lt;none&gt;        80/TCP          43s</span><br><span class="line">kube-system   kube-dns               ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   36h</span><br><span class="line">kube-system   kubernetes-dashboard   NodePort    10.96.197.202   &lt;none&gt;        443:31234/TCP   27h</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢éƒ¨ç½²çš„Podä¿¡æ¯ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> kubectl get pods -n default -o wide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE    IP            NODE                   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-app-7d77b84f86-rsmrp   1/1     Running   0          2m1s   10.244.3.30   node03.kubernetes.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-app-7d77b84f86-snx4p   1/1     Running   0          2m1s   10.244.2.19   node02.kubernetes.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @10.96.0.10 nginx-app.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<p><img src="/img/kubernetes/dig-nginx.png" alt="dig-nginx"></p>
<p>è¿™ç±»Headless Serviceèµ„æºï¼Œä¸€èˆ¬é€šè¿‡Ingress Controllerè¿›è¡Œè´Ÿè½½ï¼Œ</p>
<ol start="4">
<li>æœåŠ¡æš´éœ²</li>
</ol>
<p>Serviceçš„IPåœ°å€ä»…åœ¨é›†ç¾¤å†…å¯è¾¾ï¼Œç„¶è€Œæœ‰äº›æœåŠ¡éœ€è¦æš´éœ²å¤–éƒ¨ç½‘ç»œã€‚æ­¤æ—¶éœ€è¦åœ¨é›†ç¾¤è¾¹ç¼˜ä¸ºå…¶æ·»åŠ ä¸€å±‚è½¬å‘æœºåˆ¶ï¼Œä»¥å®ç°å°†å¤–éƒ¨è¯·æ±‚æµé‡æ¥å…¥åˆ°é›†ç¾¤Serviceèµ„æºä¸Šï¼Œ</p>
<p>Kubernetesçš„Serviceå…±æœ‰å››ç§ç±»å‹ï¼Œ ClusterIPã€NodePortã€LoadBalancerå’ŒExternalNameï¼š</p>
<ul>
<li>ClusterIP Serviceï¼šä½¿ç”¨iptablesæ¨¡å¼ï¼Œé›†ç¾¤å†…éƒ¨çš„æºIPä¼šä¿ç•™(ä¸åšSNAT)ã€‚å¦‚æœclientå’Œserver podåœ¨åŒä¸€ä¸ªNodeä¸Šï¼Œé‚£æºIPå°±æ˜¯client podçš„IPåœ°å€ï¼›å¦‚æœåœ¨ä¸åŒçš„Nodeä¸Šï¼ŒæºIPåˆ™å–å†³äºç½‘ç»œæ’ä»¶æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæ¯”å¦‚ä½¿ç”¨flannelæ—¶ï¼ŒæºIPæ˜¯node flannel IPåœ°å€ã€‚</li>
<li>NodePort Serviceï¼šæºIPä¼šåšSNATï¼Œserver podçœ‹åˆ°çš„æºIPæ˜¯Node IPã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ç»™serviceåŠ ä¸Šannotation <code>service.beta.kubernetes.io/external-traffic=OnlyLocal</code>ï¼Œè®©serviceåªä»£ç†æœ¬åœ°endpointçš„è¯·æ±‚(å¦‚æœæ²¡æœ‰æœ¬åœ°endpointåˆ™ç›´æ¥ä¸¢åŒ…)ï¼Œä»è€Œä¿ç•™æºIPã€‚</li>
<li>LoadBalancer Serviceï¼šæºIPä¼šåšSNATï¼Œserver podçœ‹åˆ°çš„æºIPæ˜¯Node IPã€‚åœ¨GKE/GCEä¸­ï¼Œæ·»åŠ annotation <code>service.beta.kubernetes.io/external-traffic=OnlyLocal</code>åå¯ä»¥è‡ªåŠ¨ä»è´Ÿè½½å‡è¡¡å™¨ä¸­åˆ é™¤æ²¡æœ‰æœ¬åœ°endpointçš„Nodeã€‚</li>
<li>ExternalNameï¼šä¸»æœºåè¢«DNSæœåŠ¡è§£æè‡³CNAMEç±»å‹çš„è®°å½•ã€‚å®ƒå¹¶ä¸æ˜¯ç”±Kubernetesé›†ç¾¤æä¾›çš„æœåŠ¡ï¼Œè€Œæ˜¯æŠŠé›†ç¾¤å¤–éƒ¨çš„æŸæœåŠ¡ä»¥DNS CNAMEè®°å½•çš„æ–¹å¼æ˜ å°„åˆ°é›†ç¾¤ã€‚å› æ­¤è¿™ç§ç±»å‹çš„Serviceæ²¡æœ‰ClusterIPã€NodePortã€labelã€ä¹Ÿä¸ä¼šæœ‰endpointã€‚</li>
</ul>
<blockquote>
<p>ä¸ºäº†å‡ç¼“IPåœ°å€ç©ºé—´æ¯ç«­é—®é¢˜ï¼ŒNATè¢«å¼•å…¥æå‡ºï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œ</p>
</blockquote>
<blockquote>
<p>SNATï¼Œæºåœ°å€è½¬æ¢ï¼ŒSource Network Address Translationï¼Œåœ¨NATè·¯ç”±ä¸­ï¼Œå°†ipv4çš„æºåœ°å€è½¬æ¢ä¸ºå…¬ç½‘å¯è®¿é—®çš„IP<br>
DNATï¼Œç›®æ ‡åœ°å€è½¬æ¢ï¼ŒDestination Network Address Translationï¼Œåœ¨NATè·¯ç”±ä¸­ï¼Œå°†ipv4çš„ç›®æ ‡åœ°å€è½¬æ¢ä¸ºç§æœ‰ç½‘ç»œçš„å¯è®¿é—®IP</p>
</blockquote>
<ol start="5">
<li>Ingress Controller</li>
</ol>
<p>Serviceè™½ç„¶è§£å†³äº†æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œä½†å®ƒåœ¨ä½¿ç”¨ä¸Šè¿˜æ˜¯æœ‰ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚</p>
<ul>
<li>åªæ”¯æŒ4å±‚è´Ÿè½½å‡è¡¡ï¼Œæ²¡æœ‰7å±‚åŠŸèƒ½</li>
<li>å¯¹å¤–è®¿é—®çš„æ—¶å€™ï¼ŒNodePortç±»å‹éœ€è¦åœ¨å¤–éƒ¨æ­å»ºé¢å¤–çš„è´Ÿè½½å‡è¡¡ï¼Œè€ŒLoadBalancerè¦æ±‚Kuberneteså¿…é¡»è·‘åœ¨æ”¯æŒçš„cloud providerä¸Šé¢</li>
</ul>
<p>Ingresså°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é™åˆ¶è€Œå¼•å…¥çš„æ–°èµ„æºï¼Œä¸»è¦ç”¨æ¥å°†æœåŠ¡æš´éœ²åˆ°clusterå¤–é¢ï¼Œå¹¶ä¸”å¯ä»¥è‡ªå®šä¹‰æœåŠ¡çš„è®¿é—®ç­–ç•¥ã€‚æ¯”å¦‚æƒ³è¦é€šè¿‡è´Ÿè½½å‡è¡¡å™¨å®ç°ä¸åŒå­åŸŸååˆ°ä¸åŒæœåŠ¡çš„è®¿é—®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">foo.bar.com --|                |-&gt; foo.bar.com s1:80</span><br><span class="line">              | 178.91.123.132 |</span><br><span class="line">bar.foo.com --|                |-&gt; bar.foo.com s2:80</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥è¿™æ ·æ¥å®šä¹‰Ingressï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/nginx</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-app</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„Ingressæœ¬èº«å¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ï¼Œclusterä¸­éœ€è¦è¿è¡Œä¸€ä¸ªingress controlleræ¥æ ¹æ®Ingressçš„å®šä¹‰æ¥ç®¡ç†è´Ÿè½½å‡è¡¡å™¨ã€‚ç›®å‰è®¾è®¡æä¾›äº†nginxå’Œgceçš„å‚è€ƒå®ç°ã€‚</p>
<p>Kubernetesä¸­ï¼ŒServiceèµ„æºå’ŒPodèµ„æºçš„IPåœ°å€ä»…èƒ½ç”¨äºé›†ç¾¤ç½‘ç»œå†…éƒ¨çš„é€šä¿¡ï¼Œæ‰€æœ‰çš„ç½‘ç»œæµé‡éƒ½æ— æ³•ç©¿é€è¾¹ç•Œè·¯ç”±å™¨(Edge Router)ä»¥å®ç°é›†ç¾¤å†…å¤–é€šä¿¡ã€‚å³ä½¿Serviceä¸­ä½¿ç”¨NodePortæˆ–LoadBalanceré€šè¿‡èŠ‚ç‚¹å¼•å…¥å¤–éƒ¨æµé‡ï¼Œå®ƒä¾ç„¶æ˜¯4å±‚æµé‡è½¬å‘ï¼Œå¯ç”¨çš„è´Ÿè½½å‡è¡¡å™¨ä¹Ÿä¸ºä¼ è¾“å±‚è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚</p>
<p>Ingressæ˜¯Kubernetes APIçš„æ ‡å‡†èµ„æºç±»å‹ä¹‹ä¸€ï¼ŒIngressæ§åˆ¶å™¨å¯ä»¥ç”±ä»»ä½•å…·æœ‰åå‘ä»£ç†(HTTP/HTTPS)åŠŸèƒ½çš„æœåŠ¡ç¨‹åºå®ç°ï¼Œä¾‹å¦‚Nginxã€Envoyã€HAProxyã€Vulcandå’ŒTraefikç­‰ã€‚</p>
<p>Traefikæä¾›äº†æ˜“ç”¨çš„Ingress Controllerï¼Œä½¿ç”¨æ–¹æ³•è§<a target="_blank" rel="noopener" href="https://docs.traefik.io/user-guide/kubernetes/">https://docs.traefik.io/user-guide/kubernetes/</a>ã€‚</p>
<p>ä¸ç®¡æ€æ ·ï¼Œä½ éƒ½éœ€è¦å…ˆå®‰è£…Ingress Controllerï¼Œ</p>
<p>é¦–å…ˆç¡®ä¿nginx-ingressæ˜¯å¦éƒ¨ç½²ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm list</span><br><span class="line">NAME               	REVISION	UPDATED                 	STATUS  	CHART              	APP VERSION	NAMESPACE</span><br><span class="line">rolling-rattlesnake	1       	Wed Feb  6 05:09:06 2019	DEPLOYED	nginx-ingress-0.9.5	0.10.2     	default  </span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰å®‰è£…ï¼Œéƒ¨ç½²ä¸€ä»½ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/mandatory.yaml</span><br></pre></td></tr></table></figure>
<p>å¦å¤–è¿˜éœ€è¦æ‰‹åŠ¨åˆ›å»ºä¸€ä»½Serviceä¸ºå…¶åˆ›å»ºç›¸å…³çš„NodePortæˆ–LoadBalancerï¼Œå¹¶æ˜ç¡®æŒ‡å®šç«¯å£å’ŒIPåœ°å€ï¼Œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30443</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.99</span><span class="number">.99</span><span class="number">.99</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºIngressè§„åˆ™éœ€è¦ç”±ä¸€ä¸ªServiceèµ„æºå¯¹è±¡è¾…åŠ©è¯†åˆ«ç›¸å…³çš„æ‰€æœ‰Podå¯¹è±¡ï¼Œä½†ingress-nginxæ§åˆ¶å™¨å¯ç»ç”±<code>host</code>è§„åˆ™çš„å®šä¹‰ç›´æ¥å°†æµé‡è°ƒåº¦ï¼Œ</p>
<p>ä¸‹é¢åŠ¨æ‰‹å®è·µä¸€ä¸‹ï¼Œéƒ¨ç½²ä¸¤ä»½Ingressï¼Œè´Ÿè½½åˆ°è¿™ä¸ªnginx-ingress-controllerä¸‹ï¼Œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-deploy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">testing</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tomcat.kubernetes.io</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">tomcat-svc</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.kubernetes.io</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">nginx-app</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/kubernetes/ingress-controller-service.png" alt=""></p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œservcieå’Œpodä»…å¯åœ¨é›†ç¾¤å†…éƒ¨ç½‘ç»œä¸­é€šè¿‡IPåœ°å€è®¿é—®ã€‚æ‰€æœ‰åˆ°è¾¾è¾¹ç•Œè·¯ç”±å™¨çš„æµé‡æˆ–è¢«ä¸¢å¼ƒæˆ–è¢«è½¬å‘åˆ°å…¶å®ƒåœ°æ–¹ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œå¯èƒ½æ˜¯ï¼Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">internet</span><br><span class="line">      |</span><br><span class="line">------------</span><br><span class="line">[ Services ]</span><br></pre></td></tr></table></figure>
<p>Ingressæ˜¯æˆæƒå…¥ç«™è¿æ¥åˆ°è¾¾é›†ç¾¤æœåŠ¡çš„è§„åˆ™é›†åˆï¼Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> internet</span><br><span class="line">     |</span><br><span class="line">[ Ingress ]</span><br><span class="line">--|-----|--</span><br><span class="line">[ Services ]</span><br></pre></td></tr></table></figure>
<p>Ingressæ§åˆ¶å™¨è‡ªèº«ä¹Ÿæ˜¯è¿è¡Œäºé›†ç¾¤ä¸­çš„Podèµ„æºå¯¹è±¡ï¼Œå®ƒä¸è¢«ä»£ç†çš„è¿è¡Œä¸ºPodèµ„æºçš„åº”ç”¨è¿è¡Œåœ¨åŒä¸€ç½‘ç»œä¸­ï¼Œ</p>
<p><img src="/img/kubernetes/ingress-controller.svg" alt=""></p>
<p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œåœ¨é›†ç¾¤ä¹‹å¤–åº”è¯¥å­˜åœ¨ä¸€ä¸ªç”¨äºè°ƒåº¦ç”¨æˆ·è¯·æ±‚è‡³ä¸ªèŠ‚ç‚¹ä¸ŠIngressæ§åˆ¶å™¨ç›¸å…³çš„NodePortçš„è´Ÿè½½å‡è¡¡å™¨ã€‚å¦‚æœä¸å…·æœ‰LBaaSçš„ä½¿ç”¨æ¡ä»¶ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥åŸºäºNginxã€Haproxyã€LVSç­‰æ‰‹åŠ¨æ„å»ºï¼Œå¹¶é€šè¿‡Keepalivedç­‰è§£å†³æ–¹æ¡ˆå®ç°å…¶æœåŠ¡çš„é«˜å¯ç”¨é…ç½®ã€‚</p>
<p><img src="/img/kubernetes/nginx-lb.png" alt="nginx-lb"></p>
<ol start="6">
<li>Service Load Balancer</li>
</ol>
<p>åœ¨Ingresså‡ºç°ä»¥å‰ï¼ŒService Load Blanceræ˜¯æ¨èçš„è§£å†³Serviceå±€é™æ€§çš„æ–¹å¼ã€‚Service Load Balancerå°†haproxyè·‘åœ¨å®¹å™¨ä¸­ï¼Œå¹¶ç›‘æ§serviceå’Œendpointçš„å˜åŒ–ï¼Œé€šè¿‡å®¹å™¨IPå¯¹å¤–æä¾›4å±‚å’Œ7å±‚è´Ÿè½½å‡è¡¡æœåŠ¡ã€‚</p>
<p>ç¤¾åŒºæä¾›çš„Service Load Balanceræ”¯æŒå››ç§è´Ÿè½½å‡è¡¡åè®®ï¼šTCPã€HTTPã€HTTPSå’ŒSSL TERMINATIONï¼Œå¹¶æ”¯æŒACLè®¿é—®æ§åˆ¶ã€‚</p>
<ol start="7">
<li>Custom Load Balancer</li>
</ol>
<p>è™½ç„¶Kubernetesæä¾›äº†ä¸°å¯Œçš„è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œä½†åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šç¢°åˆ°ä¸€äº›å¤æ‚çš„åœºæ™¯æ˜¯å®ƒä¸èƒ½æ”¯æŒçš„ï¼Œæ¯”å¦‚</p>
<ul>
<li>æ¥å…¥å·²æœ‰çš„è´Ÿè½½å‡è¡¡è®¾å¤‡</li>
<li>å¤šç§Ÿæˆ·ç½‘ç»œæƒ…å†µä¸‹ï¼Œå®¹å™¨ç½‘ç»œå’Œä¸»æœºç½‘ç»œæ˜¯éš”ç¦»çš„ï¼Œè¿™æ ·<code>kube-proxy</code>å°±ä¸èƒ½æ­£å¸¸å·¥ä½œ</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™å¯ä»¥è‡ªå®šä¹‰ç»„ä»¶ï¼Œå¹¶ä»£æ›¿kube-proxyæ¥åšè´Ÿè½½å‡è¡¡ã€‚åŸºæœ¬çš„æ€è·¯æ˜¯ç›‘æ§Kubernetesä¸­Serviceå’Œendpointçš„å˜åŒ–ï¼Œå¹¶æ ¹æ®è¿™äº›å˜åŒ–æ¥é…ç½®è´Ÿè½½å‡è¡¡å™¨ã€‚æ¯”å¦‚weave fluxã€nginx plusã€kube2haproxyç­‰ã€‚</p>
</div></article><nav class="article-nav"><div class="article-nav-prev">ğŸ”™<a href="/2019/02/08/kubernetes/kubernetes-04-theory-and-concpetion-md/">kubernetes è®¾è®¡ç†å¿µåŠä¸»è¦æ¦‚å¿µä¹‹Volume(å››)</a></div><div class="article-nav-next">ğŸ”œ<a href="/2019/02/04/kubernetes/kubernetes-02-theory-and-concpetion-md/">kubernetes è®¾è®¡ç†å¿µåŠä¸»è¦æ¦‚å¿µä¹‹Pod(äºŒ)</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/02/06/kubernetes/kubernetes-03-theory-and-concpetion-md/';
var disqus_title = 'kubernetes è®¾è®¡ç†å¿µåŠä¸»è¦æ¦‚å¿µä¹‹Service(ä¸‰)';
var disqus_url = 'https://galudisu.info/2019/02/06/kubernetes/kubernetes-03-theory-and-concpetion-md/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>Â©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>