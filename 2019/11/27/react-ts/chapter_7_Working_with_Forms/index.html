<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>第七章 表单</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/maths/">Maths</a></li><li class="menu-item"><a class="menu-link" href="/projects/">Projects</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/maths/">Maths</a></li><li class="menu-item"><a class="menu-link" href="/projects/">Projects</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">第七章 表单</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-11-27</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tags"> </i><a class="tag-link" href="/tags/react/">react<span class="tag">, </span></a><a class="tag-link" href="/tags/typescript/">typescript</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/react/">react</a></p></div><div class="article-content"><ul>
<li>creating a form with controlled components</li>
<li>Reducing boilerplate code with generic components</li>
<li>Validating forms</li>
<li>Form submission</li>
</ul>
<h2 id="Creating-a-form-with-controlled-components"><a class="header-anchor" href="#Creating-a-form-with-controlled-components">¶</a>Creating a form with controlled components</h2>
<p>表单是大部分应用的常见内容。在React中，创建表单的标准方式是使用被称为 <em>controlled component</em> 的组件。</p>
<h3 id="Adding-a-Contact-Us-page"><a class="header-anchor" href="#Adding-a-Contact-Us-page">¶</a>Adding a Contact Us page</h3>
<p>在src目录添加一个新的文件<code>ContactUsPage.tsx</code>，内容如下</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContactUsPage</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> (</span><br><span class="line">			<span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;page-container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Contact Us<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				<span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">					If you enter your details we&#x27;ll get back to you as soon as we can.</span></span><br><span class="line"><span class="language-xml">				<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ContactUsPage</span>;</span><br></pre></td></tr></table></figure>
<p>该组件需要包含状态，目前首先创建了header相关信息。接下来，导入该组件到页面中，打开<code>Routes.tsx</code>，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ContactUsPage</span> <span class="keyword">from</span> <span class="string">&quot;./ContactUsPage&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>在<code>Routes</code>组件的<code>render</code>方法中，添加新的路由，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Switch</span>&gt;</span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">exact</span>=<span class="string">&#123;true&#125;</span> <span class="attr">from</span>=<span class="string">&quot;/&quot;</span> <span class="attr">to</span>=<span class="string">&quot;/products&quot;</span> /&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/products/:id&quot;</span> <span class="attr">component</span>=<span class="string">&quot;&#123;ProductPage&#125; /&gt;</span></span></span></span><br><span class="line">	<span class="language-xml"><span class="tag"><span class="string">&lt;Route exact=&#123;true&#125; path=&quot;</span>/<span class="attr">products</span>&quot; <span class="attr">compoent</span>=<span class="string">&#123;ProductsPage&#125;</span> /&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;contactus&quot;</span> <span class="attr">component</span>=<span class="string">&#123;ContactUsPage&#125;</span> /&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/admin&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  ...</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">compoent</span>=<span class="string">&#123;LoginPage&#125;</span> /&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">component</span>=<span class="string">&#123;NotFoundPage&#125;</span> /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Switch</span>&gt;</span><br></pre></td></tr></table></figure>
<p>打开<code>Header.tsx</code>，添加新的导航信息，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;nav&gt;</span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">NavLink</span> <span class="attr">to</span>=<span class="string">&quot;/products&quot;</span> <span class="attr">className</span>=<span class="string">&quot;header-link&quot;</span> <span class="attr">activeClassName</span>=<span class="string">&quot;header-link-active&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  Products</span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">NavLink</span>&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">NavLink</span> <span class="attr">to</span>=<span class="string">&quot;/contactus&quot;</span> <span class="attr">className</span>=<span class="string">&quot;header-link&quot;</span> <span class="attr">activeClassName</span>=<span class="string">&quot;header-link-active&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  Contact Us</span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">NavLink</span>&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">NavLink</span> <span class="attr">to</span>=<span class="string">&quot;/admin&quot;</span> <span class="attr">className</span>=<span class="string">&quot;header-link&quot;</span> <span class="attr">activeClassName</span>=<span class="string">&quot;header-link-active&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  Admin</span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">NavLink</span>&gt;</span></span></span><br><span class="line">&lt;/nav&gt;</span><br></pre></td></tr></table></figure>
<p>现在，页面已经创建了，下面创建表单输入框。</p>
<h2 id="Creating-controlled-inputs"><a class="header-anchor" href="#Creating-controlled-inputs">¶</a>Creating controlled inputs</h2>
<p>在src目录下创建一个新文件<code>ContactUs.tsx</code>，包含下面内容，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ContactUs</span>: <span class="title class_">React</span>.<span class="property">SFC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">className</span>=<span class="string">&quot;form&quot;</span> <span class="attr">noValidate</span>=<span class="string">&#123;true&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	    <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Your name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ContactUs</span>;</span><br></pre></td></tr></table></figure>
<p>这是一个功能组件，渲染一个表单包含label和用户名的输入框。</p>
<p>现在需要添加对应的css样式，</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.form</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0px</span> auto <span class="number">0px</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">label</span> &#123;</span><br><span class="line">  <span class="attribute">align-self</span>: flex-start;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">input</span>, <span class="selector-tag">select</span>, <span class="selector-tag">textarea</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: Arial, Helvetica, sans-serif;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">border</span>: lightgray solid <span class="number">1px</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在在我们页面<code>ContactUsPage.tsx</code>添加并渲染表单，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ContactUs</span> <span class="keyword">from</span> <span class="string">&quot;./ContactUs&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>在<code>render</code>方法中添加，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;page-container&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Contact Us<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you enter your details we&#x27;ll get back to you as soon as we can.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">ContactUs</span> /&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>表单已经创建好了，但需要创建一个状态类型到<code>ContactUsPage</code>页面中，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">reason</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">notes</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContactUsPage</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;&#123;&#125;, <span class="title class_">IState</span>&gt; &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>在构造器中初始化状态，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="variable language_">super</span>(props);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    <span class="attr">email</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="attr">name</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="attr">notes</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">	<span class="attr">reason</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要将<code>ContactUsPage</code>中的状态传递到<code>ContactUs</code>组件中。在<code>ContactUs</code>组件中，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IProps</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">reason</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">notes</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ContactUs</span>: <span class="title class_">React</span>.<span class="property">SFC</span>&lt;<span class="title class_">IProps</span>&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>将表单名name绑定到<code>name</code>属性中，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;form-group&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Your name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&#123;props.name&#125;</span> /&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>将表单状态传递给<code>ContactUsPage</code>，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ContactUs</span></span><br><span class="line">  name=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">name</span>&#125;</span><br><span class="line">  emial=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">email</span>&#125;</span><br><span class="line">  reason=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">reason</span>&#125;</span><br><span class="line">  notes=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">notes</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>添加事件监听，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input <span class="keyword">type</span>=<span class="string">&quot;text&quot;</span> id=<span class="string">&quot;name&quot;</span> value=&#123;props.<span class="property">name</span>&#125; onChange=&#123;handleNameChange&#125; /&gt;</span><br></pre></td></tr></table></figure>
<p>创建对应的handler，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ContactUs</span>: <span class="title class_">React</span>.<span class="property">SFC</span>&lt;<span class="title class_">IProps</span>&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleNameChange</span> = (<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">    props.<span class="title function_">onNameChange</span>(e.<span class="property">currentTarget</span>.<span class="property">value</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> ( ... );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这是使用到了<code>React.ChangeEvent</code>。我们需要添加<code>onNameChange</code>函数到IProps中，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IProps</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">onNameChange</span>: <span class="function">(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">onEmailChange</span>: <span class="function">(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span></span>) =&gt;</span><span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">reason</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">onReasonChange</span>: <span class="function">(<span class="params"><span class="attr">reason</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">notes</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">onNotesChange</span>: <span class="function">(<span class="params"><span class="attr">notes</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在需要将来自<code>ContactUsPage</code>的Props传递到<code>ContactUs</code>中，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ContactUs</span></span><br><span class="line">  name=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">name</span>&#125;</span><br><span class="line">  onNameChange=&#123;<span class="variable language_">this</span>.<span class="property">handleNameChange</span>&#125;</span><br><span class="line">  email=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">email</span>&#125;</span><br><span class="line">  onEmailChange=&#123;<span class="variable language_">this</span>.<span class="property">handleEmailChange</span>&#125;</span><br><span class="line">  reason=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">reason</span>&#125;</span><br><span class="line">  onReasonChange=&#123;<span class="variable language_">this</span>.<span class="property">handleReasonChange</span>&#125;</span><br><span class="line">  notes=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">notes</span>&#125;</span><br><span class="line">  onNotesChange=&#123;<span class="variable language_">this</span>.<span class="property">handleNotesChange</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来创建对应的handlers方法，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleNameChange = (<span class="attr">name</span>: <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; name &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">private</span> handleEmailChange = <span class="function">(<span class="params"><span class="attr">email</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; email &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">private</span> handleReasonChange = <span class="function">(<span class="params"><span class="attr">reason</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; reason &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">private</span> handleNotesChange = <span class="function">(<span class="params"><span class="attr">notes</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; notes &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下来在<code>ContactUs</code>中补充其它表单内容，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;form className=<span class="string">&quot;form&quot;</span> noValidate=&#123;<span class="literal">true</span>&#125;&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span>&gt;</span>Your name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">id</span>=<span class="string">&quot;name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">value</span>=<span class="string">&#123;props.name&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">onChange</span>=<span class="string">&#123;handleNameChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;email&quot;</span>&gt;</span>Your email address<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&#123;props.email&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;handleEmailChange&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;reason&quot;</span>&gt;</span>Reason you need to contact us<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;reason&quot;</span> <span class="attr">value</span>=<span class="string">&#123;props.reason&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;handleReasonChange&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Marketing&quot;</span>&gt;</span>Marketing<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Support&quot;</span> <span class="attr">selected</span>=<span class="string">&#123;true&#125;</span>&gt;</span>Support<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Feedback&quot;</span>&gt;</span>Feedback<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Jobs&quot;</span>&gt;</span>Jobs<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Other&quot;</span>&gt;</span>Other<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;notes&quot;</span>&gt;</span>Additional notes<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;notes&quot;</span> <span class="attr">value</span>=<span class="string">&#123;props.notes&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;handleNotesChange&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>现在创建这些handler的函数属性</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleEmailChange</span> = (<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>)</span><br><span class="line">=&gt; &#123;</span><br><span class="line">props.<span class="title function_">onEmailChange</span>(e.<span class="property">currentTarget</span>.<span class="property">value</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleReasonChange</span> = (<span class="params"><span class="attr">e</span>:</span></span><br><span class="line"><span class="params"><span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLSelectElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">props.<span class="title function_">onReasonChange</span>(e.<span class="property">currentTarget</span>.<span class="property">value</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleNotesChange</span> = (<span class="params"><span class="attr">e</span>:</span></span><br><span class="line"><span class="params"><span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLTextAreaElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">props.<span class="title function_">onNotesChange</span>(e.<span class="property">currentTarget</span>.<span class="property">value</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Reducing-boilerplate-code-with-generic-components"><a class="header-anchor" href="#Reducing-boilerplate-code-with-generic-components">¶</a>Reducing boilerplate code with generic components</h2>
<p>通用表单组件将有利于减少表单代码的重复实现。我们重构上面的<code>ContactUs</code>组件来实现generic form components。</p>
<p>假设我们希望，理想情况下消费组件<code>ContactUs</code>内容的generic component组件的形式如下，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Form</span></span><br><span class="line">defaultValues=&#123;&#123; <span class="attr">name</span>: <span class="string">&quot;&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;&quot;</span>, <span class="attr">reason</span>: <span class="string">&quot;Support&quot;</span>, <span class="attr">notes</span>: <span class="string">&quot;&quot;</span> &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Your name&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Your email address&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Email&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span> <span class="attr">name</span>=<span class="string">&quot;reason&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Reason you need to contact us&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">type</span>=<span class="string">&quot;Select&quot;</span> <span class="attr">options</span>=<span class="string">&#123;[</span>&quot;<span class="attr">Marketing</span>&quot;, &quot;<span class="attr">Support</span>&quot;, &quot;<span class="attr">Feedback</span>&quot;, &quot;<span class="attr">Jobs</span>&quot;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">&quot;<span class="attr">Other</span>&quot;]&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span> <span class="attr">name</span>=<span class="string">&quot;notes&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Additional notes&quot;</span> <span class="attr">type</span>=<span class="string">&quot;TextArea&quot;</span> /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure>
<p>在这个示例中，有两个通用合成组件：<code>Form</code>和<code>Field</code>。它们有某些特点，</p>
<ul>
<li><code>Form</code>组件是用于合成、管理状态和交互的。</li>
<li><code>Fomr</code>组件使用<code>defaultValues</code>属性来传递默认值。</li>
<li><code>Field</code>组件渲染label和每个字段的一个编辑器。</li>
<li>每个字段包含一个<code>name</code>属性，并被存储在对应的state属性名内。</li>
<li>每个字段有一个<code>label</code>属性用于展示每个字段的标签。</li>
<li>特殊字段用<code>type</code>属性标识。默认的属性为文本类型<code>input</code>。</li>
<li>如果编辑器类型是<code>Select</code>，我们可以通过<code>options</code>属性指定。</li>
</ul>
<p>新版本的<code>ContactUs</code>组件相比原来的更简短、更易用。状态的管理和事件的处理被隐藏和封装在<code>Form</code>组件内。</p>
<h3 id="Creating-a-basic-form-component"><a class="header-anchor" href="#Creating-a-basic-form-component">¶</a>Creating a basic form component</h3>
<p>下面开始构建我们的通用<code>Form</code>组件；</p>
<ol>
<li>在<code>src</code>文件夹下创建一个新的文件<code>Form.tsx</code>，包含下面内容：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormProps</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Form</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;<span class="title class_">IFormProps</span>, <span class="title class_">IState</span>&gt; &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: <span class="title class_">IFormProps</span></span>) &#123;&#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Form</code>是一个基类组件，因为它需要管理状态。我们将属性接口命名为<code>IFormProps</code>，因为之后我们将需要一个字段属性的接口。</p>
<ol start="2">
<li>添加一个<code>defaultValues</code>属性到<code>IFormProps</code>接口中，它为每个字段提供默认值，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">IValues</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormProps</span> &#123;</span><br><span class="line">  <span class="attr">defaultValues</span>: <span class="title class_">IValues</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用一个额外的接口<code>IValues</code>，它是一个索引的key/value类型<code>[key: string]: any</code>，key是字段名，value是字段值。</p>
<p>因此，<code>defaultValues</code>属性可以是，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> name<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> email<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> reason<span class="punctuation">:</span> <span class="string">&quot;Support&quot;</span><span class="punctuation">,</span> notes<span class="punctuation">:</span> <span class="string">&quot;&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>对于表单的state，需要存储这个接口类型，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>接下来需要在构造方法中初始化组件的状态，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: <span class="title class_">IFormProps</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">super</span>(props);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">state</span> =  &#123;</span><br><span class="line">    <span class="attr">values</span>: props.<span class="property">defaultValues</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>最后一步，实现<code>render</code>方法，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">className</span>=<span class="string">&quot;form&quot;</span> <span class="attr">noValidate</span>=<span class="string">&#123;true&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  &#123;this.props.children&#125;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在<code>form</code>标签中渲染子组件，使用了<code>children</code>属性。</p>
<p>接下来，我们需要实现我们的<code>Field</code>组件。</p>
<h3 id="Adding-a-basic-Field-component"><a class="header-anchor" href="#Adding-a-basic-Field-component">¶</a>Adding a basic Field component</h3>
<p><code>Field</code>组件需要渲染一个标签(label)和一个编辑框(editor)。</p>
<ol>
<li>首先在<code>Form.tsx</code>中创建一个接口属性，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IFieldProps</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">label</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">type</span>?: <span class="string">&quot;Text&quot;</span> | <span class="string">&quot;Email&quot;</span> | <span class="string">&quot;Select&quot;</span> | <span class="string">&quot;TextArea&quot;</span>;</span><br><span class="line">  <span class="attr">options</span>?: <span class="built_in">string</span>[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>name</code>表示字段名</li>
<li><code>label</code>是展示标签</li>
<li><code>type</code>输入类型，可选</li>
<li><code>options</code>，仅作用于当<code>type</code>是<code>Select</code>时，可选</li>
</ul>
<ol start="2">
<li>现在添加<code>Field</code>属性字段的骨架，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Field</span>: <span class="title class_">React</span>.<span class="property">SFC</span>&lt;<span class="title class_">IFieldProps</span>&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>另外，首先添加<code>type</code>字段的默认属性，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Form</span>.<span class="property">Field</span>.<span class="property">defaultProps</span> = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;Text&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样，默认的<code>type</code>是一个文本类型，</p>
<ol start="4">
<li>现在，渲染它的内容，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Field</span>: <span class="title class_">React</span>.<span class="property">SFC</span>&lt;<span class="title class_">IFieldProps</span>&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; name, label, <span class="keyword">type</span>, options &#125; = props;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;name&#125;</span>&gt;</span>&#123;label&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#123;type.toLowerCase()&#125;</span> <span class="attr">id</span>=<span class="string">&#123;name&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  ）；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这虽然是好的开头，但是，仅使用<code>Text</code>和<code>Email</code>类型。</p>
<ol start="5">
<li>因此，需要添加合适的条件进行渲染，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">type</span> === <span class="string">&quot;TextArea&quot;</span> ... &#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="keyword">type</span> === <span class="string">&quot;Select&quot;</span> &amp;&amp; (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;options &amp;&amp;</span></span><br><span class="line"><span class="language-xml">      options.map(option =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">key</span>=<span class="string">&#123;option&#125;</span> <span class="attr">value</span>=<span class="string">&#123;option&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;option&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Sharing-state-with-React-context"><a class="header-anchor" href="#Sharing-state-with-React-context">¶</a>Sharing state with React context</h3>
<p><code>Form</code>组件内的字段值状态，需要在<code>Field</code>组件内共享，即可以通过<code>Field</code>组件访问和修改。</p>
<ol>
<li>首先在<code>Form.tsx</code>创建一个接口，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormContext</span> &#123;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在<code>IFormContext</code>下使用<code>React.createContext</code>创建一个上下文创建(context component)，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">FormContext</span> = <span class="title class_">React</span>.<span class="property">createContext</span>&lt;<span class="title class_">IFormContext</span>&gt;(&#123;</span><br><span class="line">  <span class="attr">values</span>: &#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在<code>Form</code>的<code>render</code>方法中，创建包含上下文的值，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">context</span>: <span class="title class_">IFormContext</span> = &#123;</span><br><span class="line">    <span class="attr">values</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> ( ... )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>包装表单标签，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">FormContext</span>.<span class="property">Provider</span> value=&#123;context&#125;&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">...</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">    ...</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">FormContext</span>.<span class="property">Provider</span>&gt;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>在<code>Field</code>上下文进行消费，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">FormContext</span>.<span class="property">Consumer</span>&gt;</span><br><span class="line">  &#123;<span class="function"><span class="params">context</span> =&gt;</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )&#125;</span><br><span class="line">&lt;/<span class="title class_">FormContext</span>.<span class="property">Consumer</span>&gt;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>现在可以访问这些上下文了，下面补充剩余的输入框，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;form-group&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;name&#125;</span>&gt;</span>&#123;label&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line">  &#123;(<span class="keyword">type</span> === <span class="string">&quot;Text&quot;</span> || <span class="keyword">type</span> === <span class="string">&quot;Email&quot;</span>) &amp;&amp; (</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#123;type.toLowerCase()</span> <span class="attr">id</span>=<span class="string">&#123;name&#125;</span> <span class="attr">value</span>=<span class="string">&#123;context.values[name]&#125;</span> /&gt;</span></span></span><br><span class="line">   )&#125;</span><br><span class="line">   </span><br><span class="line">   &#123;<span class="keyword">type</span> === <span class="string">&quot;TextArea&quot;</span> &amp;&amp; (</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&#123;name&#125;</span> <span class="attr">value</span>=<span class="string">&#123;context.values[name]&#125;</span> /&gt;</span></span></span><br><span class="line">   )&#125;</span><br><span class="line">   </span><br><span class="line">   &#123;<span class="keyword">type</span> === <span class="string">&quot;Select&quot;</span> &amp;&amp; (</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">value</span>=<span class="string">&#123;context.values[name]&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	 ...</span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line">   )&#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>目前还没有添加事件用于更新上下文的状态，需要实现相应的事件处理机制。</p>
<ol start="7">
<li>在<code>Form</code>类中创建一个<code>setValue</code>方法，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> setValue = <span class="function">(<span class="params"><span class="attr">fieldName</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> newValues = &#123; ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span>, [fieldName]: value &#125;;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">values</span>: newValues &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>该方法包含有：</p>
<ul>
<li>该方法接收fieldName和value作为参数。</li>
<li>状态被更新为<code>newValues</code>，旧的值被更新，没有则添加。</li>
<li>新值被更新了。</li>
</ul>
<ol start="8">
<li>接下来在<code>Field</code>组件中创建该方法的一个上下文属性，以实现访问，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormContext</span> &#123;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">setValue</span>?: <span class="function">(<span class="params"><span class="attr">fieldName</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>对应地，在<code>Form</code>组件也创建一个上下文属性，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">context</span>: <span class="title class_">IFormContext</span> = &#123;</span><br><span class="line">  <span class="attr">setValue</span>: <span class="variable language_">this</span>.<span class="property">setValue</span>,</span><br><span class="line">  <span class="attr">values</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>现在可以在<code>Field</code>组件中访问该方法了。在<code>Field</code>中，即在解构(destucture)对象props后面，创建对应的事件Hnadler，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; name, label, <span class="keyword">type</span>, options &#125; = props;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">e</span>:</span></span><br><span class="line"><span class="params">    | <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span></span><br><span class="line"><span class="params">    | <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLTextAreaElement</span>&gt;</span></span><br><span class="line"><span class="params">    | <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLSelectElement</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">IFormContext</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (context.<span class="property">setValue</span>) &#123;</span><br><span class="line">    context.<span class="title function_">setValue</span>(props.<span class="property">name</span>, e.<span class="property">currentTarget</span>.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>该方法有几个关键的地方：</p>
<ul>
<li>TypeScript的事件改变类型是<code>ChangeEvent&lt;T&gt;</code>，其中<code>T</code>是被处理的元素。</li>
<li>该方法的第一个参数<code>e</code>，对应事件类型，组合(union)了所有不同的输入框事件，方便对事件进行统一处理。</li>
<li>该方法的第二个参数是表单上线文。</li>
<li>方法体内加入了条件语句，以确保编译顺利。</li>
<li>调用<code>setValue</code>方法更新或添加新值。</li>
</ul>
<ol start="11">
<li>现在可以为<code>input</code>输入框添加这个事件处理，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;input </span><br><span class="line">  <span class="keyword">type</span>=&#123;<span class="keyword">type</span>.<span class="title function_">toLowerCase</span>() &#125;</span><br><span class="line">  id=&#123;name&#125;</span><br><span class="line">  value=&#123;context.<span class="property">values</span>[name] &#125;</span><br><span class="line">  onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">handleChange</span>(e, context) &#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<ol start="12">
<li>对于<code>textarea</code>标签，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea</span><br><span class="line">  id=&#123;name&#125;</span><br><span class="line">  value=&#123;context.<span class="property">values</span>[name]&#125;</span><br><span class="line">  onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">handleChange</span>(e, context) &#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<ol start="13">
<li>对于<code>select</code>标签，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;select</span><br><span class="line">  value=&#123;context.<span class="property">values</span>[name] &#125;</span><br><span class="line">  onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">handleChange</span>(e, context) &#125;</span><br><span class="line">&gt;</span><br><span class="line"> ...</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<p>现在，我们的<code>Form</code>和<code>Field</code>组件可以组合在一起工作了。</p>
<h3 id="Implementing-our-new-ContactUs-component"><a class="header-anchor" href="#Implementing-our-new-ContactUs-component">¶</a>Implementing our new ContactUs component</h3>
<p>接下来，我们使用<code>Form</code>和<code>Field</code>重新实现我们的<code>ContactUs</code>组件。</p>
<ol>
<li>
<p>首先删除<code>ContactUs.tsx</code>中的props，</p>
</li>
<li>
<p>重新定义<code>ContactUs</code>的SFC，</p>
</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ContactUs</span>: <span class="title class_">React</span>.<span class="property">SFC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在<code>ContactUs.tsx</code>中导入<code>Form</code>组件，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Form</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Form&quot;</span>;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>现在引用<code>Form</code>组件，带上默认值，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">return</span> (</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Form</span> <span class="attr">defaultValues</span>=<span class="string">&#123;&#123;</span> <span class="attr">name:</span> &quot;&quot;, <span class="attr">email:</span> &quot;&quot;, <span class="attr">reason:</span> &quot;<span class="attr">Support</span>&quot;, <span class="attr">notes:</span> &quot;&quot; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">&lt;/<span class="attr">Form</span>&gt;</span></span></span><br><span class="line"> );</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>添加<code>name</code>输入框，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Form</span> defaultValues=&#123;&#123; <span class="attr">name</span>: <span class="string">&quot;&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;&quot;</span>, <span class="attr">reason</span>: <span class="string">&quot;Support&quot;</span>, <span class="attr">notes</span>: <span class="string">&quot;&quot;</span> &#125;&#125;</span><br><span class="line">  &lt;<span class="title class_">Form</span>.<span class="property">Field</span> name=<span class="string">&quot;name&quot;</span> label=<span class="string">&quot;Your name&quot;</span> /&gt;</span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure>
<p>注意这个没有写<code>type</code>属性，则默认使用<code>text</code>填充，</p>
<ol start="6">
<li>下面补充<code>email</code>，<code>reason</code>和<code>notes</code>字段，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Form</span> defaultValues=&#123;&#123; <span class="attr">name</span>: <span class="string">&quot;&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;&quot;</span>, <span class="attr">reason</span>: <span class="string">&quot;Support&quot;</span>, <span class="attr">notes</span>: <span class="string">&quot;&quot;</span> &#125;&#125;</span><br><span class="line">  &lt;<span class="title class_">Form</span>.<span class="property">Field</span> name=<span class="string">&quot;name&quot;</span> label=<span class="string">&quot;Your name&quot;</span> /&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Your email address&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Email&quot;</span> /&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">name</span>=<span class="string">&quot;reason&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">	<span class="attr">label</span>=<span class="string">&quot;Reason you need to contact us&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">	<span class="attr">type</span>=<span class="string">&quot;Select&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">	<span class="attr">options</span>=<span class="string">&#123;[</span>&quot;<span class="attr">Marketing</span>&quot;, &quot;<span class="attr">Support</span>&quot;, &quot;<span class="attr">Feedback</span>&quot;, &quot;<span class="attr">Jobs</span>&quot;, &quot;<span class="attr">Other</span>&quot;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  /&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Form.Field</span> <span class="attr">name</span>=<span class="string">&quot;notes&quot;</span> <span class="attr">label</span>=<span class="string">&quot;Additional notes&quot;</span> <span class="attr">type</span>=<span class="string">&quot;TextArea&quot;</span> /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure>
<p>接下来的<code>ContactUsPage</code>就变得简单了。它不需要包含任何状态(state)，因为状态的维护已经交由<code>Form</code>组件管理。我们也不需要传递任何属性(props)到<code>ContactUs</code>组件中，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ContactUsPage</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;&#123;&#125;, &#123;&#125;&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">	  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;page-container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Contact Us<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		  If you enter your details we&#x27;ll get back to you as soon as we can.</span></span><br><span class="line"><span class="language-xml">	    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	    <span class="tag">&lt;<span class="name">ContactUs</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前为止这个通用组件变得易用并减少我们的重复代码，但还需添加表单验证的实现。</p>
<h2 id="Validating-forms"><a class="header-anchor" href="#Validating-forms">¶</a>Validating forms</h2>
<p>为了提升用户体验，需要在表单中实现校验功能。</p>
<p>在<code>ContactUs</code>组件中我们需要实现的校验规则是：</p>
<ul>
<li>name和email应该被填充</li>
<li>name字段不少于2个字符</li>
</ul>
<h3 id="Adding-a-validatio-rules-prop-to-form"><a class="header-anchor" href="#Adding-a-validatio-rules-prop-to-form">¶</a>Adding a validatio rules prop to form</h3>
<p>首先思考如何在表单中指定校验规则。我们需要为一个字段指定一个或多个规则。某些规则可能会有参数，例如最小长度。以如下形式，</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Form</span></span><br><span class="line">  ...</span><br><span class="line">  validationRules=&#123;&#123;</span><br><span class="line">    <span class="attr">email</span>: &#123; <span class="attr">validator</span>: required &#125;,</span><br><span class="line">	<span class="attr">name</span>: [&#123; <span class="attr">validator</span>: required &#125;, &#123; <span class="attr">validator</span>: minLength, <span class="attr">arg</span>: <span class="number">3</span> &#125;]</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure>
<p>首先在<code>Form</code>组件实现一个<code>validationRules</code>属性，</p>
<ol>
<li>在<code>Form.tsx</code>中定义一个<code>Validator</code>函数：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Validator</span>= <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">fieldName</span>: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">values</span>: <span class="title class_">IValues</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">args</span>?: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> <span class="built_in">string</span>;</span><br></pre></td></tr></table></figure>
<p>一个<code>Validator</code>函数包含字段名、值、以及一个可选参数，并返回string的字符串消息。如果输入内容合法，则返回空字符串。</p>
<ol start="2">
<li>下面使用该类型创建一个<code>required</code>函数，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">required</span>: <span class="title class_">Validator</span> = (</span><br><span class="line">  <span class="attr">fieldName</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>,</span><br><span class="line">  <span class="attr">args</span>?: <span class="built_in">any</span></span><br><span class="line">): <span class="function"><span class="params">string</span> =&gt;</span></span><br><span class="line">  values[fieldName] === <span class="literal">undefined</span> ||</span><br><span class="line">  values[fieldName] === <span class="literal">null</span> ||</span><br><span class="line">  values[fieldName] === <span class="string">&quot;&quot;</span></span><br><span class="line">    ? <span class="string">&quot;This must be populated&quot;</span></span><br><span class="line">	: <span class="string">&quot;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>这里需要将这个函数对外暴露使用。该函数会检测字段值是<code>undefined</code>、<code>null</code>还是空字符串，如果是则返回<code>This must be populated</code>的错误信息。</p>
<ol start="3">
<li>类似地，创建一个长度判断的函数，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">minLength</span>: <span class="title class_">Validator</span> = (</span><br><span class="line">  <span class="attr">fieldName</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>,</span><br><span class="line">  <span class="attr">length</span>: <span class="built_in">number</span></span><br><span class="line">): <span class="function"><span class="params">string</span> =&gt;</span></span><br><span class="line">  values[fieldName] &amp;&amp; values[fieldName].<span class="property">length</span> &lt; length ? <span class="string">`This must be at least <span class="subst">$&#123;length&#125;</span> characters`</span></span><br><span class="line">  : <span class="string">&quot;&quot;</span>;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>接下来需要创建传递这些规则的props，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IValidation</span> &#123;</span><br><span class="line">  <span class="attr">validator</span>: <span class="title class_">Validator</span>;</span><br><span class="line">  <span class="attr">arg</span>?: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IValidationProp</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">IValidation</span> | <span class="title class_">IValidation</span>[];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormProps</span> &#123;</span><br><span class="line">  <span class="attr">defaultValues</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">validationRules</span>: <span class="title class_">IValidationProp</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>validationRules</code>是一个索引key/value类型，其中key是字段名，value是一个或多个验证规则。</li>
<li>一个校验规则包含函数类型和一个参数。</li>
</ul>
<ol start="5">
<li>有了<code>validationRules</code>后，在<code>ContactUs</code>中添加，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Form</span>, minLenght, requied &#125; <span class="keyword">from</span> <span class="string">&quot;./Forma&quot;</span>;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>现在，添加校验规则到<code>ContactUs</code>组件中，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Form</span> defaultValues=&#123;&#123; <span class="attr">name</span>: <span class="string">&quot;&quot;</span>, <span class="attr">email</span>: <span class="string">&quot;&quot;</span>, <span class="attr">reason</span>: <span class="string">&quot;Support&quot;</span>, <span class="attr">notes</span>: <span class="string">&quot;&quot;</span> &#125;&#125;</span><br><span class="line">  valiationRules=&#123;&#123;</span><br><span class="line">    <span class="attr">email</span>: &#123; <span class="attr">validator</span>: required &#125;,</span><br><span class="line">	<span class="attr">name</span>: [&#123; <span class="attr">validator</span>: required &#125;, &#123; <span class="attr">validator</span>: minLength, <span class="attr">arg</span>: <span class="number">2</span> &#125;]</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure>
<h3 id="Tracking-validation-error-messages"><a class="header-anchor" href="#Tracking-validation-error-messages">¶</a>Tracking validation error messages</h3>
<p>有必要跟踪用户的不合法输入信息，提供友好的用户体验。</p>
<p><code>Form</code>组件的职责用于管理表单状态，因此将错误信息添加到state中，</p>
<ol>
<li>定义错误信息类型，添加到<code>IState</code>中，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IErrors</span> &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">string</span>[];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">errors</span>: <span class="title class_">IErrors</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>errors</code>是一个key/value键值对，key为字段名，value为一组错误消息。</p>
<ol start="2">
<li>在构造器中初始化<code>errors</code>的状态，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: <span class="title class_">IFormProps</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">super</span>(props);</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">errors</span>: <span class="title class_">IErrors</span> = &#123;&#125;;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(props.<span class="property">defaultValues</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">fieldName</span> =&gt;</span> &#123;</span><br><span class="line">    errors[fieldName] = [];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    errors,</span><br><span class="line">    <span class="attr">values</span>: props.<span class="property">defaultValues</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的<code>defaultValues</code>包含了所有字段名。当<code>Form</code>组件初始化，所有字段的错误信息为空。</p>
<ol start="3">
<li><code>Field</code>组件最终被用于渲染校验的错误信息，因此需要将这些信息添加到表单上下文。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormContext</span> &#123;</span><br><span class="line">  <span class="attr">errors</span>: <span class="title class_">IErrors</span>;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">setValue</span>?: <span class="function">(<span class="params"><span class="attr">fieldName</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>添加一个空白的<code>error</code>字面量作为默认值。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">FormContext</span> = <span class="title class_">React</span>.<span class="property">createContext</span>&lt;<span class="title class_">IFormContext</span>&gt;(&#123;</span><br><span class="line">  <span class="attr">errors</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">values</span>: &#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>现在加入到context中，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">context</span>: <span class="title class_">IFormContext</span> = &#123;</span><br><span class="line">    <span class="attr">errors</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">errors</span>,</span><br><span class="line">	<span class="attr">setValue</span>: <span class="variable language_">this</span>.<span class="property">setValue</span>,</span><br><span class="line">	<span class="attr">values</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    ...</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，校验错误信息被设置在state中，并且可以被<code>Field</code>组件访问。接下来要创建一个方法来调用这些校验规则。</p>
<h3 id="Invoking-validation-rules"><a class="header-anchor" href="#Invoking-validation-rules">¶</a>Invoking validation rules</h3>
<p>前面定义了校验规则，并且将校验信息关联到state中。但这些规则还没被调用。接下来我们要实现：</p>
<ol>
<li>我们需要在<code>Form</code>组件内创建一个方法，使用这些规则来校验字段。我们创建一个<code>validate</code>方法，它接收字段名和它的值。该方法会返回一个error message的数组信息，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> validate = (</span><br><span class="line">  <span class="attr">fieldName</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">value</span>: <span class="built_in">any</span></span><br><span class="line">): <span class="built_in">string</span>[] =&gt; &#123;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>方法内，需要获取校验规则，并初始化返回信息<code>errors</code>。我们会收集校验的错误信息并存储在<code>errors</code>中。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> validate = (</span><br><span class="line">  <span class="attr">fieldName</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">value</span>: <span class="built_in">any</span></span><br><span class="line">): <span class="built_in">string</span>[] =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> rules = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">validationRules</span>[fieldName];</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">errors</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// TODO - execute all the validators</span></span><br><span class="line">  <span class="keyword">return</span> errors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>上下文获取的规则可能是一个<code>IValidation</code>数组，也可能是一个<code>IValidation</code>对象。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">errors</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(rules)) &#123;</span><br><span class="line">  <span class="comment">// TODO - execute all the validators in the array of rules</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (rules) &#123;</span><br><span class="line">    <span class="keyword">const</span> error = rules.<span class="title function_">validator</span>(fieldName, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span>, rules.<span class="property">arg</span>);</span><br><span class="line">	<span class="keyword">if</span> (error) &#123;</span><br><span class="line">	  errors.<span class="title function_">push</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> errors;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>有多个校验规则时，我们可以使用<code>forEach</code>函数迭代执行，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(rules)) &#123;</span><br><span class="line">  rules.<span class="title function_">forEach</span>(<span class="function"><span class="params">rule</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> error = rule.<span class="title function_">validator</span>(</span><br><span class="line">	  fieldNmae,</span><br><span class="line">	  <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span>,</span><br><span class="line">	  rule.<span class="property">arg</span></span><br><span class="line">    );</span><br><span class="line">	<span class="keyword">if</span> (error) &#123;</span><br><span class="line">	  errors.<span class="title function_">push</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> errors;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>剩下的代码部分是，将校验的结果存储到表单状态<code>errors</code>中。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(rules)) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> newErrors = &#123; ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">errors</span>, [fieldName]: errors &#125;;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">errors</span>: newErrors &#125;);</span><br><span class="line"><span class="keyword">return</span> errors;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>表单<code>Field</code>组件需要调用到这个<code>validate</code>方法。首先添加到<code>IFormContext</code>接口，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormContext</span> &#123;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">errors</span>: <span class="title class_">IErrors</span>;</span><br><span class="line">  <span class="attr">setValue</span>?: <span class="function">(<span class="params"><span class="attr">fieldName</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">validate</span>?: <span class="function">(<span class="params"><span class="attr">fieldName</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>现在将它添加到<code>Form</code>渲染内容中，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">context</span>: <span class="title class_">IFormContext</span> = &#123;</span><br><span class="line">    <span class="attr">errors</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">errors</span>,</span><br><span class="line">	<span class="attr">setValue</span>: <span class="variable language_">this</span>.<span class="property">setValue</span>,</span><br><span class="line">	<span class="attr">validate</span>: <span class="variable language_">this</span>.<span class="property">validate</span>,</span><br><span class="line">	<span class="attr">values</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    ...</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>表单的校验和方法的调用已经完成了。但没有事件触发这个动作，</p>
<h3 id="TRiggering-validation-rule-execution-from-field"><a class="header-anchor" href="#TRiggering-validation-rule-execution-from-field">¶</a>TRiggering validation rule execution from field</h3>
<p>当用户输入表单内容后，我们希望校验规则在blur时触发，</p>
<ol>
<li>首先创建一个函数处理这些输入框触发的<code>blur</code>事件，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handleChange = (</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleBlur</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">e</span>:</span></span><br><span class="line"><span class="params">    | <span class="title class_">React</span>.<span class="title class_">FocusEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span></span><br><span class="line"><span class="params">	| <span class="title class_">React</span>.<span class="title class_">FocusEvent</span>&lt;<span class="title class_">HTMLTextAreaElement</span>&gt;</span></span><br><span class="line"><span class="params">	| <span class="title class_">React</span>.<span class="title class_">FocusEvent</span>&lt;<span class="title class_">HTMLSelectElement</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">context</span>: <span class="title class_">IFormContext</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (context.<span class="property">validate</span>) &#123;</span><br><span class="line">    context.<span class="title function_">validate</span>(props.<span class="property">name</span>, e.<span class="property">currentTarget</span>.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ( ... )</span><br></pre></td></tr></table></figure>
<ul>
<li>TypeScript的blur事件是<code>FocusEvent&lt;T&gt;</code>，其中<code>T</code>是被处理的元素。</li>
<li>参数<code>e</code>作为事件对象。</li>
<li>第二个参数是表单上下文。</li>
<li>需要使用条件语句判断<code>validate</code>方法是否定义。</li>
<li>方法体内调用<code>valdiate</code>方法。</li>
</ul>
<ol start="2">
<li>将事件引入，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;(<span class="keyword">type</span> === <span class="string">&quot;Text&quot;</span> || <span class="keyword">type</span> === <span class="string">&quot;Email&quot;</span>) &amp;&amp; (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">type</span>=<span class="string">&#123;type.toLowerCase()&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">id</span>=<span class="string">&#123;name&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">value</span>=<span class="string">&#123;context.values[name]&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> handleChange(e, context)&#125;</span></span><br><span class="line"><span class="language-xml">onBlur=&#123;e =&gt; handleBlur(e, context)&#125;</span></span><br><span class="line"><span class="language-xml">/&gt;</span></span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>类似地，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">type</span> === <span class="string">&quot;TextArea&quot;</span> &amp;&amp; (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">textarea</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">id</span>=<span class="string">&#123;name&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">value</span>=<span class="string">&#123;context.values[name]&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> handleChange(e, context)&#125;</span></span><br><span class="line"><span class="language-xml">onBlur=&#123;e =&gt; handleBlur(e, context)&#125;</span></span><br><span class="line"><span class="language-xml">/&gt;</span></span><br><span class="line">)&#125;</span><br><span class="line">&#123;<span class="keyword">type</span> === <span class="string">&quot;Select&quot;</span> &amp;&amp; (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">value</span>=<span class="string">&#123;context.values[name]&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> handleChange(e, context)&#125;</span></span><br><span class="line"><span class="language-xml">onBlur=&#123;e =&gt; handleBlur(e, context)&#125;</span></span><br><span class="line"><span class="language-xml">&gt;</span></span><br><span class="line"><span class="language-xml">...</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>
<p>输入框字段会在失去焦点时触发校验动作。</p>
<h3 id="Rendering-validation-error-messages"><a class="header-anchor" href="#Rendering-validation-error-messages">¶</a>Rendering validation error messages</h3>
<p>在此之前，需要将错误信息展示或者隐藏。</p>
<ol>
<li>添加<code>form-error</code>样式控制，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;form-group&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&#123;name&#125;</span>&gt;</span>&#123;label&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line">  &#123;(<span class="keyword">type</span> === <span class="string">&quot;Text&quot;</span> || <span class="keyword">type</span> === <span class="string">&quot;Email&quot;</span>) &amp;&amp; (</span><br><span class="line">    ...</span><br><span class="line">  )&#125;</span><br><span class="line">  &#123;<span class="keyword">type</span> === <span class="string">&quot;TextArea&quot;</span> &amp;&amp; (</span><br><span class="line">    ...</span><br><span class="line">  )&#125;</span><br><span class="line">  &#123;<span class="keyword">type</span> === <span class="string">&quot;Select&quot;</span> &amp;&amp; (</span><br><span class="line">    ...</span><br><span class="line">  )&#125;</span><br><span class="line">&#123;context.<span class="property">errors</span>[name] &amp;&amp;</span><br><span class="line">  context.<span class="property">errors</span>[name].<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">  context.<span class="property">errors</span>[name].<span class="title function_">map</span>(<span class="function"><span class="params">error</span> =&gt;</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">key</span>=<span class="string">&#123;error&#125;</span> <span class="attr">className</span>=<span class="string">&quot;form-error&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       &#123;error&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">  ))&#125;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>首先检测有错误的字段，再将错误信息渲染出来。</p>
<ol start="2">
<li>下面是css样式，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">form</span>-error &#123;</span><br><span class="line">font-<span class="attr">size</span>: 13px;</span><br><span class="line"><span class="attr">color</span>: red;</span><br><span class="line"><span class="attr">margin</span>: 3px auto 0px 0px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Form-submission"><a class="header-anchor" href="#Form-submission">¶</a>Form submission</h2>
<p>表单触发提交动作时，同样也需要进行校验。</p>
<ol>
<li>首先添加提交按钮，在<code>Form</code>组件中添加，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">FormContext</span>.<span class="property">Provider</span> value=&#123;context&#125;&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">className</span>=<span class="string">&quot;form&quot;</span> <span class="attr">noValidate</span>=<span class="string">&#123;true&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;this.props.children&#125;</span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">FormContext</span>.<span class="property">Provider</span>&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>给按钮添加样式，</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">button</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">8px</span> <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">80px</span>;</span><br><span class="line">  <span class="attribute">border</span>: black solid <span class="number">1px</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: black;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.form-group</span> <span class="selector-tag">button</span><span class="selector-pseudo">:disabled</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: gray solid <span class="number">1px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: gray;</span><br><span class="line">  <span class="attribute">cursor</span>: not-allowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Adding-a-onSubmit-form-prop"><a class="header-anchor" href="#Adding-a-onSubmit-form-prop">¶</a>Adding a onSubmit form prop</h3>
<p>在我们的<code>Form</code>组件中，需要一个新的属性来消费表单的提交动作。</p>
<ol>
<li>在<code>Form</code>组件中创建一个prop函数，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ISubmitResult</span> &#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">errors</span>?: <span class="title class_">IErrors</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IFormProps</span> &#123;</span><br><span class="line">  <span class="attr">defaultValues</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">validationRules</span>: <span class="title class_">IValidationProp</span>;</span><br><span class="line">  <span class="attr">onSubmit</span>: <span class="function">(<span class="params"><span class="attr">values</span>: <span class="title class_">IValues</span></span>) =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="title class_">ISubmitResult</span>&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onSubmit</code>函数会接收filed的值，并异步返回提交的信息。</p>
<ol start="2">
<li>另外需要添加状态记录表单的提交动作，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">  <span class="attr">values</span>: <span class="title class_">IValues</span>;</span><br><span class="line">  <span class="attr">errors</span>: <span class="title class_">IErrors</span>;</span><br><span class="line">  <span class="attr">submitting</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">submitted</span>: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>另外需要在构造器初始化，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: <span class="title class_">IFormProps</span></span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    errors,</span><br><span class="line">	<span class="attr">submitted</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">submitting</span>: <span class="literal">false</span>,</span><br><span class="line">	<span class="attr">values</span>: props.<span class="property">defaultValues</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>表单提交后按钮不可用，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;button <span class="keyword">type</span>=<span class="string">&quot;submit&quot;</span></span><br><span class="line">  disabled=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">submitting</span> || <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">submitted</span>&#125;</span><br><span class="line">&gt;</span><br><span class="line">  <span class="title class_">Submit</span></span><br><span class="line">&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>在表单中添加事件控制，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form className=<span class="string">&quot;form&quot;</span> noValidate=&#123;<span class="literal">true</span>&#125; onSubmit=&#123;<span class="variable language_">this</span>.<span class="property">handleSubmit</span>&#125;&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>下面模拟这个提交动作，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleSubmit = <span class="title function_">async</span> (<span class="attr">e</span>: <span class="title class_">React</span>.<span class="property">FormEvent</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;) =&gt; &#123;</span><br><span class="line">  e.<span class="title function_">preventDefault</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里使用了<code>preventDefault</code>避免浏览器自动提交。</p>
<ol start="7">
<li>接下来就是重点，表单验证！</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">validateForm</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">errors</span>: <span class="title class_">IErrors</span> = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">haveError</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">defaultValues</span>).<span class="title function_">map</span>(<span class="function"><span class="params">fieldName</span> =&gt;</span> &#123;</span><br><span class="line">    errors[fieldName] = <span class="variable language_">this</span>.<span class="title function_">validate</span>(</span><br><span class="line">      fieldName,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span>[fieldName]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (errors[fieldName].<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      haveError = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; errors &#125;);</span><br><span class="line">  <span class="keyword">return</span> !haveError;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> handleSubmit = <span class="title function_">async</span> (<span class="attr">e</span>: <span class="title class_">React</span>.<span class="property">FormEvent</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;) =&gt; &#123;</span><br><span class="line">  e.<span class="title function_">preventDefault</span>();</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">validateForm</span>()) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>表单的状态会更新到最新的校验错误信息，</p>
<ol start="8">
<li>实现剩余的代码，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleSubmit = <span class="title function_">async</span> (<span class="attr">e</span>: <span class="title class_">React</span>.<span class="property">FormEvent</span>&lt;<span class="title class_">HTMLFormElement</span>&gt;) =&gt; &#123; </span><br><span class="line">  e.<span class="title function_">preventDefault</span>();</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">validateForm</span>()) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">submitting</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onSubmit</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">values</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">errors</span>: result.<span class="property">errors</span> || &#123;&#125;,</span><br><span class="line">      <span class="attr">submitted</span>: result.<span class="property">success</span>,</span><br><span class="line">      <span class="attr">submitting</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Consuming-the-onSubmit-form-prop"><a class="header-anchor" href="#Consuming-the-onSubmit-form-prop">¶</a>Consuming the onSubmit form prop</h3>
<p>在本小节，将实现如何消费表单的提交内容。</p>
<ol>
<li>首先在<code>ContactUs</code>组件中导入<code>ISubmitResult</code>和<code>IValues</code>，用于处理提交的内容，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Form</span>, <span class="title class_">ISubmitResult</span>, <span class="title class_">IValues</span>, minLength, required &#125; <span class="keyword">from</span> <span class="string">&quot;./Form&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IProps</span> &#123;</span><br><span class="line">  <span class="attr">onSubmit</span>: <span class="function">(<span class="params"><span class="attr">values</span>: <span class="title class_">IValues</span></span>) =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="title class_">ISubmitResult</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ContactUs</span>: <span class="title class_">React</span>.<span class="property">SFC</span>&lt;<span class="title class_">IProps</span>&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建一个<code>handleSubmit</code>函数，它将会调用<code>onSubmit</code>属性，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ContactUs</span>: <span class="title class_">React</span>.<span class="property">SFC</span>&lt;<span class="title class_">IProps</span>&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> handleSubmit = <span class="title function_">async</span> (<span class="attr">values</span>: <span class="title class_">IValues</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ISubmitResult</span>&gt; =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> props.<span class="title function_">onSubmit</span>(values);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> ( ... );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>onSubmit</code>属性是异步的，因此需要函数前缀带<code>async</code>以及<code>onSubmit</code>前面带<code>await</code>。</p>
<ol start="3">
<li>绑定这个属性，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Form</span> <span class="attr">...</span> <span class="attr">onSubmit</span>=<span class="string">&#123;handleSubmit&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ...</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>现在移步到<code>ContactUsPage</code>组件，创建提交处理，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleSubmit = <span class="title function_">async</span> (<span class="attr">values</span>: <span class="title class_">IValues</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ISubmitResult</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">1000</span>); <span class="comment">// simulate asynchronous web API call</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">errors</span>: &#123;</span><br><span class="line">	  <span class="attr">email</span>: [<span class="string">&quot;Some is wrong with this&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">	<span class="attr">success</span>: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>接着创建<code>wait</code>函数，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wait = (<span class="attr">ms</span>: <span class="built_in">number</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>在<code>ContactUs</code>组件中加上，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ContactUs</span> onSubmit=&#123;<span class="variable language_">this</span>.<span class="property">handleSubmit</span>&#125; /&gt;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>导入暴露的属性，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ISubmitResult</span>, <span class="title class_">IValues</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./Form&quot;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a class="header-anchor" href="#Summary">¶</a>Summary</h2>
<p>本章讨论了控制组件，通过实现自定义表单组件描述。我们构建了一个通用型的<code>Form</code>和<code>Field</code>组件，并实现了状态控制、事件处理、表单提交等操作。</p>
<h2 id="Questions"><a class="header-anchor" href="#Questions">¶</a>Questions</h2>
<p>问题练习：</p>
<ol>
<li>扩展<code>Field</code>组件内容，包含<code>number</code>属性。</li>
<li>实现一个的输入框，该输入框响应紧急的程度，用数字表示。</li>
<li>实现一个新的校验函数，检测输入的数字是否在区间范围内。</li>
<li>合并实现2和3的功能。</li>
<li>为这个输入框添加事件。</li>
</ol>
</div></article><nav class="article-nav"><div class="article-nav-prev"><a href="/2019/11/27/react-ts/chapter_8_React_Redux/">第八章 React Redux</a></div><div class="article-nav-next"><a href="/2019/11/27/react-ts/chapter_6_Component_Patterns/">第六章 Component Patterns</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/11/27/react-ts/chapter_7_Working_with_Forms/';
var disqus_title = '第七章 表单';
var disqus_url = 'https://galudisu.info/2019/11/27/react-ts/chapter_7_Working_with_Forms/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>