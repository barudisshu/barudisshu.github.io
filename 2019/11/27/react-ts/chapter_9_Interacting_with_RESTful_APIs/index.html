<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>第九章 RESTful 接口交互</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">第九章 RESTful 接口交互</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2019-11-27</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tags"> </i><a class="tag-link" href="/tags/react/">react<span class="tag">, </span></a><a class="tag-link" href="/tags/typescript/">typescript</a></p><p class="meta-item meta-category"><span class="meta-item-title"></span><i class="icon-bookmark"> </i><a class="category-link" href="/categories/react/">react</a></p></div><div class="article-content"><ul>
<li>Writing asynchronous code</li>
<li>Using fetch</li>
<li>Using axios with class components</li>
<li>Using axios with function components</li>
</ul>
<h2 id="Writing-asynchronous-code"><a class="header-anchor" href="#Writing-asynchronous-code">¶</a>Writing asynchronous code</h2>
<p>默认下TypeScript的代码是同步执行的。既是一行一行代码执行。TypeScript也可以实现异步功能。调用REST API就是一个异步实现的例子。</p>
<h3 id="Callbacks"><a class="header-anchor" href="#Callbacks">¶</a>Callbacks</h3>
<p>回调指的是将函数作为参数，传入到一个异步函数中调用，当该异步函数完成时执行该传参函数的内容。</p>
<h3 id="Callback-execution"><a class="header-anchor" href="#Callback-execution">¶</a>Callback execution</h3>
<p>下面以一个例子阐述在TypeScript环境下的异步回调实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">firstName</span>: <span class="built_in">string</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  firstName = <span class="string">&quot;Fred&quot;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;firstName in callback&quot;</span>, firstName);</span><br><span class="line">&#125;,<span class="number">1000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;firstName aftr setTimeout&quot;</span>, firstName);</span><br></pre></td></tr></table></figure>
<p>代码中调用了JavaScript的异步函数<code>setTimeout</code>。第一个参数是一个回调函数，第二个参数是执行等待的时间。</p>
<p>这里的回调函数，形式上使用<code>() =&gt;&#123;&#125;</code> 表述，回调函数会将<code>firstName</code>变量更改为<code>Fred</code>，并输出到控制台。</p>
<p>执行代码，可以看到回调函数并没有执行，而是等待1000毫秒后再触发控制台打印信息。</p>
<p>异步函数的执行不会等待函数内部的完成。这种方式一方面不便于阅读，另一方面容易造成回调地狱(callback hell)。因为开发者容易在回调中内嵌更复杂的回调或异步函数实现。那么我们如何处理这种异步回调的错误？</p>
<h3 id="Handling-callback-erros"><a class="header-anchor" href="#Handling-callback-erros">¶</a>Handling callback erros</h3>
<p>本小节将探索如何处理异步代码的错误信息。</p>
<ol>
<li>首先有如下代码：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Someting went wrong&quot;</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;An error has occurred&quot;</span>, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这次使用了<code>try / catch</code>方式来处理异步出现的错误信息。</p>
<ol start="2">
<li>错误信息必须被处理。更改为：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IResult</span> &#123;</span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">error</span>?: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">result</span>: <span class="title class_">IResult</span> = &#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Something went wrong&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    result.<span class="property">success</span> = <span class="literal">false</span>;</span><br><span class="line">    result.<span class="property">error</span> = ex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br></pre></td></tr></table></figure>
<p>这里将<code>try / catch</code>放置在回调函数的内部。以及使用了变量<code>result</code>来表述执行的成功或失败。</p>
<p>至此，回调引发的错误已经被处理了。幸运的是，有更好的方式来处理这种挑战。</p>
<h2 id="Promises"><a class="header-anchor" href="#Promises">¶</a>Promises</h2>
<p>promise是JavaScript里面的对象。它表述了一个异步操作的最终结果(成功或失败).</p>
<h3 id="Consuming-a-promised-based-function"><a class="header-anchor" href="#Consuming-a-promised-based-function">¶</a>Consuming a promised-based function</h3>
<p>下面是一个promised-based的API</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">json</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error&quot;</span>, json));</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的函数<code>fetch</code>是javascript本地函数，用于处理RESTful API。</li>
<li>入参是一个URL</li>
<li><code>then</code>方法处理返回</li>
<li><code>catch</code>方法处理错误信息</li>
</ul>
<p>相比来说代码更易于阅读和理解。我们不需要在<code>then</code>方法中处理错误信息。</p>
<h3 id="Creating-a-promised-based-function"><a class="header-anchor" href="#Creating-a-promised-based-function">¶</a>Creating a promised based function</h3>
<p>本小节会创建一个<code>wait</code>函数来处理异步等待信息。</p>
<ol>
<li>首先实现一个简单的回调：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">wait</span> = (<span class="params"><span class="attr">ms</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ms &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="string">&quot;Too long&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="string">&quot;Successfully waited&quot;</span>);</span><br><span class="line">    &#125;, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数返回一个<code>Promise</code>对象，该对象包含有一个需要异步执行的构造器入参。</li>
<li><code>promise</code>构造入参<code>resolve</code>是一个函数，表示当函数执行完成后要处理的动作。</li>
<li><code>promise</code>构造入参<code>reject</code>是一个函数，表示出现错误后需要处理的动作。</li>
<li>函数体内部则使用了<code>setTimeout</code>以及一个回调处理等待动作。</li>
</ul>
<ol start="2">
<li>消费这个<code>promised-based</code>函数：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">wait</span>(<span class="number">500</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;then &gt;&quot;</span>, result))</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;catch &gt;&quot;</span>, error));</span><br></pre></td></tr></table></figure>
<p>等待500毫秒后，函数将输出正确或失败信息。</p>
<ol start="3">
<li>将等待时间延长，大于1000，<code>catch</code>方法被调用。</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">wait</span>(<span class="number">1500</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;then &gt;&quot;</span>, result))</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;catch &gt;&quot;</span>, error));</span><br></pre></td></tr></table></figure>
<p><code>Promise</code>对于异步代码有一个很好的处理机制。致辞，还有另一种异步处理的实现方式。</p>
<h2 id="async-and-awit"><a class="header-anchor" href="#async-and-awit">¶</a>async and awit</h2>
<p><code>async</code>和<code>await</code>是JavaScript的关键字。</p>
<ol>
<li>首先从<code>wait</code>函数的例子开始：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">someWork</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">500</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_">someWork</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>这里创建了一个箭头函数<code>someWork</code>，使用关键字<code>async</code>标注为异步。</li>
<li>使用关键字<code>await</code>在<code>wait</code>前面声明。<code>wait</code>下一行的执行将被暂停(halt)直到这个异步操作完成。</li>
<li><code>try / catch</code>将捕获任何异常信息。</li>
</ul>
<p>该方法有点像是一个异步操作的管理者。执行代码后，控制台打印：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">then &gt; Successfully waited</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将等待时间改为1500毫秒：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">1500</span>);</span><br></pre></td></tr></table></figure>
<p>控制台打印错误信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Too long</span><br></pre></td></tr></table></figure>
<p>因此，使用<code>async</code>和<code>await</code>使得代码更易于阅读。另一个奖励是，这种实现在旧的浏览器中仍然支持。</p>
<p>到目前为止，我们已经对如何编写更好的异步代码有更好的理解，下面会就RESTful API的实现进行练习。</p>
<h2 id="Using-fetch"><a class="header-anchor" href="#Using-fetch">¶</a>Using fetch</h2>
<p><code>fetch</code>函数是一个JavaScript本地函数。本小节会对一些常见的RESTful API通过<code>fetch</code>进行交互。</p>
<h3 id="Geting-data-with-fetch"><a class="header-anchor" href="#Geting-data-with-fetch">¶</a>Geting data with fetch</h3>
<p>首先开始从GET请求开始。</p>
<h3 id="Baisc-GET-request"><a class="header-anchor" href="#Baisc-GET-request">¶</a>Baisc GET request</h3>
<p>打开 TypeScript playground，输入如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>fetch</code>函数的第一个参数是一个URL请求地址</li>
<li><code>fetch</code>是一个promised-base函数</li>
<li>第一个<code>then</code>方法处理返回</li>
<li>第二个<code>then</code>方法处理当返回body是JSON</li>
</ul>
<h3 id="Getting-response-status"><a class="header-anchor" href="#Getting-response-status">¶</a>Getting response status</h3>
<p>通常，我们需要处理返回的status code：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>, respons.<span class="property">ok</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>返回的<code>status</code>给出了HTTP的状态信息</li>
<li><code>ok</code>返回一个<code>boolean</code>值表示200的状态码</li>
</ul>
<p>另一个404的不存在的示例如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1001&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>, response.<span class="property">ok</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Handling-errors"><a class="header-anchor" href="#Handling-errors">¶</a>Handling errors</h3>
<p>通过<code>catch</code>方法处理错误信息：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">json</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error&quot;</span>, json));</span><br></pre></td></tr></table></figure>
<p>然而，<code>catch</code>并没有捕获非200状态的机制。所以对于非200的错误返回请求时，可以在第一个<code>then</code>方法中处理。</p>
<p>那么<code>catch</code>方法是干嘛的？它是用来捕获网络异常的，非200返回并不是一种网络异常。</p>
<h3 id="Creating-data-with-fetch"><a class="header-anchor" href="#Creating-data-with-fetch">¶</a>Creating data with fetch</h3>
<p>本小节将使用<code>fetch</code>来创建一些数据。</p>
<h3 id="Basic-POST-request"><a class="header-anchor" href="#Basic-POST-request">¶</a>Basic POST request</h3>
<p>通常情况下，调用<code>post</code>请求来创建数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Interesting post&quot;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&quot;This si an interesting post abount ...&quot;</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>);</span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data));</span><br></pre></td></tr></table></figure>
<p><code>fetch</code>函数的第二个参数是一个可选对象。包含请求的method和body信息。</p>
<h3 id="Request-HTTP-headers"><a class="header-anchor" href="#Request-HTTP-headers">¶</a>Request HTTP headers</h3>
<p>通常，请求信息需要包含标头(header)。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="title class_">Authorization</span>: <span class="string">&quot;bearer some-bearer-token&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Interesting post&quot;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&quot;This is an interesting post about ...&quot;</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>);</span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data));</span><br></pre></td></tr></table></figure>
<p>对于<code>GET</code>请求，可以用如下形式：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="title class_">Authorization</span>: <span class="string">&quot;bearer some-bearer-token&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(...);</span><br></pre></td></tr></table></figure>
<h3 id="Changing-data-with-fetch"><a class="header-anchor" href="#Changing-data-with-fetch">¶</a>Changing data with fetch</h3>
<h3 id="Basic-PUT-request"><a class="header-anchor" href="#Basic-PUT-request">¶</a>Basic PUT request</h3>
<p>通常情况下，对于数据的更改是用<code>PUT</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;PUT&quot;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Corrected post&quot;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&quot;This is corrected post about ...&quot;</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>);</span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data));</span><br></pre></td></tr></table></figure>
<h3 id="Basic-PATCH-request"><a class="header-anchor" href="#Basic-PATCH-request">¶</a>Basic PATCH request</h3>
<p>某些情况下，<code>PATCH</code>的请求用于部分请求的更改。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;PATCH&quot;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Corrected post&quot;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>);</span><br><span class="line">  <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data));</span><br></pre></td></tr></table></figure>
<h3 id="Deleting-data-with-fetch"><a class="header-anchor" href="#Deleting-data-with-fetch">¶</a>Deleting data with fetch</h3>
<p>通常情况下，RESTful接口都是用<code>DELETE</code>方法删除数据。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">status</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>到目前为止，我们已经学习了如何使用<code>fetch</code>函数来操作RESTful API。</p>
<h2 id="Using-axios-with-class-components"><a class="header-anchor" href="#Using-axios-with-class-components">¶</a>Using axios with class components</h2>
<p><code>axios</code>是一个流行的开源JavaScript HTTP客户端。我们会创建一个React App包含有create,read,upate,delete等操作。并探索<code>axios</code>相比<code>fetch</code>有哪些优势。</p>
<h3 id="Installing-axios"><a class="header-anchor" href="#Installing-axios">¶</a>Installing axios</h3>
<p>首先新建一个应用：</p>
<ol>
<li>在控制台通过命令新建一个TypeScript的React项目：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app crud-api --typescript</span><br></pre></td></tr></table></figure>
<p>注意我们使用的React版本至少是<code>16.7.0-alpha.0</code>。我们可以在<code>package.json</code>里面检查。如果低于<code>16.7.0-alpha.0</code>，可以使用下面命令安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install react@16.7.0-alpha.0</span><br><span class="line">npm install react@16.7.0-alpaha.0</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>项目创建后，添加TSLint到项目中，并带有某些规则：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd crud-api</span><br><span class="line">npm install tslint tslint-react tslint-config-prettier --save-dev</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>新建<code>tslint.json</code>包含下面规则：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;extends&quot;: [&quot;tslint:recommended&quot;, &quot;tslint-react&quot;, &quot;tslint-config-prettier&quot;],</span><br><span class="line">  &quot;rules&quot;: &#123;</span><br><span class="line">    &quot;ordered-imports&quot;: false,</span><br><span class="line">    &quot;object-literal-sort-keys&quot;: false,</span><br><span class="line">    &quot;jsx-no-lambda&quot;: false,</span><br><span class="line">    &quot;no-debugger&quot;: false,</span><br><span class="line">    &quot;no-console&quot;: false,</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;linterOptions&quot;: &#123;</span><br><span class="line">    &quot;exclude&quot;: [</span><br><span class="line">      &quot;config/**/*.js&quot;,</span><br><span class="line">      &quot;node_modules/**/*.ts&quot;,</span><br><span class="line">      &quot;converage/lcov-report/*.js&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>打开<code>App.tsx</code>文件，会有一个linting错误。在<code>render()</code>方法中添加<code>public</code>关键字处理该问题：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ( ... );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>添加<code>axios</code>：</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install axios</span><br></pre></td></tr></table></figure>
<p>注意<code>axios</code>内已经包含TypeScript类型了，不需要额外安装。</p>
<ol start="6">
<li>运行我们的应用。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure>
<h3 id="Getting-data-with-axios"><a class="header-anchor" href="#Getting-data-with-axios">¶</a>Getting data with axios</h3>
<h3 id="Basic-GET-request"><a class="header-anchor" href="#Basic-GET-request">¶</a>Basic GET request</h3>
<p>首先从GET请求开始。</p>
<ol>
<li>打开<code>App.tsx</code>，导入：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建接口类型，表示JSONPlaceholder返回的内容：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IPost</span> &#123;</span><br><span class="line">    <span class="attr">userId</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">id</span>?: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">body</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>我们需要存储上述的邮件信息到state中，因此添加下面这个接口：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">    <span class="attr">posts</span>: <span class="title class_">IPost</span>[];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;&#123;&#125;, <span class="title class_">IState</span>&gt; &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在构造器生命周期中初始化state：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;&#123;&#125;, <span class="title class_">IState</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">posts</span>: []</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>通常是在<code>componentDidMount</code>生命周期函数中获取REST API数据。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    axios</span><br><span class="line">    .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">posts</span>: response.<span class="property">data</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这是使用<code>get</code>函数表述<code>GET</code>请求，它跟<code>fetch</code>一样，是一个promised-based函数。</li>
<li>这里是一个泛型函数，泛型参数为返回消息数据类型。</li>
<li>URL地址作为传入参数。</li>
<li>在<code>then</code>方法处理返回信息。</li>
<li>通过<code>data</code>对象属性获取请求的返回对象。</li>
</ul>
<p>因此，相比<code>fetch</code>有两点好处：</p>
<ul>
<li>可以定义返回的数据类型</li>
<li>只需要一步即可获取返回体</li>
</ul>
<ol start="6">
<li>在<code>render</code>方法渲染：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">url</span> <span class="attr">className</span>=<span class="string">&quot;posts&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;this.state.posts.map(post =&gt; (</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;post.id&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;post.title&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;post.body&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                ))&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用<code>posts</code>数组的<code>map</code>函数来展现数据。</p>
<ol start="7">
<li>在<code>index.css</code>添加CSS属性，</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.posts</span> &#123;</span><br><span class="line">    <span class="attribute">list-style</span>: none;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0px</span> auto;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">800px</span>;</span><br><span class="line">    <span class="attribute">text-align</span>: left;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，使用<code>axios</code>来处理请求更简单方便。以及我们需要在<code>componentDidMount</code>生命周期函数中调用。</p>
<p>那么对于网络错误如何处理？</p>
<h3 id="Handling-errors-v2"><a class="header-anchor" href="#Handling-errors-v2">¶</a>Handling errors</h3>
<ol>
<li>首先添加一个错误的URL，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/postsX&quot;</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>我们希望出现网络错误的情况下，依然给用户以反馈内容。可以用<code>catch</code>方法：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axios</span><br><span class="line">  .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/postsX&quot;</span>)</span><br><span class="line">  .<span class="title function_">then</span>( ... )</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">ex</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> error = </span><br><span class="line">        ex.<span class="property">response</span>.<span class="property">status</span> === <span class="number">404</span> ? <span class="string">&quot;Resource not found&quot;</span> : <span class="string">&quot;An unexpected error has occurred&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; error &#125;);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>和<code>fetch</code>不同，HTTP status错误返回码可以在<code>catch</code>方法处理。错误信息包含有一个属性<code>response</code>表示请求的返回内容。</p>
<ol start="3">
<li>另外修改该部分渲染，我们希望将错误信息显示出来：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">    <span class="attr">posts</span>: <span class="title class_">IPost</span>[];</span><br><span class="line">    <span class="attr">error</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;&#123;&#125;, <span class="title class_">IState</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">posts</span>: [],</span><br><span class="line">            <span class="attr">error</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>渲染错误内容：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul className=<span class="string">&quot;posts&quot;</span>&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;/ul&gt;</span><br><span class="line">&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">error</span> &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;error&quot;</span>&gt;</span>&#123;this.state.error&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>添加错误的样式：</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.error</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次执行应用，可以看到红色的 <strong>Resource not found</strong> 字体。</p>
<ol start="6">
<li>将URL更改为原来有效的地址，</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Request-Http-headers"><a class="header-anchor" href="#Request-Http-headers">¶</a>Request Http headers</h3>
<p>有时候我们希望带上header请求信息。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>因此，我们在HTTP请求时定义了<code>headers</code>属性。</p>
<h3 id="Timeouts"><a class="header-anchor" href="#Timeouts">¶</a>Timeouts</h3>
<p>超时机制用于提高用户体验。</p>
<ol>
<li>在我们的app添加一个请求超时：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">1</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里的单位是毫秒。表示期望请求在1毫秒内做出响应。</p>
<ol start="2">
<li>在<code>catch</code>方法处理超时：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">ex</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> error = </span><br><span class="line">          ex.<span class="property">code</span> === <span class="string">&quot;ECONNABORTED&quot;</span></span><br><span class="line">    	? <span class="string">&quot;A timeout has occurred&quot;</span></span><br><span class="line">    	: ex.<span class="property">response</span>.<span class="property">status</span> === <span class="number">404</span> </span><br><span class="line">    		? <span class="string">&quot;Resource not found&quot;</span></span><br><span class="line">    		: <span class="string">&quot;An unexpected error has occurred&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; error &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>我们检测<code>code</code>属性来判断是否发生了超时。</p>
<p>再次执行应用，可以看到红色<strong>A timeout has occurred</strong>字体。</p>
<ol start="3">
<li>将超时更改为合适的值。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">5000</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Canceling-requests"><a class="header-anchor" href="#Canceling-requests">¶</a>Canceling requests</h3>
<p>允许用户取消请求可以提升用户体验效果。</p>
<ol>
<li>首先，导入<code>CancelTokenSource</code>类型：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios, &#123; <span class="title class_">CancelTokenSource</span> &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>添加 cancel token和加载flag到state中：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">  <span class="attr">posts</span>: <span class="title class_">IPost</span>[];</span><br><span class="line">  <span class="attr">error</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">cancelTokenSource</span>?: <span class="title class_">CancelTokenSource</span>;</span><br><span class="line">  <span class="attr">loading</span>: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在构造器初始化：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">  <span class="attr">posts</span>: [],</span><br><span class="line">  <span class="attr">error</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="attr">loading</span>: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>在<code>GET</code>请求之前，生成token资源：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> cancelToken = axios.<span class="property">CancelToken</span>;</span><br><span class="line">  <span class="keyword">const</span> cancelTokenSource = cancelToken.<span class="title function_">source</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; cancelTokenSource &#125;);</span><br><span class="line">  axios</span><br><span class="line">    .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(...)</span><br><span class="line">    .<span class="title function_">then</span>(...)</span><br><span class="line">    .<span class="title function_">catch</span>(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>然后在GET请求中使用这个token：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">cancelToken</span>: cancelTokenSource.<span class="property">token</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>我们可以在<code>catch</code>方法处理取消的情况。并设置<code>loading</code>状态为<code>false</code>：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">catch</span>(<span class="function">(<span class="params">ex</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> error =</span><br><span class="line">    ex.<span class="property">code</span> === <span class="string">&quot;ECONNABORTED&quot;</span></span><br><span class="line">      ? <span class="string">&quot;A timeout has occurred&quot;</span></span><br><span class="line">      : ex.<span class="property">response</span>.<span class="property">status</span> === <span class="number">404</span></span><br><span class="line">      ? <span class="string">&quot;Resource not found&quot;</span></span><br><span class="line">      : <span class="string">&quot;An unexpected error has occurred&quot;</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; error &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>因此我们使用<code>axios</code>里面的<code>isCancel</code>函数来检测请求是否已经被取消。</p>
<ol start="7">
<li>在<code>componentDidMount</code>方法里面，在<code>then</code>方法设置<code>loading</code>的状态为<code>false</code>：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">posts</span>: response.<span class="property">data</span>, <span class="attr">loading</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>在<code>render</code>方法中，添加一个<code>Cancel</code>按钮，允许用户取消请求：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">loading</span> &amp;&amp; (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleCancelClick&#125;</span>&gt;</span>Cancel<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">)&#125;</span><br><span class="line">&lt;url className=<span class="string">&quot;posts&quot;</span>&gt;...&lt;/url&gt;</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>实现取消处理：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleCancelClick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">cancelTokenSource</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">cancelTokenSource</span>.<span class="title function_">cancel</span>(<span class="string">&quot;User cancelled operation&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>现在有点难测，因为请求一般很快。为了可以看到取消请求的动作。我们可以在<code>componentDidMount</code>方法内立即取消请求动作：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">axios</span><br><span class="line">  .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(...)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;...&#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">ex</span> =&gt;</span> &#123;...&#125;);</span><br><span class="line">cancelTokenSource.<span class="title function_">cancel</span>(<span class="string">&quot;User cancelled operation&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>回到浏览器可以看到红色字体的<strong>Request cancelled</strong>字样。</p>
<h3 id="Creating-data-with-axios"><a class="header-anchor" href="#Creating-data-with-axios">¶</a>Creating data with axios</h3>
<p>使用POST请求创建数据：</p>
<ol>
<li>首先添加状态属性：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IState</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">editPost</span>: <span class="title class_">IPost</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在构造器初始化：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">constructor</span>(<span class="params"><span class="attr">props</span>: &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        ...,</span><br><span class="line">        <span class="attr">editPost</span>: &#123;</span><br><span class="line">          <span class="attr">body</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">title</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">userId</span>: <span class="number">1</span></span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建表单内容：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;App&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;post-eidt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">type</span>=<span class="string">&quot;text&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">placeholder</span>=<span class="string">&quot;Enter title&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">value</span>=<span class="string">&#123;this.state.editPost.title&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onChange</span>=<span class="string">&#123;this.handleTitleChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">textarea</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">placeholder</span>=<span class="string">&quot;Enter body&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">value</span>=<span class="string">&#123;this.state.editPost.body&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onChange</span>=<span class="string">&#123;this.handleBodyChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleSaveClick&#125;</span>&gt;</span>Save<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;this.state.loading &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleCancelClick&#125;</span>&gt;</span>Cancel<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        )&#125;</span></span><br><span class="line"><span class="language-xml">        ...</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>下面是对状态的更新处理：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleTitleChange = <span class="function">(<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">editPost</span>: &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>,</span><br><span class="line">            <span class="attr">title</span>: e.<span class="property">currentTarget</span>.<span class="property">value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> handleBodyChange = <span class="function">(<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLTextAreaElement</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">editPost</span>: &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>,</span><br><span class="line">            <span class="attr">body</span>: e.<span class="property">currentTarget</span>.<span class="property">value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>在<code>index.css</code>中添加一些CSS样式让它看起来更合理：</li>
</ol>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.post-edit</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post-edit</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: inherit;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post-edit</span> <span class="selector-tag">textarea</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: inherit;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post-edit</span> <span class="selector-tag">button</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: inherit;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>然后在点击时，触发<code>POST</code>请求：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleSaveClick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    axios</span><br><span class="line">      .<span class="property">post</span>&lt;<span class="title class_">IPost</span>&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">body</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>.<span class="property">body</span>,</span><br><span class="line">        <span class="attr">title</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>.<span class="property">title</span>,</span><br><span class="line">        <span class="attr">userId</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>.<span class="property">userId</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">posts</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">posts</span>.<span class="title function_">concat</span>(response.<span class="property">data</span>)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>post</code>函数的结构和<code>get</code>非常相似。实际上，可以像<code>get</code>方法一样，添加错误处理、超时、取消等动作。</p>
<h3 id="Updating-data-with-axios"><a class="header-anchor" href="#Updating-data-with-axios">¶</a>Updating data with axios</h3>
<p>我们希望用户可以点击<strong>Update</strong>按钮来更新数据。</p>
<ol>
<li>首先创建一个<code>Update</code>按钮。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;li key=&#123;post.<span class="property">id</span>&#125;&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;post.title&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;post.body&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.handleUpdateClick(post)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">    Update</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>实现<strong>Update</strong>按钮的事件处理：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleUpdateClick = <span class="function">(<span class="params"><span class="attr">post</span>:<span class="title class_">IPost</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">editPost</span>: post &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在原来的保存点击句柄，需要实现两个分支：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleSaveClick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>.<span class="property">id</span>) &#123;</span><br><span class="line">    <span class="comment">// TODO - make a PUT request</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    axios</span><br><span class="line">      .<span class="property">post</span>&lt;<span class="title class_">IPost</span>&gt;( ... )</span><br><span class="line">      .<span class="property">then</span> ( ... );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>实现<code>PUT</code>请求分支：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>.<span class="property">id</span>) &#123;</span><br><span class="line">  axios</span><br><span class="line">  .<span class="property">put</span>&lt;<span class="title class_">IPost</span>&gt;(</span><br><span class="line">    <span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;<span class="variable language_">this</span>.state.editPost.id&#125;</span>`</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>, &#123;</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">editPost</span>: &#123;</span><br><span class="line">        <span class="attr">body</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">userId</span>: <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">posts</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">posts</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">post</span> =&gt;</span> post.<span class="property">id</span> !== <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>.<span class="property">id</span>)</span><br><span class="line">        .<span class="title function_">concat</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">editPost</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Delete-data-with-axios"><a class="header-anchor" href="#Delete-data-with-axios">¶</a>Delete data with axios</h3>
<p>添加<code>Delete</code>按钮以允许用户删除数据：</p>
<ol>
<li>首先创建一个<code>Delete</code>按钮：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;li key=&#123;post.<span class="property">id</span>&#125;&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;post.title&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;post.body&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.handleUpdateClick(post)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">    Update</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.handleDeleteClick(post)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">    Delete</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>添加删除的事件处理：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> handleDeleteClick = <span class="function">(<span class="params"><span class="attr">post</span>: <span class="title class_">IPost</span></span>) =&gt;</span> &#123;</span><br><span class="line">  axios</span><br><span class="line">  .<span class="title function_">delete</span>(<span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;post.id&#125;</span>`</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">posts</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">posts</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">p</span> =&gt;</span> p.<span class="property">id</span> !== post.<span class="property">id</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Using-axios-with-function-components"><a class="header-anchor" href="#Using-axios-with-function-components">¶</a>Using axios with function components</h3>
<p>本小节将实现函数组件(function component)版本的<code>axios</code>调用。我们将重构上一节的<code>App</code>的代码：</p>
<ol>
<li>首先声明<code>defaultPosts</code>常量，它包含了邮箱的初始状态。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">defaultPosts</span>: <span class="title class_">IPost</span>[] = [];</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>删除<code>IState</code>接口，因为状态被构造为独立的块。</li>
<li>移除先前的<code>App</code>类组件。</li>
<li>接下来，在常量<code>defaultPosts</code>下开始我们的<code>App</code>函数组件。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">App</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>下面创建独立的状态块，包括post、error、cancel token、loading falg、editpost。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">App</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [posts, setPosts]: [<span class="title class_">IPost</span>[], <span class="function">(<span class="params"><span class="attr">posts</span>: <span class="title class_">IPost</span>[]</span>) =&gt;</span> <span class="built_in">void</span>] = <span class="title class_">React</span>.<span class="title function_">useState</span>(defaultPosts);</span><br><span class="line">  <span class="keyword">const</span> [error, setError]: [<span class="built_in">string</span>, <span class="function">(<span class="params"><span class="attr">error</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> cancelToken = axios.<span class="property">CancelToken</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [cancelTokenSource, setCancelTokenSource]: [</span><br><span class="line">    <span class="title class_">CancelTokenSource</span>,</span><br><span class="line">    <span class="function">(<span class="params"><span class="attr">cancelSourceToken</span>: <span class="title class_">CancelTokenSource</span></span>) =&gt;</span> <span class="built_in">void</span>,</span><br><span class="line">  ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(cancelToken.<span class="title function_">source</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading]: [<span class="built_in">boolean</span>, <span class="function">(<span class="params"><span class="attr">loading</span>: <span class="built_in">boolean</span></span>) =&gt;</span> <span class="built_in">void</span>] = <span class="title class_">React</span>.<span class="property">useState</span>&lt;<span class="built_in">boolean</span>&gt;(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">const</span> [editPost, setEditPost]: [<span class="title class_">IPost</span>, <span class="function">(<span class="params"><span class="attr">post</span>: <span class="title class_">IPost</span></span>) =&gt;</span> <span class="built_in">void</span>] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，我们使用了<code>useState</code>函数来定义和初始化所有这些状态块。</p>
<ol start="6">
<li>我们希望在组件首次被挂载时调用REST API以获取邮箱信息。我们可以使用<code>useEffect</code>函数，在状态定义下添加：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// TODO - get posts</span></span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>在arrow function调用REST API获取邮件数据：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  axios</span><br><span class="line">  .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">cancelToken</span>: cancelTokenSource.<span class="property">token</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">5000</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>处理返回数据，设置邮箱数据和加载状态：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  axios</span><br><span class="line">  .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(...)</span><br><span class="line">	.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setPosts</span>(response.<span class="property">data</span>);</span><br><span class="line">    <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>处理错误状态信息：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  axios</span><br><span class="line">    .<span class="property">get</span>&lt;<span class="title class_">IPost</span>[]&gt;(...)</span><br><span class="line">    .<span class="title function_">then</span>(...)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">ex</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> err = axios.<span class="title function_">isCancel</span>(ex)</span><br><span class="line">        ? <span class="string">&#x27;Request cancelled&#x27;</span></span><br><span class="line">        : ex.<span class="property">code</span> === <span class="string">&#x27;ECONNABORTED&#x27;</span></span><br><span class="line">        ? <span class="string">&#x27;A timeout has occurred&#x27;</span></span><br><span class="line">        : ex.<span class="property">response</span>.<span class="property">status</span> === <span class="number">404</span></span><br><span class="line">        ? <span class="string">&#x27;Resource not found&#x27;</span></span><br><span class="line">        : <span class="string">&#x27;An unexpected error has occurred&#x27;</span>;</span><br><span class="line">      <span class="title function_">setError</span>(err);</span><br><span class="line">      <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="10">
<li>接下来处理事件。事件的处理并没有多大变化，只是使用<code>const</code>来声明，以及用前面声明的状态块来设置状态。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleCancelClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (cancelTokenSource) &#123;</span><br><span class="line">    cancelTokenSource.<span class="title function_">cancel</span>(<span class="string">&quot;User cancelled operation&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="11">
<li>输入变更事件：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleTitleChange</span> = (<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLInputElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">setEditPost</span>(&#123; ...editPost, <span class="attr">title</span>: e.<span class="property">currentTarget</span>.<span class="property">value</span> &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleBodyChange</span> = (<span class="params"><span class="attr">e</span>: <span class="title class_">React</span>.<span class="title class_">ChangeEvent</span>&lt;<span class="title class_">HTMLTextAreaElement</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">setEditPost</span>(&#123; ...editPost, <span class="attr">body</span>: e.<span class="property">currentTarget</span>.<span class="property">value</span> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="12">
<li><strong>Save</strong>按钮事件：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleSaveClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (editPost.<span class="property">id</span>) &#123;</span><br><span class="line">    axios</span><br><span class="line">      .<span class="property">put</span>&lt;<span class="title class_">IPost</span>&gt;(<span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;editPost.id&#125;</span>`</span>, editPost, &#123;</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setEditPost</span>(&#123;</span><br><span class="line">          <span class="attr">body</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">          <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">          <span class="attr">userId</span>: <span class="number">1</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="title function_">setPosts</span>(posts.<span class="title function_">filter</span>(<span class="function"><span class="params">post</span> =&gt;</span> post.<span class="property">id</span> !== editPost.<span class="property">id</span>).<span class="title function_">concat</span>(editPost));</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    axios</span><br><span class="line">      .<span class="property">post</span>&lt;<span class="title class_">IPost</span>&gt;(</span><br><span class="line">        <span class="string">&#x27;https://jsonplaceholder.typicode.com/posts&#x27;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">body</span>: editPost.<span class="property">body</span>,</span><br><span class="line">          <span class="attr">title</span>: editPost.<span class="property">title</span>,</span><br><span class="line">          <span class="attr">userId</span>: editPost.<span class="property">userId</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setPosts</span>(posts.<span class="title function_">concat</span>(response.<span class="property">data</span>));</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="13">
<li><strong>Update</strong> 按钮：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleUpdateClick</span> = (<span class="params"><span class="attr">post</span>: <span class="title class_">IPost</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">setEditPost</span>(post);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="14">
<li><strong>Delete</strong>按钮：</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleDeleteClick</span> = (<span class="params"><span class="attr">post</span>: <span class="title class_">IPost</span></span>) =&gt; &#123;</span><br><span class="line">  axios.<span class="title function_">delete</span>(<span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;post.id&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setPosts</span>(posts.<span class="title function_">filter</span>(<span class="function"><span class="params">p</span> =&gt;</span> p.<span class="property">id</span> !== post.<span class="property">id</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="15">
<li>最后的任务是实现返回语句。和原来的没有太大改变，只是删掉了<code>this</code>引用。</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;post-edit&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Enter title&quot;</span> <span class="attr">value</span>=<span class="string">&#123;editPost.title&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;handleTitleChange&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">placeholder</span>=<span class="string">&quot;Enter body&quot;</span> <span class="attr">value</span>=<span class="string">&#123;editPost.body&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;handleBodyChange&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleSaveClick&#125;</span>&gt;</span>Save<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;loading &amp;&amp; <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleCancelClick&#125;</span>&gt;</span>Cancel<span class="tag">&lt;/<span class="name">button</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">className</span>=<span class="string">&quot;posts&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;posts.map(post =&gt; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;post.id&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;post.title&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;post.body&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> handleUpdateClick(post)&#125;&gt;Update<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> handleDeleteClick(post)&#125;&gt;Delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ))&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;error &amp;&amp; <span class="tag">&lt;<span class="name">p</span> <span class="attr">className</span>=<span class="string">&quot;error&quot;</span>&gt;</span>&#123;error&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>主要不同的地方是，我们使用了<code>useEffect</code>函数来调用REST API，替换原来的<code>componentDidMount()</code>。</p>
<h2 id="Summary"><a class="header-anchor" href="#Summary">¶</a>Summary</h2>
<p>Callback-based异步代码难于阅读和维护。谁会花几个小时，从根节点开始去追踪Callback-based异步代码的bug呢？又或者花好几个小时来逐步理解每个回调的意思？幸运的是，我们有Promise-based的写法。</p>
<p>Promise-based函数相比基于回调的写法有很大提升。更易于阅读、错误更易处理。结合关键字<code>async</code>和<code>await</code>后的使用相比原来代码有更大的阅读性。</p>
<p>现代浏览器有一个很好的<code>fetch</code>函数来处理REST请求。它是一个Promise-based的函数，提供对异步请求很好的处理。</p>
<p><code>axios</code>是相对<code>fetch</code>的另一种选择。它的API更清晰，TypeScript更友好，错误处理更方便。</p>
<p>最后我们还对异步请求的实现做了两个不同的版本。一个是class component，另一个是function component(FC)。在类组件，异步的处理要放在<code>componentDidMount</code>生命周期函数中。在函数组件，使用<code>useEffect</code>函数来处理每次的渲染。两种方式，你会选择哪种？</p>
<p>REST API并不是唯一会交互的API。GraphQL是另一种流行的API服务。将在下个章节学习。</p>
<h2 id="Questions"><a class="header-anchor" href="#Questions">¶</a>Questions</h2>
<p>问题时间。</p>
<ol>
<li>下面程序执行后，会在console输出什么？</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Oops&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sorry, there is a problem&quot;</span>, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>假设没有9999这个邮箱，下面程序会输出什么？</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/999&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;HTTP status code&quot;</span>, response.<span class="property">status</span>);</span><br><span class="line">    <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Response body&quot;</span>, data))</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error&quot;</span>, error));</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>下面程序执行后，console会输出什么？</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axios</span><br><span class="line">.<span class="title function_">get</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/9999&quot;</span>)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;HTTP status code&quot;</span>, response.<span class="property">status</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error&quot;</span>, error.<span class="property">response</span>.<span class="property">status</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>使用<code>fetch</code>和<code>axios</code>有什么好处？</li>
<li>下面程序如何添加一个bearer token？</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">get</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>)</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>我们使用下面程序来更新邮箱的标题？</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">put</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;corrected title&quot;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&quot;some stuff&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>如果要用到<code>PATCH</code>请求，怎么改更高效。</li>
<li>我们实现了一个FC来显示邮箱，下面代码在执行时会有什么错误？</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    axios</span><br><span class="line">    .<span class="title function_">get</span>(<span class="string">`https://jsonplaceholder.typicode.com/posts/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">    .<span class="title function_">then</span>(...)</span><br><span class="line">    .<span class="title function_">catch</span>(...);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</div></article><nav class="article-nav"><div class="article-nav-prev">🔙<a href="/2019/11/27/react-ts/chapter_a_Interacting_with_GraphQL_APIs/">第十章 GraphQL接口交互</a></div><div class="article-nav-next">🔜<a href="/2019/11/27/react-ts/chapter_8_React_Redux/">第八章 React Redux</a></div></nav><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2019/11/27/react-ts/chapter_9_Interacting_with_RESTful_APIs/';
var disqus_title = '第九章 RESTful 接口交互';
var disqus_url = 'https://galudisu.info/2019/11/27/react-ts/chapter_9_Interacting_with_RESTful_APIs/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>