<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"><title>Pekko in Kubernetes, application level solution for Digital Transformation</title>
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="/css/vendors/rabbit-lyrics.css">
<link rel="shortcut icon" href="/img/favicon.ico"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="简单易懂の现代魔法" type="application/atom+xml">
</head><body><header class="base-menu"><div class="menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav></div></header><header class="base-mobile-menu"><div class="mobile-menu-wrapper"><div class="menu-layout-bg"></div><nav class="menu-content"><ul class="menu-list"><li class="menu-item"><a class="menu-link" href="/">简单易懂の现代魔法</a></li><li class="menu-item"><a class="menu-link" href="/archives/">Archives</a></li><li class="menu-item"><a class="menu-link" target="_blank" rel="noopener" href="http://weibo.com/u/2360401155">Weibo</a></li><li class="menu-item"><a class="menu-link" href="/about">About</a></li><li class="menu-item"><a class="menu-link" href="/atom.xml">Rss</a></li></ul></nav><div class="toggle-menu" id="mobile-menu-toggle"><span class="menu-bar"></span><span class="menu-bar"> </span><span class="menu-bar"></span></div></div></header><div class="base-content"><div class="base-content-main"><article class="article-main"><h1 class="article-title">Pekko in Kubernetes, application level solution for Digital Transformation</h1><div class="article-meta"><p class="meta-item meta-time"><span class="meta-item-title"></span><i class="icon-calendar"> </i>2024-06-13</p><p class="meta-item meta-tag"><span class="meta-item-title"></span><i class="icon-tags"> </i><a class="tag-link" href="/tags/kubernetes/">kubernetes<span class="tag">, </span></a><a class="tag-link" href="/tags/pekko/">pekko<span class="tag">, </span></a><a class="tag-link" href="/tags/udp/">udp<span class="tag">, </span></a><a class="tag-link" href="/tags/IIoT/">IIoT</a></p></div><div class="article-content"><h2 id="Digital-Reform"><a class="header-anchor" href="#Digital-Reform">¶</a>Digital Reform</h2>
<p>There was a vary circumstances from digital governance, industry, manufacture and medicine, and the booming of<br>
new business models has stimulated enterprises to accelerate <strong>digital transformation</strong> for better company management<br>
and customer service, which further promotes the upgrading and optimization of the Chinese digital economy.</p>
<span id="more"></span>
<h2 id="Solution-Cloud-Native"><a class="header-anchor" href="#Solution-Cloud-Native">¶</a>Solution - Cloud Native</h2>
<p>What’s internet essentially?</p>
<blockquote>
<p>移动互联网络应该是<br>
一个异步的由事件流驱动的巨大的状态机</p>
</blockquote>
<p>There are many reason that we are migrating business service into Cloud Native. One of most important reason is that we<br>
need to reduce our costs. Furthermore, as our productivity increases, we will have a vision on the IoT service.</p>
<p><img src="iot-visable.png" alt="Facets of design in IoT-a good product requires integrated thinking across all of these"></p>
<p>the digital reform indicate that in the future, the connected things shall be self-diagnosis, reliable, lower-bandwidth,<br>
low-carbon, more intelligent, and have a better version management.</p>
<h2 id="Why-Pekko-if-you-have-kubernetes"><a class="header-anchor" href="#Why-Pekko-if-you-have-kubernetes">¶</a>Why Pekko if you have kubernetes?</h2>
<blockquote>
<p>Kubernetes is not the application layer.</p>
</blockquote>
<p>As we know, K8S is covering the cluster orchestration, supporting auto-scaling and resilience on the nodes or the pods<br>
level.</p>
<p>How the auto-scaling and self-healing will be handled within the application instances or node?</p>
<p>Kubernetes will not be able to help with that, another layer such as Pekko need to look after the application<br>
communication, remoting, concurrency &amp; parallel processing, responding to application failure, implementing resilience<br>
design patterns such as bulk-heading and circuit-breakers on the application node level.</p>
<p>Non-function design in Kubernetes is stupid, such like GEO-Red, distributed-lock for business, transactions, entity-id<br>
tracing, overload protect, data desensitization, Monitoring… etc.</p>
<p>In short, Kubernetes is looking after elasticity, auto-scaling and resilience outside the nodes while Pekko and other<br>
reactive application tools are looking after those within the application layer and the nodes.</p>
<p>After all, Kubernetes will not be able to fix a poorly designed application that is prone to failure and lacking<br>
resilience and elasticity.</p>
<p>We need a <strong>REAL</strong> <a target="_blank" rel="noopener" href="https://www.reactivemanifesto.org/">reactive manifesto</a> application, and below Lightbend diagrams<br>
help with understanding the concept:</p>
<p><img src="pekko-cloud.png" alt="Cloud Native"></p>
<p><img src="pekko-pod.png" alt="Cloud Pekko"></p>
<p>So, how to build stateful, resilient and responsive applications in the Cloud?</p>
<h2 id="Sharding-your-X"><a class="header-anchor" href="#Sharding-your-X">¶</a>Sharding your X</h2>
<h2 id="Pekko-roles-as-Kubernetes-resource-mapping"><a class="header-anchor" href="#Pekko-roles-as-Kubernetes-resource-mapping">¶</a>Pekko roles as Kubernetes resource mapping</h2>
<p>We use both Kubernetes Statefulset and Deployment. As we can use Statefulset for the seed nodes, mark as role <code>seed</code>,<br>
and Deployment for scaling out worker nodes, marks role <code>worker</code>. In this way, we can maintaion stable and ordered DNS<br>
names for the seed nodes, while retain the ability to start multiple Pekko nodes in parallel when scale with<br>
Deployment.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  seeds  : Statefulset</span><br><span class="line">  workers: Deployment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="Gossip.png" alt=""></p>
<p>We will setup env from Kubernetes and deliver into <code>application.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cluster &#123;</span><br><span class="line">  # This can also be defined as Java system properties when starting the JVM using the following syntax:</span><br><span class="line">  #</span><br><span class="line">  # -Dpekko.cluster.seed-nodes.0=pekko://Pekko@seed1:2551</span><br><span class="line">  # -Dpekko.cluster.seed-nodes.1=pekko://Pekko@seed2:2551</span><br><span class="line">  #</span><br><span class="line">  seed-nodes = [</span><br><span class="line">    &quot;pekko://Pekko@127.0.0.1:2551&quot;,</span><br><span class="line">    &quot;pekko://Pekko@127.0.0.1:2552&quot;]</span><br><span class="line">  seed-nodes = $&#123;?SEED_NODES&#125;</span><br><span class="line">  roles = [&quot;seed&quot;, &quot;sharding&quot;]</span><br><span class="line">  roles = $&#123;?ROLES&#125;</span><br><span class="line">  sharding.role = &quot;sharding&quot;</span><br><span class="line">  sharding.role = $&#123;?SHARDING_ROLE&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Statefulset-for-entry-seeds"><a class="header-anchor" href="#Statefulset-for-entry-seeds">¶</a>Statefulset for entry -&gt; seeds</h3>
<p>especially, mTLS in istio. We will map it for traffic entries as a headless service. And the <code>seed</code>-ed service won’t<br>
do anything. The resource definition looks like a regular service, but clusterIP set to None:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">pekko-seed</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2551</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">2551</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5684</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">5684</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pekko-seed</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure>
<p>Every Pekko seed node instance in the Statefulset can be addressed via DNS as <code>$&#123;SEED_NODE_NAME&#125;.pekko-seed</code>.</p>
<p>Then, create Statefulset of seed nodes:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pekko-seed</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pekko-seed</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">pekko-seed</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">pekko-seed</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">pekko-seed</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pekko-seed</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">localhost:32000/pekko-jdk17-slim:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEED_NODES.0</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">pekko://Pekko@pekko-seed-0.pekko-seed:2551</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEED_NODES.1</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">pekko://Pekko@pekko-seed-1.pekko-seed:2551</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ROLES.0</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">seed</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SHARDING_ROLE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">sharding</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">$(POD_NAME).kaxis-seed</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;4684&quot;</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;HOST_NAME=$&#123;POD_NAME&#125;.pekko-seed java -jar /app/app.jar&quot;</span>]</span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">2551</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2551</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5684</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">UDP</span></span><br></pre></td></tr></table></figure>
<p>First of all, every seed node will have a stable name (e.g. pekko-seed-0, pekko-ssed-1). This name is known as the<br>
Kubernetes pod name. And then use it to construct the addressable DNS name, such as <code>pekko-seed-0.pekko-seed</code>.</p>
<p>Once deployment the Pekko seed nodes:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pekko-seeds.yaml</span><br></pre></td></tr></table></figure>
<p>We will seed the seeds that were created sequentially:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">NAME                          READY     STATUS    RESTARTS   AGE</span><br><span class="line">pekko-seed-0                   1/1       Running   0          15h</span><br><span class="line">pekko-seed-1                   1/1       Running   0          15h</span><br></pre></td></tr></table></figure>
<p>As mentioned before, the seed nodes won’t do anything, below diagram show it just play the role for traffic transform,<br>
cluster communication and cluster init.</p>
<p>This part is very-very important!! for vary business service, such like coap, diameter protocol based on udp that<br>
Kubernetes doesn’t provide a full-stack support for loadbalancer.</p>
<h3 id="Deployment-for-loadbancer-workers"><a class="header-anchor" href="#Deployment-for-loadbancer-workers">¶</a>Deployment for loadbancer -&gt; workers</h3>
<p>Next, deploy the worker nodes using Deployment. It use the Downward API to assign the Pod IP address as te Pekko node’s<br>
hostname.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pekko-worker</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pekko-worker</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pekko-worker</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pekko-worker</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">localhost:32000/pekko-jdk17-slim:latest</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEED_NODES.0</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">pekko://Pekko@pekko-seed-0.pekko-seed:4684</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SEED_NODES.1</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">pekko://Pekko@pekko-seed-1.pekko-seed:4684</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ROLES.0</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sharding</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SHARDING_ROLE</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">sharding</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;$(POD_NAME)&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_PORT</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;4684&quot;</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">6684</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">health/alive</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">6684</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">health/ready</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">20</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5684</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">tcp-udp</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4684</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-gossip</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">regcred</span></span><br></pre></td></tr></table></figure>
<p>Once deloyed, you can validate that all nodes are up and running:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pods</span></span><br><span class="line">NAME                           READY     STATUS    RESTARTS   AGE</span><br><span class="line">pekko-seed-0                    1/1       Running   0          8s</span><br><span class="line">pekko-seed-1                    1/1       Running   0          6s</span><br><span class="line">pekko-worker-2263404214-8c266   1/1       Running   0          8s</span><br><span class="line">pekko-worker-2263404214-9ws3k   1/1       Running   0          8s</span><br><span class="line">pekko-worker-2263404214-f2tp3   1/1       Running   0          8s</span><br><span class="line">pekko-worker-2263404214-lkvz3   1/1       Running   0          8s</span><br></pre></td></tr></table></figure>
<p>You can validate that the nodes have joined the cluster by inspecting the logs of any of the Pekko nodes. For<br>
example, to tail the first seed node’s log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubect logs -f pekko-seed-0</span><br><span class="line">[INFO] [02/12/2017 15:36:53.568] [main] [pekko.remote.Remoting] Starting remoting</span><br><span class="line">[INFO] [02/12/2017 15:36:53.707] [main] [pekko.remote.Remoting] Remoting started; listening on addresses :[pekko.tcp://Pekko@pekko-seed-0.akka-seed:2551]</span><br><span class="line">...</span><br><span class="line">[INFO] [02/12/2017 15:37:05.101] [ClusterSystem-pekko.actor.default-dispatcher-16] [pekko.cluster.Cluster(pekko://ClusterSystem)] Cluster Node [pekko.tcp://Pekko@pekko-seed-0.pekko-seed:2551] - Node [pekko.tcp://Pekko@pekko-seed-1.pekko-seed:2551] is JOINING, roles []</span><br><span class="line">[INFO] [02/12/2017 15:37:06.854] [ClusterSystem-pekko.actor.default-dispatcher-16] [pekko://ClusterSystem/user/$a] Member is Up: Member(address = akka.tcp://Pekko@10.44.2.10:2551, status = Up)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Also, you can simply attach Kubernetes HPA:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: pekko-worker</span><br><span class="line">spec:</span><br><span class="line">  maxReplicas: 3</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: pekko-worker</span><br><span class="line">  targetCPUUtilizationPercentage: 15</span><br></pre></td></tr></table></figure>
<h2 id="Health-check"><a class="header-anchor" href="#Health-check">¶</a>Health check</h2>
<p>Pekko already implementation cluster health check management:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">management</span></span><br><span class="line">management &#123;</span><br><span class="line">  http.hostname = 127.0.0.1</span><br><span class="line">  http.hostname = $&#123;?HOST_NAME&#125;</span><br><span class="line">  http.bind-hostname = 0.0.0.0</span><br><span class="line">  http.bind-hostname = $&#123;?HOST_NAME&#125;</span><br><span class="line">  health-checks &#123;</span><br><span class="line">    readiness-path = &quot;health/ready&quot;</span><br><span class="line">    liveness-path = &quot;health/alive&quot;</span><br><span class="line">    readiness-checks &#123;</span><br><span class="line">      # Default health check for cluster.</span><br><span class="line">      cluster-membership = &quot;org.apache.pekko.management.cluster.javadsl.ClusterMembershipCheck&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a class="header-anchor" href="#Summary">¶</a>Summary</h2>
<p>Please check my own repo in <a target="_blank" rel="noopener" href="https://github.com/barudisshu/kaxis">GitHub</a>, if you need more investigate.</p>
</div></article><div id="base-discus"><div id="disqus_thread"></div><script>var disqus_shortname = 'barudisshu-github-io';
var disqus_identifier = '2024/06/13/pekko/pekko-in-kubernetes-for-coap/';
var disqus_title = 'Pekko in Kubernetes, application level solution for Digital Transformation';
var disqus_url = 'https://galudisu.info/2024/06/13/pekko/pekko-in-kubernetes-for-coap/';
(function () {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async>  </script></div></div></div><footer class="base-footer"><div class="footer-wrapper"><span>©2016 - 2025 <a href="https://galudisu.info">barudisshu</a>, unless otherwise noted.</span></div></footer><div class="dom-ready">
<script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>

<link rel="stylesheet" href="//cdn.bootcss.com/pace/1.0.2/themes/green/pace-theme-flash.min.css">

<script src="/js/base.js"></script>

<script src="/js/rabbit-lyrics.js"></script>
</div></body></html>